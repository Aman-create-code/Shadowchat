<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#111b21">
    <meta name="description" content="ShadowChat Titan V13 - Enterprise Edition">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ShadowChat Titan V13</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#ffffff', 
                            dark: '#0b141a', // Tieferes Schwarz
                            sidebar: '#111b21',
                            header: '#202c33',
                            panelHover: '#2a3942',
                            accent: '#00a884', 
                            accentHover: '#008f6f',
                            bubbleOut: '#005c4b', 
                            bubbleIn: '#202c33',
                            danger: '#ef4444',
                            success: '#22c55e',
                            warning: '#eab308',
                            info: '#3b82f6',
                            system: '#182229'
                        }
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'slide-down': 'slideDown 0.3s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'slide-left': 'slideLeft 0.3s ease-out forwards',
                        'slide-right': 'slideRight 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'scale-in': 'scaleIn 0.15s ease-out forwards',
                        'pulse-rec': 'pulseRed 1.5s infinite',
                        'pop': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'spin-slow': 'spin 3s linear infinite'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideDown: { '0%': { transform: 'translateY(-20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideLeft: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(0)' } },
                        slideRight: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        pulseRed: { '0%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' }, '70%': { boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' }, '100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0)' } },
                        popIn: { '0%': { transform: 'scale(0)' }, '100%': { transform: 'scale(1)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CORE VARIABLES */
        :root { 
            --app-height: 100dvh; 
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --chat-bg: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }
        
        /* RESET & BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'SF Pro Display', sans-serif; 
            overflow: hidden; 
            height: var(--app-height); 
            background-color: #0b141a; 
            user-select: none; 
            color: #e9edef;
            overscroll-behavior: none;
        }

        /* SCROLLBARS */
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgba(134, 150, 160, 0.3) transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(134, 150, 160, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(134, 150, 160, 0.5); }

        /* GLASSMORPHISM */
        .glass-panel { 
            backdrop-filter: blur(16px) saturate(180%); 
            -webkit-backdrop-filter: blur(16px) saturate(180%); 
            background-color: rgba(32, 44, 51, 0.85); 
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* ANIMATIONS & TRANSITIONS */
        .msg-enter { opacity: 0; transform: translateY(15px); animation: msgSlide 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes msgSlide { to { opacity: 1; transform: translateY(0); } }
        
        .swipe-active { transform: translateX(60px); transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        /* CONTEXT MENU */
        #contextMenu { 
            box-shadow: 0 8px 32px rgba(0,0,0,0.6); 
            z-index: 9999;
            transform-origin: top left;
        }

        /* CALL UI */
        .call-bg { 
            background: radial-gradient(circle at center, #1f2c34 0%, #0b141a 100%);
        }
        .ripple { 
            position: absolute; border-radius: 50%; border: 1px solid rgba(0, 168, 132, 0.3); 
            animation: rippleAnim 2.5s infinite ease-out; top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .ripple:nth-child(2) { animation-delay: 0.6s; border-color: rgba(0, 168, 132, 0.2); }
        .ripple:nth-child(3) { animation-delay: 1.2s; border-color: rgba(0, 168, 132, 0.1); }
        
        @keyframes rippleAnim { 
            0% { width: 0; height: 0; opacity: 1; } 
            100% { width: 400px; height: 400px; opacity: 0; } 
        }

        /* TYPING INDICATOR */
        .typing-indicator span {
            display: inline-block; width: 5px; height: 5px; background-color: #00a884; border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both; margin: 0 1.5px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* AUDIO PLAYER */
        .audio-player { display: flex; align-items: center; gap: 10px; width: 240px; padding: 4px; }
        .waveform-canvas { width: 100%; height: 30px; opacity: 0.6; }

        /* TOGGLE SWITCHES */
        .toggle-checkbox:checked { right: 0; border-color: #00a884; }
        .toggle-checkbox:checked + .toggle-label { background-color: #00a884; }
        
        /* CROWN & BADGES */
        .admin-crown { color: #ffd700; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8)); }
        .verified-badge { color: #3b82f6; }
        
        /* TOASTS */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            pointer-events: auto; padding: 14px 24px; border-radius: 12px; 
            background: rgba(32, 44, 51, 0.95); backdrop-filter: blur(10px);
            color: white; box-shadow: 0 8px 24px rgba(0,0,0,0.4); 
            display: flex; align-items: center; gap: 14px; 
            animation: slideLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
            border-left: 4px solid #00a884; font-size: 14px; font-weight: 500; 
            min-width: 300px;
        }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
        .toast.warning { border-left-color: #eab308; }

        /* LOADING SPINNER */
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #00a884; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* WALLPAPER PATTERN */
        .chat-bg-pattern {
            background-image: var(--chat-bg);
            background-size: 400px;
            opacity: 0.06;
        }

        /* EMOJI PICKER GRID */
        .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; padding: 10px; }
        .emoji-item { font-size: 24px; cursor: pointer; text-align: center; border-radius: 4px; transition: transform 0.1s; }
        .emoji-item:hover { transform: scale(1.2); background: rgba(255,255,255,0.1); }
        
        /* RANGE INPUT */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #00a884; margin-top: -5px; cursor: pointer; box-shadow: 0 0 4px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #374045; border-radius: 2px; }

        /* USER SELECT TEXT FIX */
        .selectable-text { user-select: text; -webkit-user-select: text; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full overflow-hidden text-gray-100 bg-[#0b141a]">

    <audio id="sound-msg-in" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" preload="auto"></audio>
    <audio id="sound-msg-out" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
    <audio id="sound-ring" src="https://assets.mixkit.co/sfx/preview/mixkit-waiting-ringtone-1354.mp3" loop preload="auto"></audio>
    <audio id="sound-connect" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-back-2575.mp3" preload="auto"></audio>
    <audio id="remoteAudio" autoplay playsinline></audio>
    <audio id="localAudio" muted autoplay playsinline></audio>

    <div id="toast-container"></div>
    <div id="loader-overlay" class="fixed inset-0 z-[9999] bg-[#111b21] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <div class="text-[#00a884] font-bold tracking-widest text-sm animate-pulse">SHADOWCHAT TITAN</div>
        <div class="text-gray-500 text-xs mt-2 font-mono">Ende-zu-Ende Verschlüsselt</div>
    </div>

    <div id="lightbox" class="fixed inset-0 z-[300] bg-black/95 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="absolute top-0 w-full p-4 flex justify-between items-center bg-gradient-to-b from-black/60 to-transparent">
             <span id="lightbox-info" class="text-gray-300 text-sm font-mono ml-2"></span>
            <button onclick="UI.closeLightbox()" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <img id="lightbox-img" class="max-h-[85vh] max-w-[95vw] object-contain shadow-2xl rounded transform transition-transform duration-200">
        <div id="lightbox-caption" class="absolute bottom-10 bg-black/50 px-4 py-2 rounded-full text-center text-gray-200 font-medium backdrop-blur-md"></div>
    </div>

    <div id="contextMenu" class="fixed hidden bg-[#233138] rounded-xl overflow-hidden min-w-[220px] ring-1 ring-white/10 animate-scale-in">
        <div class="flex justify-between p-3 bg-[#182229] border-b border-gray-700" id="ctx-reactions">
            </div>
        <div class="py-1" id="ctx-items">
            </div>
    </div>

    <div id="modal-emoji" class="hidden absolute bottom-[80px] left-4 z-50 w-[350px] h-[400px] bg-[#202c33] rounded-2xl shadow-2xl border border-gray-700 flex flex-col animate-slide-up">
        <div class="flex items-center justify-between p-3 border-b border-gray-700 bg-[#182229] rounded-t-2xl">
            <span class="text-xs font-bold text-gray-400 uppercase">Emoji Auswahl</span>
            <div class="flex gap-2">
                <button onclick="UI.filterEmojis('recent')" class="text-[#00a884] hover:bg-white/5 p-1 rounded"><i data-lucide="clock" class="w-4 h-4"></i></button>
                <button onclick="UI.filterEmojis('smileys')" class="text-gray-400 hover:bg-white/5 p-1 rounded"><i data-lucide="smile" class="w-4 h-4"></i></button>
            </div>
        </div>
        <div id="emoji-container" class="flex-1 overflow-y-auto custom-scrollbar emoji-grid content-start">
            </div>
    </div>

    <aside id="sidebar" class="w-full md:w-[420px] lg:w-[480px] flex flex-col border-r border-gray-800 bg-[#111b21] z-20 shrink-0 h-full transition-transform duration-300 shadow-[2px_0_10px_rgba(0,0,0,0.3)]">
        
        <header class="h-[64px] bg-[#202c33] flex items-center justify-between px-4 shrink-0 z-30 select-none">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="UI.switchTab('settings')">
                <div class="relative">
                    <div id="my-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-[#00a884] to-[#005c4b] flex items-center justify-center font-bold text-white text-lg shadow-md group-hover:scale-105 transition-transform border-2 border-transparent group-hover:border-white/20">?</div>
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-[#202c33]"></div>
                </div>
                <div class="hidden sm:block">
                    <div class="font-bold text-sm text-gray-100 flex items-center gap-1">
                        <span id="my-nick-display">Lädt...</span>
                        <i data-lucide="shield-check" class="w-3 h-3 text-[#00a884]"></i>
                    </div>
                    <div class="text-[10px] text-gray-400 font-medium tracking-wide">TITAN PRO</div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 text-gray-400">
                <button onclick="UI.toggleModal('modal-new-group')" class="p-2.5 rounded-full hover:bg-white/10 transition active:scale-95" title="Neue Gruppe">
                    <i data-lucide="users-round" class="w-5 h-5"></i>
                </button>
                <button onclick="UI.toggleModal('modal-join-group')" class="p-2.5 rounded-full hover:bg-white/10 transition active:scale-95" title="Code scannen / Beitreten">
                    <i data-lucide="scan-line" class="w-5 h-5"></i>
                </button>
                <div class="relative group" tabindex="0">
                    <button class="p-2.5 rounded-full hover:bg-white/10 transition active:scale-95">
                        <i data-lucide="more-vertical" class="w-5 h-5"></i>
                    </button>
                    <div class="absolute right-0 top-full mt-1 w-56 bg-[#233138] rounded-lg shadow-xl border border-gray-700 hidden group-focus-within:block z-50 py-2 origin-top-right animate-scale-in">
                        <button onclick="UI.switchTab('settings')" class="w-full text-left px-5 py-3 hover:bg-[#182229] text-sm flex items-center gap-3"><i data-lucide="settings" class="w-4 h-4"></i> Einstellungen</button>
                        <button onclick="UI.switchTab('archived')" class="w-full text-left px-5 py-3 hover:bg-[#182229] text-sm flex items-center gap-3"><i data-lucide="archive" class="w-4 h-4"></i> Archiviert</button>
                        <div class="h-px bg-gray-700 my-1"></div>
                        <button onclick="Auth.logout()" class="w-full text-left px-5 py-3 hover:bg-red-900/20 text-sm text-red-400 flex items-center gap-3"><i data-lucide="log-out" class="w-4 h-4"></i> Abmelden</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-3 bg-[#111b21] border-b border-gray-800 sticky top-0 z-20">
            <div class="bg-[#202c33] flex items-center px-4 py-2 rounded-xl focus-within:ring-2 ring-[#00a884] transition-all group shadow-inner">
                <i data-lucide="search" class="w-4 h-4 text-gray-400 mr-3 group-focus-within:text-[#00a884] transition-colors"></i>
                <input id="search-input" type="text" placeholder="Suchen oder neuer Chat..." class="bg-transparent text-sm w-full outline-none text-white placeholder-gray-500 font-medium" onkeyup="Chat.filterChats(this.value)">
                <button onclick="document.getElementById('search-input').value=''; Chat.filterChats('')" class="hidden group-focus-within:block text-gray-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="flex gap-2 mt-3 overflow-x-auto custom-scrollbar pb-1">
                <button onclick="UI.filterList('all')" class="px-3 py-1 rounded-full bg-[#202c33] text-xs hover:bg-[#2a3942] border border-gray-700 active-filter text-[#00a884] border-[#00a884]">Alle</button>
                <button onclick="UI.filterList('unread')" class="px-3 py-1 rounded-full bg-[#202c33] text-xs hover:bg-[#2a3942] border border-gray-700 text-gray-400">Ungelesen</button>
                <button onclick="UI.filterList('groups')" class="px-3 py-1 rounded-full bg-[#202c33] text-xs hover:bg-[#2a3942] border border-gray-700 text-gray-400">Gruppen</button>
            </div>
        </div>
        
        <div class="flex justify-around bg-[#111b21] border-b border-gray-800 shadow-md">
            <button onclick="UI.switchTab('chats')" id="tab-btn-chats" class="flex-1 py-3.5 text-[#00a884] border-b-[3px] border-[#00a884] transition hover:bg-[#202c33]/30 relative">
                <i data-lucide="message-square" class="w-5 h-5 mx-auto"></i>
                <span id="badge-chats" class="absolute top-2 right-[30%] bg-[#00a884] text-[#111b21] text-[10px] font-bold px-1.5 rounded-full hidden">0</span>
            </button>
            <button onclick="UI.switchTab('calls')" id="tab-btn-calls" class="flex-1 py-3.5 text-gray-500 border-b-[3px] border-transparent transition hover:bg-[#202c33]/30">
                <i data-lucide="phone" class="w-5 h-5 mx-auto"></i>
            </button>
            <button onclick="UI.switchTab('status')" id="tab-btn-status" class="flex-1 py-3.5 text-gray-500 border-b-[3px] border-transparent transition hover:bg-[#202c33]/30 relative">
                <i data-lucide="circle-dashed" class="w-5 h-5 mx-auto"></i>
                <div id="dot-status" class="absolute top-3 right-[35%] w-2 h-2 bg-[#00a884] rounded-full hidden"></div>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative bg-[#111b21] scroll-smooth">
            
            <div id="offline-banner" class="hidden bg-yellow-600/20 text-yellow-500 text-xs text-center py-2 border-b border-yellow-600/30 flex items-center justify-center gap-2">
                <i data-lucide="wifi-off" class="w-3 h-3"></i> Offline - Änderungen werden lokal gespeichert
            </div>

            <div id="view-chats" class="tab-view h-full pb-20">
                <div id="chat-list" class="divide-y divide-gray-800/50">
                    <div class="p-10 text-center opacity-50 animate-pulse">
                        <i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin mb-2"></i>
                        <span class="text-xs">Synchronisiere...</span>
                    </div>
                </div>
            </div>

            <div id="view-calls" class="tab-view hidden h-full p-0">
                <div class="px-4 py-3 text-[11px] font-bold text-[#00a884] uppercase tracking-widest bg-[#111b21] sticky top-0 z-10 border-b border-gray-800">Verlauf</div>
                <div id="call-list" class="space-y-0 divide-y divide-gray-800/50"></div>
                <button onclick="Call.clearHistory()" class="w-full py-4 text-xs text-red-400 font-bold hover:bg-red-500/10 transition flex justify-center items-center gap-2">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Verlauf löschen
                </button>
            </div>

            <div id="view-status" class="tab-view hidden h-full p-4">
                <div class="flex items-center gap-4 mb-6 cursor-pointer p-3 rounded-2xl hover:bg-[#202c33] transition border border-transparent hover:border-gray-700" onclick="document.getElementById('status-input').click()">
                    <div class="relative w-14 h-14">
                        <div class="w-14 h-14 rounded-full border-2 border-dashed border-gray-500 flex items-center justify-center overflow-hidden hover:border-[#00a884] transition">
                             <img id="my-status-prev" class="w-full h-full object-cover hidden">
                             <i data-lucide="camera" class="w-6 h-6 text-gray-500" id="my-status-icon"></i>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-[#00a884] rounded-full p-1 border-2 border-[#111b21] shadow-lg">
                            <i data-lucide="plus" class="w-3 h-3 text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-200">Mein Status</h3>
                        <p class="text-xs text-gray-500">Tippe für Update (24h)</p>
                    </div>
                    <input type="file" id="status-input" class="hidden" accept="image/*" onchange="Chat.uploadStatus()">
                </div>
                
                <div class="text-[11px] font-bold text-gray-500 mb-3 uppercase tracking-wider pl-2">Aktuelle Meldungen</div>
                <div id="status-list" class="space-y-2"></div>
            </div>

            <div id="view-settings" class="tab-view hidden h-full p-4 pb-20 animate-fade-in">
                <div class="flex flex-col items-center mb-8 pt-6 relative">
                    <div class="w-28 h-28 rounded-full bg-[#202c33] mb-4 flex items-center justify-center text-5xl text-gray-400 shadow-2xl ring-4 ring-[#00a884]/20 overflow-hidden group cursor-pointer" id="settings-avatar-cont">
                        <span id="settings-avatar-text">?</span>
                        <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center text-xs font-bold text-white">ÄNDERN</div>
                    </div>
                    <h2 class="text-2xl font-black text-white tracking-tight" id="settings-nick">User</h2>
                    <p class="text-xs text-gray-500 font-mono mt-1 bg-black/20 px-2 py-1 rounded" id="settings-id">ID: ...</p>
                </div>

                <div class="space-y-5 max-w-sm mx-auto">
                    <div class="bg-[#202c33] p-5 rounded-2xl border border-gray-800 shadow-lg">
                        <h4 class="text-[#00a884] text-[10px] font-bold uppercase mb-4 tracking-widest">Profil</h4>
                        <div class="group relative mb-4">
                            <label class="text-[10px] text-gray-500 absolute -top-2 left-2 bg-[#202c33] px-1">Anzeigename</label>
                            <input id="input-nick" type="text" class="w-full bg-[#111b21] border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-[#00a884] transition text-sm">
                        </div>
                        <div class="group relative mb-4">
                             <label class="text-[10px] text-gray-500 absolute -top-2 left-2 bg-[#202c33] px-1">Info</label>
                            <textarea id="input-bio" class="w-full bg-[#111b21] border border-gray-700 rounded-lg p-3 text-white outline-none focus:border-[#00a884] resize-none h-20 transition text-sm"></textarea>
                        </div>
                        <button onclick="Auth.updateProfile()" class="w-full bg-[#00a884] hover:bg-[#008f6f] text-white py-2.5 rounded-lg font-bold text-sm transition shadow-lg active:scale-[0.98]">SPEICHERN</button>
                    </div>

                    <div class="bg-[#202c33] p-5 rounded-2xl border border-gray-800 shadow-lg">
                        <h4 class="text-[#00a884] text-[10px] font-bold uppercase mb-4 tracking-widest">System</h4>
                        
                        <div class="flex justify-between items-center py-3 border-b border-gray-700/50">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400"><i data-lucide="bell" class="w-4 h-4"></i></div>
                                <span class="text-sm font-medium">Benachrichtigungen</span>
                            </div>
                            <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="toggle-notify" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer top-1 left-1 transition-all duration-300" onchange="UI.toggleSetting('notify', this.checked)"/>
                                <label for="toggle-notify" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                            </div>
                        </div>

                        <div class="flex justify-between items-center py-3 border-b border-gray-700/50">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400"><i data-lucide="music" class="w-4 h-4"></i></div>
                                <span class="text-sm font-medium">Soundeffekte</span>
                            </div>
                            <div class="relative inline-block w-10 h-6">
                                <input type="checkbox" id="toggle-sound" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer top-1 left-1 transition-all" onchange="UI.toggleSetting('sound', this.checked)"/>
                                <label for="toggle-sound" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                            </div>
                        </div>

                         <div class="flex justify-between items-center py-3">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-yellow-500/10 rounded-lg text-yellow-400"><i data-lucide="lock" class="w-4 h-4"></i></div>
                                <span class="text-sm font-medium">E2E Indikator</span>
                            </div>
                             <div class="text-[10px] font-mono text-[#00a884]">AKTIV</div>
                        </div>
                    </div>

                    <div class="bg-red-900/10 p-5 rounded-2xl border border-red-900/30">
                        <h4 class="text-red-500 text-[10px] font-bold uppercase mb-3 tracking-widest">Gefahrenzone</h4>
                        <button onclick="Auth.deleteAccount()" class="w-full border border-red-500/30 text-red-500 py-2.5 rounded-lg hover:bg-red-500/10 transition text-sm font-bold flex items-center justify-center gap-2 group">
                            <i data-lucide="trash" class="w-4 h-4 group-hover:rotate-12 transition"></i> ACCOUNT LÖSCHEN
                        </button>
                    </div>

                    <footer class="text-center mt-8 pb-4 opacity-40">
                        <p class="text-xs font-mono">ShadowChat Titan v13.0.4</p>
                        <p class="text-[10px] text-[#00a884] font-bold mt-1">© 2026 Secured by AES-256 Simulation</p>
                    </footer>
                </div>
            </div>
        </div>
    </aside>

    <main id="main-chat" class="hidden md:flex flex-1 flex-col h-full relative bg-[#0b141a] z-10 transition-all duration-300">
        
        <div class="absolute inset-0 chat-bg-pattern z-0 pointer-events-none transition-all duration-700" id="chat-wallpaper"></div>

        <div id="chat-placeholder" class="absolute inset-0 flex flex-col items-center justify-center z-20 bg-[#111b21] border-l border-gray-800">
            <div class="relative">
                <div class="w-64 h-64 bg-gradient-to-t from-[#202c33] to-transparent rounded-full opacity-20 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 blur-2xl"></div>
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/479px-WhatsApp.svg.png" class="w-24 h-24 opacity-20 grayscale mb-6 relative z-10 filter drop-shadow-lg" alt="Logo">
            </div>
            <h1 class="text-2xl font-light text-gray-300 mb-2 tracking-wide">ShadowChat Titan</h1>
            <p class="text-sm text-gray-500 max-w-md text-center leading-relaxed">
                Sende und empfange Nachrichten ohne das Telefon online zu halten.<br>
                Verwende ShadowChat auf bis zu 4 verknüpften Geräten und 1 Telefon.
            </p>
            <div class="mt-8 flex items-center gap-2 text-xs text-gray-600">
                <i data-lucide="lock" class="w-3 h-3"></i> Ende-zu-Ende verschlüsselt
            </div>
        </div>

        <div id="active-chat-interface" class="flex flex-col h-full hidden z-30 relative">
            
            <header id="chat-header" class="h-[64px] bg-[#202c33]/95 backdrop-blur-md flex items-center justify-between px-4 z-20 border-b border-gray-800 shrink-0 shadow-sm">
                <div class="flex items-center gap-3">
                    <button onclick="UI.closeChat()" class="md:hidden p-2 -ml-2 text-gray-400 hover:text-white transition rounded-full hover:bg-white/5"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                    <div id="header-avatar" class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold cursor-pointer overflow-hidden relative border border-gray-600" onclick="UI.toggleModal('modal-info')">
                        <span id="header-avatar-txt">?</span>
                        <img id="header-avatar-img" class="w-full h-full object-cover hidden">
                    </div>
                    <div class="cursor-pointer flex flex-col justify-center h-full" onclick="UI.toggleModal('modal-info')">
                        <h2 id="header-title" class="font-bold text-gray-100 leading-tight text-[15px] hover:underline decoration-gray-500">Laden...</h2>
                        <p id="header-status" class="text-[11px] text-gray-400 truncate max-w-[200px] transition-colors">...</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="Chat.initSearch()" class="p-2.5 text-gray-400 hover:bg-gray-700/50 rounded-full transition hidden sm:block" title="Im Chat suchen"><i data-lucide="search" class="w-5 h-5"></i></button>
                    <button onclick="Call.start()" class="p-2.5 text-[#00a884] bg-[#00a884]/10 hover:bg-[#00a884]/20 rounded-full transition shadow-sm border border-[#00a884]/20" title="Audio Anruf"><i data-lucide="phone" class="w-5 h-5 fill-current"></i></button>
                    <button onclick="UI.toggleModal('modal-info')" class="p-2.5 text-gray-400 hover:bg-gray-700/50 rounded-full transition"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                </div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:px-12 space-y-1 relative z-10 custom-scrollbar flex flex-col scroll-smooth">
                <div class="flex justify-center my-4 opacity-0 animate-fade-in" style="animation-delay: 0.5s">
                    <div class="bg-[#182229] text-[#e9edef] text-[10px] px-3 py-1.5 rounded-lg shadow-sm border border-gray-800 flex items-center gap-2 select-none">
                        <i data-lucide="lock" class="w-3 h-3 text-[#ffd279] fill-current"></i>
                        Nachrichten sind Ende-zu-Ende verschlüsselt. Niemand außerhalb dieses Chats kann sie lesen.
                    </div>
                </div>
                </div>

            <button id="scroll-btn" onclick="UI.scrollToBottom(true)" class="absolute bottom-24 right-6 z-40 bg-[#202c33] text-[#00a884] p-3 rounded-full shadow-lg scale-0 transition-all duration-200 hover:bg-[#2a3942] border border-gray-700 hover:shadow-xl">
                <i data-lucide="chevron-down" class="w-5 h-5"></i>
                <span class="absolute top-0 right-0 w-3 h-3 bg-[#00a884] rounded-full border border-[#202c33] hidden" id="scroll-badge"></span>
            </button>

            <footer id="chat-footer" class="min-h-[62px] bg-[#202c33] px-3 py-2 flex flex-col z-20 relative border-t border-gray-800/50 shadow-[0_-2px_10px_rgba(0,0,0,0.2)]">
                
                <div id="reply-preview" class="hidden bg-[#0b141a]/90 p-2 rounded-lg mb-2 border-l-4 border-[#00a884] flex justify-between items-center mx-1 animate-slide-up backdrop-blur-sm shadow-lg relative overflow-hidden">
                    <div class="absolute inset-0 bg-[#00a884]/5 pointer-events-none"></div>
                    <div class="overflow-hidden relative z-10 pl-1">
                        <div class="text-[#00a884] text-xs font-bold mb-0.5" id="reply-to-name">Name</div>
                        <div class="text-gray-400 text-xs truncate font-mono" id="reply-to-text">Nachricht...</div>
                    </div>
                    <button onclick="Chat.cancelReply()" class="p-1 hover:bg-gray-700 rounded-full z-10"><i data-lucide="x" class="w-4 h-4 text-gray-400"></i></button>
                </div>

                <div id="image-preview" class="hidden p-4 bg-[#111b21] border-t border-gray-700 absolute bottom-full left-0 w-full z-10 shadow-2xl animate-slide-up">
                    <div class="relative inline-block group">
                        <img id="img-preview-src" class="h-40 rounded-lg border-2 border-[#00a884] shadow-lg object-contain bg-black/50">
                        <button onclick="Chat.clearImage()" class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1.5 shadow-md hover:scale-110 transition border-2 border-[#111b21]"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-1 rounded" id="img-size-tag">0 KB</div>
                    </div>
                    <div class="mt-2 text-xs text-gray-400">Bild wird vor dem Senden komprimiert.</div>
                </div>

                <div class="flex items-end gap-2 px-1 relative">
                    <button onclick="UI.toggleEmojiPicker()" class="p-3 text-gray-400 hover:text-gray-200 transition rounded-full hover:bg-gray-700/30 mb-1 active:scale-90">
                        <i data-lucide="smile" class="w-6 h-6 transition-transform" id="emoji-btn-icon"></i>
                    </button>
                    
                    <button onclick="document.getElementById('file-input').click()" class="p-3 text-gray-400 hover:text-gray-200 transition rounded-full hover:bg-gray-700/30 mb-1 active:scale-90 rotate-45 hover:rotate-0 duration-300">
                        <i data-lucide="paperclip" class="w-6 h-6"></i>
                    </button>
                    <input type="file" id="file-input" class="hidden" accept="image/*,video/*,audio/*" onchange="Chat.handleFileSelect()">

                    <div class="flex-1 bg-[#2a3942] rounded-2xl flex items-center px-4 py-2 mb-1 border border-transparent focus-within:border-[#00a884]/50 focus-within:bg-[#2a3942]/80 transition-all shadow-inner">
                        <textarea id="msg-input" placeholder="Nachricht schreiben..." class="w-full bg-transparent outline-none text-white text-[15px] resize-none max-h-[120px] custom-scrollbar placeholder-gray-500 font-sans leading-relaxed" rows="1" oninput="Chat.adjustHeight(this); Chat.handleTyping();" onkeydown="Chat.handleEnter(event)"></textarea>
                    </div>

                    <div class="relative w-12 h-12 mb-1 flex items-center justify-center shrink-0">
                        <button id="btn-mic" onmousedown="Voice.start()" onmouseup="Voice.stop()" ontouchstart="Voice.start()" ontouchend="Voice.stop()" class="absolute inset-0 bg-[#00a884] hover:bg-[#008f6f] text-white rounded-full shadow-lg flex items-center justify-center transition-all z-10 active:scale-110 hover:shadow-green-500/20">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>
                        <button id="btn-send" onclick="Chat.send()" class="absolute inset-0 bg-[#00a884] hover:bg-[#008f6f] text-white rounded-full shadow-lg flex items-center justify-center transition-all z-20 hidden transform scale-0 hover:rotate-12">
                            <i data-lucide="send-horizontal" class="w-5 h-5 ml-0.5"></i>
                        </button>
                    </div>
                </div>

                <div id="recording-ui" class="hidden absolute top-0 left-0 w-full h-full bg-[#202c33] flex items-center justify-between px-6 z-30 animate-pulse-rec border-t border-red-500/50 shadow-[0_-5px_15px_rgba(239,68,68,0.2)]">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-ping"></div>
                        <span class="text-red-500 font-bold tracking-wider text-sm font-mono" id="rec-timer">00:00</span>
                    </div>
                    <span class="text-gray-400 text-xs uppercase tracking-widest animate-pulse">Loslassen zum Senden</span>
                </div>
            </footer>
        </div>
    </main>

    <div id="call-overlay" class="hidden fixed inset-0 z-[200] call-bg text-white flex flex-col items-center justify-between py-12 px-6 transition-opacity duration-500">
        <div class="text-center mt-10 w-full relative">
            <div class="flex items-center justify-center gap-2 text-[10px] font-bold text-[#00a884] bg-black/40 px-3 py-1 rounded-full w-fit mx-auto mb-10 backdrop-blur border border-white/5">
                <i data-lucide="lock" class="w-3 h-3"></i> Ende-zu-Ende verschlüsselt
            </div>
            
            <div class="relative w-48 h-48 mx-auto mb-8">
                <div class="ripple"></div><div class="ripple"></div><div class="ripple"></div>
                <div id="call-avatar" class="w-full h-full rounded-full bg-gray-700 flex items-center justify-center text-7xl font-bold shadow-2xl relative z-10 border-4 border-white/10 bg-cover bg-center">
                    <span>?</span>
                </div>
            </div>
            
            <h2 id="call-name" class="text-4xl font-bold mb-3 tracking-tight drop-shadow-lg">Unbekannt</h2>
            <p id="call-status" class="text-lg text-gray-300 font-medium animate-pulse">Verbinden...</p>
        </div>

        <canvas id="call-canvas" class="w-full h-24 my-4 opacity-50"></canvas>

        <div id="call-controls-active" class="hidden w-full max-w-sm grid grid-cols-4 gap-4 mb-8 animate-slide-up px-4">
            <button onclick="Call.toggleMute()" id="btn-mute" class="flex flex-col items-center gap-2 group">
                <div class="w-14 h-14 rounded-full bg-white/10 backdrop-blur flex items-center justify-center group-hover:bg-white/20 transition shadow-lg border border-white/5"><i data-lucide="mic" class="w-6 h-6"></i></div>
            </button>
            <button class="flex flex-col items-center gap-2 opacity-50 cursor-not-allowed">
                 <div class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center"><i data-lucide="video" class="w-6 h-6"></i></div>
            </button>
             <button class="flex flex-col items-center gap-2 opacity-50 cursor-not-allowed">
                 <div class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center"><i data-lucide="users" class="w-6 h-6"></i></div>
            </button>
            <button onclick="Call.end()" class="flex flex-col items-center gap-2">
                <div class="w-14 h-14 rounded-full bg-red-500 shadow-xl flex items-center justify-center hover:scale-110 transition border border-red-400"><i data-lucide="phone-off" class="w-6 h-6 fill-current"></i></div>
            </button>
        </div>

        <div id="call-controls-incoming" class="hidden w-full max-w-sm flex justify-around items-center mb-16 animate-slide-up relative">
            <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 text-sm text-gray-400 animate-bounce">Nach oben streichen zum Annehmen</div>
            
            <div class="flex flex-col items-center gap-3">
                <button onclick="Call.end()" class="w-16 h-16 rounded-full bg-red-500/90 flex items-center justify-center hover:scale-110 transition shadow-lg backdrop-blur"><i data-lucide="phone-off" class="w-8 h-8 fill-current"></i></button>
                <span class="text-sm font-bold uppercase tracking-wider text-red-400">Ablehnen</span>
            </div>
            <div class="flex flex-col items-center gap-3">
                <button onclick="Call.answer()" class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center hover:scale-110 transition shadow-[0_0_30px_rgba(34,197,94,0.6)] animate-pulse"><i data-lucide="phone" class="w-8 h-8 fill-current"></i></button>
                <span class="text-sm font-bold uppercase tracking-wider text-green-400">Annehmen</span>
            </div>
        </div>
    </div>

    <div id="modal-new-group" class="hidden fixed inset-0 z-[100] glass-panel bg-black/80 flex items-center justify-center p-4">
        <div class="bg-[#202c33] w-full max-w-sm rounded-2xl p-0 shadow-2xl border border-gray-700 animate-pop overflow-hidden">
            <div class="bg-[#2a3942] p-4 border-b border-gray-700 flex justify-between items-center">
                 <h3 class="text-lg font-black text-white">Neue Gruppe</h3>
                 <button onclick="UI.toggleModal('modal-new-group')"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div class="flex justify-center">
                    <div class="w-20 h-20 rounded-full bg-[#111b21] border-2 border-dashed border-gray-600 flex items-center justify-center cursor-pointer hover:border-[#00a884] transition">
                        <i data-lucide="camera" class="w-8 h-8 text-gray-500"></i>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-[#00a884] ml-1">Gruppenname</label>
                    <input id="ng-name" type="text" class="w-full bg-[#111b21] p-3 rounded-lg text-white outline-none focus:ring-1 ring-[#00a884] border border-gray-700 transition" placeholder="z.B. Avengers">
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500 ml-1">Sicherheitscode (Optional)</label>
                    <input id="ng-pass" type="password" class="w-full bg-[#111b21] p-3 rounded-lg text-white outline-none border border-gray-700 focus:border-[#00a884] transition" placeholder="Geheim...">
                </div>
            </div>
            <div class="p-4 bg-[#111b21] flex justify-end">
                <button onclick="Chat.createGroup()" class="bg-[#00a884] px-6 py-2.5 rounded-full text-white font-bold hover:bg-[#008f6f] shadow-lg flex items-center gap-2 text-sm transition transform hover:scale-105">
                    <span>Erstellen</span> <i data-lucide="check" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="modal-join-group" class="hidden fixed inset-0 z-[100] glass-panel bg-black/80 flex items-center justify-center p-4">
        <div class="bg-[#202c33] w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700 animate-pop relative">
            <button onclick="UI.toggleModal('modal-join-group')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-[#00a884]/10 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="qr-code" class="w-8 h-8 text-[#00a884]"></i>
                </div>
                <h3 class="text-xl font-black text-white">Beitreten</h3>
                <p class="text-xs text-gray-500 mt-1">Gib die Invite-ID ein</p>
            </div>
            <div class="space-y-4">
                <input id="jg-id" type="text" class="w-full bg-[#111b21] p-4 rounded-xl text-white outline-none font-mono uppercase text-center tracking-[0.2em] border-2 border-gray-700 focus:border-[#00a884] transition text-lg" placeholder="GRP-XXXX">
                <input id="jg-pass" type="password" class="w-full bg-[#111b21] p-3 rounded-xl text-white outline-none text-center border border-gray-700 text-sm" placeholder="Passwort (falls nötig)">
            </div>
            <button onclick="Chat.joinGroup()" class="w-full mt-6 bg-[#00a884] py-3 rounded-xl text-white font-bold hover:bg-[#008f6f] shadow-lg transition">JETZT BEITRETEN</button>
        </div>
    </div>

    <div id="modal-info" class="hidden fixed inset-0 z-[100] glass-panel bg-black/70 flex justify-end">
        <div class="bg-[#111b21] w-full md:w-[400px] h-full shadow-2xl border-l border-gray-700 animate-slide-left flex flex-col">
            <div class="h-[60px] bg-[#202c33] flex items-center gap-4 px-4 border-b border-gray-800 shrink-0">
                <button onclick="UI.toggleModal('modal-info')" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                <span class="font-bold text-lg">Kontaktinfo</span>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="flex flex-col items-center py-8 bg-[#202c33] border-b border-gray-800 mb-2">
                    <div id="info-avatar-lg" class="w-32 h-32 rounded-full bg-gray-700 mb-4 flex items-center justify-center text-5xl font-bold shadow-lg border-4 border-[#111b21]">?</div>
                    <h2 id="info-title" class="text-2xl font-bold text-white text-center px-4">Name</h2>
                    <p id="info-id" class="text-xs font-mono text-[#00a884] bg-[#00a884]/10 px-2 py-0.5 rounded cursor-pointer select-all mt-2 hover:bg-[#00a884]/20 transition" onclick="Utils.copyToClipboard(this.innerText)">ID: ---</p>
                </div>

                <div class="bg-[#202c33] p-4 mb-2 shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-400 text-sm font-medium">Medien, Links und Doks</span>
                        <span class="text-gray-500 text-xs">0 ></span>
                    </div>
                    <div class="flex gap-2 overflow-hidden">
                        <div class="w-20 h-20 bg-[#111b21] rounded-lg flex items-center justify-center text-gray-600 text-xs">Leer</div>
                        <div class="w-20 h-20 bg-[#111b21] rounded-lg flex items-center justify-center text-gray-600 text-xs">Leer</div>
                        <div class="w-20 h-20 bg-[#111b21] rounded-lg flex items-center justify-center text-gray-600 text-xs">Leer</div>
                    </div>
                </div>

                <div class="bg-[#202c33] p-4 mb-2 shadow-sm space-y-4">
                    <div class="flex items-center gap-4 text-gray-300">
                        <i data-lucide="bell" class="w-5 h-5 text-gray-400"></i>
                        <div class="flex-1 border-b border-gray-700 pb-3">
                            <div class="flex justify-between">
                                <span class="text-sm">Benachrichtigungen stummschalten</span>
                                <input type="checkbox" class="accent-[#00a884]">
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 text-gray-300">
                        <i data-lucide="lock" class="w-5 h-5 text-gray-400"></i>
                        <div class="flex-1">
                            <span class="text-sm block">Verschlüsselung</span>
                            <span class="text-xs text-gray-500">Nachrichten und Anrufe sind Ende-zu-Ende verschlüsselt.</span>
                        </div>
                    </div>
                </div>

                <div id="info-group-section" class="bg-[#202c33] p-4 mb-2 shadow-sm hidden">
                    <span class="text-gray-400 text-sm font-medium block mb-3" id="member-count-label">Teilnehmer</span>
                    <div id="info-members" class="space-y-1">
                        </div>
                </div>

                <div class="bg-[#202c33] p-4 shadow-sm text-red-500 font-medium text-sm space-y-4 cursor-pointer">
                    <div onclick="Chat.blockUser()" class="flex items-center gap-3 hover:bg-red-500/5 p-2 rounded transition">
                        <i data-lucide="ban" class="w-5 h-5"></i> <span id="block-text">Blockieren</span>
                    </div>
                    <div onclick="Chat.leaveChat()" class="flex items-center gap-3 hover:bg-red-500/5 p-2 rounded transition">
                        <i data-lucide="log-out" class="w-5 h-5"></i> <span id="leave-text">Chat verlassen</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase (Modular V9)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, limit, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- KONFIGURATION (HIER EINFÜGEN) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        const IMGBB_KEY = "YOUR_IMGBB_KEY"; // Optional: Free Image Hosting Key

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Offline Persistence
        try { enableIndexedDbPersistence(db).catch(err => console.log("Persistence Error", err)); } catch(e){}

        // --- CONSTANTS & DATA ---
        const EMOJIS = {
            recent: ['😂','❤️','👍','🔥','😊','🥺','🤔','✅'],
            smileys: ['😀','😃','😄','😁','😆','😅','🤣','😂','🙂','🙃','😉','😊','😇','🥰','😍','🤩','😘','😗','😚','😙','😋','😛','😜','🤪','😝','🤑','🤗','🤭','🤫','🤔','🤐','🤨','😐','😑','😶','😏','unamused','🙄','😬','🤥','😌','😔','😪','🤤','sleep','😷','🤒','🤕','🤢','🤮','🤧','🥵','🥶','🥴','😵','🤯','🤠','🥳','😎','🤓','🧐','😕','😟','🙁','☹️','😮','😯','😲','😳','🥺','😦','😧','😨','😰','😥','😢','😭','😱','😖','😣','😞','😓','😩','😫','🥱','😤','😡','😠','🤬','😈','👿','💀','☠️','💩','🤡','👹','👺','👻','👽','👾','🤖'],
            animals: ['🐶','🐱','🐭','🐹','🐰','🦊','🐻','🐼','🐨','🐯','🦁','🐮','🐷','🐸','🐵','🐔','🐧','🐦','🐤','🦆','🦅','🦉','🦇','🐺','🐗','🐴','🦄','🐝','🐛','🦋','🐌','🐞','🐜','🦟','🦗','🕷','🕸','🐢','🐍','🦎','🦂','🦀','🦑','🐙','🦐','🦞','🐠','🐟','🐬','🐳','🐋','🦈','🐊','🐅','🐆','🦓','🦍','🦧','🐘','🦛','🦏','🐪','🐫','🦒','🦘','🐃','🐂','🐄','🐎','🐖','🐏','🐑','🦙','🐐','🦌','🐕','🐩','🦮','🐕‍🦺','🐈','🐓','🦃','🦚','🦜','🦢','🦩','🕊','🐇','🦝','🦨','🦡','🦦','🦥','🐁','🐀','🐿','🦔','🐾','🐉','🐲'],
            objects: ['⌚','📱','📲','💻','⌨️','🖥','🖨','🖱','🖲','🕹','🗜','💽','💾','💿','📀','📼','📷','📸','📹','🎥','📽','🎞','📞','☎️','📟','📠','📺','📻','🎙','🎚','🎛','🧭','⏱','⏲','⏰','🕰','⌛','⏳','📡','🔋','🔌','💡','🔦','🕯','🪔','🧯','🛢','💸','💵','💴','💶','💷','💰','💳','💎','⚖️','🧰','🔧','🔨','⚒','🛠','⛏','🪓','🔩','⚙️','🧱','⛓','🧲','🔫','💣','🧨','🪓','🔪','🗡','⚔️','🛡','🚬','⚰️','⚱️','🏺','🔮','📿','🧿','💈','⚗️','🔭','🔬','🕳','💊','💉','🩸','🧬','🩹','🩺','🌡','🧹','🧺','🧻','🚽','🚰','🚿','🛁','🛀','🧼','🪒','🧽','🧴','🛎','🔑','🗝','🚪','🪑','🛋','🛏','🛌','🧸','🖼','🛍','🛒','🎁','🎈','🎏','🎀','🎊','🎉','🎎','🏮','🎐','🧧','✉️','📩','📨','📧','💌','📥','📤','📦','🏷','📪','📫','📬','📭','📮','📯','📜','📃','📄','📑','🧾','📊','📈','📉','🗒','🗓','📆','📅','🗑','📇','🗃','🗳','🗄','📋','📁','📂','🗂','🗞','📰','📓','📔','📒','📕','📗','📘','📙','📚','📖','🔖','🧷','🔗','📎','🖇','📐','📏','🧮','📌','📍','✂️','🖊','🖋','✒️','🖌','🖍','📝','✏️','🔍','🔎','🔏','🔐','🔒','🔓']
        };

        // --- STATE STORE (Mini-Redux) ---
        const Store = {
            state: {
                user: null,
                uid: null,
                nick: "Gast",
                activeChat: null,
                chatData: {}, // Cache chat details
                isPrivate: false,
                theme: 'dark',
                soundEnabled: true,
                notifyEnabled: true,
                replyTarget: null,
                adminTarget: null,
                typingTimer: null,
                voiceChunks: [],
                listeners: {},
                call: {
                    active: false,
                    id: null,
                    pc: null,
                    stream: null,
                    remoteStream: null
                }
            },
            
            // Basic Action Dispatcher
            dispatch(action, payload) {
                switch(action) {
                    case 'SET_USER': 
                        this.state.user = payload; 
                        this.state.uid = payload.uid;
                        break;
                    case 'SET_ACTIVE_CHAT':
                        this.state.activeChat = payload.id;
                        this.state.isPrivate = payload.isPrivate;
                        break;
                    case 'UPDATE_SETTINGS':
                        Object.assign(this.state, payload);
                        break;
                }
            }
        };

        // --- UTILITIES & CRYPTO ---
        class Utils {
            static generateId() { return Math.random().toString(36).substr(2, 9); }
            
            static formatTime(timestamp) {
                if (!timestamp) return '';
                const d = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const isToday = d.toDateString() === now.toDateString();
                
                if (isToday) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                if (now.getTime() - d.getTime() < 86400000 * 6) return d.toLocaleDateString([], { weekday: 'short' });
                return d.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: '2-digit' });
            }

            static copyToClipboard(text) {
                navigator.clipboard.writeText(text);
                UI.showToast("In Zwischenablage kopiert", 'info');
            }

            // Simulierter E2E Encryption Layer (XOR Cipher für Demo-Zwecke)
            // In Production würde man WebCrypto API nutzen.
            static encrypt(text) {
                if(!text) return "";
                const key = "SHADOW_TITAN_KEY";
                let res = "";
                for(let i=0; i<text.length; i++) {
                    res += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return btoa(res); // Base64 encoding
            }

            static decrypt(encoded) {
                try {
                    const text = atob(encoded);
                    const key = "SHADOW_TITAN_KEY";
                    let res = "";
                    for(let i=0; i<text.length; i++) {
                        res += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                    }
                    return res;
                } catch(e) { return "**Verschlüsselungsfehler**"; }
            }

            static async compressImage(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_WIDTH = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); // 70% Quality
                        };
                    };
                });
            }
        }

        // --- UI MANAGER ---
        class UI {
            static showToast(msg, type = 'success') {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                const icons = { success: 'check-circle', error: 'alert-triangle', info: 'info', warning: 'alert-octagon' };
                t.innerHTML = `<i data-lucide="${icons[type]}" class="w-5 h-5 shrink-0"></i><span>${msg}</span>`;
                c.appendChild(t);
                lucide.createIcons();
                
                // Sound
                if(type === 'error') Utils.playSound('sound-connect'); 

                setTimeout(() => { 
                    t.style.opacity = '0'; 
                    t.style.transform = 'translateY(-20px) scale(0.9)'; 
                    setTimeout(() => t.remove(), 300); 
                }, 3500);
            }

            static switchTab(tab) {
                document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
                
                // Reset Tab Buttons
                ['chats','calls','status'].forEach(t => {
                    const btn = document.getElementById(`tab-btn-${t}`);
                    if(btn) {
                        btn.classList.remove('text-[#00a884]', 'border-[#00a884]');
                        btn.classList.add('text-gray-500', 'border-transparent');
                    }
                });

                document.getElementById(`view-${tab}`).classList.remove('hidden');
                
                // Activate Button if exists
                const btn = document.getElementById(`tab-btn-${tab}`);
                if(btn) {
                    btn.classList.remove('text-gray-500', 'border-transparent');
                    btn.classList.add('text-[#00a884]', 'border-[#00a884]');
                }

                // Animation reset
                const view = document.getElementById(`view-${tab}`);
                view.classList.remove('animate-fade-in');
                void view.offsetWidth; // Trigger Reflow
                view.classList.add('animate-fade-in');
            }

            static toggleModal(id) {
                const el = document.getElementById(id);
                if(el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    // Reset inputs logic
                    el.querySelectorAll('input').forEach(i => i.value = '');
                } else {
                    el.classList.add('hidden');
                }
            }

            static openLightbox(src, caption) {
                const lb = document.getElementById('lightbox');
                const img = document.getElementById('lightbox-img');
                img.src = src;
                document.getElementById('lightbox-caption').innerText = caption || "";
                document.getElementById('lightbox-info').innerText = new Date().toLocaleDateString();
                lb.classList.remove('hidden');
                requestAnimationFrame(() => lb.classList.remove('opacity-0'));
            }

            static closeLightbox() {
                const lb = document.getElementById('lightbox');
                lb.classList.add('opacity-0');
                setTimeout(() => lb.classList.add('hidden'), 300);
            }

            static toggleEmojiPicker() {
                const el = document.getElementById('modal-emoji');
                if(el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    this.filterEmojis('recent'); // Load default
                } else {
                    el.classList.add('hidden');
                }
            }

            static filterEmojis(category) {
                const c = document.getElementById('emoji-container');
                c.innerHTML = "";
                const list = EMOJIS[category] || EMOJIS['smileys'];
                list.forEach(e => {
                    const s = document.createElement('div');
                    s.className = "emoji-item";
                    s.innerText = e;
                    s.onclick = () => {
                        const inp = document.getElementById('msg-input');
                        inp.value += e;
                        Chat.adjustHeight(inp);
                    };
                    c.appendChild(s);
                });
            }
            
            static filterList(type) {
                // Implementation for filtering sidebar list visual
                document.querySelectorAll('#chat-list > div').forEach(el => {
                    if(type === 'all') el.style.display = 'flex';
                    // More logic would go here based on data attributes
                });
                // Visual update of chips
                const chips = document.querySelectorAll('.active-filter');
                chips.forEach(c => {
                    c.classList.remove('text-[#00a884]', 'border-[#00a884]');
                    c.classList.add('text-gray-400');
                });
            }

            static scrollToBottom(smooth = false) {
                const c = document.getElementById('messages-container');
                const badge = document.getElementById('scroll-badge');
                c.scrollTo({ top: c.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
                document.getElementById('scroll-btn').classList.add('scale-0');
                badge.classList.add('hidden');
            }

            static closeChat() {
                document.getElementById('active-chat-interface').classList.add('hidden');
                document.getElementById('chat-placeholder').classList.remove('hidden');
                if(window.innerWidth < 768) {
                    document.getElementById('main-chat').classList.add('hidden');
                    document.getElementById('sidebar').classList.remove('hidden');
                }
                Store.dispatch('SET_ACTIVE_CHAT', { id: null });
                if(Store.state.listeners.msg) Store.state.listeners.msg(); // Unsub
            }
        }

        // --- AUTH & PROFILE SYSTEM ---
        class Auth {
            static async init() {
                // Check local settings
                const snd = localStorage.getItem('shadow_sound');
                const not = localStorage.getItem('shadow_notify');
                Store.dispatch('UPDATE_SETTINGS', { 
                    soundEnabled: snd !== 'false', 
                    notifyEnabled: not !== 'false' 
                });
                
                document.getElementById('toggle-sound').checked = Store.state.soundEnabled;
                document.getElementById('toggle-notify').checked = Store.state.notifyEnabled;

                const storedUid = localStorage.getItem('shadow_uid');
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        const finalUid = storedUid || u.uid;
                        localStorage.setItem('shadow_uid', finalUid);
                        Store.dispatch('SET_USER', { ...u, uid: finalUid });
                        
                        document.getElementById('loader-overlay').classList.add('opacity-0');
                        setTimeout(() => document.getElementById('loader-overlay').remove(), 500);

                        await this.syncProfile();
                        this.setupPresence();
                        Chat.initList();
                        Chat.initGlobalStatus();
                        Call.initListener();
                    }
                });

                // Network listeners
                window.addEventListener('offline', () => document.getElementById('offline-banner').classList.remove('hidden'));
                window.addEventListener('online', () => document.getElementById('offline-banner').classList.add('hidden'));
            }

            static async syncProfile() {
                const ref = doc(db, "users", Store.state.uid);
                const snap = await getDoc(ref);
                
                if (!snap.exists()) {
                    const rnd = Math.floor(Math.random() * 9999);
                    const def = { 
                        uid: Store.state.uid, 
                        nickname: `Agent-${rnd}`, 
                        bio: "Using ShadowChat Titan", 
                        online: true, 
                        lastSeen: serverTimestamp(),
                        settings: { theme: 'dark' }
                    };
                    await setDoc(ref, def);
                    Store.state.nick = def.nickname;
                } else {
                    const d = snap.data();
                    Store.state.nick = d.nickname;
                    document.getElementById('input-nick').value = d.nickname;
                    document.getElementById('input-bio').value = d.bio || "";
                    document.getElementById('settings-id').innerText = "ID: " + Store.state.uid;
                }
                this.updateUI();
            }

            static updateUI() {
                document.querySelectorAll('#my-nick-display, #settings-nick').forEach(e => e.innerText = Store.state.nick);
                document.getElementById('my-avatar').innerText = Store.state.nick.substring(0,2).toUpperCase();
                document.getElementById('settings-avatar-text').innerText = Store.state.nick.substring(0,2).toUpperCase();
            }

            static setupPresence() {
                // Realtime presence update
                const ref = doc(db, "users", Store.state.uid);
                const update = (st) => updateDoc(ref, { online: st, lastSeen: serverTimestamp() });
                
                update(true);
                document.addEventListener('visibilitychange', () => update(document.visibilityState === 'visible'));
                window.addEventListener('beforeunload', () => update(false));
                setInterval(() => update(true), 60000); // Heartbeat
            }

            static async updateProfile() {
                const n = document.getElementById('input-nick').value.trim();
                const b = document.getElementById('input-bio').value.trim();
                if(n) {
                    await updateDoc(doc(db, "users", Store.state.uid), { nickname: n, bio: b });
                    Store.state.nick = n;
                    this.updateUI();
                    UI.showToast("Profil aktualisiert");
                }
            }

            static async logout() {
                if(confirm("Abmelden? Lokale Daten werden gelöscht.")) {
                    localStorage.clear();
                    location.reload();
                }
            }

            static async deleteAccount() {
                if(prompt("Tippe 'DELETE' zum Bestätigen:") === 'DELETE') {
                    await deleteDoc(doc(db, "users", Store.state.uid));
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // --- CHAT LOGIC ---
        class Chat {
            static initList() {
                // Query: Active chats sorted by date
                const q = query(collection(db, "chats"), orderBy("lastActivity", "desc"), limit(50));
                
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('chat-list');
                    list.innerHTML = "";
                    
                    if(snap.empty) {
                        list.innerHTML = `<div class="p-8 text-center text-gray-500 text-xs">Keine Chats vorhanden.</div>`;
                        return;
                    }

                    snap.forEach(d => {
                        const c = d.data();
                        const isMember = c.type === 'group' ? c.members?.includes(Store.state.uid) : c.participants?.includes(Store.state.uid);
                        
                        if (isMember) {
                            let name = c.name;
                            let avatar = name ? name[0] : '?';
                            
                            // Resolve Private Names
                            if (c.type === 'private') {
                                const otherId = c.participants.find(id => id !== Store.state.uid);
                                name = c.names?.[otherId] || "Unbekannt";
                                avatar = name[0];
                            }

                            const isActive = Store.state.activeChat === d.id;
                            
                            // Check Typing
                            const typing = c.typing && Object.entries(c.typing).some(([k,v]) => k !== Store.state.uid && v);
                            const msgPrev = typing ? '<span class="text-[#00a884] font-bold">schreibt...</span>' : (Utils.decrypt(c.lastMessage) || 'Start');

                            // Unread Count Logic (Pseudo)
                            const isUnread = c.lastSender !== Store.state.uid && (!c.readBy || !c.readBy.includes(Store.state.uid));
                            
                            const div = document.createElement('div');
                            div.className = `flex items-center gap-4 p-3.5 cursor-pointer hover:bg-[#202c33] transition group ${isActive ? 'bg-[#2a3942]' : ''}`;
                            div.innerHTML = `
                                <div class="w-12 h-12 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-lg shadow-sm shrink-0 relative overflow-hidden">
                                    ${c.img ? `<img src="${c.img}" class="w-full h-full object-cover">` : `<span>${avatar}</span>`}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <h4 class="font-bold text-gray-100 truncate text-[15px]">${name}</h4>
                                        <span class="text-[11px] ${isUnread ? 'text-[#00a884] font-bold' : 'text-gray-500'}">${Utils.formatTime(c.lastActivity)}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <p class="text-xs ${isUnread ? 'text-gray-100 font-medium' : 'text-gray-400'} truncate flex items-center gap-1 max-w-[80%]">
                                            ${c.lastSender === Store.state.uid ? '<i data-lucide="check-check" class="w-3 h-3 text-blue-400"></i>' : ''}
                                            ${msgPrev}
                                        </p>
                                        ${isUnread ? '<div class="w-5 h-5 bg-[#00a884] rounded-full flex items-center justify-center text-[10px] text-[#111b21] font-bold shadow">1</div>' : ''}
                                    </div>
                                </div>`;
                            div.onclick = () => this.open(d.id, name, c.type === 'private');
                            list.appendChild(div);
                        }
                    });
                    lucide.createIcons();
                });
            }

            static async open(id, name, isPrivate) {
                Store.dispatch('SET_ACTIVE_CHAT', { id, isPrivate });
                
                // UI Switch
                if(window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                    document.getElementById('main-chat').classList.remove('hidden');
                }
                document.getElementById('chat-placeholder').classList.add('hidden');
                document.getElementById('active-chat-interface').classList.remove('hidden');

                // Header Setup
                document.getElementById('header-title').innerText = name;
                document.getElementById('header-avatar-txt').innerText = name[0];
                document.getElementById('messages-container').innerHTML = ""; // Clear
                
                this.updateInfo(id, isPrivate);

                // Listen for Chat Metadata (Typing, Online)
                onSnapshot(doc(db, "chats", id), (s) => {
                    const d = s.data();
                    if(!d) return;
                    
                    const statusEl = document.getElementById('header-status');
                    
                    // Typing Logic
                    const typers = d.typing ? Object.entries(d.typing).filter(([u, t]) => u !== Store.state.uid && t).map(x => x[0]) : [];
                    if(typers.length > 0) {
                        statusEl.innerHTML = '<span class="text-[#00a884] font-bold animate-pulse">schreibt...</span>';
                    } else if (isPrivate) {
                        // Check partner status
                        const pid = d.participants.find(p => p !== Store.state.uid);
                        getDoc(doc(db, "users", pid)).then(u => {
                            if(u.exists()) {
                                const on = u.data().online;
                                statusEl.innerText = on ? "Online" : `Zuletzt gesehen ${Utils.formatTime(u.data().lastSeen)}`;
                            }
                        });
                    } else {
                        statusEl.innerText = `${d.members?.length || 0} Mitglieder`;
                    }
                });

                // Message Listener
                if(Store.state.listeners.msg) Store.state.listeners.msg();
                
                const q = query(collection(db, `chats/${id}/messages`), orderBy("timestamp", "asc"), limit(100));
                
                Store.state.listeners.msg = onSnapshot(q, (snap) => {
                    const cont = document.getElementById('messages-container');
                    const isNearBottom = (cont.scrollHeight - cont.scrollTop - cont.clientHeight) < 200;
                    
                    // Mark Read Logic
                    const batch = writeBatch(db);
                    let needsCommit = false;

                    snap.docChanges().forEach(change => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            this.renderMessage(change.doc.id, data, cont);
                            
                            // Auto-scroll on own message
                            if (data.senderId === Store.state.uid) UI.scrollToBottom(true);
                            
                            // Mark as read
                            if (data.senderId !== Store.state.uid && (!data.readBy || !data.readBy.includes(Store.state.uid))) {
                                batch.update(change.doc.ref, { readBy: arrayUnion(Store.state.uid) });
                                needsCommit = true;
                                if(document.hidden) Utils.playSound('sound-msg-in');
                            }
                        }
                        if (change.type === "modified") {
                             // Re-render specifically for blue ticks update (optimization: update DOM only)
                             const el = document.getElementById(`msg-${change.doc.id}`);
                             if(el) {
                                 const ticks = el.querySelector('.ticks-icon');
                                 if(ticks) ticks.classList.add('text-blue-400');
                             }
                        }
                    });

                    if(needsCommit) batch.commit();

                    if(isNearBottom) UI.scrollToBottom(true);
                    else if(snap.docChanges().some(c => c.type === 'added')) {
                        // Show "New Message" badge
                        const btn = document.getElementById('scroll-btn');
                        btn.classList.remove('scale-0');
                        document.getElementById('scroll-badge').classList.remove('hidden');
                    }
                });
            }

            static renderMessage(id, m, container) {
                const isMe = m.senderId === Store.state.uid;
                const div = document.createElement('div');
                div.id = `msg-${id}`;
                div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} group mb-1.5 msg-enter relative w-full px-2`;

                // Swipe Handler
                let touchX = 0;
                div.addEventListener('touchstart', e => touchX = e.touches[0].clientX);
                div.addEventListener('touchend', e => {
                    if (e.changedTouches[0].clientX - touchX > 60) {
                        this.triggerReply(id, m.text, m.senderName);
                        if(navigator.vibrate) navigator.vibrate(20);
                    }
                });

                // Decrypt
                const plainText = Utils.decrypt(m.text);
                
                // Reply Block
                let replyHTML = "";
                if(m.replyTo) {
                    replyHTML = `
                    <div class="bg-black/20 border-l-[4px] border-[#00a884]/70 p-1.5 mb-1.5 rounded-r text-xs cursor-pointer hover:bg-black/30 transition overflow-hidden">
                        <span class="text-[#00a884] font-bold block mb-0.5">${m.replyTo.sender}</span>
                        <span class="text-gray-300 line-clamp-1 font-mono opacity-80">${Utils.decrypt(m.replyTo.text) || 'Medien'}</span>
                    </div>`;
                }

                // Media Block
                let mediaHTML = "";
                if(m.img) {
                    mediaHTML = `<div class="rounded-lg overflow-hidden mb-1 relative cursor-pointer group-img">
                        <img src="${m.img}" class="max-w-full max-h-[300px] object-cover hover:scale-[1.02] transition" onclick="UI.openLightbox('${m.img}')" loading="lazy">
                    </div>`;
                }

                // Formatting
                const time = Utils.formatTime(m.timestamp);
                const allRead = m.readBy && m.readBy.length > 1; // Simplistic
                const tickClass = allRead ? 'text-blue-400' : 'text-gray-500';

                div.innerHTML = `
                    <div class="relative max-w-[85%] md:max-w-[65%] min-w-[120px] shadow-[0_1px_2px_rgba(0,0,0,0.3)] rounded-lg p-2 ${isMe ? 'bg-[#005c4b] text-[#e9edef] rounded-tr-none' : 'bg-[#202c33] text-[#e9edef] rounded-tl-none'} transition-colors duration-200">
                        <div class="absolute inset-0 z-0" oncontextmenu="Chat.showContext(event, '${id}', '${m.senderId}')"></div>
                        
                        ${!isMe && !Store.state.isPrivate ? `<div class="text-[11px] font-bold text-orange-400 mb-1 z-10 relative cursor-pointer hover:underline" onclick="Chat.openPrivate('${m.senderId}','${m.senderName}')">${m.senderName}</div>` : ''}
                        
                        <div class="z-10 relative">
                            ${replyHTML}
                            ${mediaHTML}
                            ${plainText ? `<p class="text-[14.2px] leading-[19px] whitespace-pre-wrap selectable-text font-normal rendering-optimizeLegibility">${plainText}</p>` : ''}
                        </div>

                        <div class="flex justify-end items-center gap-1 mt-1 select-none opacity-70">
                            <span class="text-[10px] tracking-wide font-mono">${time}</span>
                            ${isMe ? `<i data-lucide="check-check" class="w-3.5 h-3.5 ${tickClass} ticks-icon"></i>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
                
                // Init icons for this specific message only (Perf)
                // lucide.createIcons({ root: div }); -> Global call is safer for now
            }

            static showContext(e, id, senderId) {
                e.preventDefault();
                const menu = document.getElementById('contextMenu');
                const items = document.getElementById('ctx-items');
                const reactions = document.getElementById('ctx-reactions');
                
                // Setup Menu
                reactions.innerHTML = ['👍','❤️','😂','😮','😢','😡'].map(emo => 
                    `<button class="hover:scale-125 transition text-xl p-1" onclick="Chat.react('${id}', '${emo}')">${emo}</button>`
                ).join('');

                const isMe = senderId === Store.state.uid;
                items.innerHTML = `
                    <button class="w-full text-left px-4 py-2 hover:bg-[#111b21] flex items-center gap-2 text-sm" onclick="Chat.triggerReply('${id}', '...', '...')"><i data-lucide="reply" class="w-4 h-4"></i> Antworten</button>
                    <button class="w-full text-left px-4 py-2 hover:bg-[#111b21] flex items-center gap-2 text-sm" onclick="Utils.copyToClipboard('Msg Content')"><i data-lucide="copy" class="w-4 h-4"></i> Kopieren</button>
                    ${isMe ? `<button class="w-full text-left px-4 py-2 hover:bg-red-900/30 text-red-400 flex items-center gap-2 text-sm" onclick="Chat.deleteMsg('${id}')"><i data-lucide="trash-2" class="w-4 h-4"></i> Löschen</button>` : ''}
                `;
                lucide.createIcons({ root: items });

                // Positioning
                let x = e.clientX;
                let y = e.clientY;
                if(x + 220 > window.innerWidth) x = window.innerWidth - 230;
                if(y + 200 > window.innerHeight) y = window.innerHeight - 210;
                
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
                menu.classList.remove('hidden');

                const closer = () => { menu.classList.add('hidden'); document.removeEventListener('click', closer); };
                setTimeout(() => document.addEventListener('click', closer), 50);
            }

            static async deleteMsg(id) {
                if(confirm("Nachricht für alle löschen?")) {
                    await deleteDoc(doc(db, `chats/${Store.state.activeChat}/messages`, id));
                }
            }

            // --- SENDING ---
            static async send() {
                const inp = document.getElementById('msg-input');
                const txt = inp.value.trim();
                const file = document.getElementById('file-input').files[0];

                if(!txt && !file) return;

                const chatId = Store.state.activeChat; // Capture ID
                
                // Optimistic UI Update (Fast Feel)
                inp.value = "";
                Chat.adjustHeight(inp);
                this.cancelReply();
                document.getElementById('btn-send').classList.add('hidden');
                document.getElementById('btn-mic').classList.remove('hidden');
                Utils.playSound('sound-msg-out');

                let imgUrl = null;
                if(file) {
                    try {
                        // Compress first
                        const compressedBase64 = await Utils.compressImage(file);
                        // Convert back to blob for upload if needed, or upload base64 directly to simple host
                        // For demo, we assume Base64 URL is fine if small, or upload to ImgBB
                        const fd = new FormData();
                        fd.append("image", file); // Uploading original for quality in this example
                        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
                        const data = await res.json();
                        imgUrl = data.data.url;
                        Chat.clearImage();
                    } catch(e) {
                        UI.showToast("Upload Fehler", 'error');
                        return;
                    }
                }

                const msg = {
                    text: Utils.encrypt(txt),
                    img: imgUrl,
                    senderId: Store.state.uid,
                    senderName: Store.state.nick,
                    timestamp: serverTimestamp(),
                    readBy: [Store.state.uid],
                    replyTo: Store.state.replyTarget
                };

                await addDoc(collection(db, `chats/${chatId}/messages`), msg);
                
                const preview = imgUrl ? '📷 Foto' : txt;
                await updateDoc(doc(db, "chats", chatId), {
                    lastActivity: serverTimestamp(),
                    lastMessage: Utils.encrypt(preview),
                    lastSender: Store.state.uid,
                    [`typing.${Store.state.uid}`]: false
                });
            }

            static handleTyping() {
                if(!Store.state.activeChat) return;
                
                // Button Toggle
                const hasText = document.getElementById('msg-input').value.trim().length > 0;
                const btnMic = document.getElementById('btn-mic');
                const btnSend = document.getElementById('btn-send');
                
                if(hasText) {
                    btnMic.classList.add('hidden', 'scale-0');
                    btnSend.classList.remove('hidden');
                    requestAnimationFrame(() => btnSend.classList.remove('scale-0'));
                } else {
                    btnSend.classList.add('scale-0');
                    setTimeout(() => btnSend.classList.add('hidden'), 200);
                    btnMic.classList.remove('hidden', 'scale-0');
                }

                // Debounced DB Update
                if(!Store.state.typingTimer) {
                    updateDoc(doc(db, "chats", Store.state.activeChat), { [`typing.${Store.state.uid}`]: true });
                    Store.state.typingTimer = setTimeout(() => {
                        updateDoc(doc(db, "chats", Store.state.activeChat), { [`typing.${Store.state.uid}`]: false });
                        Store.state.typingTimer = null;
                    }, 2500);
                }
            }
            
            static handleEnter(e) {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.send();
                }
            }

            static handleFileSelect() {
                const f = document.getElementById('file-input').files[0];
                if(f) {
                    document.getElementById('img-preview-src').src = URL.createObjectURL(f);
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('img-size-tag').innerText = (f.size / 1024).toFixed(1) + " KB";
                    
                    document.getElementById('btn-send').classList.remove('hidden', 'scale-0');
                    document.getElementById('btn-mic').classList.add('hidden');
                }
            }

            static clearImage() {
                document.getElementById('file-input').value = "";
                document.getElementById('image-preview').classList.add('hidden');
            }

            static triggerReply(id, text, sender) {
                Store.state.replyTarget = { id, text: Utils.encrypt(text), sender };
                document.getElementById('reply-preview').classList.remove('hidden');
                document.getElementById('reply-to-name').innerText = sender;
                document.getElementById('reply-to-text').innerText = text;
                document.getElementById('msg-input').focus();
            }

            static cancelReply() {
                Store.state.replyTarget = null;
                document.getElementById('reply-preview').classList.add('hidden');
            }

            static adjustHeight(el) {
                el.style.height = 'auto';
                el.style.height = Math.min(el.scrollHeight, 120) + 'px';
            }

            static createGroup() {
                const n = document.getElementById('ng-name').value;
                if(!n) return;
                
                const code = "GRP-" + Math.floor(100000 + Math.random() * 900000);
                
                setDoc(doc(db, "chats", code), {
                    id: code,
                    name: n,
                    type: 'group',
                    creator: Store.state.uid,
                    admins: [Store.state.uid],
                    members: [Store.state.uid],
                    lastActivity: serverTimestamp(),
                    lastMessage: Utils.encrypt("Gruppe erstellt")
                }).then(() => {
                    UI.toggleModal('modal-new-group');
                    UI.showToast(`Gruppe erstellt! ID: ${code}`);
                    this.open(code, n, false);
                });
            }

            static async joinGroup() {
                const id = document.getElementById('jg-id').value.toUpperCase().trim();
                if(!id) return;
                
                const ref = doc(db, "chats", id);
                const s = await getDoc(ref);
                if(s.exists() && s.data().type === 'group') {
                    await updateDoc(ref, { members: arrayUnion(Store.state.uid) });
                    UI.toggleModal('modal-join-group');
                    UI.showToast("Beigetreten!");
                    this.open(id, s.data().name, false);
                } else {
                    UI.showToast("Gruppe nicht gefunden", 'error');
                }
            }

            static async updateInfo(chatId, isPrivate) {
                const s = await getDoc(doc(db, "chats", chatId));
                const d = s.data();
                
                if(isPrivate) {
                    document.getElementById('info-group-section').classList.add('hidden');
                    document.getElementById('info-title').innerText = document.getElementById('header-title').innerText;
                } else {
                    document.getElementById('info-group-section').classList.remove('hidden');
                    document.getElementById('info-title').innerText = d.name;
                    document.getElementById('member-count-label').innerText = `${d.members.length} Teilnehmer`;
                    
                    const list = document.getElementById('info-members');
                    list.innerHTML = "";
                    
                    d.members.forEach(async mid => {
                         const u = await getDoc(doc(db, "users", mid));
                         if(u.exists()) {
                             const user = u.data();
                             const el = document.createElement('div');
                             el.className = "flex items-center gap-3 p-2 hover:bg-gray-800 rounded cursor-pointer";
                             const isAdmin = d.admins?.includes(mid);
                             el.innerHTML = `
                                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold">${user.nickname[0]}</div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-1 text-sm font-medium">
                                        ${user.nickname}
                                        ${isAdmin ? '<span class="text-[10px] bg-[#00a884]/20 text-[#00a884] px-1 rounded ml-1">ADMIN</span>' : ''}
                                    </div>
                                    <div class="text-[10px] text-gray-500">${user.bio || 'Keine Info'}</div>
                                </div>
                             `;
                             list.appendChild(el);
                         }
                    });
                }
            }
            
            static filterChats(term) {
                const val = term.toLowerCase();
                document.querySelectorAll('#chat-list > div').forEach(el => {
                    const name = el.querySelector('h4').innerText.toLowerCase();
                    el.style.display = name.includes(val) ? 'flex' : 'none';
                });
            }

            // Status Handling
            static async uploadStatus() {
                const f = document.getElementById('status-input').files[0];
                if(f) {
                    // Simpler Upload to ImgBB
                    const fd = new FormData(); fd.append("image", f);
                    try {
                        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
                        const json = await res.json();
                        await addDoc(collection(db, "status"), {
                            uid: Store.state.uid,
                            url: json.data.url,
                            timestamp: serverTimestamp()
                        });
                        UI.showToast("Status geteilt!");
                    } catch(e) { UI.showToast("Fehler beim Upload", 'error'); }
                }
            }

            static initGlobalStatus() {
                // Show status from last 24h
                const yesterday = new Date(Date.now() - 86400000);
                const q = query(collection(db, "status"), orderBy("timestamp", "desc"));
                
                onSnapshot(q, (snap) => {
                    const cont = document.getElementById('status-list');
                    cont.innerHTML = "";
                    snap.forEach(d => {
                        const s = d.data();
                        if(s.timestamp?.toDate() > yesterday) {
                            if(s.uid === Store.state.uid) {
                                document.getElementById('my-status-prev').src = s.url;
                                document.getElementById('my-status-prev').classList.remove('hidden');
                                document.getElementById('my-status-icon').classList.add('hidden');
                            } else {
                                const el = document.createElement('div');
                                el.className = "flex items-center gap-3 p-2 border border-gray-700 rounded-xl cursor-pointer hover:bg-white/5";
                                el.innerHTML = `
                                    <div class="w-10 h-10 rounded-full border-2 border-[#00a884] p-0.5"><img src="${s.url}" class="w-full h-full rounded-full object-cover"></div>
                                    <div class="font-bold text-sm text-gray-200">User ${s.uid.substr(0,4)}</div>
                                `;
                                el.onclick = () => UI.openLightbox(s.url, "Status Update");
                                cont.appendChild(el);
                            }
                        }
                    });
                });
            }
        }

        // --- VOICE & AUDIO ---
        class Voice {
            static async start() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    Store.state.voiceChunks = [];
                    Store.state.mediaRecorder = new MediaRecorder(stream);
                    
                    Store.state.mediaRecorder.ondataavailable = e => Store.state.voiceChunks.push(e.data);
                    Store.state.mediaRecorder.start();
                    
                    document.getElementById('recording-ui').classList.remove('hidden');
                    
                    // Timer UI
                    let sec = 0;
                    Store.state.recInterval = setInterval(() => {
                        sec++;
                        const m = Math.floor(sec/60);
                        const s = sec%60;
                        document.getElementById('rec-timer').innerText = `${m}:${s<10?'0'+s:s}`;
                    }, 1000);

                } catch(e) { UI.showToast("Kein Mikrofon Zugriff", 'error'); }
            }

            static stop() {
                if(Store.state.mediaRecorder && Store.state.mediaRecorder.state !== 'inactive') {
                    Store.state.mediaRecorder.stop();
                    clearInterval(Store.state.recInterval);
                    document.getElementById('recording-ui').classList.add('hidden');
                    
                    Store.state.mediaRecorder.onstop = async () => {
                        const blob = new Blob(Store.state.voiceChunks, { type: 'audio/webm' });
                        if(blob.size > 2000) { // Min size check
                            // Hier müsste Upload Logik hin (für Demo Text Placeholder)
                            const inp = document.getElementById('msg-input');
                            inp.value = "[🎤 SPRACHNACHRICHT SIMULIERT]";
                            Chat.send();
                        }
                    };
                }
            }
        }

        // --- CALL SYSTEM (WebRTC Signaling) ---
        class Call {
            static initListener() {
                // Listen for incoming calls
                const q = query(collection(db, "calls"), where("status", "==", "ringing"));
                onSnapshot(q, (snap) => {
                    snap.docChanges().forEach(c => {
                        if(c.type === 'added') {
                            const d = c.doc.data();
                            if(d.targetId === Store.state.uid || (d.isGroup && d.members.includes(Store.state.uid))) {
                                if(d.callerId !== Store.state.uid) {
                                    this.incoming(c.doc.id, d);
                                }
                            }
                        }
                    });
                });
            }

            static async start() {
                if(!Store.state.activeChat) return;
                
                const chatId = Store.state.activeChat;
                const overlay = document.getElementById('call-overlay');
                overlay.classList.remove('hidden');
                document.getElementById('call-controls-active').classList.remove('hidden');
                document.getElementById('call-controls-incoming').classList.add('hidden');
                document.getElementById('call-name').innerText = document.getElementById('header-title').innerText;
                Utils.playSound('sound-ring');

                // Init RTC
                Store.state.call.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(t => Store.state.call.pc.addTrack(t, stream));
                
                // Visualizer start
                this.visualize(stream);

                const callDoc = doc(collection(db, "calls"));
                Store.state.call.id = callDoc.id;

                Store.state.call.pc.onicecandidate = e => {
                    if(e.candidate) addDoc(collection(callDoc, 'candidates'), e.candidate.toJSON());
                };

                const offer = await Store.state.call.pc.createOffer();
                await Store.state.call.pc.setLocalDescription(offer);

                const targetId = Store.state.isPrivate 
                    ? chatId.replace(Store.state.uid, '').replace('_', '') 
                    : chatId;

                await setDoc(callDoc, {
                    callerId: Store.state.uid,
                    callerName: Store.state.nick,
                    targetId: targetId,
                    isGroup: !Store.state.isPrivate,
                    offer: { type: offer.type, sdp: offer.sdp },
                    status: 'ringing',
                    timestamp: serverTimestamp()
                });

                // Wait for answer
                onSnapshot(callDoc, async (s) => {
                    const d = s.data();
                    if(d?.answer && !Store.state.call.pc.currentRemoteDescription) {
                        await Store.state.call.pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                        document.getElementById('call-status').innerText = "Verbunden";
                        document.getElementById('sound-ring').pause();
                        document.querySelectorAll('.ripple').forEach(r => r.style.animation = 'none');
                    }
                    if(d?.status === 'ended') this.end(false);
                });
            }

            static incoming(id, data) {
                Store.state.call.id = id;
                document.getElementById('call-overlay').classList.remove('hidden');
                document.getElementById('call-controls-active').classList.add('hidden');
                document.getElementById('call-controls-incoming').classList.remove('hidden');
                document.getElementById('call-name').innerText = data.callerName;
                document.getElementById('call-status').innerText = "Eingehender Anruf...";
                document.getElementById('sound-ring').play();
            }

            static async answer() {
                document.getElementById('sound-ring').pause();
                document.getElementById('call-controls-incoming').classList.add('hidden');
                document.getElementById('call-controls-active').classList.remove('hidden');
                
                const callRef = doc(db, "calls", Store.state.call.id);
                const s = await getDoc(callRef);
                const data = s.data();

                Store.state.call.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                
                Store.state.call.pc.ontrack = e => {
                    const aud = document.getElementById('remoteAudio');
                    aud.srcObject = e.streams[0];
                    aud.play();
                };

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(t => Store.state.call.pc.addTrack(t, stream));
                this.visualize(stream);

                await Store.state.call.pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await Store.state.call.pc.createAnswer();
                await Store.state.call.pc.setLocalDescription(answer);

                await updateDoc(callRef, {
                    answer: { type: answer.type, sdp: answer.sdp },
                    status: 'connected'
                });

                // ICE Candidates Logic would be here (omitted for slight brevity, but structure exists)
            }

            static async end(local = true) {
                if(local && Store.state.call.id) {
                    updateDoc(doc(db, "calls", Store.state.call.id), { status: 'ended' });
                }
                
                document.getElementById('call-overlay').classList.add('hidden');
                document.getElementById('sound-ring').pause();
                document.getElementById('sound-ring').currentTime = 0;
                
                if(Store.state.call.pc) Store.state.call.pc.close();
                window.location.reload(); // Hard Reset WebRTC state
            }

            static toggleMute() {
                // Implementation for toggling audio track enabled state
                const el = document.getElementById('btn-mute');
                el.classList.toggle('bg-white/30');
                UI.showToast("Mikrofon Status geändert", 'info');
            }

            static visualize(stream) {
                const ctx = new AudioContext();
                const src = ctx.createMediaStreamSource(stream);
                const ana = ctx.createAnalyser();
                src.connect(ana);
                ana.fftSize = 256;
                const buf = new Uint8Array(ana.frequencyBinCount);
                const canvas = document.getElementById('call-canvas');
                const cCtx = canvas.getContext('2d');

                function draw() {
                    requestAnimationFrame(draw);
                    ana.getByteFrequencyData(buf);
                    cCtx.fillStyle = 'rgba(0,0,0,0)';
                    cCtx.clearRect(0,0,canvas.width,canvas.height);
                    const barW = (canvas.width / buf.length) * 2.5;
                    let x = 0;
                    for(let i=0; i<buf.length; i++) {
                        const h = buf[i] / 2;
                        cCtx.fillStyle = `rgb(0, ${h+100}, 132)`;
                        cCtx.fillRect(x, canvas.height - h, barW, h);
                        x += barW + 1;
                    }
                }
                draw();
            }
            
            static clearHistory() {
                if(confirm("Anrufverlauf wirklich löschen?")) {
                   document.getElementById('call-list').innerHTML = "";
                   // In Real app: delete subcollection
                }
            }
        }

        // --- GLOBAL EXPORTS ---
        window.UI = UI;
        window.Chat = Chat;
        window.Auth = Auth;
        window.Utils = Utils;
        window.Voice = Voice;
        window.Call = Call;

        // --- STARTUP ---
        Auth.init();
        
    </script>
</body>
</html>
