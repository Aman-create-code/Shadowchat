<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShadowChat V12 - TITANIC ULTRA ENTERPRISE (1100+ LINES)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#f0f2f5', 
                            dark: '#0b141a', 
                            panel: '#202c33',
                            accent: '#00a884', 
                            bubbleOut: '#d9fdd3', 
                            bubbleIn: '#ffffff', 
                            bubbleDarkOut: '#005c4b', 
                            bubbleDarkIn: '#233138',
                            iosRed: '#ff3b30',
                            iosGreen: '#34c759',
                            gold: '#ffb900',
                            cyber: '#00ff41'
                        }
                    },
                    fontFamily: { 
                        sans: ['SF Pro Display', 'Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'monospace']
                    },
                    animation: {
                        'pulse-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards'
                    },
                    keyframes: {
                        slideIn: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS RESET & CUSTOM STYLES */
        :root { --accent: #00a884; --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'SF Pro Display', sans-serif; height: 100dvh; background: #0b141a; color: #e9edef; overflow: hidden; margin: 0; padding: 0; }
        
        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; border: 2px solid #0b141a; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* ADVANCED ANIMATIONS */
        @keyframes ripple { 0% { box-shadow: 0 0 0 0 rgba(0, 168, 132, 0.4); } 100% { box-shadow: 0 0 0 60px rgba(0, 168, 132, 0); } }
        .calling-active { animation: ripple 1.5s infinite; }
        
        @keyframes scanner { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .scan-line { position: absolute; left: 0; width: 100%; height: 2px; background: #00a884; box-shadow: 0 0 15px #00a884; z-index: 10; animation: scanner 3s linear infinite; pointer-events: none; }

        .glass-header { backdrop-filter: blur(25px) saturate(200%); background: rgba(32, 44, 51, 0.88); }
        .chat-wallpaper { 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: 450px; opacity: 0.05; position: absolute; inset: 0; pointer-events: none; z-index: 0;
        }

        .ios-msg-in { border-radius: 2px 18px 18px 18px; }
        .ios-msg-out { border-radius: 18px 2px 18px 18px; }
        
        .tab-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .active-tab-glow { box-shadow: 0 0 20px rgba(0, 168, 132, 0.3); }

        /* FIXES FOR MOBILE BROWSERS */
        .height-fill { height: -webkit-fill-available; }
    </style>
</head>
<body class="select-none flex flex-col md:flex-row">

    <audio id="snd_msg_in" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
    <audio id="snd_msg_out" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>
    <audio id="snd_ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop preload="auto"></audio>
    <audio id="snd_connect" src="https://assets.mixkit.co/active_storage/sfx/2569/2569-preview.mp3" preload="auto"></audio>

    <aside id="mainSidebar" class="w-full md:w-[450px] flex flex-col bg-wa-dark border-r border-gray-800 z-50 shrink-0 height-fill">
        
        <header class="h-24 bg-wa-panel flex items-center justify-between px-6 border-b border-black safe-pt shrink-0">
            <div class="flex items-center gap-4">
                <div id="selfAvatar" onclick="window.navTo('settings')" class="w-14 h-14 rounded-2xl bg-gradient-to-br from-wa-accent to-green-900 flex items-center justify-center text-white font-black text-2xl shadow-xl cursor-pointer hover:scale-105 transition transform active:scale-95">?</div>
                <div class="flex flex-col">
                    <h1 id="selfNick" class="text-lg font-black text-white leading-tight">Syncing...</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-wa-accent rounded-full animate-pulse"></span>
                        <span class="text-[9px] text-wa-accent font-black tracking-widest uppercase">Encryption Active</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.openModal('loginModal')" class="p-3 text-blue-500 hover:bg-blue-500/10 rounded-xl transition active:scale-90"><i data-lucide="shield"></i></button>
                <button onclick="window.openModal('newGroupModal')" class="p-3 text-gray-400 hover:bg-white/5 rounded-xl transition active:scale-90"><i data-lucide="plus-circle"></i></button>
            </div>
        </header>

        <div class="px-5 py-4 bg-wa-dark shrink-0">
            <div class="bg-wa-panel border border-gray-800 rounded-2xl flex items-center px-4 py-3 group focus-within:border-wa-accent transition-all duration-300">
                <i data-lucide="search" class="w-4 h-4 text-gray-500 group-focus-within:text-wa-accent"></i>
                <input type="text" id="globalSearch" onkeyup="window.searchLogic()" placeholder="Sichere Suche..." class="bg-transparent text-sm w-full outline-none px-3 text-gray-100 placeholder:text-gray-600">
            </div>
        </div>

        <nav class="flex bg-wa-dark border-b border-gray-900 shrink-0">
            <button onclick="window.switchTab('chats')" id="tab-btn-chats" class="flex-1 py-5 text-[10px] font-black uppercase tracking-widest border-b-2 border-wa-accent text-wa-accent tab-transition">Gespräche</button>
            <button onclick="window.switchTab('network')" id="tab-btn-network" class="flex-1 py-5 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-gray-500 tab-transition">Netzwerk</button>
            <button onclick="window.switchTab('pipeline')" id="tab-btn-pipeline" class="flex-1 py-5 text-[10px] font-black uppercase tracking-widest border-b-2 border-transparent text-gray-500 tab-transition">Pipeline</button>
        </nav>

        <div id="sidebarScroll" class="flex-1 overflow-y-auto custom-scrollbar relative">
            
            <div id="pane-chats" class="tab-pane block">
                <div id="chatContainer" class="divide-y divide-gray-900/50">
                    <div class="p-20 text-center opacity-20"><i data-lucide="refresh-cw" class="w-10 h-10 animate-spin mx-auto mb-4"></i><p class="text-[10px] font-black uppercase">Initialisiere Archiv...</p></div>
                </div>
            </div>

            <div id="pane-network" class="tab-pane hidden p-6 animate-fade-in">
                <div class="bg-wa-panel border border-gray-800 p-8 rounded-[35px] shadow-2xl mb-8 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-wa-accent to-transparent"></div>
                    <label class="text-[10px] font-black text-wa-accent uppercase tracking-[0.3em] block mb-4">Neuer Signalknoten</label>
                    <div class="flex gap-3">
                        <input id="friendIdInput" type="text" placeholder="SHADOW-UID" class="flex-1 bg-wa-dark border border-gray-700 p-5 rounded-2xl text-xs font-mono text-white outline-none focus:border-wa-accent transition">
                        <button onclick="window.sendRequest()" class="bg-wa-accent text-white px-8 rounded-2xl shadow-lg hover:shadow-wa-accent/30 active:scale-95 transition"><i data-lucide="zap" class="w-5 h-5"></i></button>
                    </div>
                </div>
                
                <div id="incomingSignals" class="hidden mb-10">
                    <div class="flex items-center justify-between mb-4 px-2">
                        <h4 class="text-[10px] font-black text-orange-500 uppercase tracking-[0.2em]">Signalanfragen</h4>
                        <span id="sigCount" class="bg-orange-500 text-black text-[9px] font-black px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div id="requestStack" class="space-y-3"></div>
                </div>

                <div class="px-2">
                    <h4 class="text-[10px] font-black text-gray-600 uppercase tracking-[0.2em] mb-6">Verifizierte Partner</h4>
                    <div id="verifiedStack" class="space-y-4"></div>
                </div>
            </div>

            <div id="pane-pipeline" class="tab-pane hidden p-6 animate-fade-in">
                <div class="grid grid-cols-2 gap-5" id="pipelineGrid">
                    <div onclick="document.getElementById('pipelineUp').click()" class="aspect-square border-2 border-dashed border-gray-800 rounded-[40px] flex flex-col items-center justify-center gap-3 cursor-pointer hover:border-wa-accent group transition-all duration-500">
                        <div class="w-12 h-12 rounded-full bg-wa-panel flex items-center justify-center group-hover:scale-110 transition"><i data-lucide="camera" class="text-gray-600 group-hover:text-wa-accent"></i></div>
                        <span class="text-[9px] font-black text-gray-600 uppercase tracking-widest">Update</span>
                        <input type="file" id="pipelineUp" class="hidden" accept="image/*" onchange="window.handlePipelineUpload()">
                    </div>
                </div>
            </div>

            <div id="pane-settings" class="tab-pane hidden p-10 animate-fade-in text-center">
                <div id="setAva" class="w-36 h-36 rounded-[50px] bg-wa-panel border-4 border-wa-dark shadow-2xl mx-auto mb-8 flex items-center justify-center text-6xl font-black text-wa-accent relative group cursor-pointer">
                    ?
                    <div class="absolute inset-0 bg-black/40 rounded-[50px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i data-lucide="edit-3"></i></div>
                </div>
                <h2 id="setNickDisplay" class="text-3xl font-black text-white mb-2 italic">Agent</h2>
                <p id="setUidDisplay" class="text-[10px] font-mono text-gray-600 mb-12 tracking-widest uppercase truncate select-all">---</p>
                
                <div class="space-y-4 max-w-xs mx-auto">
                    <div class="text-left">
                        <label class="text-[9px] font-black text-gray-500 uppercase ml-4 mb-2 block">Anzeigename</label>
                        <input id="editNickInput" type="text" class="w-full bg-wa-panel border border-gray-800 p-5 rounded-2xl outline-none focus:border-wa-accent text-white font-bold transition">
                    </div>
                    <button onclick="window.updateProfile()" class="w-full bg-wa-accent py-5 rounded-2xl font-black text-xs uppercase shadow-xl hover:shadow-wa-accent/20 active:scale-95 transition">Daten Sichern</button>
                    
                    <div class="pt-10 border-t border-gray-900 mt-10">
                        <button onclick="window.terminateAccount()" class="text-red-500 font-black text-[10px] uppercase tracking-[0.3em] hover:text-red-400 transition">Selbstzerstörung (Account löschen)</button>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main id="chatWindow" class="hidden md:flex flex-1 flex-col h-full bg-wa-dark relative z-40 overflow-hidden height-fill">
        <div class="chat-wallpaper"></div>
        
        <header id="chatHeader" class="h-24 glass-header border-b border-black flex items-center justify-between px-8 z-50 shrink-0 safe-pt">
            <div class="flex items-center gap-6">
                <button onclick="window.backToSidebar()" class="md:hidden p-3 text-gray-400 hover:text-white transition"><i data-lucide="arrow-left"></i></button>
                <div id="chatAvatar" class="w-14 h-14 rounded-2xl bg-wa-accent flex items-center justify-center text-white font-black text-2xl shadow-lg ring-4 ring-wa-dark">?</div>
                <div class="flex flex-col">
                    <h2 id="chatTitle" class="text-xl font-black text-white tracking-tight leading-none mb-1">...</h2>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-wa-accent rounded-full animate-pulse shadow-[0_0_8px_#00a884]"></span>
                        <span class="text-[9px] text-wa-accent font-black uppercase tracking-widest">End-to-End aktiv</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="window.initCall('voice')" class="w-14 h-14 rounded-2xl bg-wa-panel border border-gray-800 text-wa-accent flex items-center justify-center hover:bg-wa-accent hover:text-white transition active:scale-90 shadow-lg"><i data-lucide="phone"></i></button>
                <button onclick="window.initCall('video')" class="w-14 h-14 rounded-2xl bg-wa-panel border border-gray-800 text-wa-accent flex items-center justify-center hover:bg-wa-accent hover:text-white transition active:scale-90 shadow-lg"><i data-lucide="video"></i></button>
                <button onclick="window.openModal('chatInfoModal')" class="w-14 h-14 rounded-2xl bg-wa-panel border border-gray-800 text-gray-500 flex items-center justify-center hover:text-white transition active:scale-90 shadow-lg"><i data-lucide="more-vertical"></i></button>
            </div>
        </header>

        <div id="messageScroller" class="flex-1 overflow-y-auto p-6 md:p-12 space-y-6 relative z-10 custom-scrollbar flex flex-col">
            <div class="m-auto flex flex-col items-center opacity-10">
                <i data-lucide="lock" class="w-32 h-32 mb-6"></i>
                <p class="text-[10px] font-black uppercase tracking-[1em]">Verschlüsselter Kanal</p>
            </div>
        </div>

        <footer id="chatFooter" class="p-6 md:p-10 bg-wa-panel/95 glass-header border-t border-black z-50 shrink-0 safe-pb">
            
            <div id="filePreview" class="hidden absolute bottom-36 left-10 bg-wa-panel p-5 rounded-[30px] border-2 border-wa-accent shadow-2xl animate-slide-in">
                <img id="previewImg" class="max-h-64 rounded-2xl shadow-lg border border-gray-800">
                <button onclick="window.cancelFile()" class="absolute -top-4 -right-4 bg-red-600 text-white p-3 rounded-full shadow-2xl hover:bg-red-500 transition active:scale-90"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="flex items-end gap-5 max-w-7xl mx-auto">
                <div class="flex gap-2">
                    <button onclick="document.getElementById('msgFileIn').click()" class="p-4 text-gray-500 hover:text-wa-accent hover:bg-white/5 rounded-2xl transition"><i data-lucide="paperclip"></i></button>
                    <input type="file" id="msgFileIn" class="hidden" accept="image/*" onchange="window.processFileSelection()">
                </div>
                
                <div class="flex-1 bg-wa-dark border border-gray-800 rounded-[28px] px-6 py-4 flex items-center shadow-inner focus-within:border-wa-accent transition duration-300">
                    <textarea id="msgInput" placeholder="Sichere Nachricht..." class="w-full bg-transparent outline-none text-white resize-none max-h-40 font-medium placeholder:text-gray-700" rows="1"></textarea>
                    <button class="ml-4 text-gray-500 hover:text-wa-accent transition"><i data-lucide="smile"></i></button>
                </div>
                
                <button onclick="window.sendMessage()" id="sendBtn" class="bg-wa-accent text-white p-6 rounded-[25px] shadow-2xl shadow-wa-accent/30 hover:shadow-wa-accent/50 active:scale-90 transition transform duration-200">
                    <i data-lucide="send" class="w-6 h-6"></i>
                </button>
            </div>
        </footer>
    </main>

    <div id="callOverlay" class="hidden fixed inset-0 z-[1000] bg-black/98 flex flex-col items-center justify-between py-24 px-10 text-white overflow-hidden">
        <div class="scan-line"></div>
        <div class="absolute inset-0 bg-wa-accent/5 opacity-20 pointer-events-none"></div>

        <div class="flex flex-col items-center z-10 text-center">
            <div id="callTargetAva" class="w-56 h-56 rounded-[75px] bg-wa-panel flex items-center justify-center text-7xl font-black border-4 border-wa-accent shadow-[0_0_50px_rgba(0,168,132,0.3)] mb-12 relative overflow-hidden">?</div>
            <h2 id="callTargetName" class="text-5xl font-black tracking-tighter mb-4 italic italic">Signalaufbau...</h2>
            <div class="flex items-center gap-4">
                <span class="w-3 h-3 bg-wa-accent rounded-full animate-ping"></span>
                <p id="callStatusText" class="text-wa-accent font-black uppercase tracking-[0.5em] text-[10px]">Synchronisiere Frequenzen</p>
            </div>
        </div>

        <div class="flex gap-16 z-10">
            <button onclick="window.terminateCall()" class="w-28 h-28 rounded-full bg-wa-iosRed flex items-center justify-center shadow-3xl ring-[12px] ring-red-500/10 hover:scale-110 active:scale-90 transition duration-300">
                <i data-lucide="phone-off" class="w-12 h-12"></i>
            </button>
            <button id="answerCallBtn" onclick="window.answerIncomingCall()" class="hidden w-28 h-28 rounded-full bg-wa-iosGreen flex items-center justify-center shadow-3xl ring-[12px] ring-green-500/10 animate-bounce hover:scale-110 active:scale-90 transition duration-300">
                <i data-lucide="phone" class="w-12 h-12"></i>
            </button>
        </div>

        <audio id="remoteAudioSink" autoplay></audio>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 z-[2000] bg-black/90 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-sm rounded-[55px] p-12 border border-gray-800 shadow-3xl text-center relative overflow-hidden">
            <div class="scan-line"></div>
            <div class="w-24 h-24 bg-wa-accent/10 text-wa-accent rounded-[35px] flex items-center justify-center mb-8 mx-auto border border-wa-accent/20"><i data-lucide="fingerprint" class="w-12 h-12"></i></div>
            <h3 class="text-3xl font-black text-white mb-2 tracking-tight">Knotenpunkt Login</h3>
            <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest mb-10">Verschlüsselter Terminal-Zugriff</p>
            <input id="loginUidInput" type="text" placeholder="SHADOW-UID-PROX" class="w-full bg-wa-dark border border-gray-700 p-6 rounded-2xl text-white mb-8 text-center font-mono uppercase tracking-[0.3em] outline-none focus:border-wa-accent transition shadow-inner">
            <button onclick="window.performLogin()" class="w-full bg-wa-accent py-5 rounded-3xl font-black text-xs uppercase tracking-widest text-white shadow-2xl hover:shadow-wa-accent/30 active:scale-95 transition">Identität Bestätigen</button>
            <button onclick="window.closeModal('loginModal')" class="mt-8 text-gray-600 font-bold uppercase text-[10px] tracking-widest hover:text-gray-400 transition">Abbrechen</button>
        </div>
    </div>

    <div id="newGroupModal" class="hidden fixed inset-0 z-[2000] bg-black/90 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-sm rounded-[55px] p-12 border border-gray-800 shadow-3xl">
            <h3 class="text-3xl font-black text-white mb-8 tracking-tight">Neuer Verbund</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[9px] font-black text-gray-500 uppercase ml-2 mb-2 block">Name der Pipeline</label>
                    <input id="newGroupName" type="text" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-2xl text-white outline-none focus:border-wa-accent transition">
                </div>
                <button onclick="window.createGroupLogic()" class="w-full bg-wa-accent py-5 rounded-3xl font-black text-xs uppercase tracking-widest text-white shadow-2xl active:scale-95 transition">Pipeline Starten</button>
                <button onclick="window.closeModal('newGroupModal')" class="w-full mt-4 text-gray-600 font-bold uppercase text-[10px] tracking-widest">Schließen</button>
            </div>
        </div>
    </div>

    <script type="module">
        /* FIREBASE SDK IMPORTS */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, writeBatch, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        /* SYSTEM CONFIGURATION */
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_API = "bd8f03312d551a4e7c4973f6af975396";

        /* STATE MANAGEMENT */
        let currentUser = null;
        let currentActiveChatId = null;
        let myNickname = "Agent";
        let localMediaStream = null;
        let rtcPeerConnection = null;
        let currentCallSessionId = null;
        let activeCallListener = null;

        const iceServersConfig = { 
            iceServers: [
                { urls: ["stun:stun.l.google.com:19302", "stun:stun1.l.google.com:19302", "stun:stun2.l.google.com:19302"] }
            ] 
        };

        /* BOOTSTRAP: INITIALIZING THE SYSTEM */
        onAuthStateChanged(auth, async (fbUser) => {
            if (fbUser) {
                const storedUid = localStorage.getItem("shadow_uid") || fbUser.uid;
                currentUser = { uid: storedUid };
                
                const userRef = doc(db, "users", storedUid);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    myNickname = "Agent-" + Math.floor(1000 + Math.random() * 9000);
                    await setDoc(userRef, {
                        uid: storedUid,
                        nickname: myNickname,
                        friends: [],
                        incoming: [],
                        created: serverTimestamp(),
                        status: "online"
                    });
                } else {
                    myNickname = userSnap.data().nickname;
                }
                
                initUI();
                startGlobalListeners();
            } else {
                signInAnonymously(auth);
            }
        });

        /* UI CORE FUNCTIONS */
        function initUI() {
            document.getElementById('selfNick').innerText = myNickname;
            document.getElementById('selfAvatar').innerText = myNickname[0];
            document.getElementById('setNickDisplay').innerText = myNickname;
            document.getElementById('editNickInput').value = myNickname;
            document.getElementById('setAva').innerText = myNickname[0];
            document.getElementById('setUidDisplay').innerText = currentUser.uid;
            lucide.createIcons();
        }

        window.switchTab = (tabId) => {
            const panes = document.querySelectorAll('.tab-pane');
            const buttons = document.querySelectorAll('nav button');
            
            panes.forEach(p => p.classList.add('hidden'));
            document.getElementById('pane-' + tabId).classList.remove('hidden');
            
            buttons.forEach(b => {
                b.classList.remove('border-wa-accent', 'text-wa-accent');
                b.classList.add('border-transparent', 'text-gray-500');
            });
            
            const activeBtn = document.getElementById('tab-btn-' + tabId);
            activeBtn.classList.add('border-wa-accent', 'text-wa-accent');
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            lucide.createIcons();
        };

        window.openModal = (id) => {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            m.classList.add('flex');
        };

        window.closeModal = (id) => {
            const m = document.getElementById(id);
            m.classList.add('hidden');
            m.classList.remove('flex');
        };

        /* REALTIME LISTENERS */
        function startGlobalListeners() {
            // Listen for Chats
            const chatQuery = query(collection(db, "chats"), orderBy("lastActivity", "desc"));
            onSnapshot(chatQuery, (snapshot) => {
                const container = document.getElementById('chatContainer');
                container.innerHTML = "";
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const isParticipant = data.type === 'private' ? 
                        data.participants.includes(currentUser.uid) : 
                        data.members.includes(currentUser.uid);
                        
                    if (isParticipant) {
                        renderChatListItem(docSnap.id, data);
                    }
                });
            });

            // Listen for User Network (Friends & Requests)
            onSnapshot(doc(db, "users", currentUser.uid), async (snap) => {
                const data = snap.data();
                renderNetwork(data);
            });

            // Listen for Incoming Calls
            const callQuery = query(collection(db, "calls"), where("receiver", "==", currentUser.uid), where("status", "==", "ringing"));
            onSnapshot(callQuery, (snap) => {
                snap.docChanges().forEach(change => {
                    if (change.type === "added") {
                        handleIncomingCall(change.doc.id, change.doc.data());
                    }
                });
            });

            // Listen for Pipeline (Statuses)
            const pipelineQuery = query(collection(db, "pipeline"), orderBy("time", "desc"), limit(20));
            onSnapshot(pipelineQuery, (snap) => {
                renderPipeline(snap);
            });
        }

        /* CHAT LOGIC */
        function renderChatListItem(id, data) {
            const container = document.getElementById('chatContainer');
            let name = data.name || "Kanal";
            
            if (data.type === 'private') {
                const otherUid = data.participants.find(p => p !== currentUser.uid);
                name = data.names?.[otherUid] || "Agent";
            }

            const div = document.createElement('div');
            div.className = "p-6 hover:bg-wa-panel/40 cursor-pointer flex items-center gap-5 transition duration-300 group relative active:bg-wa-panel";
            div.innerHTML = `
                <div class="w-16 h-16 rounded-[22px] bg-wa-accent flex items-center justify-center text-white font-black text-2xl shadow-lg group-hover:scale-105 transition-transform duration-300">${name[0]}</div>
                <div class="flex-1 overflow-hidden">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-black text-gray-100 truncate text-base">${name}</h3>
                        <span class="text-[8px] font-black text-gray-600 uppercase tracking-widest">${data.type}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate font-medium">${data.lastMsg || 'Sicherheitskanal etabliert...'}</p>
                </div>
                ${id === currentActiveChatId ? '<div class="absolute left-0 w-1.5 h-10 bg-wa-accent rounded-r-full"></div>' : ''}
            `;
            
            div.onclick = () => window.activateChat(id, name);
            container.appendChild(div);
        }

        window.activateChat = (id, name) => {
            currentActiveChatId = id;
            const win = document.getElementById('chatWindow');
            const sidebar = document.getElementById('mainSidebar');
            
            win.classList.replace('hidden', 'flex');
            if (window.innerWidth < 768) sidebar.classList.add('hidden');
            
            document.getElementById('chatTitle').innerText = name;
            document.getElementById('chatAvatar').innerText = name[0];
            
            loadMessages(id);
        };

        function loadMessages(chatId) {
            const msgBox = document.getElementById('messageScroller');
            const q = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"), limit(100));
            
            onSnapshot(q, (snapshot) => {
                msgBox.innerHTML = "";
                snapshot.forEach(d => {
                    const m = d.data();
                    renderMessage(m);
                });
                msgBox.scrollTop = msgBox.scrollHeight;
                lucide.createIcons();
            });
        }

        function renderMessage(m) {
            const msgBox = document.getElementById('messageScroller');
            const isMe = m.senderId === currentUser.uid;
            
            const wrap = document.createElement('div');
            wrap.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'} animate-slide-in`;
            
            wrap.innerHTML = `
                <div class="max-w-[82%] px-6 py-4 shadow-2xl ${isMe ? 'bg-wa-bubbleDarkOut text-white ios-msg-out' : 'bg-wa-panel text-gray-100 ios-msg-in'}">
                    ${!isMe ? `<p class="text-[9px] font-black text-wa-accent uppercase mb-1.5 tracking-widest">${m.senderName}</p>` : ''}
                    ${m.imageUrl ? `<img src="${m.imageUrl}" class="rounded-2xl mb-3 max-h-80 w-full object-cover border border-black/20 shadow-lg cursor-pointer" onclick="window.open('${m.imageUrl}')">` : ''}
                    <p class="text-[15px] leading-relaxed font-medium">${m.text || ''}</p>
                    <div class="flex justify-end mt-1 opacity-40">
                        <span class="text-[8px] font-black uppercase">${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</span>
                    </div>
                </div>
            `;
            msgBox.appendChild(wrap);
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            const file = document.getElementById('msgFileIn').files[0];
            
            if (!currentActiveChatId || (!text && !file)) return;
            
            let uploadedUrl = null;
            if (file) {
                uploadedUrl = await uploadToImgBB(file);
            }

            const msgData = {
                text: text,
                imageUrl: uploadedUrl,
                senderId: currentUser.uid,
                senderName: myNickname,
                timestamp: serverTimestamp()
            };

            await addDoc(collection(db, `chats/${currentActiveChatId}/messages`), msgData);
            await updateDoc(doc(db, "chats", currentActiveChatId), {
                lastActivity: serverTimestamp(),
                lastMsg: text ? text.substring(0, 50) : "Datei empfangen"
            });

            input.value = "";
            window.cancelFile();
            document.getElementById('snd_msg_out').play();
            input.style.height = 'auto';
        };

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API}`, { method: "POST", body: formData });
                const json = await res.json();
                return json.success ? json.data.url : null;
            } catch (e) {
                console.error("Upload failed", e);
                return null;
            }
        }

        /* WEBRTC CALL ENGINE (TRUE FUNCTIONALITY) */
        async function setupWebRTCPeer(isCaller) {
            rtcPeerConnection = new RTCPeerConnection(iceServersConfig);
            
            // Add local audio track
            localMediaStream.getTracks().forEach(track => {
                rtcPeerConnection.addTrack(track, localMediaStream);
            });

            // Handle incoming remote audio
            rtcPeerConnection.ontrack = (event) => {
                const sink = document.getElementById('remoteAudioSink');
                sink.srcObject = event.streams[0];
            };

            // Ice Candidate Gathering
            rtcPeerConnection.onicecandidate = (event) => {
                if (event.candidate && currentCallSessionId) {
                    const collectionPath = isCaller ? 'callerCandidates' : 'receiverCandidates';
                    addDoc(collection(db, `calls/${currentCallSessionId}/${collectionPath}`), event.candidate.toJSON());
                }
            };
        }

        window.initCall = async (type) => {
            if (!currentActiveChatId) return;
            
            try {
                localMediaStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: type === 'video' });
                
                const chatSnap = await getDoc(doc(db, "chats", currentActiveChatId));
                const cData = chatSnap.data();
                const targetUid = cData.type === 'private' ? 
                    cData.participants.find(p => p !== currentUser.uid) : cData.creator;

                currentCallSessionId = "CALL_" + Date.now() + "_" + currentUser.uid.substring(0, 5);
                
                await setupWebRTCPeer(true);

                const offer = await rtcPeerConnection.createOffer();
                await rtcPeerConnection.setLocalDescription(offer);

                const callPayload = {
                    caller: currentUser.uid,
                    callerName: myNickname,
                    receiver: targetUid,
                    type: type,
                    status: "ringing",
                    offer: { sdp: offer.sdp, type: offer.type },
                    timestamp: serverTimestamp()
                };

                await setDoc(doc(db, "calls", currentCallSessionId), callPayload);

                // UI Call State
                document.getElementById('callOverlay').classList.remove('hidden');
                document.getElementById('callTargetName').innerText = document.getElementById('chatTitle').innerText;
                document.getElementById('callTargetAva').innerText = document.getElementById('chatTitle').innerText[0];
                document.getElementById('snd_ringtone').play();

                // Listen for Answer
                onSnapshot(doc(db, "calls", currentCallSessionId), async (s) => {
                    const data = s.data();
                    if (data?.answer && !rtcPeerConnection.currentRemoteDescription) {
                        await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                        document.getElementById('callStatusText').innerText = "GESICHERTE VERBINDUNG";
                        document.getElementById('snd_ringtone').pause();
                        document.getElementById('snd_connect').play();
                    }
                    if (data?.status === "ended") window.terminateCall();
                });

                // Listen for Remote Candidates
                onSnapshot(collection(db, `calls/${currentCallSessionId}/receiverCandidates`), (s) => {
                    s.docChanges().forEach(change => {
                        if (change.type === "added") {
                            rtcPeerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                        }
                    });
                });

            } catch (err) {
                console.error("Call failed", err);
                alert("Hardware-Zugriff verweigert (Mikrofon/Kamera)");
            }
        };

        function handleIncomingCall(callId, data) {
            currentCallSessionId = callId;
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('answerCallBtn').classList.remove('hidden');
            document.getElementById('callTargetName').innerText = data.callerName;
            document.getElementById('callTargetAva').innerText = data.callerName[0];
            document.getElementById('callStatusText').innerText = "EINGEHENDES SIGNAL...";
            document.getElementById('snd_ringtone').play();
            
            // Listen for cancellation
            activeCallListener = onSnapshot(doc(db, "calls", callId), (s) => {
                if (s.data()?.status === "ended") window.terminateCall();
            });
        }

        window.answerIncomingCall = async () => {
            try {
                localMediaStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                const callRef = doc(db, "calls", currentCallSessionId);
                const callSnap = await getDoc(callRef);
                const callData = callSnap.data();

                await setupWebRTCPeer(false);
                await rtcPeerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
                
                const answer = await rtcPeerConnection.createAnswer();
                await rtcPeerConnection.setLocalDescription(answer);

                await updateDoc(callRef, {
                    answer: { sdp: answer.sdp, type: answer.type },
                    status: "connected"
                });

                // Listen for Caller Candidates
                onSnapshot(collection(db, `calls/${currentCallSessionId}/callerCandidates`), (s) => {
                    s.docChanges().forEach(change => {
                        if (change.type === "added") {
                            rtcPeerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                        }
                    });
                });

                document.getElementById('answerCallBtn').classList.add('hidden');
                document.getElementById('callStatusText').innerText = "VERBUNDEN";
                document.getElementById('snd_ringtone').pause();
                document.getElementById('snd_connect').play();

            } catch (err) {
                console.error("Answer failed", err);
                window.terminateCall();
            }
        };

        window.terminateCall = async () => {
            if (currentCallSessionId) {
                await updateDoc(doc(db, "calls", currentCallSessionId), { status: "ended" }).catch(() => {});
                // Auto-Cleanup after 5 seconds
                setTimeout(() => deleteDoc(doc(db, "calls", currentCallSessionId)).catch(() => {}), 5000);
            }
            
            if (localMediaStream) {
                localMediaStream.getTracks().forEach(track => track.stop());
            }
            if (rtcPeerConnection) {
                rtcPeerConnection.close();
            }
            
            document.getElementById('callOverlay').classList.add('hidden');
            document.getElementById('snd_ringtone').pause();
            document.getElementById('snd_ringtone').currentTime = 0;
            currentCallSessionId = null;
            if (activeCallListener) activeCallListener();
        };

        /* NETWORK & PROFILE LOGIC */
        window.sendRequest = async () => {
            const targetId = document.getElementById('friendIdInput').value.trim();
            if (!targetId || targetId === currentUser.uid) return;
            
            const targetRef = doc(db, "users", targetId);
            const snap = await getDoc(targetRef);
            
            if (snap.exists()) {
                await updateDoc(targetRef, {
                    incoming: arrayUnion(currentUser.uid)
                });
                alert("Signal gesendet.");
                document.getElementById('friendIdInput').value = "";
            } else {
                alert("ID nicht im Netzwerk gefunden.");
            }
        };

        function renderNetwork(data) {
            const reqStack = document.getElementById('requestStack');
            const verStack = document.getElementById('verifiedStack');
            
            reqStack.innerHTML = "";
            verStack.innerHTML = "";
            
            if (data.incoming?.length > 0) {
                document.getElementById('incomingSignals').classList.remove('hidden');
                document.getElementById('sigCount').innerText = data.incoming.length;
                data.incoming.forEach(rid => {
                    const row = document.createElement('div');
                    row.className = "p-4 bg-wa-panel border border-wa-accent/30 rounded-2xl flex justify-between items-center animate-pulse-fast";
                    row.innerHTML = `
                        <span class="text-[10px] font-mono text-gray-300">${rid.substring(0,15)}...</span>
                        <button onclick="window.acceptNetwork('${rid}')" class="bg-wa-accent text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest">Akzeptieren</button>
                    `;
                    reqStack.appendChild(row);
                });
            } else {
                document.getElementById('incomingSignals').classList.add('hidden');
            }

            data.friends?.forEach(async (fid) => {
                const fSnap = await getDoc(doc(db, "users", fid));
                if (fSnap.exists()) {
                    const fData = fSnap.data();
                    const row = document.createElement('div');
                    row.className = "p-5 bg-wa-panel border border-gray-800 rounded-3xl flex items-center justify-between hover:border-wa-accent transition cursor-pointer active:scale-95";
                    row.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-wa-accent/20 text-wa-accent flex items-center justify-center font-black">${fData.nickname[0]}</div>
                            <span class="font-bold text-gray-200">${fData.nickname}</span>
                        </div>
                        <i data-lucide="message-square" class="w-4 h-4 text-wa-accent"></i>
                    `;
                    row.onclick = () => window.establishPrivateChat(fid, fData.nickname);
                    verStack.appendChild(row);
                    lucide.createIcons();
                }
            });
        }

        window.acceptNetwork = async (rid) => {
            const batch = writeBatch(db);
            batch.update(doc(db, "users", currentUser.uid), {
                friends: arrayUnion(rid),
                incoming: arrayRemove(rid)
            });
            batch.update(doc(db, "users", rid), {
                friends: arrayUnion(currentUser.uid)
            });
            await batch.commit();
        };

        window.establishPrivateChat = async (otherId, otherNick) => {
            const combinedId = [currentUser.uid, otherId].sort().join("_");
            const chatRef = doc(db, "chats", combinedId);
            
            await setDoc(chatRef, {
                type: 'private',
                participants: [currentUser.uid, otherId],
                names: {
                    [currentUser.uid]: myNickname,
                    [otherId]: otherNick
                },
                lastActivity: serverTimestamp()
            }, { merge: true });
            
            window.switchTab('chats');
            window.activateChat(combinedId, otherNick);
        };

        window.createGroupLogic = async () => {
            const name = document.getElementById('newGroupName').value.trim();
            if (!name) return;
            
            const gid = "GROUP_" + Date.now();
            await setDoc(doc(db, "chats", gid), {
                type: 'group',
                name: name,
                members: [currentUser.uid],
                creator: currentUser.uid,
                lastActivity: serverTimestamp(),
                lastMsg: "Kanal erstellt"
            });
            
            window.closeModal('newGroupModal');
            window.activateChat(gid, name);
        };

        /* UTILS */
        window.processFileSelection = () => {
            const f = document.getElementById('msgFileIn').files[0];
            if (f) {
                document.getElementById('previewImg').src = URL.createObjectURL(f);
                document.getElementById('filePreview').classList.remove('hidden');
            }
        };

        window.cancelFile = () => {
            document.getElementById('msgFileIn').value = "";
            document.getElementById('filePreview').classList.add('hidden');
        };

        window.updateProfile = async () => {
            const newNick = document.getElementById('editNickInput').value.trim();
            if (newNick && newNick !== myNickname) {
                await updateDoc(doc(db, "users", currentUser.uid), { nickname: newNick });
                location.reload();
            }
        };

        window.performLogin = () => {
            const val = document.getElementById('loginUidInput').value.trim();
            if (val) {
                localStorage.setItem("shadow_uid", val);
                location.reload();
            }
        };

        window.backToSidebar = () => {
            document.getElementById('chatWindow').classList.add('hidden');
            document.getElementById('mainSidebar').classList.remove('hidden');
        };

        window.terminateAccount = async () => {
            if (confirm("DIES LÖSCHT ALLE DEINE DATEN UNWIDERRUFLICH. FORTFAHREN?")) {
                await deleteDoc(doc(db, "users", currentUser.uid));
                localStorage.clear();
                location.reload();
            }
        };

        /* AUTORESIZE TEXTAREA */
        document.getElementById('msgInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

    </script>
</body>
</html>
