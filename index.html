<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0b141a">
    <title>ShadowChat Ultra V13 - Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script> <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#ffffff', 
                            dark: '#0f172a', /* Modernes Slate-Dark */
                            panelLight: '#f1f5f9',
                            panel: '#1e293b',
                            accent: '#6366f1', /* Modern Indigo */
                            accentHover: '#4f46e5',
                            bubbleOut: '#e0e7ff', /* Soft Indigo Tint */
                            bubbleIn: '#ffffff', 
                            bubbleDarkOut: '#3730a3', 
                            bubbleDarkIn: '#1e293b',
                            iosRed: '#ef4444',
                            iosGreen: '#22c55e',
                            system: '#020617'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'SF Pro Display', '-apple-system', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'pop-in': 'popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'pulse-rec': 'pulseRec 1.5s infinite',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        popIn: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        pulseRec: { '0%': { transform: 'scale(1)', boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' }, '70%': { transform: 'scale(1.1)', boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' }, '100%': { transform: 'scale(1)', boxShadow: '0 0 0 0 rgba(239, 68, 68, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --app-height: 100dvh; }
        body { font-family: 'Inter', sans-serif; height: var(--app-height); background-color: #020617; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Modern Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }

        /* Blur UI */
        .glass-panel { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.05); }
        .glass-modal { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); }
        
        /* Message Swipe Logic */
        .msg-container { transition: transform 0.2s ease-out; touch-action: pan-y; }
        .msg-content { position: relative; z-index: 10; }
        .reply-icon-wrapper { position: absolute; left: -40px; top: 50%; transform: translateY(-50%); opacity: 0; transition: opacity 0.2s; }
        
        /* Context Menu */
        #contextMenu { transform-origin: bottom center; }
        
        /* Audio Player Styling */
        audio::-webkit-media-controls-panel { background-color: transparent; }
    </style>
</head>
<body class="text-slate-900 dark:text-slate-100 flex flex-col md:flex-row h-[100dvh]">

    <audio id="remoteAudio" autoplay playsinline></audio>
    <audio id="localAudio" muted autoplay playsinline></audio>
    <audio id="notifySound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/sfx/preview/mixkit-waiting-ringtone-1354.mp3" loop></audio>
    <audio id="sentSound" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3"></audio>

    <div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none"></div>

    <div id="lightbox" class="fixed inset-0 z-[300] bg-black/95 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <button onclick="window.closeLightbox()" class="absolute top-4 right-4 p-3 bg-white/10 rounded-full hover:bg-white/20 text-white"><i data-lucide="x"></i></button>
        <img id="lightbox-img" class="max-h-[90dvh] max-w-[95vw] object-contain rounded-lg">
    </div>

    <aside id="mainSidebar" class="flex flex-col w-full md:w-[400px] h-full border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 z-20 shrink-0 transition-all">
        
        <header class="h-[70px] px-4 flex items-center justify-between bg-white dark:bg-slate-950/50 backdrop-blur-md sticky top-0 z-30">
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="window.switchTab('settings')">
                <img id="myAvatarImg" class="w-10 h-10 rounded-full object-cover bg-slate-200 dark:bg-slate-800">
                <div>
                    <h1 class="font-bold text-lg leading-none" id="myDisplayNick">Laden...</h1>
                    <span class="text-[10px] font-bold text-wa-accent tracking-wider uppercase">Online</span>
                </div>
            </div>
            <div class="flex gap-1">
                <button onclick="window.toggleModal('newGroupModal')" class="p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition text-slate-500 dark:text-slate-400"><i data-lucide="users-round" class="w-5 h-5"></i></button>
                <div class="relative group">
                    <button class="p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition text-slate-500 dark:text-slate-400"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
                    <div class="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 hidden group-hover:block z-50 overflow-hidden animate-pop-in">
                        <button onclick="window.switchTab('settings')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">Einstellungen</button>
                        <button onclick="window.toggleModal('loginModal')" class="w-full text-left px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm text-red-400 font-medium border-t dark:border-slate-700">Account wechseln</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="px-4 pb-2">
            <div class="bg-slate-100 dark:bg-slate-900 flex items-center px-4 py-2.5 rounded-xl border border-transparent focus-within:border-wa-accent focus-within:ring-1 focus-within:ring-wa-accent/50 transition-all">
                <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
                <input id="searchInput" type="text" placeholder="Suchen..." class="bg-transparent text-sm w-full outline-none px-3 placeholder-slate-500 dark:text-white" onkeyup="window.filterChats()">
            </div>
        </div>

        <div class="hidden md:flex px-4 gap-1 border-b border-slate-200 dark:border-slate-800/50 mb-2">
            <button onclick="window.switchTab('chats')" id="dt-chats" class="flex-1 pb-3 text-sm font-bold border-b-2 border-transparent hover:text-wa-accent transition">Chats</button>
            <button onclick="window.switchTab('calls')" id="dt-calls" class="flex-1 pb-3 text-sm font-bold border-b-2 border-transparent hover:text-wa-accent transition">Anrufe</button>
            <button onclick="window.switchTab('friends')" id="dt-friends" class="flex-1 pb-3 text-sm font-bold border-b-2 border-transparent hover:text-wa-accent transition">Kontakte</button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative">
            <div id="tab-chats" class="tab-content h-full">
                <div id="pinnedChats" class="hidden border-b border-dashed border-slate-200 dark:border-slate-800 mb-2 pb-2"></div>
                <div id="chatListContainer" class="pb-20">
                    <div class="flex flex-col items-center justify-center h-40 text-slate-500 gap-2">
                        <div class="w-6 h-6 border-2 border-wa-accent border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
            </div>

            <div id="tab-calls" class="hidden tab-content p-2 pb-20 space-y-2">
                <h3 class="text-xs font-bold text-slate-500 uppercase px-4 mt-2">Anrufverlauf</h3>
                <div id="callHistoryList" class="space-y-1"></div>
            </div>

            <div id="tab-friends" class="hidden tab-content p-4 pb-20 space-y-6">
                 <div class="bg-slate-100 dark:bg-slate-900 p-4 rounded-2xl">
                    <h4 class="text-xs font-bold text-wa-accent uppercase mb-2">Kontakt hinzuf√ºgen</h4>
                    <div class="flex gap-2">
                        <input id="friendSearchInput" type="text" class="flex-1 bg-white dark:bg-slate-800 p-2 rounded-lg text-sm outline-none" placeholder="ID eingeben...">
                        <button onclick="window.sendRequest()" class="bg-wa-accent text-white p-2 rounded-lg"><i data-lucide="user-plus" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div id="pendingContainer" class="hidden">
                    <h4 class="text-[10px] font-bold text-orange-400 uppercase mb-2">Anfragen</h4>
                    <div id="pendingList" class="space-y-2"></div>
                </div>
                <div>
                    <h4 class="text-[10px] font-bold text-slate-500 uppercase mb-2">Deine Kontakte</h4>
                    <div id="contactsList" class="space-y-1"></div>
                </div>
            </div>

            <div id="tab-settings" class="hidden tab-content p-6 pb-20 space-y-6 animate-slide-up">
                <div class="text-center">
                    <div class="relative inline-block group cursor-pointer" onclick="document.getElementById('avatarIn').click()">
                        <img id="setAvatarImg" class="w-24 h-24 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-xl">
                        <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i data-lucide="camera" class="text-white"></i></div>
                    </div>
                    <input type="file" id="avatarIn" class="hidden" accept="image/*" onchange="window.uploadAvatar()">
                    <h2 class="text-xl font-bold mt-3" id="setNick">...</h2>
                </div>

                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl space-y-3">
                    <label class="text-xs font-bold text-slate-500 uppercase">Profil</label>
                    <input id="nickIn" type="text" class="w-full bg-transparent border-b border-slate-300 dark:border-slate-700 py-2 text-sm font-medium outline-none focus:border-wa-accent transition" placeholder="Dein Name">
                    <input id="bioIn" type="text" class="w-full bg-transparent border-b border-slate-300 dark:border-slate-700 py-2 text-sm font-medium outline-none focus:border-wa-accent transition" placeholder="Info">
                    <button onclick="window.saveProfile()" class="w-full bg-wa-accent text-white py-2 rounded-lg text-xs font-bold uppercase shadow hover:bg-wa-accentHover transition">Speichern</button>
                </div>

                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl flex items-center justify-between">
                    <div><p class="text-sm font-bold">Benachrichtigungen</p><p class="text-xs text-slate-500">Push-Meldungen</p></div>
                    <button onclick="window.requestNotifyPermission()" id="notifyBtn" class="text-xs bg-slate-200 dark:bg-slate-700 px-3 py-1 rounded-full font-bold">Aktivieren</button>
                </div>

                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-2xl">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-2">Sicherheit</p>
                    <div class="flex items-center gap-2 bg-slate-200 dark:bg-slate-800 p-2 rounded-lg mb-2">
                        <code id="myFullId" class="text-xs flex-1 truncate font-mono select-all">---</code>
                        <button onclick="window.copyMyId()" class="p-1"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                    <button onclick="window.logoutAndClear()" class="w-full py-2 text-red-500 text-xs font-bold border border-red-500/20 rounded-lg hover:bg-red-500 hover:text-white transition">Vom Ger√§t l√∂schen</button>
                </div>
            </div>
        </div>

        <nav class="md:hidden h-[65px] bg-white dark:bg-slate-950 border-t dark:border-slate-900 flex justify-around items-center shrink-0 z-30 pb-safe">
            <button onclick="window.switchTab('chats')" id="mnav-chats" class="flex flex-col items-center text-wa-accent"><i data-lucide="message-square" class="w-6 h-6"></i></button>
            <button onclick="window.switchTab('calls')" id="mnav-calls" class="flex flex-col items-center text-slate-500"><i data-lucide="phone" class="w-6 h-6"></i></button>
            <button onclick="window.switchTab('friends')" id="mnav-friends" class="flex flex-col items-center text-slate-500"><i data-lucide="users" class="w-6 h-6"></i></button>
            <button onclick="window.switchTab('settings')" id="mnav-settings" class="flex flex-col items-center text-slate-500"><i data-lucide="settings" class="w-6 h-6"></i></button>
        </nav>
    </aside>

    <main id="chatArea" class="hidden md:flex flex-1 flex-col h-full relative overflow-hidden bg-slate-100 dark:bg-[#0b141a] z-30 transition-all">
        
        <div class="absolute inset-0 opacity-[0.05] pointer-events-none" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px;"></div>

        <header id="chatHeader" class="h-[70px] bg-white/90 dark:bg-slate-950/90 backdrop-blur-md flex items-center justify-between px-4 z-20 border-b dark:border-slate-800 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="window.closeChatMobile()" class="md:hidden p-2 -ml-2 text-slate-500"><i data-lucide="arrow-left"></i></button>
                <img id="activeChatAvatar" class="w-10 h-10 rounded-full object-cover bg-slate-300 cursor-pointer" onclick="window.toggleModal('infoModal')">
                <div class="cursor-pointer" onclick="window.toggleModal('infoModal')">
                    <h2 id="activeChatTitle" class="font-bold text-base leading-tight">Chat</h2>
                    <p id="activeChatSub" class="text-xs text-wa-accent font-medium truncate animate-fade-in">...</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.initiateCall()" class="p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition text-wa-accent"><i data-lucide="phone" class="w-5 h-5 fill-current"></i></button>
                <button onclick="window.toggleChatPin()" id="pinBtn" class="p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition text-slate-400"><i data-lucide="pin" class="w-5 h-5"></i></button>
                <button onclick="window.toggleModal('infoModal')" class="p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition text-slate-400"><i data-lucide="info" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div id="messagesList" class="flex-1 overflow-y-auto p-4 space-y-1 relative z-10 custom-scrollbar scroll-smooth"></div>

        <div id="replyPreview" class="hidden bg-slate-50 dark:bg-slate-900 border-t dark:border-slate-800 p-2 px-4 flex justify-between items-center z-20 border-l-4 border-wa-accent">
            <div class="overflow-hidden">
                <p class="text-xs font-bold text-wa-accent" id="replyTargetName">Antwort an...</p>
                <p class="text-xs text-slate-500 truncate" id="replyTargetText">Nachricht...</p>
            </div>
            <button onclick="window.cancelReply()" class="p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>

        <footer class="p-2 md:p-3 bg-white dark:bg-slate-950 flex items-end gap-2 z-20 border-t dark:border-slate-800">
            <button onclick="document.getElementById('imgIn').click()" class="p-3 text-slate-500 hover:text-wa-accent transition"><i data-lucide="plus" class="w-6 h-6"></i></button>
            <input type="file" id="imgIn" class="hidden" accept="image/*" onchange="window.handleImageUpload()">
            
            <div class="flex-1 bg-slate-100 dark:bg-slate-900 rounded-2xl flex items-center px-4 py-2 min-h-[48px] focus-within:ring-2 ring-wa-accent/50 transition-all relative">
                <textarea id="msgIn" placeholder="Nachricht..." class="w-full bg-transparent outline-none text-[15px] dark:text-white resize-none max-h-32 custom-scrollbar placeholder-slate-500 py-2" rows="1" oninput="window.autoGrow(this)" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault(); window.sendMsg();}"></textarea>
            </div>
            
            <button id="micBtn" class="bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 p-3 rounded-full hover:bg-slate-300 dark:hover:bg-slate-700 transition" onmousedown="window.startRecording()" onmouseup="window.stopRecording()" ontouchstart="window.startRecording()" ontouchend="window.stopRecording()">
                <i data-lucide="mic" class="w-5 h-5"></i>
            </button>
            
            <button id="sendBtn" onclick="window.sendMsg()" class="hidden bg-wa-accent text-white p-3 rounded-full hover:bg-wa-accentHover transition shadow-lg transform active:scale-90">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
            </button>
        </footer>

        <div id="recordingOverlay" class="absolute bottom-20 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 hidden z-50 animate-pulse-rec">
            <i data-lucide="mic" class="w-5 h-5 animate-bounce"></i>
            <span class="font-bold tracking-widest" id="recTimer">0:00</span>
            <span class="text-xs opacity-80 uppercase">Lassen zum Senden</span>
        </div>
    </main>

    <div id="callOverlay" class="hidden fixed inset-0 z-[200] flex flex-col items-center justify-between py-12 px-6 bg-slate-900/90 backdrop-blur-xl text-white animate-fade-in">
        <div class="mt-10 text-center">
            <div class="inline-flex items-center gap-2 bg-white/10 px-4 py-1 rounded-full text-xs font-bold mb-8 backdrop-blur-md">
                <i data-lucide="lock" class="w-3 h-3"></i> End-to-End Encrypted
            </div>
            <img id="callAvatar" class="w-32 h-32 rounded-full mx-auto mb-6 border-4 border-white/10 shadow-2xl object-cover bg-slate-700">
            <h2 id="callName" class="text-3xl font-black mb-2">...</h2>
            <p id="callStatus" class="text-lg text-slate-400 animate-pulse">Verbinden...</p>
        </div>

        <div id="activeCallControls" class="hidden grid grid-cols-3 gap-6 mb-10">
            <button onclick="window.toggleMute()" id="muteBtn" class="flex flex-col items-center gap-2 group"><div class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-white/20 transition"><i data-lucide="mic" class="w-6 h-6"></i></div><span class="text-xs">Stumm</span></button>
            <button onclick="window.hangUpCall()" class="col-start-2 w-16 h-16 rounded-full bg-red-500 flex items-center justify-center shadow-lg hover:scale-110 transition"><i data-lucide="phone-off" class="w-8 h-8 fill-current"></i></button>
        </div>

        <div id="incomingCallControls" class="hidden flex items-center gap-10 mb-10">
            <button onclick="window.hangUpCall()" class="flex flex-col items-center gap-2"><div class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center shadow-lg hover:scale-110 transition"><i data-lucide="x" class="w-8 h-8"></i></div><span class="text-sm font-bold">Ablehnen</span></button>
            <button onclick="window.answerCall()" class="flex flex-col items-center gap-2"><div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center shadow-lg hover:scale-110 transition animate-bounce"><i data-lucide="phone" class="w-8 h-8 fill-current"></i></div><span class="text-sm font-bold">Annehmen</span></button>
        </div>
    </div>

    <div id="msgContextMenu" class="hidden fixed inset-0 z-[100] z-[100] flex items-end sm:items-center justify-center sm:justify-center p-4" onclick="window.closeContextMenu(event)">
        <div class="glass-modal absolute inset-0"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-xs rounded-2xl p-2 shadow-2xl relative z-10 animate-slide-up sm:animate-pop-in space-y-1">
            <button onclick="window.ctxAction('reply')" class="w-full flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition text-left text-sm font-bold"><i data-lucide="reply" class="w-4 h-4 text-wa-accent"></i> Antworten</button>
            <button onclick="window.ctxAction('forward')" class="w-full flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition text-left text-sm font-bold"><i data-lucide="forward" class="w-4 h-4 text-blue-500"></i> Weiterleiten</button>
            <button onclick="window.ctxAction('copy')" class="w-full flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition text-left text-sm font-bold"><i data-lucide="copy" class="w-4 h-4 text-slate-500"></i> Kopieren</button>
            <button id="ctxDeleteBtn" onclick="window.ctxAction('delete')" class="w-full flex items-center gap-3 p-3 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-xl transition text-left text-sm font-bold text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i> L√∂schen (F√ºr alle)</button>
        </div>
    </div>

    <div id="forwardModal" class="hidden fixed inset-0 z-[110] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-2xl p-4 shadow-2xl max-h-[70vh] flex flex-col">
            <h3 class="font-bold text-lg mb-4 px-2">Weiterleiten an...</h3>
            <div id="forwardList" class="flex-1 overflow-y-auto space-y-2 custom-scrollbar"></div>
            <button onclick="window.toggleModal('forwardModal')" class="mt-4 w-full py-3 bg-slate-200 dark:bg-slate-700 rounded-xl font-bold text-sm">Abbrechen</button>
        </div>
    </div>

    <div id="newGroupModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-xl font-black mb-4">Neue Gruppe</h3>
            <div class="space-y-4">
                <input id="ng_name" type="text" class="w-full bg-slate-100 dark:bg-slate-900 p-3 rounded-xl outline-none" placeholder="Gruppenname">
                <input id="ng_pass" type="text" class="w-full bg-slate-100 dark:bg-slate-900 p-3 rounded-xl outline-none" placeholder="Passwort (Optional)">
                <div class="flex gap-2 mt-4">
                    <button onclick="window.toggleModal('newGroupModal')" class="flex-1 py-3 text-slate-500 font-bold">Abbrechen</button>
                    <button onclick="window.createGrp()" class="flex-1 bg-wa-accent text-white rounded-xl font-bold shadow-lg">Erstellen</button>
                </div>
                <div class="border-t dark:border-slate-700 pt-4 mt-2">
                     <p class="text-xs font-bold text-slate-500 mb-2">Oder beitreten:</p>
                     <div class="flex gap-2">
                        <input id="jg_id" type="text" class="flex-1 bg-slate-100 dark:bg-slate-900 p-2 rounded-lg text-xs font-mono uppercase" placeholder="8-Stellige ID">
                        <button onclick="window.joinGrp()" class="bg-slate-700 text-white px-4 rounded-lg text-xs font-bold">Join</button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative">
            <button onclick="window.toggleModal('loginModal')" class="absolute top-4 right-4"><i data-lucide="x"></i></button>
            <h3 class="text-xl font-black mb-6">Account wiederherstellen</h3>
            <div class="space-y-3">
                <input id="login_id" type="text" placeholder="User ID" class="w-full bg-slate-100 dark:bg-slate-900 p-3 rounded-xl outline-none font-mono text-center">
                <input id="login_pass" type="password" placeholder="Passwort" class="w-full bg-slate-100 dark:bg-slate-900 p-3 rounded-xl outline-none font-mono text-center">
                <button onclick="window.recoverAccount()" class="w-full bg-wa-accent text-white py-3 rounded-xl font-bold shadow-lg mt-4">Login</button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
            <div class="relative h-32 bg-wa-accent/20">
                <button onclick="window.toggleModal('infoModal')" class="absolute top-4 right-4 bg-black/20 text-white p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="px-6 -mt-10 mb-4 flex flex-col items-center">
                <img id="infoAvatar" class="w-24 h-24 rounded-full border-4 border-white dark:border-slate-800 shadow-xl object-cover bg-slate-500">
                <h2 id="infoTitle" class="text-xl font-black mt-2 text-center">...</h2>
                <p id="infoSub" class="text-xs text-slate-500">...</p>
                <div id="infoIdBadge" class="mt-2 text-[10px] font-mono bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded select-all">ID</div>
            </div>
            <div class="flex-1 overflow-y-auto px-6 custom-scrollbar">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Teilnehmer & Admins</h4>
                <div id="infoMemberList" class="space-y-2 pb-4"></div>
            </div>
            <div class="p-4 border-t dark:border-slate-700" id="infoActions">
                <button onclick="window.leaveChat()" class="w-full py-3 rounded-xl text-red-500 font-bold bg-red-50 dark:bg-red-900/10 hover:bg-red-100 transition flex justify-center gap-2"><i data-lucide="log-out" class="w-5 h-5"></i> <span id="leaveText">Verlassen</span></button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, writeBatch, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // --- KONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app", // WICHTIG: Storage Bucket muss in Console aktiviert sein
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // --- GLOBAL STATE ---
        let currentUser = null; 
        let myRealUid = null;
        let myData = null;
        let activeChatId = null; 
        let isPrivate = false;
        let activeChatData = null; // F√ºr Admin Checks

        // Features State
        let mediaRecorder = null;
        let audioChunks = [];
        let replyToMsg = null; // { id, text, sender }
        let contextMsgId = null; // ID f√ºr Kontextmen√º
        let contextMsgData = null;
        
        // WebRTC
        let peerConnection = null;
        let localStream = null;
        let callUnsub = null;
        let currentCallId = null;
        const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };

        // Schimpfwort Filter (Basic)
        const BAD_WORDS = ["arsch", "idiot", "hurensohn", "wichser", "fuck", "shit"];

        // --- AUTH & INIT ---
        const savedUid = localStorage.getItem('shadow_uid_v13');
        signInAnonymously(auth);

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                myRealUid = savedUid || u.uid;
                const userRef = doc(db, "users", myRealUid);
                const snap = await getDoc(userRef);

                if(!snap.exists()) {
                    if(savedUid) { localStorage.removeItem('shadow_uid_v13'); location.reload(); return; }
                    // Create New
                    const nick = "User-" + Math.floor(Math.random()*1000);
                    const pass = Math.random().toString(36).slice(-6);
                    await setDoc(userRef, { 
                        uid: myRealUid, nickname: nick, bio: "Hey there!", 
                        password: pass, avatar: null, friends: [], incoming: [],
                        online: true, lastSeen: serverTimestamp() 
                    });
                    showToast("Willkommen! Dein Passwort: " + pass, 'info');
                } else {
                    myData = snap.data();
                    updateSelfUI();
                }
                
                // Online Presence
                updateDoc(userRef, { online: true });
                document.addEventListener('visibilitychange', () => {
                    updateDoc(userRef, { online: document.visibilityState === 'visible', lastSeen: serverTimestamp() });
                });
                window.addEventListener('beforeunload', () => updateDoc(userRef, { online: false, lastSeen: serverTimestamp() }));

                loadChats();
                loadCallsHistory();
                loadFriends();
                startIncomingCallListener();
                lucide.createIcons();
            }
        });

        // --- UI HELPERS ---
        window.showToast = (msg, type='info') => {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `p-4 rounded-xl shadow-lg text-sm font-bold flex items-center gap-2 animate-slide-up ${type==='error'?'bg-red-500 text-white':'bg-white dark:bg-slate-800 dark:text-white'}`;
            d.innerHTML = type==='error' ? `<i data-lucide="alert-circle" class="w-5 h-5"></i> ${msg}` : `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i> ${msg}`;
            c.appendChild(d);
            lucide.createIcons();
            setTimeout(() => d.remove(), 3000);
        };

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            document.getElementById('tab-'+id).classList.add('animate-slide-up');
            
            // Desktop Highlighting
            document.querySelectorAll('[id^="dt-"]').forEach(b => b.classList.remove('text-wa-accent', 'border-wa-accent'));
            const dt = document.getElementById('dt-'+id); if(dt) dt.classList.add('text-wa-accent', 'border-wa-accent');

            // Mobile Highlighting
            document.querySelectorAll('[id^="mnav-"]').forEach(b => b.classList.replace('text-wa-accent', 'text-slate-500'));
            const mn = document.getElementById('mnav-'+id); if(mn) mn.classList.replace('text-slate-500', 'text-wa-accent');
        };

        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            if(el.classList.contains('hidden')) { el.classList.remove('hidden'); } else { el.classList.add('hidden'); }
        };

        function updateSelfUI() {
            document.getElementById('myDisplayNick').innerText = myData.nickname;
            document.getElementById('setNick').innerText = myData.nickname;
            document.getElementById('nickIn').value = myData.nickname;
            document.getElementById('bioIn').value = myData.bio;
            document.getElementById('myFullId').innerText = myRealUid;
            
            const ava = myData.avatar || `https://api.dicebear.com/7.x/initials/svg?seed=${myData.nickname}`;
            document.getElementById('myAvatarImg').src = ava;
            document.getElementById('setAvatarImg').src = ava;
        }

        // --- CORE FEATURES ---

        // 7. & 8. Profilbild & Schimpfwort Filter
        window.uploadAvatar = async () => {
            const file = document.getElementById('avatarIn').files[0];
            if(!file) return;
            showToast("Lade hoch...");
            try {
                const sRef = ref(storage, `avatars/${myRealUid}_${Date.now()}`);
                await uploadBytes(sRef, file);
                const url = await getDownloadURL(sRef);
                await updateDoc(doc(db, "users", myRealUid), { avatar: url });
                myData.avatar = url; updateSelfUI();
                showToast("Profilbild aktualisiert");
            } catch(e) { showToast("Upload Fehler", 'error'); }
        };

        window.saveProfile = async () => {
            const newNick = document.getElementById('nickIn').value.trim();
            const newBio = document.getElementById('bioIn').value.trim();
            
            // Profanity Check
            if(BAD_WORDS.some(w => newNick.toLowerCase().includes(w))) {
                return showToast("Name enth√§lt unzul√§ssige W√∂rter!", 'error');
            }

            await updateDoc(doc(db, "users", myRealUid), { nickname: newNick, bio: newBio });
            myData.nickname = newNick; myData.bio = newBio;
            updateSelfUI();
            showToast("Gespeichert!");
        };

        // 9. Benachrichtigungen
        window.requestNotifyPermission = () => {
            Notification.requestPermission().then(p => {
                if(p === 'granted') {
                    showToast("Benachrichtigungen aktiv!");
                    document.getElementById('notifyBtn').classList.add('hidden');
                }
            });
        };
        
        function sendNotification(title, body) {
            if(document.hidden && Notification.permission === 'granted') {
                new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png' });
                document.getElementById('sentSound').play();
            }
        }

        // --- CHAT LOGIC ---

        window.openChat = async (chatId, name, priv, avatarUrl) => {
            activeChatId = chatId; isPrivate = priv;
            document.getElementById('chatArea').classList.replace('hidden', 'flex');
            document.getElementById('mainSidebar').classList.add('hidden'); // Mobile logic
            
            document.getElementById('activeChatTitle').innerText = name;
            document.getElementById('activeChatAvatar').src = avatarUrl || `https://api.dicebear.com/7.x/initials/svg?seed=${name}`;
            
            // Set Pin State
            const chatRef = doc(db, "chats", chatId);
            const chatSnap = await getDoc(chatRef);
            activeChatData = chatSnap.data();
            
            const isPinned = activeChatData.pinned?.[myRealUid] || false;
            document.getElementById('pinBtn').classList.toggle('text-wa-accent', isPinned);
            document.getElementById('pinBtn').classList.toggle('text-slate-400', !isPinned);

            // Load Messages
            const q = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"), limit(60));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('messagesList');
                list.innerHTML = "";
                
                // 12. Real Blue Ticks Logic (Mark as read when I see them)
                if(!document.hidden) {
                    snap.docs.forEach(d => {
                        const m = d.data();
                        if(!m.readBy.includes(myRealUid)) {
                            updateDoc(d.ref, { readBy: arrayUnion(myRealUid) });
                        }
                    });
                }

                snap.forEach(d => renderMessage(d, list, activeChatData.members?.length || 2));
                list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
                lucide.createIcons();
            });

            // Update Header Status
            if(isPrivate) {
                const pid = chatId.split('_').find(x => x !== myRealUid);
                onSnapshot(doc(db, "users", pid), s => {
                    const u = s.data();
                    const sub = document.getElementById('activeChatSub');
                    if(u.online) sub.innerHTML = '<span class="text-green-500">Online</span>';
                    else sub.innerText = u.lastSeen ? "Zuletzt: " + u.lastSeen.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : "Offline";
                });
            } else {
                document.getElementById('activeChatSub').innerText = `${activeChatData.members.length} Mitglieder`;
            }
        };

        // 1. Voice Messages Logic
        window.startRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.start();
                
                document.getElementById('recordingOverlay').classList.remove('hidden');
                document.getElementById('msgIn').disabled = true;
                
                let sec = 0;
                window.recInterval = setInterval(() => {
                    sec++;
                    document.getElementById('recTimer').innerText = `0:0${sec}`;
                }, 1000);
            } catch(e) { showToast("Mikrofon Fehler", 'error'); }
        };

        window.stopRecording = () => {
            if(!mediaRecorder) return;
            mediaRecorder.stop();
            clearInterval(window.recInterval);
            document.getElementById('recordingOverlay').classList.add('hidden');
            document.getElementById('msgIn').disabled = false;
            
            mediaRecorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/mp3' });
                // Upload logic
                const fname = `voice/${activeChatId}/${Date.now()}.mp3`;
                const sRef = ref(storage, fname);
                await uploadBytes(sRef, blob);
                const url = await getDownloadURL(sRef);
                sendMessage(null, null, url); // type defaults to audio if url present and no text
            };
        };

        // 2. & 11. & 12. Message Rendering & Interaction
        function renderMessage(docSnap, container, memberCount) {
            const m = docSnap.data();
            const mid = docSnap.id;
            const isMe = m.senderId === myRealUid;
            
            // 11. Deleted Stub
            if(m.type === 'system' && m.text === 'deleted') {
                container.innerHTML += `<div class="flex justify-center my-2"><span class="text-xs text-slate-400 italic bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded-full"><i data-lucide="ban" class="w-3 h-3 inline"></i> Nachricht gel√∂scht</span></div>`;
                return;
            }

            const div = document.createElement('div');
            // Swipe Logic Wrapper
            div.className = `msg-container flex ${isMe ? 'justify-end' : 'justify-start'} mb-1 group relative`;
            
            // Long Press Event
            const hammer = new Hammer(div);
            hammer.on('press', () => { window.openContextMenu(mid, m, isMe); });
            // Swipe Event (Right swipe to reply)
            hammer.on('panright', (e) => {
                if(Math.abs(e.deltaY) < 50) { // Only horizontal
                   div.style.transform = `translateX(${Math.min(e.deltaX, 100)}px)`;
                   if(e.deltaX > 80) div.querySelector('.reply-icon-wrapper').style.opacity = 1;
                }
            });
            hammer.on('panend', (e) => {
                div.style.transform = '';
                div.querySelector('.reply-icon-wrapper').style.opacity = 0;
                if(e.deltaX > 80) window.initReply(mid, m);
            });

            // 12. Blue Ticks Logic
            const isRead = m.readBy && m.readBy.length >= memberCount; // Simple logic: Everyone read it
            const checkColor = isRead ? 'text-blue-500' : 'text-slate-400';

            // Content Builder
            let content = '';
            
            // Reply Header
            if(m.replyTo) {
                content += `<div class="bg-black/5 dark:bg-black/20 p-1 pl-2 mb-1 rounded border-l-2 border-wa-accent text-xs cursor-pointer" onclick="document.getElementById('${m.replyTo.id}')?.scrollIntoView({behavior:'smooth'})">
                    <span class="font-bold text-wa-accent">${m.replyTo.sender}</span><br>
                    <span class="truncate opacity-70">${m.replyTo.text}</span>
                </div>`;
            }

            // Forwarded Label
            if(m.isForwarded) {
                content += `<div class="text-[10px] text-slate-400 italic mb-1 flex items-center gap-1"><i data-lucide="forward" class="w-3 h-3"></i> Weitergeleitet</div>`;
            }

            // Body
            if(m.audio) {
                content += `<audio controls src="${m.audio}" class="h-8 w-48"></audio>`;
            } else if(m.img) {
                content += `<img src="${m.img}" class="max-w-[200px] rounded-lg cursor-pointer" onclick="window.openLightbox('${m.img}')">`;
                if(m.text) content += `<p class="mt-1">${m.text}</p>`;
            } else {
                content += `<p>${m.text}</p>`;
            }
            
            const time = m.timestamp ? m.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

            div.innerHTML = `
                <div class="reply-icon-wrapper text-wa-accent"><i data-lucide="reply" class="w-6 h-6 bg-white dark:bg-slate-800 rounded-full p-1 shadow"></i></div>
                <div id="${mid}" class="msg-content max-w-[75%] p-2 rounded-xl shadow-sm relative text-[15px] leading-relaxed 
                    ${isMe ? 'bg-wa-bubbleOut dark:bg-wa-bubbleDarkOut rounded-tr-none text-slate-800 dark:text-slate-100' : 'bg-white dark:bg-wa-bubbleDarkIn rounded-tl-none text-slate-800 dark:text-slate-100'}">
                    ${!isMe && !isPrivate ? `<p class="text-[10px] font-bold text-wa-accent mb-0.5">${m.senderName}</p>` : ''}
                    ${content}
                    <div class="flex justify-end items-center gap-1 mt-1 select-none">
                        <span class="text-[9px] opacity-60">${time}</span>
                        ${isMe ? `<i data-lucide="check-check" class="w-3 h-3 ${checkColor}"></i>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        // Send Logic
        window.sendMsg = async () => {
            const txt = document.getElementById('msgIn').value.trim();
            if(!txt && !window.tempImg) return;
            await sendMessage(txt, window.tempImg, null);
            document.getElementById('msgIn').value = "";
            window.cancelReply();
        };

        async function sendMessage(text, img, audio) {
            const payload = {
                text: text || null,
                img: img || null,
                audio: audio || null,
                senderId: myRealUid,
                senderName: myData.nickname,
                timestamp: serverTimestamp(),
                readBy: [myRealUid],
                type: audio ? 'audio' : (img ? 'image' : 'text'),
                isForwarded: false
            };
            if(replyToMsg) payload.replyTo = replyToMsg;

            await addDoc(collection(db, `chats/${activeChatId}/messages`), payload);
            await updateDoc(doc(db, "chats", activeChatId), { 
                lastMessage: audio ? 'üé§ Sprachnachricht' : (img ? 'üì∑ Bild' : text),
                lastActivity: serverTimestamp() 
            });
            document.getElementById('sentSound').play();
        }

        // 3. Context Menu Logic
        window.openContextMenu = (mid, mData, isMe) => {
            contextMsgId = mid;
            contextMsgData = mData;
            
            // Admin Check for "Delete for Everyone"
            const isAdmin = activeChatData.admins?.includes(myRealUid) || activeChatData.creator === myRealUid;
            const delBtn = document.getElementById('ctxDeleteBtn');
            
            // L√∂schen Logik: Eigene Nachricht oder Admin in Gruppe
            if (isMe || (isAdmin && !isPrivate)) {
                delBtn.classList.remove('hidden');
            } else {
                delBtn.classList.add('hidden');
            }

            document.getElementById('msgContextMenu').classList.remove('hidden');
        };

        window.closeContextMenu = (e) => {
            if(e.target === e.currentTarget || e.target.classList.contains('glass-modal')) 
                document.getElementById('msgContextMenu').classList.add('hidden');
        };

        window.ctxAction = (action) => {
            document.getElementById('msgContextMenu').classList.add('hidden');
            if(action === 'reply') window.initReply(contextMsgId, contextMsgData);
            if(action === 'copy') { navigator.clipboard.writeText(contextMsgData.text || ""); showToast("Kopiert"); }
            if(action === 'delete') window.deleteMessageForEveryone(contextMsgId);
            if(action === 'forward') window.openForwardModal();
        };

        // 2. Swipe / Reply Logic
        window.initReply = (mid, mData) => {
            replyToMsg = { id: mid, text: mData.text || (mData.audio ? "Sprachnachricht" : "Bild"), sender: mData.senderName };
            document.getElementById('replyPreview').classList.remove('hidden');
            document.getElementById('replyTargetName').innerText = `Antwort an ${mData.senderName}`;
            document.getElementById('replyTargetText').innerText = replyToMsg.text;
            document.getElementById('msgIn').focus();
        };

        window.cancelReply = () => {
            replyToMsg = null;
            document.getElementById('replyPreview').classList.add('hidden');
        };

        // 3. Forward Logic
        window.openForwardModal = () => {
            const list = document.getElementById('forwardList');
            list.innerHTML = "";
            window.toggleModal('forwardModal');
            // Populate list from existing chats
            const chats = document.querySelectorAll('#chatListContainer > div'); // Lazy way, better query DB again in real app
            // Just fetching recent chats from DB for clean list
            getDoc(doc(db, "users", myRealUid)).then(async u => { // Or use existing chat list data
                 // Dummy: Reuse visual list logic or fetch
                 // Implementation detail: Iterate loaded chats
                 showToast("W√§hle einen Chat aus der Liste (Placeholder)");
            });
            // Simplified:
            const q = query(collection(db, "chats"), where("members", "array-contains", myRealUid), limit(5));
            getDocs(q).then(snap => {
                snap.forEach(d => {
                    const c = d.data();
                    const btn = document.createElement('button');
                    btn.className = "w-full p-3 text-left hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg font-bold text-sm truncate";
                    btn.innerText = c.name || "Chat";
                    btn.onclick = () => window.forwardTo(d.id);
                    list.appendChild(btn);
                });
            });
        };

        window.forwardTo = async (targetId) => {
            window.toggleModal('forwardModal');
            const payload = {
                ...contextMsgData,
                senderId: myRealUid,
                senderName: myData.nickname,
                timestamp: serverTimestamp(),
                readBy: [myRealUid],
                isForwarded: true,
                replyTo: null
            };
            delete payload.id; // New ID
            await addDoc(collection(db, `chats/${targetId}/messages`), payload);
            showToast("Weitergeleitet!");
        };

        // 11. Delete Logic
        window.deleteMessageForEveryone = async (mid) => {
            if(confirm("Nachricht f√ºr alle l√∂schen?")) {
                await updateDoc(doc(db, `chats/${activeChatId}/messages`, mid), {
                    type: 'system',
                    text: 'deleted',
                    img: null,
                    audio: null
                });
            }
        };

        // 6. Pin Chats
        window.toggleChatPin = async () => {
            if(!activeChatId) return;
            const currentPin = activeChatData.pinned?.[myRealUid] || false;
            await updateDoc(doc(db, "chats", activeChatId), {
                [`pinned.${myRealUid}`]: !currentPin
            });
            document.getElementById('pinBtn').classList.toggle('text-wa-accent');
            showToast(currentPin ? "Chat gel√∂st" : "Chat angepinnt");
        };

        // --- CALLS LOGIC (5. & 10.) ---
        
        // 5. Calls Tab History
        function loadCallsHistory() {
            const q = query(collection(db, "calls"), where("callerId", "==", myRealUid), orderBy("timestamp", "desc"), limit(20));
            onSnapshot(q, snap => {
                const list = document.getElementById('callHistoryList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-3 bg-white dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-800";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center"><i data-lucide="phone-outgoing" class="w-5 h-5 text-slate-500"></i></div>
                            <div>
                                <p class="font-bold text-sm">${c.targetName || "Unbekannt"}</p>
                                <p class="text-[10px] text-slate-400">${c.timestamp ? c.timestamp.toDate().toLocaleDateString() : 'Gerade'}</p>
                            </div>
                        </div>
                        <button onclick="window.initiateCall('${c.targetId}', '${c.targetName}')" class="text-green-500 p-2"><i data-lucide="refresh-ccw" class="w-5 h-5"></i></button>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.initiateCall = async (tid, tname) => {
            const targetId = tid || (isPrivate ? activeChatId.split('_').find(x=>x!==myRealUid) : null);
            if(!targetId && !isPrivate) return showToast("Gruppenanrufe noch Beta", 'error');

            const targetName = tname || document.getElementById('activeChatTitle').innerText;
            
            // UI
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('activeCallControls').classList.remove('hidden');
            document.getElementById('incomingCallControls').classList.add('hidden');
            document.getElementById('callName').innerText = targetName;
            document.getElementById('callStatus').innerText = "W√§hle...";

            // WebRTC Init
            localStream = await navigator.mediaDevices.getUserMedia({audio:true});
            const callDoc = doc(collection(db, "calls"));
            currentCallId = callDoc.id;
            
            peerConnection = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
            peerConnection.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
            peerConnection.onicecandidate = e => e.candidate && addDoc(collection(callDoc, 'offerCandidates'), e.candidate.toJSON());

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await setDoc(callDoc, {
                callerId: myRealUid, callerName: myData.nickname, targetId, targetName,
                offer: {sdp: offer.sdp, type: offer.type}, status: 'ringing', timestamp: serverTimestamp()
            });

            callUnsub = onSnapshot(callDoc, s => {
                const d = s.data();
                if(!peerConnection.currentRemoteDescription && d?.answer) peerConnection.setRemoteDescription(d.answer);
                if(d?.status === 'connected') document.getElementById('callStatus').innerText = "Verbunden";
                if(d?.status === 'ended') window.hangUpCall();
            });
        };

        // 10. Ringtone & Incoming
        function startIncomingCallListener() {
            onSnapshot(query(collection(db, "calls"), where("status", "==", "ringing")), snap => {
                snap.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        const d = change.doc.data();
                        if(d.targetId === myRealUid) {
                            currentCallId = change.doc.id;
                            document.getElementById('callOverlay').classList.remove('hidden');
                            document.getElementById('incomingCallControls').classList.remove('hidden');
                            document.getElementById('activeCallControls').classList.add('hidden');
                            document.getElementById('callName').innerText = d.callerName;
                            document.getElementById('callStatus').innerText = "Eingehender Anruf...";
                            
                            // 10. Ringtone
                            const ring = document.getElementById('ringtone');
                            ring.currentTime = 0; ring.play();
                            sendNotification("Anruf", `${d.callerName} ruft an!`);
                        }
                    }
                });
            });
        }
        
        window.answerCall = async () => {
            document.getElementById('ringtone').pause();
            document.getElementById('incomingCallControls').classList.add('hidden');
            document.getElementById('activeCallControls').classList.remove('hidden');
            
            const callDoc = doc(db, "calls", currentCallId);
            const callData = (await getDoc(callDoc)).data();
            
            localStream = await navigator.mediaDevices.getUserMedia({audio:true});
            peerConnection = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
            peerConnection.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
            peerConnection.onicecandidate = e => e.candidate && addDoc(collection(callDoc, 'answerCandidates'), e.candidate.toJSON());
            
            await peerConnection.setRemoteDescription(callData.offer);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            await updateDoc(callDoc, { answer: {sdp: answer.sdp, type: answer.type}, status: 'connected' });
        };

        window.hangUpCall = async () => {
            document.getElementById('ringtone').pause();
            if(currentCallId) updateDoc(doc(db, "calls", currentCallId), { status: 'ended' });
            if(peerConnection) peerConnection.close();
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
            document.getElementById('callOverlay').classList.add('hidden');
            window.location.reload(); // Quick reset for WebRTC state
        };

        // --- GROUP ADMIN LOGIC (13.) ---
        window.createGrp = async () => {
            const name = document.getElementById('ng_name').value;
            // 13. 8-Stellige ID
            const gid = Math.random().toString(36).slice(-8).toUpperCase();
            
            await setDoc(doc(db, "chats", gid), {
                type: 'group', name, 
                members: [myRealUid],
                admins: [myRealUid], // Creator is admin
                creator: myRealUid,
                lastActivity: serverTimestamp()
            });
            window.toggleModal('newGroupModal');
            showToast("Gruppe erstellt: " + gid);
        };

        // Render Members list with Admin controls
        function renderGroupInfo(members, admins, creator) {
            const list = document.getElementById('infoMemberList');
            list.innerHTML = "";
            const iAmAdmin = admins.includes(myRealUid);

            members.forEach(async mid => {
                const uSnap = await getDoc(doc(db, "users", mid));
                if(!uSnap.exists()) return;
                const u = uSnap.data();
                const isUserAdmin = admins.includes(mid);
                const isUserCreator = mid === creator;

                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 hover:bg-slate-50 dark:hover:bg-slate-900 rounded-lg";
                
                let badges = "";
                if(isUserCreator) badges += `<span class="text-[9px] bg-yellow-100 text-yellow-600 px-1 rounded ml-1">OWNER</span>`;
                else if(isUserAdmin) badges += `<span class="text-[9px] bg-blue-100 text-blue-600 px-1 rounded ml-1">ADMIN</span>`;

                let controls = "";
                // 13. Admin Controls (Kick, Promote) - Creator cannot be touched
                if(iAmAdmin && mid !== myRealUid && mid !== creator) {
                    controls = `
                    <div class="flex gap-1">
                        ${!isUserAdmin ? `<button onclick="window.grpAction('promote','${mid}')" class="text-blue-500 p-1" title="Admin machen"><i data-lucide="shield" class="w-3 h-3"></i></button>` : `<button onclick="window.grpAction('demote','${mid}')" class="text-orange-500 p-1"><i data-lucide="shield-off" class="w-3 h-3"></i></button>`}
                        <button onclick="window.grpAction('kick','${mid}')" class="text-red-500 p-1" title="Kicken"><i data-lucide="user-minus" class="w-3 h-3"></i></button>
                    </div>`;
                }

                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${u.avatar || 'https://api.dicebear.com/7.x/initials/svg?seed='+u.nickname}" class="w-8 h-8 rounded-full">
                        <span class="text-sm font-bold">${u.nickname} ${badges}</span>
                    </div>
                    ${controls}
                `;
                list.appendChild(div);
                lucide.createIcons();
            });
        }

        window.grpAction = async (action, targetId) => {
            const ref = doc(db, "chats", activeChatId);
            if(action === 'kick') {
                if(confirm("Nutzer entfernen?")) await updateDoc(ref, { members: arrayRemove(targetId), admins: arrayRemove(targetId) });
            }
            if(action === 'promote') await updateDoc(ref, { admins: arrayUnion(targetId) });
            if(action === 'demote') await updateDoc(ref, { admins: arrayRemove(targetId) });
            // Refresh UI triggers automatically via Snapshot
        };

        // Helpers for Chat List
        function loadChats() {
            onSnapshot(query(collection(db, "chats"), orderBy("lastActivity", "desc"), limit(50)), snap => {
                const cont = document.getElementById('chatListContainer');
                const pinCont = document.getElementById('pinnedChats');
                cont.innerHTML = ""; pinCont.innerHTML = "";
                let hasPinned = false;

                snap.forEach(d => {
                    const c = d.data();
                    if(c.members?.includes(myRealUid) || c.participants?.includes(myRealUid)) {
                        const isPinned = c.pinned?.[myRealUid];
                        const div = document.createElement('div');
                        // Styling Logic...
                        let name = c.name;
                        if(c.type === 'private') {
                             const pid = c.participants.find(x => x !== myRealUid);
                             // Async Name fetch placeholder
                             name = c.names?.[pid] || "User"; 
                        }
                        
                        div.className = "flex items-center gap-4 p-4 hover:bg-slate-50 dark:hover:bg-slate-900 cursor-pointer transition border-b dark:border-slate-800/50";
                        if(activeChatId === d.id) div.classList.add('bg-slate-100', 'dark:bg-slate-800');
                        
                        div.innerHTML = `
                            <div class="relative">
                                <img src="https://api.dicebear.com/7.x/initials/svg?seed=${name}" class="w-12 h-12 rounded-full object-cover">
                                ${isPinned ? '<div class="absolute -top-1 -right-1 bg-wa-accent text-white p-0.5 rounded-full"><i data-lucide="pin" class="w-3 h-3"></i></div>' : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between">
                                    <h4 class="font-bold text-sm truncate dark:text-slate-100">${name}</h4>
                                    <span class="text-[10px] text-slate-400">${c.lastActivity ? new Date(c.lastActivity.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                                </div>
                                <p class="text-xs text-slate-500 truncate dark:text-slate-400">${c.lastMessage || 'Start a chat'}</p>
                            </div>
                        `;
                        div.onclick = () => window.openChat(d.id, name, c.type==='private');

                        if(isPinned) { hasPinned = true; pinCont.appendChild(div); }
                        else cont.appendChild(div);
                    }
                });
                pinCont.classList.toggle('hidden', !hasPinned);
                lucide.createIcons();
            });
        }
        
        // Init Mobile Helper
        window.closeChatMobile = () => {
            document.getElementById('chatArea').classList.add('hidden');
            document.getElementById('mainSidebar').classList.remove('hidden');
            activeChatId = null;
        };

        // Additional utility to handle the generic imports
        window.getDocs = getDocs; 
        window.arrayUnion = arrayUnion;
        window.arrayRemove = arrayRemove;
        
    </script>
</body>
</html>
