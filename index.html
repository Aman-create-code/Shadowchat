<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#111b21">
    <meta name="description" content="ShadowChat Ultimate V12 - Pro Edition">
    <meta name="author" content="Amancreatecode">
    <title>ShadowChat Ultimate V12 - Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#ffffff', 
                            dark: '#111b21', 
                            panelLight: '#f0f2f5',
                            panel: '#202c33',
                            panelHover: '#2a3942',
                            accent: '#00a884', 
                            accentHover: '#008f6f',
                            bubbleOut: '#005c4b', 
                            bubbleIn: '#202c33',
                            system: '#182229',
                            danger: '#ef4444',
                            success: '#22c55e'
                        }
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['Fira Code', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'slide-down': 'slideDown 0.3s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'scale-in': 'scaleIn 0.15s ease-out forwards',
                        'pulse-rec': 'pulseRed 1.5s infinite',
                        'pop': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideDown: { '0%': { transform: 'translateY(-20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        pulseRed: { '0%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' }, '70%': { boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' }, '100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0)' } },
                        popIn: { '0%': { transform: 'scale(0)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { 
            --app-height: 100dvh; 
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'SF Pro Display', sans-serif; 
            overflow: hidden; 
            height: var(--app-height); 
            background-color: #0b141a; 
            user-select: none; 
            color: #e9edef;
        }

        /* Scrollbar Styling */
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgba(134, 150, 160, 0.3) transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(134, 150, 160, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(134, 150, 160, 0.5); }

        /* Glassmorphism & Modals */
        .glass-modal { 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            background-color: rgba(0,0,0,0.75); 
        }

        /* Nachrichten Animationen */
        .msg-enter { opacity: 0; transform: translateY(10px); animation: msgSlide 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes msgSlide { to { opacity: 1; transform: translateY(0); } }
        
        .swipe-active { transform: translateX(50px); transition: transform 0.2s ease-out; }
        
        /* Kontext Menü */
        #contextMenu { 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); 
            z-index: 9999;
            transform-origin: top left;
        }

        /* Call Overlay */
        .call-bg { 
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            backdrop-filter: blur(20px);
        }
        
        .ripple { 
            position: absolute; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); 
            animation: rippleAnim 2s infinite ease-out; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .ripple:nth-child(2) { animation-delay: 0.5s; }
        .ripple:nth-child(3) { animation-delay: 1s; }
        
        @keyframes rippleAnim { 
            0% { width: 0; height: 0; opacity: 0.8; } 
            100% { width: 300px; height: 300px; opacity: 0; } 
        }

        /* Typing Dots */
        .typing-indicator span {
            display: inline-block; width: 4px; height: 4px; background-color: #00a884; border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both; margin: 0 1px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Audio Player Custom Styles */
        .audio-player { display: flex; align-items: center; gap: 8px; width: 220px; }
        .audio-progress { flex: 1; height: 3px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; position: relative; }
        .audio-bar { height: 100%; background: #00a884; width: 0%; transition: width 0.1s linear; }

        /* Range Input Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #00a884; margin-top: -6px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #374045; border-radius: 2px; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #00a884; }
        .toggle-checkbox:checked + .toggle-label { background-color: #00a884; }
        
        .admin-crown { color: #ffd700; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8)); }
        
        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; padding: 12px 20px; border-radius: 8px; background: #202c33; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: slideDown 0.3s forwards; border-left: 4px solid #00a884; font-size: 14px; font-weight: 500; }
        .toast.error { border-left-color: #ef4444; }
        .toast.info { border-left-color: #3b82f6; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full overflow-hidden text-gray-100 bg-[#0b141a]">

    <audio id="sound-msg-in" src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" preload="auto"></audio>
    <audio id="sound-msg-out" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
    <audio id="sound-ring" src="https://assets.mixkit.co/sfx/preview/mixkit-waiting-ringtone-1354.mp3" loop preload="auto"></audio>
    <audio id="remoteAudio" autoplay playsinline></audio>
    <audio id="localAudio" muted autoplay playsinline></audio>

    <div id="toast-container"></div>

    <div id="lightbox" class="fixed inset-0 z-[300] bg-black/95 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="absolute top-0 w-full p-4 flex justify-end">
            <button onclick="UI.closeLightbox()" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <img id="lightbox-img" class="max-h-[85vh] max-w-[95vw] object-contain shadow-2xl rounded">
        <div id="lightbox-caption" class="mt-4 text-center text-gray-300 font-medium"></div>
    </div>

    <div id="contextMenu" class="fixed hidden bg-[#233138] rounded-lg shadow-xl overflow-hidden min-w-[200px] ring-1 ring-white/5 animate-scale-in">
        <div class="flex justify-between p-2 bg-[#182229] border-b border-gray-700" id="ctx-reactions">
            </div>
        <div class="py-1">
            <button onclick="Chat.handleCtxAction('reply')" class="w-full text-left px-4 py-3 hover:bg-[#182229] flex items-center gap-3 text-sm text-gray-200">
                <i data-lucide="reply" class="w-4 h-4"></i> Antworten
            </button>
            <button onclick="Chat.handleCtxAction('copy')" class="w-full text-left px-4 py-3 hover:bg-[#182229] flex items-center gap-3 text-sm text-gray-200">
                <i data-lucide="copy" class="w-4 h-4"></i> Kopieren
            </button>
            <button onclick="Chat.handleCtxAction('forward')" class="w-full text-left px-4 py-3 hover:bg-[#182229] flex items-center gap-3 text-sm text-gray-200">
                <i data-lucide="forward" class="w-4 h-4"></i> Weiterleiten
            </button>
            <div id="ctx-owner-actions" class="border-t border-gray-700 mt-1 pt-1 hidden">
                <button onclick="Chat.handleCtxAction('edit')" class="w-full text-left px-4 py-3 hover:bg-[#182229] flex items-center gap-3 text-sm text-gray-200">
                    <i data-lucide="pencil" class="w-4 h-4"></i> Bearbeiten
                </button>
                <button onclick="Chat.handleCtxAction('delete')" class="w-full text-left px-4 py-3 hover:bg-red-900/30 text-red-400 flex items-center gap-3 text-sm">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Löschen
                </button>
            </div>
        </div>
    </div>

    <aside id="sidebar" class="w-full md:w-[400px] lg:w-[450px] flex flex-col border-r border-gray-800 bg-[#111b21] z-20 shrink-0 h-full transition-transform duration-300">
        
        <header class="h-[60px] bg-[#202c33] flex items-center justify-between px-4 shrink-0 shadow-sm z-30">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="UI.switchTab('settings')">
                <div id="my-avatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-[#00a884] to-[#005c4b] flex items-center justify-center font-bold text-white text-lg shadow-md group-hover:scale-105 transition-transform">
                    ?
                </div>
                <div class="hidden sm:block">
                    <div class="font-bold text-sm text-gray-100" id="my-nick-display">Laden...</div>
                    <div class="text-[10px] text-[#00a884] font-bold tracking-wide">ULTIMATE PRO</div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 text-gray-400">
                <button onclick="UI.toggleModal('modal-new-group')" class="p-2 rounded-full hover:bg-white/10 transition" title="Neue Gruppe">
                    <i data-lucide="users-round" class="w-5 h-5"></i>
                </button>
                <button onclick="UI.toggleModal('modal-join-group')" class="p-2 rounded-full hover:bg-white/10 transition" title="Beitreten">
                    <i data-lucide="log-in" class="w-5 h-5"></i>
                </button>
                <div class="relative group">
                    <button class="p-2 rounded-full hover:bg-white/10 transition">
                        <i data-lucide="more-vertical" class="w-5 h-5"></i>
                    </button>
                    <div class="absolute right-0 top-full mt-1 w-48 bg-[#233138] rounded-lg shadow-xl border border-gray-700 hidden group-hover:block z-50 py-1">
                        <button onclick="UI.switchTab('settings')" class="w-full text-left px-4 py-2 hover:bg-[#182229] text-sm">Einstellungen</button>
                        <button onclick="Auth.logout()" class="w-full text-left px-4 py-2 hover:bg-[#182229] text-sm text-red-400">Abmelden</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-2 bg-[#111b21] border-b border-gray-800">
            <div class="bg-[#202c33] flex items-center px-4 py-1.5 rounded-lg focus-within:ring-1 ring-[#00a884] transition-all">
                <i data-lucide="search" class="w-4 h-4 text-gray-400 mr-3"></i>
                <input id="search-input" type="text" placeholder="Suchen oder neuer Chat" class="bg-transparent text-sm w-full outline-none text-white placeholder-gray-500" onkeyup="Chat.filterChats()">
            </div>
        </div>
        
        <div class="flex justify-around bg-[#111b21] border-b border-gray-800">
            <button onclick="UI.switchTab('chats')" id="tab-btn-chats" class="flex-1 py-3 text-[#00a884] border-b-2 border-[#00a884] transition hover:bg-[#202c33]/30">
                <i data-lucide="message-square" class="w-5 h-5 mx-auto"></i>
            </button>
            <button onclick="UI.switchTab('calls')" id="tab-btn-calls" class="flex-1 py-3 text-gray-500 border-b-2 border-transparent transition hover:bg-[#202c33]/30">
                <i data-lucide="phone" class="w-5 h-5 mx-auto"></i>
            </button>
            <button onclick="UI.switchTab('status')" id="tab-btn-status" class="flex-1 py-3 text-gray-500 border-b-2 border-transparent transition hover:bg-[#202c33]/30">
                <i data-lucide="circle-dashed" class="w-5 h-5 mx-auto"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative bg-[#111b21]">
            
            <div id="view-chats" class="tab-view h-full">
                <div id="chat-list" class="divide-y divide-gray-800">
                    <div class="flex flex-col items-center justify-center h-32 text-gray-500 gap-2">
                        <div class="w-6 h-6 border-2 border-[#00a884] border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-xs">Chats werden geladen...</span>
                    </div>
                </div>
            </div>

            <div id="view-calls" class="tab-view hidden h-full p-2">
                <div class="px-4 py-2 text-xs font-bold text-[#00a884] uppercase tracking-widest bg-[#111b21]">Anrufverlauf</div>
                <div id="call-list" class="space-y-1">
                    </div>
            </div>

            <div id="view-status" class="tab-view hidden h-full p-4">
                <div class="flex items-center gap-4 mb-6 cursor-pointer p-2 rounded-xl hover:bg-[#202c33] transition" onclick="document.getElementById('status-input').click()">
                    <div class="relative w-12 h-12">
                        <div class="w-12 h-12 rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center overflow-hidden">
                             <img id="my-status-prev" class="w-full h-full object-cover hidden">
                             <i data-lucide="camera" class="w-5 h-5 text-gray-500" id="my-status-icon"></i>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-[#00a884] rounded-full p-0.5 border-2 border-[#111b21]">
                            <i data-lucide="plus" class="w-3 h-3 text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-200">Mein Status</h3>
                        <p class="text-xs text-gray-500">Tippe für Update</p>
                    </div>
                    <input type="file" id="status-input" class="hidden" accept="image/*" onchange="Chat.uploadStatus()">
                </div>
                <div class="text-xs font-bold text-gray-500 mb-2 uppercase">Aktuell</div>
                <div id="status-list" class="space-y-3"></div>
            </div>

            <div id="view-settings" class="tab-view hidden h-full p-4 pb-20">
                <div class="flex flex-col items-center mb-6 pt-4">
                    <div class="w-24 h-24 rounded-full bg-[#202c33] mb-4 flex items-center justify-center text-4xl text-gray-400" id="settings-avatar">?</div>
                    <h2 class="text-xl font-bold text-white" id="settings-nick">User</h2>
                    <p class="text-sm text-gray-500" id="settings-id">ID: ...</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-[#202c33] p-4 rounded-xl border border-gray-800">
                        <h4 class="text-[#00a884] text-xs font-bold uppercase mb-3">Profil bearbeiten</h4>
                        <input id="input-nick" type="text" class="w-full bg-transparent border-b border-gray-600 p-2 text-white outline-none focus:border-[#00a884] mb-4 transition" placeholder="Dein Name">
                        <textarea id="input-bio" class="w-full bg-transparent border-b border-gray-600 p-2 text-white outline-none focus:border-[#00a884] resize-none h-20 transition" placeholder="Deine Bio"></textarea>
                        <button onclick="Auth.updateProfile()" class="w-full bg-[#00a884] hover:bg-[#008f6f] text-white py-2 rounded-lg font-bold text-sm mt-2 transition">SPEICHERN</button>
                    </div>

                    <div class="bg-[#202c33] p-4 rounded-xl border border-gray-800">
                        <h4 class="text-[#00a884] text-xs font-bold uppercase mb-3">App Einstellungen</h4>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700/50">
                            <span>Benachrichtigungen</span>
                            <input type="checkbox" id="toggle-notify" class="accent-[#00a884] w-4 h-4" onchange="UI.toggleSetting('notify', this.checked)">
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span>Töne</span>
                            <input type="checkbox" id="toggle-sound" class="accent-[#00a884] w-4 h-4" onchange="UI.toggleSetting('sound', this.checked)">
                        </div>
                    </div>

                    <div class="bg-[#202c33] p-4 rounded-xl border border-gray-800">
                        <h4 class="text-red-500 text-xs font-bold uppercase mb-3">Gefahrenzone</h4>
                        <button onclick="Auth.deleteAccount()" class="w-full border border-red-500/30 text-red-500 py-2 rounded-lg hover:bg-red-500/10 transition text-sm font-bold flex items-center justify-center gap-2">
                            <i data-lucide="trash" class="w-4 h-4"></i> ACCOUNT LÖSCHEN
                        </button>
                    </div>

                    <footer class="text-center mt-8 opacity-40">
                        <p class="text-xs font-mono">ShadowChat Ultimate V12</p>
                        <p class="text-[10px] text-[#00a884] font-bold mt-1">© Amancreatecode 2026</p>
                    </footer>
                </div>
            </div>
        </div>
    </aside>

    <main id="main-chat" class="hidden md:flex flex-1 flex-col h-full relative bg-[#0b141a] z-10 transition-all duration-300">
        
        <div class="absolute inset-0 opacity-[0.06] pointer-events-none z-0" 
             style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px;">
        </div>

        <header id="chat-header" class="hidden h-[60px] bg-[#202c33] flex items-center justify-between px-4 z-20 border-b border-gray-800 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="UI.closeChat()" class="md:hidden p-2 -ml-2 text-gray-400 hover:text-white"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <div id="header-avatar" class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold cursor-pointer" onclick="UI.toggleModal('modal-info')">?</div>
                <div class="cursor-pointer" onclick="UI.toggleModal('modal-info')">
                    <h2 id="header-title" class="font-bold text-gray-100 leading-tight">Wähle einen Chat</h2>
                    <p id="header-status" class="text-xs text-gray-400 truncate max-w-[200px] h-4">...</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="Call.start()" class="p-2 text-[#00a884] hover:bg-gray-700/50 rounded-full transition" title="Anrufen"><i data-lucide="phone" class="w-5 h-5 fill-current"></i></button>
                <button onclick="UI.toggleModal('modal-info')" class="p-2 text-gray-400 hover:bg-gray-700/50 rounded-full transition"><i data-lucide="info" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:px-12 space-y-1 relative z-10 custom-scrollbar flex flex-col">
            </div>

        <button id="scroll-btn" onclick="UI.scrollToBottom(true)" class="absolute bottom-24 right-6 z-20 bg-[#202c33] text-[#00a884] p-3 rounded-full shadow-lg scale-0 transition-transform duration-200 hover:bg-[#2a3942]">
            <i data-lucide="chevron-down" class="w-5 h-5"></i>
        </button>

        <footer id="chat-footer" class="hidden min-h-[62px] bg-[#202c33] px-2 py-2 flex flex-col z-20 relative">
            
            <div id="reply-preview" class="hidden bg-[#0b141a]/50 p-2 rounded-lg mb-2 border-l-4 border-[#00a884] flex justify-between items-center mx-2 animate-slide-up backdrop-blur-sm">
                <div class="overflow-hidden">
                    <div class="text-[#00a884] text-xs font-bold mb-0.5" id="reply-to-name">Name</div>
                    <div class="text-gray-400 text-xs truncate" id="reply-to-text">Nachricht...</div>
                </div>
                <button onclick="Chat.cancelReply()" class="p-1 hover:bg-gray-700 rounded-full"><i data-lucide="x" class="w-4 h-4 text-gray-400"></i></button>
            </div>

            <div id="image-preview" class="hidden p-4 bg-[#111b21] border-t border-gray-700 absolute bottom-full left-0 w-full z-10">
                <div class="relative inline-block">
                    <img id="img-preview-src" class="h-32 rounded-lg border border-[#00a884] shadow-lg">
                    <button onclick="Chat.clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:scale-110 transition"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            </div>

            <div class="flex items-end gap-2 px-2">
                <button onclick="document.getElementById('file-input').click()" class="p-3 text-gray-400 hover:text-gray-200 transition rounded-full hover:bg-gray-700/30 mb-1">
                    <i data-lucide="paperclip" class="w-6 h-6"></i>
                </button>
                <input type="file" id="file-input" class="hidden" accept="image/*" onchange="Chat.handleFileSelect()">

                <div class="flex-1 bg-[#2a3942] rounded-xl flex items-center px-4 py-2 mb-1 border border-transparent focus-within:border-[#00a884]/50 transition-colors">
                    <textarea id="msg-input" placeholder="Nachricht schreiben..." class="w-full bg-transparent outline-none text-white text-[15px] resize-none max-h-[100px] custom-scrollbar placeholder-gray-500" rows="1" oninput="Chat.adjustHeight(this); Chat.handleTyping();" onkeydown="Chat.handleEnter(event)"></textarea>
                </div>

                <div class="relative w-12 h-12 mb-1 flex items-center justify-center">
                    <button id="btn-mic" onmousedown="Voice.start()" onmouseup="Voice.stop()" ontouchstart="Voice.start()" ontouchend="Voice.stop()" class="absolute inset-0 bg-[#00a884] hover:bg-[#008f6f] text-white rounded-full shadow-lg flex items-center justify-center transition-all z-10 active:scale-110">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                    </button>
                    <button id="btn-send" onclick="Chat.send()" class="absolute inset-0 bg-[#00a884] hover:bg-[#008f6f] text-white rounded-full shadow-lg flex items-center justify-center transition-all z-20 hidden transform scale-0">
                        <i data-lucide="send-horizontal" class="w-5 h-5 ml-0.5"></i>
                    </button>
                </div>
            </div>

            <div id="recording-ui" class="hidden absolute top-0 left-0 w-full h-full bg-[#202c33] flex items-center justify-center gap-3 z-30 animate-pulse-rec border-t border-red-500/50">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-bounce"></div>
                <span class="text-red-500 font-bold tracking-wider text-sm">AUFNAHME... (Loslassen zum Senden)</span>
            </div>
        </footer>
    </main>

    <div id="call-overlay" class="hidden fixed inset-0 z-[200] call-bg text-white flex flex-col items-center justify-between py-12 px-6">
        <div class="text-center mt-10 w-full relative">
            <div class="flex items-center justify-center gap-2 text-xs font-bold text-[#00a884] bg-black/20 px-3 py-1 rounded-full w-fit mx-auto mb-8 backdrop-blur">
                <i data-lucide="lock" class="w-3 h-3"></i> Ende-zu-Ende verschlüsselt
            </div>
            
            <div class="relative w-40 h-40 mx-auto mb-6">
                <div class="ripple"></div><div class="ripple"></div>
                <div id="call-avatar" class="w-40 h-40 rounded-full bg-gray-700 flex items-center justify-center text-6xl font-bold shadow-2xl relative z-10 border-4 border-white/10">?</div>
            </div>
            
            <h2 id="call-name" class="text-3xl font-bold mb-2">Unbekannt</h2>
            <p id="call-status" class="text-lg text-gray-300 font-medium animate-pulse">Verbinden...</p>
        </div>

        <div id="call-controls-active" class="hidden w-full max-w-sm grid grid-cols-3 gap-6 mb-8 animate-slide-up">
            <button onclick="Call.toggleMute()" id="btn-mute" class="flex flex-col items-center gap-2 group">
                <div class="w-14 h-14 rounded-full bg-white/10 backdrop-blur flex items-center justify-center group-hover:bg-white/20 transition"><i data-lucide="mic" class="w-6 h-6"></i></div>
                <span class="text-xs">Stumm</span>
            </button>
            <button class="flex flex-col items-center gap-2 opacity-50"><div class="w-14 h-14 rounded-full bg-white/10 flex items-center justify-center"><i data-lucide="video-off" class="w-6 h-6"></i></div><span class="text-xs">Video</span></button>
            <button onclick="Call.end()" class="flex flex-col items-center gap-2">
                <div class="w-14 h-14 rounded-full bg-red-500 shadow-lg flex items-center justify-center hover:scale-110 transition"><i data-lucide="phone-off" class="w-6 h-6 fill-current"></i></div>
                <span class="text-xs font-bold text-red-400">Auflegen</span>
            </button>
        </div>

        <div id="call-controls-incoming" class="hidden w-full max-w-sm flex justify-around items-center mb-12 animate-slide-up">
            <div class="flex flex-col items-center gap-2">
                <button onclick="Call.end()" class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center hover:scale-110 transition shadow-lg"><i data-lucide="phone-off" class="w-8 h-8 fill-current"></i></button>
                <span class="text-sm font-bold">Ablehnen</span>
            </div>
            <div class="flex flex-col items-center gap-2">
                <button onclick="Call.answer()" class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center hover:scale-110 transition shadow-lg animate-bounce"><i data-lucide="phone" class="w-8 h-8 fill-current"></i></button>
                <span class="text-sm font-bold">Annehmen</span>
            </div>
        </div>
    </div>

    <div id="modal-new-group" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-[#202c33] w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700 animate-pop">
            <h3 class="text-xl font-black mb-4 text-white">Neue Gruppe erstellen</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] uppercase font-bold text-[#00a884] ml-1">Gruppenname</label>
                    <input id="ng-name" type="text" class="w-full bg-[#111b21] p-3 rounded-lg text-white outline-none focus:ring-1 ring-[#00a884] border border-gray-700" placeholder="z.B. Team Rocket">
                </div>
                <div>
                    <label class="text-[10px] uppercase font-bold text-gray-500 ml-1">Passwort (Optional)</label>
                    <input id="ng-pass" type="password" class="w-full bg-[#111b21] p-3 rounded-lg text-white outline-none border border-gray-700" placeholder="Geheim...">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="UI.toggleModal('modal-new-group')" class="px-4 py-2 text-gray-400 font-bold hover:bg-white/5 rounded-lg">Abbrechen</button>
                <button onclick="Chat.createGroup()" class="bg-[#00a884] px-6 py-2 rounded-lg text-white font-bold hover:bg-[#008f6f] shadow-lg">Erstellen</button>
            </div>
        </div>
    </div>

    <div id="modal-join-group" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-[#202c33] w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700 animate-pop">
            <h3 class="text-xl font-black mb-2 text-white">Gruppe beitreten</h3>
            <p class="text-xs text-gray-500 mb-4">Erfrage die Gruppen-ID beim Admin.</p>
            <div class="space-y-4">
                <input id="jg-id" type="text" class="w-full bg-[#111b21] p-3 rounded-lg text-white outline-none font-mono uppercase text-center tracking-widest border border-gray-700 focus:border-[#00a884]" placeholder="GRP-XXXXXX">
                <input id="jg-pass" type="password" class="w-full bg-[#111b21] p-3 rounded-lg text-white outline-none text-center border border-gray-700" placeholder="Passwort (falls nötig)">
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="UI.toggleModal('modal-join-group')" class="px-4 py-2 text-gray-400 font-bold hover:bg-white/5 rounded-lg">Zurück</button>
                <button onclick="Chat.joinGroup()" class="bg-[#00a884] px-6 py-2 rounded-lg text-white font-bold hover:bg-[#008f6f] shadow-lg">Beitreten</button>
            </div>
        </div>
    </div>

    <div id="modal-forward" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-[#202c33] w-full max-w-sm rounded-2xl shadow-2xl border border-gray-700 flex flex-col max-h-[70vh] animate-pop">
            <div class="p-4 border-b border-gray-700">
                <h3 class="font-bold text-white">Nachricht weiterleiten an...</h3>
            </div>
            <div id="forward-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                </div>
            <div class="p-3 border-t border-gray-700 text-right">
                <button onclick="UI.toggleModal('modal-forward')" class="text-gray-400 hover:text-white font-bold text-sm">Abbrechen</button>
            </div>
        </div>
    </div>

    <div id="modal-info" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-[#202c33] w-full max-w-md rounded-[30px] overflow-hidden shadow-2xl flex flex-col max-h-[85vh] border border-gray-700 animate-slide-up">
            <div class="h-32 bg-gradient-to-r from-[#00a884] to-[#005c4b] relative shrink-0">
                <button onclick="UI.toggleModal('modal-info')" class="absolute top-4 right-4 bg-black/30 text-white p-2 rounded-full hover:bg-black/50 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="info-avatar" class="absolute -bottom-10 left-8 w-24 h-24 rounded-2xl bg-[#202c33] p-1 shadow-xl">
                    <div class="w-full h-full bg-gray-600 rounded-xl flex items-center justify-center text-4xl font-bold text-white">?</div>
                </div>
            </div>
            <div class="pt-12 px-8 pb-6 flex-1 overflow-y-auto custom-scrollbar">
                <h2 id="info-title" class="text-2xl font-bold text-white">Chat Name</h2>
                <div class="flex items-center gap-2 mt-1">
                    <p id="info-id" class="text-xs font-mono text-[#00a884] bg-[#00a884]/10 px-2 py-0.5 rounded cursor-pointer select-all" onclick="Utils.copyToClipboard(this.innerText)">ID: ---</p>
                </div>
                
                <div id="info-group-section" class="mt-8">
                    <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest border-b border-gray-700 pb-2 mb-3">Teilnehmer</h4>
                    <div id="info-members" class="space-y-2"></div>
                </div>
            </div>
            <div class="p-4 bg-[#111b21] border-t border-gray-800 shrink-0">
                <button onclick="Chat.leaveChat()" id="btn-leave" class="w-full py-3 rounded-xl border border-red-500/30 text-red-500 font-bold hover:bg-red-500/10 transition flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Chat verlassen
                </button>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="hidden fixed inset-0 z-[150] bg-black/60 flex items-end md:items-center justify-center p-4 animate-fade-in">
        <div class="bg-[#202c33] w-full max-w-xs rounded-2xl p-4 shadow-2xl animate-slide-up border border-gray-700">
            <h3 class="font-bold text-center mb-1 text-white" id="admin-target-name">User verwalten</h3>
            <p class="text-center text-xs text-gray-500 mb-4">Wähle eine Aktion</p>
            <div class="space-y-2">
                <button onclick="Chat.execAdmin('kick')" class="w-full p-3 bg-red-500/10 text-red-400 rounded-lg font-bold text-sm flex items-center justify-center gap-2 hover:bg-red-500/20 transition">
                    <i data-lucide="user-x" class="w-4 h-4"></i> Aus der Gruppe entfernen
                </button>
                <button onclick="Chat.execAdmin('promote')" id="btn-promote" class="w-full p-3 bg-blue-500/10 text-blue-400 rounded-lg font-bold text-sm flex items-center justify-center gap-2 hover:bg-blue-500/20 transition">
                    <i data-lucide="shield-check" class="w-4 h-4"></i> Zum Admin machen
                </button>
                <button onclick="Chat.execAdmin('demote')" id="btn-demote" class="hidden w-full p-3 bg-gray-700/50 text-gray-300 rounded-lg font-bold text-sm flex items-center justify-center gap-2 hover:bg-gray-700 transition">
                    <i data-lucide="shield-off" class="w-4 h-4"></i> Admin entfernen
                </button>
            </div>
            <button onclick="document.getElementById('modal-admin').classList.add('hidden')" class="w-full mt-4 p-2 text-gray-500 font-bold text-xs hover:text-white transition">ABBRECHEN</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- KONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE STORE ---
        const State = {
            user: null,
            uid: null,
            nick: "Gast",
            activeChat: null,
            isPrivate: false,
            soundEnabled: localStorage.getItem('shadow_sound') !== 'false',
            notifyEnabled: localStorage.getItem('shadow_notify') === 'true',
            listeners: { msg: null, presence: null, call: null },
            typingTimer: null,
            replyTarget: null,
            adminTarget: null,
            longPressTimer: null,
            selectedMsg: null,
            voice: { recorder: null, chunks: [] },
            webrtc: { pc: null, stream: null, callId: null, unsub: null },
            iceServers: { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] }
        };

        // --- UTILS CLASS ---
        class Utils {
            static showToast(msg, type = 'success') {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                const icons = { success: 'check', error: 'alert-circle', info: 'info' };
                t.innerHTML = `<i data-lucide="${icons[type]}" class="w-5 h-5 shrink-0"></i><span>${msg}</span>`;
                c.appendChild(t);
                lucide.createIcons();
                setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(-20px)'; setTimeout(() => t.remove(), 300); }, 3000);
            }

            static playSound(id) {
                if (State.soundEnabled) {
                    const el = document.getElementById(id);
                    if (el) { el.currentTime = 0; el.play().catch(() => {}); }
                }
            }

            static formatTime(timestamp) {
                if (!timestamp) return '...';
                const d = timestamp.toDate();
                const now = new Date();
                if (d.toDateString() === now.toDateString()) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            static copyToClipboard(text) {
                navigator.clipboard.writeText(text);
                this.showToast("In Zwischenablage kopiert", 'info');
            }
            
            static sendNotification(title, body) {
                if(State.notifyEnabled && Notification.permission === "granted" && document.hidden) {
                    new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png' });
                }
            }
        }

        // --- UI MANAGER ---
        class UI {
            static switchTab(tab) {
                document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('[id^="tab-btn-"]').forEach(el => {
                    el.classList.remove('text-[#00a884]', 'border-[#00a884]');
                    el.classList.add('text-gray-500', 'border-transparent');
                });
                
                document.getElementById(`view-${tab}`).classList.remove('hidden');
                document.getElementById(`view-${tab}`).classList.add('animate-fade-in');
                
                const btn = document.getElementById(`tab-btn-${tab}`);
                if(btn) {
                    btn.classList.remove('text-gray-500', 'border-transparent');
                    btn.classList.add('text-[#00a884]', 'border-[#00a884]');
                }
                
                // Mobile Sidebar Logic
                if(window.innerWidth < 768 && tab === 'chats') {
                     // Stay on sidebar
                }
            }

            static toggleModal(id) {
                const el = document.getElementById(id);
                el.classList.toggle('hidden');
                if(!el.classList.contains('hidden')) {
                    // Reset Inputs
                    el.querySelectorAll('input').forEach(i => i.value = '');
                }
            }

            static toggleSetting(key, val) {
                if(key === 'sound') State.soundEnabled = val;
                if(key === 'notify') {
                    State.notifyEnabled = val;
                    if(val && Notification.permission !== 'granted') Notification.requestPermission();
                }
                localStorage.setItem(`shadow_${key}`, val);
                Utils.showToast(`Einstellung ${val ? 'aktiviert' : 'deaktiviert'}`);
            }

            static openLightbox(src, caption) {
                document.getElementById('lightbox-img').src = src;
                document.getElementById('lightbox-caption').innerText = caption || "";
                document.getElementById('lightbox').classList.remove('hidden');
                setTimeout(() => document.getElementById('lightbox').classList.remove('opacity-0'), 10);
            }

            static closeLightbox() {
                document.getElementById('lightbox').classList.add('opacity-0');
                setTimeout(() => document.getElementById('lightbox').classList.add('hidden'), 300);
            }

            static closeChat() {
                document.getElementById('main-chat').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                State.activeChat = null;
                if(State.listeners.msg) State.listeners.msg();
                if(State.listeners.presence) State.listeners.presence();
            }

            static scrollToBottom(smooth = false) {
                const c = document.getElementById('messages-container');
                c.scrollTo({ top: c.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
            }
        }

        // --- AUTH & PROFILE ---
        class Auth {
            static async init() {
                const storedUid = localStorage.getItem('shadow_uid');
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        State.uid = storedUid || u.uid;
                        if (!storedUid) localStorage.setItem('shadow_uid', State.uid);
                        State.user = u;
                        
                        await this.syncProfile();
                        this.setupPresence();
                        Chat.loadList();
                        Call.initHistory();
                        Chat.loadGlobalStatus();
                        Call.listen(); // Call Listener Start

                        // Settings UI Init
                        document.getElementById('toggle-sound').checked = State.soundEnabled;
                        document.getElementById('toggle-notify').checked = State.notifyEnabled;
                    }
                });
            }

            static async syncProfile() {
                const ref = doc(db, "users", State.uid);
                const snap = await getDoc(ref);
                
                if (!snap.exists()) {
                    State.nick = "User-" + Math.floor(Math.random() * 9999);
                    await setDoc(ref, { 
                        uid: State.uid, 
                        nickname: State.nick, 
                        bio: "I use ShadowChat Ultimate.", 
                        online: true, 
                        lastSeen: serverTimestamp() 
                    });
                } else {
                    const d = snap.data();
                    State.nick = d.nickname;
                    document.getElementById('input-nick').value = State.nick;
                    document.getElementById('input-bio').value = d.bio || "";
                    document.getElementById('settings-id').innerText = "ID: " + State.uid;
                }
                
                this.updateUI();
            }

            static updateUI() {
                document.getElementById('my-nick-display').innerText = State.nick;
                document.getElementById('settings-nick').innerText = State.nick;
                document.getElementById('my-avatar').innerText = State.nick.substring(0,2).toUpperCase();
                document.getElementById('settings-avatar').innerText = State.nick.substring(0,2).toUpperCase();
            }

            static setupPresence() {
                const ref = doc(db, "users", State.uid);
                const update = (online) => updateDoc(ref, { online: online, lastSeen: serverTimestamp() });
                
                update(true);
                document.addEventListener('visibilitychange', () => update(document.visibilityState === 'visible'));
                window.addEventListener('beforeunload', () => update(false));
                setInterval(() => update(true), 60000); // Heartbeat
            }

            static async updateProfile() {
                const n = document.getElementById('input-nick').value.trim();
                const b = document.getElementById('input-bio').value.trim();
                if (n) {
                    await updateDoc(doc(db, "users", State.uid), { nickname: n, bio: b });
                    State.nick = n;
                    this.updateUI();
                    Utils.showToast("Profil gespeichert");
                }
            }

            static async logout() {
                if(confirm("Möchtest du dich abmelden?")) {
                    location.reload();
                }
            }
            
            static async deleteAccount() {
                const check = prompt("Tippe 'DELETE' um deinen Account unwiderruflich zu löschen.");
                if(check === 'DELETE') {
                    try {
                        await deleteDoc(doc(db, "users", State.uid));
                        localStorage.clear();
                        location.reload();
                    } catch(e) { Utils.showToast("Fehler beim Löschen", 'error'); }
                }
            }
        }

        // --- CHAT LOGIC ---
        class Chat {
            static loadList() {
                const q = query(collection(db, "chats"), orderBy("lastActivity", "desc"), limit(50));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('chat-list');
                    list.innerHTML = "";
                    
                    if(snap.empty) {
                        list.innerHTML = `<div class="p-8 text-center text-gray-500 text-sm">Keine Chats vorhanden.<br>Starte eine Gruppe oder warte auf Einladung.</div>`;
                        return;
                    }

                    snap.forEach(d => {
                        const c = d.data();
                        const isMember = c.type === 'group' ? c.members?.includes(State.uid) : c.participants?.includes(State.uid);
                        
                        if (isMember) {
                            let name = c.name;
                            if (c.type === 'private') {
                                const otherId = c.participants.find(id => id !== State.uid);
                                name = c.names?.[otherId] || "Unbekannt";
                            }

                            const isActive = State.activeChat === d.id;
                            const div = document.createElement('div');
                            div.className = `flex items-center gap-4 p-4 cursor-pointer hover:bg-[#202c33] border-b border-gray-800 transition ${isActive ? 'bg-[#2a3942]' : ''}`;
                            div.innerHTML = `
                                <div class="w-12 h-12 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-lg shadow-sm shrink-0 relative">
                                    ${name[0]}
                                    ${c.typing && Object.values(c.typing).some(v => v) ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-[#00a884] rounded-full border border-[#111b21] animate-bounce"></div>' : ''}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center mb-0.5">
                                        <h4 class="font-bold text-gray-100 truncate">${name}</h4>
                                        <span class="text-[10px] text-gray-500">${c.lastActivity ? Utils.formatTime(c.lastActivity) : ''}</span>
                                    </div>
                                    <p class="text-xs text-gray-400 truncate flex items-center gap-1">
                                        ${c.type === 'group' ? '<i data-lucide="users" class="w-3 h-3"></i>' : ''}
                                        ${c.lastMessage || 'Keine Nachrichten'}
                                    </p>
                                </div>`;
                            div.onclick = () => this.open(d.id, name, c.type === 'private');
                            list.appendChild(div);
                        }
                    });
                    lucide.createIcons();
                });
            }

            static async open(id, name, isPrivate) {
                State.activeChat = id;
                State.isPrivate = isPrivate;

                // UI Update
                if (window.innerWidth < 768) {
                    document.getElementById('sidebar').classList.add('hidden');
                    document.getElementById('main-chat').classList.remove('hidden');
                }
                document.getElementById('chat-header').classList.remove('hidden', 'flex');
                document.getElementById('chat-header').classList.add('flex');
                document.getElementById('chat-footer').classList.remove('hidden', 'flex');
                document.getElementById('chat-footer').classList.add('flex');
                
                document.getElementById('header-title').innerText = name;
                document.getElementById('header-avatar').innerText = name[0];
                document.getElementById('messages-container').innerHTML = ""; // Clear old
                
                this.updateInfoModal(id, name, isPrivate);

                // Typing Listener
                onSnapshot(doc(db, "chats", id), (s) => {
                    const d = s.data();
                    let typingText = "";
                    if (d.typing) {
                         const typers = Object.entries(d.typing).filter(([uid, isTyping]) => isTyping && uid !== State.uid);
                         if(typers.length > 0) typingText = "schreibt...";
                    }
                    
                    const statusEl = document.getElementById('header-status');
                    if (typingText) {
                        statusEl.innerHTML = `<span class="text-[#00a884] font-bold animate-pulse">${typingText}</span>`;
                    } else if (isPrivate) {
                        const pid = d.participants.find(p => p !== State.uid);
                        // Fetch partner status separate
                        getDoc(doc(db, "users", pid)).then(u => {
                            if(u.exists()) {
                                const online = u.data().online;
                                statusEl.innerText = online ? "Online" : `Zuletzt gesehen: ${Utils.formatTime(u.data().lastSeen)}`;
                            }
                        });
                    } else {
                        statusEl.innerText = `${d.members.length} Mitglieder`;
                    }
                });

                // Messages Listener
                if(State.listeners.msg) State.listeners.msg();
                const q = query(collection(db, `chats/${id}/messages`), orderBy("timestamp", "asc"), limit(60));
                
                State.listeners.msg = onSnapshot(q, (snap) => {
                    const cont = document.getElementById('messages-container');
                    let isScrolledBottom = (cont.scrollHeight - cont.scrollTop - cont.clientHeight) < 100;
                    
                    // Render changes only (optimization not fully implemented for simplicity, re-render all safe for <60 msg)
                    cont.innerHTML = ""; 
                    
                    // Mark read
                    snap.docs.forEach(d => {
                        const m = d.data();
                        if(!m.readBy.includes(State.uid)) updateDoc(d.ref, { readBy: arrayUnion(State.uid) });
                    });

                    snap.forEach(d => {
                        const m = d.data();
                        this.renderMessage(d.id, m, cont);
                    });

                    if(isScrolledBottom || snap.docChanges().some(c => c.type === 'added')) {
                         UI.scrollToBottom(snap.docChanges().length > 1); // Smooth only on single new
                         if(snap.docChanges().length === 1) Utils.playSound('sound-msg-in');
                    }
                    lucide.createIcons();
                });
            }

            static renderMessage(id, m, container) {
                const isMe = m.senderId === State.uid;
                const div = document.createElement('div');
                div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} group mb-1 msg-enter relative select-none`;
                div.id = `msg-${id}`;

                // Swipe Logic
                let touchStartX = 0;
                div.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
                div.addEventListener('touchend', e => {
                    if (e.changedTouches[0].screenX - touchStartX > 60) {
                        this.triggerReply(id, m.text, m.senderName);
                        div.classList.add('swipe-active');
                        setTimeout(() => div.classList.remove('swipe-active'), 300);
                        if(navigator.vibrate) navigator.vibrate(50);
                    }
                });

                // Context Menu Logic
                const handleCtx = (e) => {
                    e.preventDefault();
                    this.showContextMenu(e, id, m, isMe);
                };
                div.addEventListener('contextmenu', handleCtx);
                
                // Content
                const allRead = m.readBy && m.readBy.length > 1; // Simplifiziert: Wenn mehr als 1 gelesen hat (Sender + 1)
                const checkColor = allRead ? 'text-blue-400' : 'text-gray-500';
                
                let contentHTML = "";
                
                if(m.replyTo) {
                    contentHTML += `
                    <div class="bg-black/20 border-l-[3px] border-[#00a884] p-1 mb-1 rounded text-xs opacity-80 cursor-pointer hover:bg-black/30 transition">
                        <span class="text-[#00a884] font-bold block">${m.replyTo.sender}</span>
                        <span class="text-gray-300 line-clamp-1">${m.replyTo.text || 'Medien'}</span>
                    </div>`;
                }
                
                if(m.img) {
                    contentHTML += `<img src="${m.img}" class="rounded-lg mb-1 max-w-[280px] max-h-[300px] object-cover cursor-pointer hover:opacity-90" onclick="UI.openLightbox('${m.img}')">`;
                }
                
                if(m.audio) {
                    contentHTML += `
                    <div class="audio-player p-1">
                        <button onclick="Voice.play('${id}', '${m.audio}')" id="play-btn-${id}" class="text-gray-300 hover:text-white"><i data-lucide="play" class="w-6 h-6 fill-current"></i></button>
                        <div class="flex-1 flex flex-col justify-center">
                            <input type="range" id="seek-${id}" value="0" max="100" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer" disabled>
                            <span class="text-[9px] text-gray-400 mt-1" id="time-${id}">Sprachnachricht</span>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-[#00a884] flex items-center justify-center relative shrink-0">
                           <i data-lucide="mic" class="w-4 h-4 text-white"></i>
                        </div>
                        <audio id="audio-${id}" src="${m.audio}" ontimeupdate="Voice.updateProgress('${id}')" onended="Voice.reset('${id}')"></audio>
                    </div>`;
                }

                if(m.text) {
                    contentHTML += `<p class="text-sm leading-relaxed whitespace-pre-wrap">${m.text} ${m.edited ? '<span class="text-[10px] text-gray-400 italic">(bearbeitet)</span>' : ''}</p>`;
                }

                div.innerHTML = `
                    <div class="relative max-w-[85%] md:max-w-[65%] min-w-[100px] shadow-sm rounded-lg p-2 ${isMe ? 'bg-[#005c4b] text-gray-100 rounded-tr-none' : 'bg-[#202c33] text-gray-100 rounded-tl-none'}">
                        ${!isMe && !State.isPrivate ? `<div class="text-xs font-bold text-orange-400 mb-1 cursor-pointer hover:underline" onclick="Chat.openPrivate('${m.senderId}','${m.senderName}')">${m.senderName}</div>` : ''}
                        
                        ${contentHTML}

                        <div class="flex justify-end items-center gap-1 mt-0.5 select-none">
                            <span class="text-[10px] text-gray-400">${Utils.formatTime(m.timestamp)}</span>
                            ${isMe ? `<span class="${checkColor}"><i data-lucide="check-check" class="w-3 h-3"></i></span>` : ''}
                        </div>
                        
                        ${m.reactions ? `
                        <div class="absolute -bottom-2 ${isMe ? 'left-0' : 'right-0'} bg-[#202c33] border border-gray-700 rounded-full px-1.5 py-0.5 shadow-md flex gap-0.5 text-[10px] z-10">
                            ${m.reactions.join('')}
                        </div>` : ''}
                    </div>
                `;
                container.appendChild(div);
            }

            // --- SENDING ---
            static handleTyping() {
                if(State.activeChat && !State.typingTimer) {
                    updateDoc(doc(db, "chats", State.activeChat), { [`typing.${State.uid}`]: true });
                    State.typingTimer = setTimeout(() => {
                        updateDoc(doc(db, "chats", State.activeChat), { [`typing.${State.uid}`]: false });
                        State.typingTimer = null;
                    }, 2000);
                }
                
                const btnMic = document.getElementById('btn-mic');
                const btnSend = document.getElementById('btn-send');
                if(document.getElementById('msg-input').value.trim()) {
                    btnMic.classList.add('hidden', 'transform', 'scale-0');
                    btnSend.classList.remove('hidden', 'transform', 'scale-0');
                    setTimeout(() => btnSend.classList.add('scale-100'), 50);
                } else {
                    btnSend.classList.remove('scale-100');
                    btnSend.classList.add('transform', 'scale-0', 'hidden');
                    btnMic.classList.remove('hidden', 'transform', 'scale-0');
                }
            }

            static handleEnter(e) {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.send();
                }
            }

            static adjustHeight(el) {
                el.style.height = 'auto';
                el.style.height = Math.min(el.scrollHeight, 120) + 'px';
            }

            static async send(audioBlob = null) {
                const input = document.getElementById('msg-input');
                const txt = input.value.trim();
                const file = document.getElementById('file-input').files[0];
                
                if (!txt && !file && !audioBlob) return;

                let imgUrl = null;
                let audioUrl = null;

                // Image Upload
                if (file) {
                    const fd = new FormData(); fd.append("image", file);
                    try {
                        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                        const data = await res.json();
                        imgUrl = data.data.url;
                    } catch (e) { Utils.showToast("Bild Fehler", 'error'); return; }
                }

                // Audio Upload (Base64 for simplicity in this file scope)
                if (audioBlob) {
                     audioUrl = await new Promise(r => {
                         const reader = new FileReader();
                         reader.onload = () => r(reader.result);
                         reader.readAsDataURL(audioBlob);
                     });
                }

                const msgData = {
                    text: txt,
                    img: imgUrl,
                    audio: audioUrl,
                    senderId: State.uid,
                    senderName: State.nick,
                    timestamp: serverTimestamp(),
                    readBy: [State.uid],
                    replyTo: State.replyTarget
                };

                try {
                    await addDoc(collection(db, `chats/${State.activeChat}/messages`), msgData);
                    
                    let lastMsg = "Nachricht";
                    if(audioUrl) lastMsg = "🎤 Audio";
                    else if(imgUrl) lastMsg = "📷 Bild";
                    else lastMsg = txt;

                    await updateDoc(doc(db, "chats", State.activeChat), {
                        lastActivity: serverTimestamp(),
                        lastMessage: lastMsg,
                        [`typing.${State.uid}`]: false
                    });
                    
                    Utils.playSound('sound-msg-out');
                    
                    // Reset UI
                    input.value = "";
                    this.adjustHeight(input);
                    this.clearImage();
                    this.cancelReply();
                    document.getElementById('btn-send').classList.add('hidden');
                    document.getElementById('btn-mic').classList.remove('hidden');
                    
                } catch(e) { console.error(e); Utils.showToast("Senden fehlgeschlagen", 'error'); }
            }

            // --- INTERACTIONS ---
            static triggerReply(id, text, sender) {
                State.replyTarget = { id, text, sender };
                document.getElementById('reply-preview').classList.remove('hidden');
                document.getElementById('reply-to-name').innerText = sender;
                document.getElementById('reply-to-text').innerText = text || "Medien";
                document.getElementById('msg-input').focus();
            }

            static cancelReply() {
                State.replyTarget = null;
                document.getElementById('reply-preview').classList.add('hidden');
            }

            static handleFileSelect() {
                const f = document.getElementById('file-input').files[0];
                if(f) {
                    document.getElementById('img-preview-src').src = URL.createObjectURL(f);
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('btn-send').classList.remove('hidden');
                    document.getElementById('btn-mic').classList.add('hidden');
                }
            }
            
            static clearImage() {
                document.getElementById('file-input').value = "";
                document.getElementById('image-preview').classList.add('hidden');
            }

            static showContextMenu(e, msgId, msgData, isMe) {
                const menu = document.getElementById('contextMenu');
                State.selectedMsg = { id: msgId, data: msgData };
                
                // Reactions
                const emojis = ['👍','❤️','😂','😮','😢','😡'];
                document.getElementById('ctx-reactions').innerHTML = emojis.map(emo => 
                    `<button onclick="Chat.addReaction('${emo}')" class="p-1.5 hover:bg-gray-700 rounded text-lg transition hover:scale-125">${emo}</button>`
                ).join('');

                // Owner Actions
                const oa = document.getElementById('ctx-owner-actions');
                isMe ? oa.classList.remove('hidden') : oa.classList.add('hidden');

                // Pos
                let x = e.clientX, y = e.clientY;
                if(x + 200 > window.innerWidth) x = window.innerWidth - 210;
                if(y + 250 > window.innerHeight) y = window.innerHeight - 260;
                
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
                menu.classList.remove('hidden');
                
                // Close Listener
                const close = () => { menu.classList.add('hidden'); document.removeEventListener('click', close); };
                setTimeout(() => document.addEventListener('click', close), 100);
            }

            static handleCtxAction(act) {
                const { id, data } = State.selectedMsg;
                if(act === 'reply') this.triggerReply(id, data.text, data.senderName);
                if(act === 'copy') Utils.copyToClipboard(data.text || "Medien");
                if(act === 'delete') {
                    if(confirm("Nachricht löschen?")) deleteDoc(doc(db, `chats/${State.activeChat}/messages`, id));
                }
                if(act === 'edit') {
                    const n = prompt("Text bearbeiten:", data.text);
                    if(n) updateDoc(doc(db, `chats/${State.activeChat}/messages`, id), { text: n, edited: true });
                }
                if(act === 'forward') {
                    this.loadChatsForForwarding();
                    UI.toggleModal('modal-forward');
                }
            }
            
            static async addReaction(emoji) {
                await updateDoc(doc(db, `chats/${State.activeChat}/messages`, State.selectedMsg.id), {
                    reactions: arrayUnion(emoji)
                });
            }

            static loadChatsForForwarding() {
                // Simplified: Reuse chat list logic or clone it
                const list = document.getElementById('forward-list');
                list.innerHTML = "";
                // Einfacher Hack: Kopiere aktuelle Chatliste für das Beispiel
                const chats = document.getElementById('chat-list').cloneNode(true);
                // Ändere Click Handler
                Array.from(chats.children).forEach((child, index) => {
                     // Hier bräuchte man die IDs der Chats, aber für dieses Demo reicht der Flow
                     const btn = document.createElement('button');
                     btn.innerText = "Senden";
                     btn.className = "bg-[#00a884] px-2 py-1 rounded text-xs ml-auto";
                     btn.onclick = (e) => {
                         e.stopPropagation();
                         alert("Feature: Weiterleitung simuliert (ID Logik benötigt)");
                         UI.toggleModal('modal-forward');
                     };
                     child.appendChild(btn);
                });
                list.appendChild(chats);
            }

            // --- ADMIN & GROUPS ---
            static createGroup() {
                const n = document.getElementById('ng-name').value;
                const p = document.getElementById('ng-pass').value;
                if(!n) return;
                const id = "GRP-" + Math.random().toString(36).substring(2, 8).toUpperCase();
                setDoc(doc(db, "chats", id), {
                    name: n, password: p, type: 'group', creator: State.uid, 
                    admins: [State.uid], members: [State.uid], lastActivity: serverTimestamp()
                }).then(() => {
                    UI.toggleModal('modal-new-group');
                    this.open(id, n, false);
                    Utils.showToast("Gruppe erstellt: " + id);
                });
            }

            static async joinGroup() {
                const id = document.getElementById('jg-id').value.toUpperCase();
                const p = document.getElementById('jg-pass').value;
                const ref = doc(db, "chats", id);
                const snap = await getDoc(ref);
                if(snap.exists() && snap.data().type === 'group') {
                    if(snap.data().password && snap.data().password !== p) return Utils.showToast("Passwort falsch", 'error');
                    await updateDoc(ref, { members: arrayUnion(State.uid) });
                    UI.toggleModal('modal-join-group');
                    this.open(id, snap.data().name, false);
                    Utils.showToast("Beigetreten!");
                } else Utils.showToast("Gruppe nicht gefunden", 'error');
            }

            static async updateInfoModal(id, name, isPrivate) {
                document.getElementById('info-title').innerText = name;
                document.getElementById('info-id').innerText = "ID: " + id;
                const list = document.getElementById('info-members'); list.innerHTML = "";
                
                if(isPrivate) {
                     document.getElementById('info-group-section').classList.add('hidden');
                } else {
                    document.getElementById('info-group-section').classList.remove('hidden');
                    const cSnap = await getDoc(doc(db, "chats", id));
                    const cData = cSnap.data();
                    const admins = cData.admins || [];
                    const isOwner = cData.creator === State.uid;
                    const amIAdmin = admins.includes(State.uid);

                    cData.members.forEach(async mid => {
                        const uSnap = await getDoc(doc(db, "users", mid));
                        if(uSnap.exists()) {
                            const u = uSnap.data();
                            const isAdmin = admins.includes(mid);
                            const isCreator = cData.creator === mid;
                            
                            const el = document.createElement('div');
                            el.className = "flex items-center justify-between p-2 rounded hover:bg-[#111b21] group";
                            el.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center text-xs font-bold">${u.nickname[0]}</div>
                                    <div>
                                        <div class="text-sm font-bold flex items-center gap-1 text-gray-200">
                                            ${u.nickname}
                                            ${isCreator ? '<i data-lucide="crown" class="w-3 h-3 admin-crown fill-current"></i>' : (isAdmin ? '<i data-lucide="shield" class="w-3 h-3 text-blue-400 fill-current"></i>' : '')}
                                        </div>
                                        <div class="text-[10px] text-gray-500">${mid === State.uid ? 'DU' : ''}</div>
                                    </div>
                                </div>
                                ${amIAdmin && mid !== State.uid && !isCreator ? `<button class="text-gray-500 hover:text-white" onclick="Chat.openAdminMenu('${mid}', '${u.nickname}')"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>` : ''}
                            `;
                            list.appendChild(el);
                            lucide.createIcons();
                        }
                    });
                }
            }

            static openAdminMenu(uid, name) {
                State.adminTarget = uid;
                document.getElementById('admin-target-name').innerText = name;
                document.getElementById('modal-admin').classList.remove('hidden');
                // Admin Button Logic check would go here (hide promote if already admin etc)
                // For brevity, simple toggles could be added here.
            }

            static async execAdmin(action) {
                const ref = doc(db, "chats", State.activeChat);
                document.getElementById('modal-admin').classList.add('hidden');
                if(action === 'kick') await updateDoc(ref, { members: arrayRemove(State.adminTarget), admins: arrayRemove(State.adminTarget) });
                if(action === 'promote') await updateDoc(ref, { admins: arrayUnion(State.adminTarget) });
                if(action === 'demote') await updateDoc(ref, { admins: arrayRemove(State.adminTarget) });
                this.updateInfoModal(State.activeChat, document.getElementById('header-title').innerText, false);
                Utils.showToast("Aktion erfolgreich");
            }
            
            static async leaveChat() {
                if(confirm("Wirklich verlassen?")) {
                    await updateDoc(doc(db, "chats", State.activeChat), { members: arrayRemove(State.uid) });
                    location.reload();
                }
            }

            static openPrivate(uid, name) {
                // Quick start private chat
                const id = [State.uid, uid].sort().join('_');
                setDoc(doc(db, "chats", id), {
                    type: 'private', participants: [State.uid, uid], names: {[State.uid]: State.nick, [uid]: name}, lastActivity: serverTimestamp()
                }, { merge: true }).then(() => this.open(id, name, true));
            }
            
            // Status Logic
            static async uploadStatus() {
                const f = document.getElementById('status-input').files[0];
                if(f) {
                    const fd = new FormData(); fd.append("image", f);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                    const d = await res.json();
                    await addDoc(collection(db, "status"), { uid: State.uid, name: State.nick, img: d.data.url, timestamp: serverTimestamp() });
                    Utils.showToast("Status hochgeladen!");
                }
            }
            
            static loadGlobalStatus() {
                // Query last 24h
                const yest = new Date(Date.now() - 86400000);
                onSnapshot(query(collection(db, "status"), orderBy("timestamp", "desc")), snap => {
                    const c = document.getElementById('status-list'); c.innerHTML = "";
                    snap.forEach(d => {
                        const s = d.data();
                        if(s.timestamp && s.timestamp.toDate() > yest) {
                            if(s.uid === State.uid) {
                                document.getElementById('my-status-prev').src = s.img;
                                document.getElementById('my-status-prev').classList.remove('hidden');
                                document.getElementById('my-status-icon').classList.add('hidden');
                            } else {
                                const el = document.createElement('div');
                                el.className = "flex items-center gap-3 p-2 border border-gray-700 rounded-xl cursor-pointer hover:bg-white/5";
                                el.innerHTML = `<div class="w-10 h-10 rounded-full border-2 border-[#00a884] p-0.5"><img src="${s.img}" class="w-full h-full rounded-full object-cover"></div><div class="font-bold text-sm text-gray-200">${s.name}</div><div class="text-xs text-gray-500 ml-auto">${Utils.formatTime(s.timestamp)}</div>`;
                                el.onclick = () => UI.openLightbox(s.img, s.name);
                                c.appendChild(el);
                            }
                        }
                    });
                });
            }
        }

        // --- VOICE RECORDER ---
        class Voice {
            static async start() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    State.voice.chunks = [];
                    State.voice.recorder = new MediaRecorder(stream);
                    State.voice.recorder.ondataavailable = e => State.voice.chunks.push(e.data);
                    State.voice.recorder.start();
                    document.getElementById('recording-ui').classList.remove('hidden');
                    if(navigator.vibrate) navigator.vibrate(50);
                } catch(e) { Utils.showToast("Mikrofon Fehler", 'error'); }
            }

            static stop() {
                if(State.voice.recorder && State.voice.recorder.state !== 'inactive') {
                    State.voice.recorder.stop();
                    document.getElementById('recording-ui').classList.add('hidden');
                    State.voice.recorder.onstop = () => {
                        const blob = new Blob(State.voice.chunks, { type: 'audio/webm' });
                        if(blob.size > 0) Chat.send(blob);
                        State.voice.recorder.stream.getTracks().forEach(t => t.stop());
                    };
                }
            }

            static play(id, url) {
                const audio = document.getElementById(`audio-${id}`);
                const btn = document.getElementById(`play-btn-${id}`);
                
                // Stop all others
                document.querySelectorAll('audio').forEach(a => { if(a.id !== `audio-${id}` && !a.id.startsWith('sound')) a.pause(); });
                document.querySelectorAll('[id^="play-btn-"]').forEach(b => b.innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-current"></i>');

                if (audio.paused) {
                    audio.play();
                    btn.innerHTML = '<i data-lucide="pause" class="w-6 h-6 fill-current"></i>';
                } else {
                    audio.pause();
                    btn.innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-current"></i>';
                }
                lucide.createIcons();
            }

            static updateProgress(id) {
                const audio = document.getElementById(`audio-${id}`);
                const range = document.getElementById(`seek-${id}`);
                const time = document.getElementById(`time-${id}`);
                if(audio.duration) {
                    const val = (audio.currentTime / audio.duration) * 100;
                    range.value = val;
                    // Format Time mm:ss
                    const m = Math.floor(audio.currentTime / 60);
                    const s = Math.floor(audio.currentTime % 60);
                    time.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                }
            }

            static reset(id) {
                document.getElementById(`seek-${id}`).value = 0;
                document.getElementById(`play-btn-${id}`).innerHTML = '<i data-lucide="play" class="w-6 h-6 fill-current"></i>';
                lucide.createIcons();
            }
        }

        // --- CALL SYSTEM (WebRTC) ---
        class Call {
            static initHistory() {
                onSnapshot(query(collection(db, `users/${State.uid}/callHistory`), orderBy("timestamp", "desc"), limit(20)), snap => {
                    const c = document.getElementById('call-list'); c.innerHTML = "";
                    snap.forEach(d => {
                        const h = d.data();
                        const el = document.createElement('div');
                        el.className = "flex items-center gap-4 p-3 border-b border-gray-800";
                        el.innerHTML = `
                            <div class="bg-gray-700 w-10 h-10 rounded-full flex items-center justify-center"><i data-lucide="${h.type==='out'?'arrow-up-right':'arrow-down-left'}" class="w-5 h-5 ${h.type==='out'?'text-green-500':'text-red-500'}"></i></div>
                            <div>
                                <div class="font-bold text-gray-200">${h.name}</div>
                                <div class="text-xs text-gray-500">${Utils.formatTime(h.timestamp)}</div>
                            </div>
                        `;
                        c.appendChild(el);
                    });
                    lucide.createIcons();
                });
            }

            static listen() {
                onSnapshot(query(collection(db, "calls"), where("status", "==", "ringing")), s => {
                    s.docChanges().forEach(c => {
                        if(c.type === 'added') {
                            const d = c.doc.data();
                            const isForMe = d.targetId === State.uid || (d.isGroup && d.members?.includes(State.uid));
                            if(d.callerId !== State.uid && isForMe) {
                                State.webrtc.callId = c.doc.id;
                                this.showIncoming(d.callerName);
                            }
                        }
                    });
                });
            }

            static async start() {
                if(!State.activeChat) return;
                const name = document.getElementById('header-title').innerText;
                document.getElementById('call-overlay').classList.remove('hidden');
                document.getElementById('call-controls-active').classList.remove('hidden');
                document.getElementById('call-controls-incoming').classList.add('hidden');
                document.getElementById('call-name').innerText = name;
                document.getElementById('call-avatar').innerText = name[0];
                document.getElementById('call-status').innerText = "Wählt...";
                Utils.playSound('sound-ring');

                // History Log
                addDoc(collection(db, `users/${State.uid}/callHistory`), { name, type: 'out', timestamp: serverTimestamp() });

                // RTC Setup
                State.webrtc.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                State.webrtc.pc = new RTCPeerConnection(State.iceServers);
                
                State.webrtc.stream.getTracks().forEach(t => State.webrtc.pc.addTrack(t, State.webrtc.stream));
                State.webrtc.pc.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
                
                const callRef = doc(collection(db, "calls"));
                State.webrtc.callId = callRef.id;
                
                State.webrtc.pc.onicecandidate = e => e.candidate && addDoc(collection(callRef, 'offerCandidates'), e.candidate.toJSON());

                const offer = await State.webrtc.pc.createOffer();
                await State.webrtc.pc.setLocalDescription(offer);

                const targetId = State.isPrivate ? State.activeChat.split('_').find(x => x !== State.uid) : State.activeChat;

                await setDoc(callRef, {
                    callerId: State.uid, callerName: State.nick, targetId, isGroup: !State.isPrivate,
                    offer: { type: offer.type, sdp: offer.sdp }, status: 'ringing'
                });

                State.webrtc.unsub = onSnapshot(callRef, s => {
                    const d = s.data();
                    if(d?.answer && !State.webrtc.pc.currentRemoteDescription) {
                        State.webrtc.pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                        document.getElementById('call-status').innerText = "Verbunden";
                        document.getElementById('sound-ring').pause();
                        // Stop Ripple
                        document.querySelectorAll('.ripple').forEach(el => el.style.animation = 'none');
                    }
                    if(d?.status === 'ended') this.end(false);
                });
            }

            static showIncoming(name) {
                document.getElementById('call-overlay').classList.remove('hidden');
                document.getElementById('call-controls-active').classList.add('hidden');
                document.getElementById('call-controls-incoming').classList.remove('hidden');
                document.getElementById('call-name').innerText = name;
                document.getElementById('call-avatar').innerText = name[0];
                document.getElementById('call-status').innerText = "Eingehender Anruf...";
                document.getElementById('sound-ring').play();
                Utils.sendNotification("Eingehender Anruf", name + " ruft an!");
            }

            static async answer() {
                document.getElementById('sound-ring').pause();
                document.getElementById('call-controls-incoming').classList.add('hidden');
                document.getElementById('call-controls-active').classList.remove('hidden');
                document.getElementById('call-status').innerText = "Verbinde...";

                const callRef = doc(db, "calls", State.webrtc.callId);
                const callSnap = await getDoc(callRef);
                const data = callSnap.data();

                // History Log
                addDoc(collection(db, `users/${State.uid}/callHistory`), { name: data.callerName, type: 'in', timestamp: serverTimestamp() });

                State.webrtc.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                State.webrtc.pc = new RTCPeerConnection(State.iceServers);
                State.webrtc.stream.getTracks().forEach(t => State.webrtc.pc.addTrack(t, State.webrtc.stream));
                State.webrtc.pc.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
                
                State.webrtc.pc.onicecandidate = e => e.candidate && addDoc(collection(callRef, 'answerCandidates'), e.candidate.toJSON());

                await State.webrtc.pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await State.webrtc.pc.createAnswer();
                await State.webrtc.pc.setLocalDescription(answer);

                await updateDoc(callRef, { answer: { type: answer.type, sdp: answer.sdp }, status: 'connected' });
                
                onSnapshot(collection(callRef, 'offerCandidates'), s => {
                    s.docChanges().forEach(c => {
                        if(c.type === 'added') State.webrtc.pc.addIceCandidate(new RTCIceCandidate(c.doc.data()));
                    });
                });
                
                State.webrtc.unsub = onSnapshot(callRef, s => { if(s.data()?.status === 'ended') this.end(false); });
            }

            static async end(updateDB = true) {
                document.getElementById('call-overlay').classList.add('hidden');
                document.getElementById('sound-ring').pause();
                document.getElementById('sound-ring').currentTime = 0;
                
                if (State.webrtc.stream) {
                    State.webrtc.stream.getTracks().forEach(t => t.stop());
                }
                if (State.webrtc.pc) {
                    State.webrtc.pc.close();
                }
                if (State.webrtc.unsub) State.webrtc.unsub();
                
                if (updateDB && State.webrtc.callId) {
                    try { await updateDoc(doc(db, "calls", State.webrtc.callId), { status: 'ended' }); } catch(e){}
                }
                
                State.webrtc = { pc: null, stream: null, callId: null, unsub: null };
            }

            static toggleMute() {
                if(State.webrtc.stream) {
                    const track = State.webrtc.stream.getAudioTracks()[0];
                    track.enabled = !track.enabled;
                    document.getElementById('btn-mute').classList.toggle('text-red-500', !track.enabled);
                }
            }
        }

        // --- GLOBAL EXPORTS ---
        window.UI = UI;
        window.Chat = Chat;
        window.Auth = Auth;
        window.Utils = Utils;
        window.Voice = Voice;
        window.Call = Call;

        // START
        Auth.init();
        lucide.createIcons();

    </script>
</body>
</html>
