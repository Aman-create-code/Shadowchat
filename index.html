<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShadowChat Pro | Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.08); }
        .mobile-sidebar { position: fixed; left: -100%; transition: 0.3s; z-index: 50; width: 85%; height: 100%; }
        .mobile-sidebar.active { left: 0; }
        @media (min-width: 768px) { .mobile-sidebar { position: relative; left: 0; width: 320px; } .menu-btn { display: none; } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .msg-bubble { word-break: break-word; }
    </style>
</head>
<body class="h-screen flex">

    <aside id="sidebar" class="mobile-sidebar glass flex flex-col">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center">
            <h1 class="font-black text-xl bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent">SHADOW PRO</h1>
            <button onclick="toggleMenu()" class="md:hidden text-slate-400"><i data-lucide="x"></i></button>
        </div>

        <div class="p-4 flex gap-2">
            <button onclick="toggleModal('groupModal')" class="flex-1 bg-indigo-600 p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Neu
            </button>
            <button onclick="toggleModal('joinModal')" class="flex-1 bg-slate-800 p-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 border border-slate-700">
                <i data-lucide="hash" class="w-4 h-4"></i> Join
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
            <div>
                <p class="text-[10px] text-slate-500 uppercase font-black px-2 mb-3 tracking-widest">Gruppen</p>
                <div id="groupList" class="space-y-2"></div>
            </div>
            <div>
                <p class="text-[10px] text-indigo-400 uppercase font-black px-2 mb-3 tracking-widest">Kontakte</p>
                <div id="friendList" class="space-y-2"></div>
            </div>
        </div>

        <div class="p-4 border-t border-slate-800">
            <div onclick="copyMyId()" class="flex items-center gap-3 bg-slate-950 p-4 rounded-2xl border border-white/5 cursor-pointer hover:bg-slate-900 transition-all">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-bold">ME</div>
                <div class="flex-1 truncate">
                    <p class="text-xs font-bold" id="myNickname">...</p>
                    <p class="text-[9px] text-indigo-400">ID KOPIEREN</p>
                </div>
                <button onclick="event.stopPropagation(); toggleModal('settingsModal')"><i data-lucide="settings" class="w-5 h-5 text-slate-500"></i></button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0">
        <header class="h-16 glass flex items-center px-4 justify-between border-b border-white/5 shrink-0">
            <div class="flex items-center gap-3 truncate">
                <button onclick="toggleMenu()" class="menu-btn p-2 text-indigo-400"><i data-lucide="menu"></i></button>
                <div onclick="showMembers()" class="cursor-pointer truncate">
                    <h2 id="currentGroupName" class="font-bold text-sm md:text-lg truncate">Wähle einen Chat</h2>
                    <p class="text-[10px] text-indigo-500 font-mono" id="displayGroupId"></p>
                </div>
            </div>
        </header>

        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar"></div>

        <footer class="p-4 bg-slate-950/50">
            <div id="previewContainer" class="hidden mb-2 p-2 bg-slate-800 rounded-xl w-fit relative">
                <img id="imagePreview" src="" class="h-20 rounded-lg">
                <button onclick="cancelImage()" class="absolute -top-2 -right-2 bg-red-500 p-1 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>
            <div class="max-w-4xl mx-auto flex items-center gap-2 bg-slate-900 p-2 rounded-2xl border border-slate-800 shadow-xl">
                <label class="p-3 text-slate-400 cursor-pointer"><i data-lucide="image"></i><input type="file" id="imageInput" class="hidden" accept="image/*" onchange="previewFile()"></label>
                <input type="text" id="msgInput" placeholder="Nachricht..." class="flex-1 bg-transparent border-none outline-none text-sm text-white px-2">
                <button id="sendBtn" class="bg-indigo-600 p-3 rounded-xl text-white shadow-lg"><i data-lucide="send-horizontal"></i></button>
            </div>
        </footer>
    </main>

    <div id="groupModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4">
        <div class="glass w-full max-w-sm p-6 rounded-3xl">
            <h3 class="text-xl font-bold mb-4">Gruppe erstellen</h3>
            <input type="text" id="newGroupName" placeholder="Gruppenname" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl mb-4 outline-none">
            <input type="password" id="newGroupPass" placeholder="Passwort (optional)" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl mb-6 outline-none">
            <div class="flex gap-2">
                <button onclick="toggleModal('groupModal')" class="flex-1 p-4 text-slate-500">Abbrechen</button>
                <button id="confirmCreateGroup" class="flex-1 bg-indigo-600 p-4 rounded-xl font-bold">Erstellen</button>
            </div>
        </div>
    </div>

    <div id="joinModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4">
        <div class="glass w-full max-w-sm p-6 rounded-3xl">
            <h3 class="text-xl font-bold mb-4">Gruppe beitreten</h3>
            <input type="text" id="joinId" placeholder="8-Stellige ID" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl mb-4 font-mono">
            <input type="password" id="joinPass" placeholder="Passwort" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-xl mb-6 font-mono">
            <button id="confirmJoinGroup" class="w-full bg-indigo-600 p-4 rounded-xl font-bold">Join</button>
            <button onclick="toggleModal('joinModal')" class="w-full mt-2 text-slate-500">Abbrechen</button>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4">
        <div class="glass w-full max-w-sm p-6 rounded-3xl">
            <h3 class="text-xl font-bold mb-6">Einstellungen</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-slate-500 uppercase font-black">Nickname</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="editNickname" class="flex-1 bg-slate-950 border border-slate-800 p-3 rounded-xl text-sm">
                        <button onclick="updateNickname()" class="bg-indigo-600 px-4 rounded-xl text-xs font-bold">OK</button>
                    </div>
                    <p id="nicknameError" class="text-[9px] text-red-500 mt-1 hidden"></p>
                </div>
            </div>
            <button onclick="toggleModal('settingsModal')" class="w-full mt-8 p-4 bg-slate-800 rounded-xl font-bold">Schließen</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";
        let currentUser, activeGroupId, myNickname;

        lucide.createIcons();

        // NICKNAME GEN
        const genNick = () => "Ghost-" + Math.random().toString(36).substring(2,6).toUpperCase();
        
        // 8-STELLIGE ID GEN
        const genShortId = () => Math.random().toString(36).substring(2,10);

        onAuthStateChanged(auth, async u => {
            if(u) {
                currentUser = u;
                const ref = doc(db, "users", u.uid);
                const snap = await getDoc(ref);
                if(!snap.exists()) {
                    myNickname = genNick();
                    await setDoc(ref, { uid: u.uid, nickname: myNickname, friends: [], incomingRequests: [], lastNickChange: 0 });
                } else { myNickname = snap.data().nickname; }
                document.getElementById('myNickname').innerText = myNickname;
                loadSocial();
            }
        });

        // UI HELPERS
        window.toggleMenu = () => { document.getElementById('sidebar').classList.toggle('active'); };
        window.toggleModal = id => document.getElementById(id).classList.toggle('hidden');

        // GROUP LOGIC
        document.getElementById('confirmCreateGroup').onclick = async () => {
            const name = document.getElementById('newGroupName').value;
            const pass = document.getElementById('newGroupPass').value;
            if(!name) return;
            const shortId = genShortId();
            // Wir nutzen die shortId als Dokumenten-ID
            await setDoc(doc(db, "groups", shortId), {
                name, password: pass || null, creator: currentUser.uid, members: [currentUser.uid], lastActivity: serverTimestamp()
            });
            toggleModal('groupModal');
            selectGroup(shortId, name);
        };

        document.getElementById('confirmJoinGroup').onclick = async () => {
            const id = document.getElementById('joinId').value;
            const pass = document.getElementById('joinPass').value;
            const snap = await getDoc(doc(db, "groups", id));
            if(snap.exists()){
                const g = snap.data();
                if(g.password && g.password !== pass) return alert("Falsches Passwort");
                await updateDoc(doc(db, "groups", id), { members: arrayUnion(currentUser.uid) });
                toggleModal('joinModal');
                selectGroup(id, g.name);
            } else { alert("Nicht gefunden"); }
        };

        onSnapshot(collection(db, "groups"), snap => {
            const list = document.getElementById('groupList'); list.innerHTML = "";
            snap.forEach(d => {
                if(d.data().members.includes(currentUser?.uid)) {
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-2xl cursor-pointer ${activeGroupId === d.id ? 'bg-indigo-600' : 'bg-slate-900 border border-white/5'}`;
                    div.innerHTML = `<p class="text-sm font-bold truncate">${d.data().name}</p>`;
                    div.onclick = () => { selectGroup(d.id, d.data().name); toggleMenu(); };
                    list.appendChild(div);
                }
            });
        });

        // CHAT
        let chatSub = null;
        const selectGroup = (id, name) => {
            activeGroupId = id;
            document.getElementById('currentGroupName').innerText = name;
            document.getElementById('displayGroupId').innerText = "#" + id;
            if(chatSub) chatSub();
            chatSub = onSnapshot(query(collection(db, `groups/${id}/messages`), orderBy("timestamp", "asc")), snap => {
                const c = document.getElementById('chatMessages'); c.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data(); const isMe = m.senderId === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `max-w-[85%] p-3 rounded-2xl msg-bubble shadow-lg ${isMe ? 'self-end bg-indigo-600 rounded-tr-none' : 'self-start bg-slate-800 rounded-tl-none'}`;
                    div.innerHTML = `<p class="text-[8px] font-black opacity-40 uppercase mb-1">${m.senderName}</p>${m.img ? `<img src="${m.img}" class="rounded-lg mb-2">` : ''}<p class="text-sm">${m.text || ''}</p>`;
                    c.appendChild(div);
                });
                c.scrollTop = c.scrollHeight;
            });
        };

        document.getElementById('sendBtn').onclick = async () => {
            const text = document.getElementById('msgInput').value, file = document.getElementById('imageInput').files[0];
            if(!activeGroupId || (!text && !file)) return;
            let img = null;
            if(file) {
                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {method:"POST", body:fd});
                const d = await res.json(); img = d.data.url;
            }
            await addDoc(collection(db, `groups/${activeGroupId}/messages`), {
                text, senderId: currentUser.uid, senderName: myNickname, img, timestamp: serverTimestamp()
            });
            await updateDoc(doc(db, "groups", activeGroupId), { lastActivity: serverTimestamp() });
            document.getElementById('msgInput').value = ""; cancelImage();
        };

        // NICKNAME & SOCIAL
        window.updateNickname = async () => {
            const n = document.getElementById('editNickname').value;
            const ref = doc(db, "users", currentUser.uid);
            const snap = await getDoc(ref);
            const now = Date.now();
            if(now - (snap.data().lastNickChange || 0) < 7*24*60*60*1000) return alert("Sperre aktiv!");
            await updateDoc(ref, { nickname: n, lastNickChange: now });
            myNickname = n; document.getElementById('myNickname').innerText = n;
            toggleModal('settingsModal');
        };

        const loadSocial = () => {
            onSnapshot(doc(db, "users", currentUser.uid), async snap => {
                const u = snap.data(); const list = document.getElementById('friendList'); list.innerHTML = "";
                for(let rId of u.incomingRequests){
                    const rDoc = await getDoc(doc(db, "users", rId));
                    const div = document.createElement('div');
                    div.className = "p-3 bg-indigo-900/30 border border-indigo-500/30 rounded-xl flex justify-between items-center mb-2";
                    div.innerHTML = `<span class="text-xs font-bold">${rDoc.data()?.nickname}</span> <button onclick="accept('${rId}')" class="bg-indigo-600 p-1 rounded"><i data-lucide="check" class="w-3 h-3"></i></button>`;
                    list.appendChild(div);
                }
                for(let fId of u.friends){
                    const fDoc = await getDoc(doc(db, "users", fId));
                    const div = document.createElement('div');
                    div.className = "p-3 bg-slate-900/50 rounded-xl text-xs font-bold mb-1 border border-white/5";
                    div.innerText = fDoc.data()?.nickname;
                    list.appendChild(div);
                }
                lucide.createIcons();
            });
        };

        window.accept = async id => {
            const myRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(myRef);
            await updateDoc(myRef, { friends: arrayUnion(id), incomingRequests: snap.data().incomingRequests.filter(x => x !== id) });
            await updateDoc(doc(db, "users", id), { friends: arrayUnion(currentUser.uid) });
        };

        window.copyMyId = () => { navigator.clipboard.writeText(currentUser.uid); alert("Deine User-ID kopiert!"); };
        window.previewFile = () => {
            const f = document.getElementById('imageInput').files[0]; const r = new FileReader();
            r.onload = e => { document.getElementById('imagePreview').src = e.target.result; document.getElementById('previewContainer').classList.remove('hidden'); };
            r.readAsDataURL(f);
        };
        window.cancelImage = () => { document.getElementById('imageInput').value = ""; document.getElementById('previewContainer').classList.add('hidden'); };
        document.getElementById('msgInput').addEventListener('keypress', e => e.key === 'Enter' && document.getElementById('sendBtn').click());
    </script>
</body>
</html>
