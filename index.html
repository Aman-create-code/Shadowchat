<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShadowChat V12 - God Mode Enterprise</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#f0f2f5', 
                            dark: '#0b141a', 
                            panel: '#202c33',
                            accent: '#00a884', 
                            bubbleOut: '#d9fdd3', 
                            bubbleIn: '#ffffff', 
                            bubbleDarkOut: '#005c4b', 
                            bubbleDarkIn: '#233138',
                            iosRed: '#ff3b30',
                            iosGreen: '#34c759',
                            gold: '#ffb900'
                        }
                    },
                    fontFamily: { sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'SF Pro Display', sans-serif; overflow: hidden; height: 100dvh; background-color: #0b141a; color: #e9edef; margin: 0; }
        
        /* Custom UI Elements */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .glass-modal { backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); background-color: rgba(10, 10, 10, 0.85); }
        .ios-blur { backdrop-filter: blur(50px) brightness(0.6); -webkit-backdrop-filter: blur(50px) brightness(0.6); }
        
        /* Message Layouts */
        .msg-in { border-radius: 0 18px 18px 18px; }
        .msg-out { border-radius: 18px 0 18px 18px; }
        
        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes ripple { 0% { box-shadow: 0 0 0 0 rgba(0, 168, 132, 0.4); } 100% { box-shadow: 0 0 0 30px rgba(0, 168, 132, 0); } }
        
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .calling-active { animation: ripple 1.5s infinite; }

        /* Status Ring */
        .status-ring { padding: 2px; background: linear-gradient(45deg, #00a884, #34c759); border-radius: 50%; }
        
        .chat-wallpaper { 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: 400px; opacity: 0.05; position: absolute; inset: 0; pointer-events: none; z-index: 0; 
        }

        /* Safe Areas for Mobile */
        .pb-safe { padding-bottom: var(--sab); }
        .pt-safe { padding-top: var(--sat); }
    </style>
</head>
<body class="bg-wa-dark select-none">

    <audio id="snd_msg_in" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
    <audio id="snd_msg_out" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>
    <audio id="snd_call_loop" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop preload="auto"></audio>

    <div id="notiBanner" class="hidden fixed top-0 left-0 right-0 z-[3000] p-4 bg-wa-accent text-white flex items-center justify-between shadow-2xl animate-slide-up">
        <div class="flex items-center gap-3">
            <i data-lucide="bell-ring" class="w-6 h-6"></i>
            <div>
                <p class="font-bold text-sm">Push-Benachrichtigungen aktivieren?</p>
                <p class="text-[10px] opacity-80">Erfahre sofort, wenn dir jemand schreibt.</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="window.requestNotificationPerm()" class="bg-white text-wa-accent px-4 py-1.5 rounded-full font-black text-xs uppercase shadow-sm">Ja, erlauben</button>
            <button onclick="document.getElementById('notiBanner').remove()" class="px-3 py-1.5 text-xs font-bold uppercase">Nein</button>
        </div>
    </div>

    <div class="flex h-full w-full overflow-hidden relative">
        
        <aside id="mainSidebar" class="flex flex-col w-full md:w-[480px] h-full border-r border-gray-800 bg-wa-dark z-20 shrink-0">
            
            <header class="h-16 bg-wa-panel flex items-center justify-between px-5 shrink-0 border-b border-gray-900 pt-safe">
                <div class="flex items-center gap-4">
                    <div id="userAvatar" onclick="window.switchTab('settings')" class="w-10 h-10 rounded-full bg-wa-accent flex items-center justify-center font-black text-white cursor-pointer shadow-lg hover:rotate-6 transition-transform text-lg border-2 border-white/10">?</div>
                    <div class="hidden sm:block">
                        <h1 id="userNickHeader" class="text-sm font-bold leading-none mb-1 text-gray-100">Synchronisierung...</h1>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-wa-accent rounded-full animate-pulse"></span>
                            <span class="text-[9px] font-black text-wa-accent uppercase tracking-widest">Shadow V12 Online</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="window.showModal('loginModal')" class="p-2.5 rounded-full hover:bg-white/5 text-blue-400 transition" title="Login"><i data-lucide="fingerprint" class="w-5 h-5"></i></button>
                    <button onclick="window.showModal('createGroupModal')" class="p-2.5 rounded-full hover:bg-white/5 text-gray-400 transition"><i data-lucide="users" class="w-5 h-5"></i></button>
                    <button onclick="window.showModal('joinGroupModal')" class="p-2.5 rounded-full hover:bg-white/5 text-wa-accent transition"><i data-lucide="plus-square" class="w-5 h-5"></i></button>
                    <button onclick="window.switchTab('settings')" class="p-2.5 rounded-full hover:bg-white/5 text-gray-400 transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
                </div>
            </header>

            <div class="px-4 py-3 bg-wa-dark border-b border-gray-800/50">
                <div class="bg-wa-panel flex items-center px-4 py-2.5 rounded-2xl border border-gray-700/50 focus-within:border-wa-accent focus-within:ring-1 focus-within:ring-wa-accent/30 transition-all">
                    <i data-lucide="search" class="w-4 h-4 text-gray-500"></i>
                    <input type="text" id="mainSearch" placeholder="Chats, Gruppen oder IDs suchen..." class="bg-transparent text-sm w-full outline-none px-3 text-gray-200 placeholder:text-gray-600">
                </div>
            </div>

            <nav class="flex bg-wa-dark border-b border-gray-800">
                <button onclick="window.switchTab('chats')" id="btn-chats" class="flex-1 py-4 text-[11px] font-black uppercase tracking-[0.2em] border-b-2 border-wa-accent text-wa-accent transition-all duration-300">Chats</button>
                <button onclick="window.switchTab('friends')" id="btn-friends" class="flex-1 py-4 text-[11px] font-black uppercase tracking-[0.2em] border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-all duration-300">Kontakte</button>
                <button onclick="window.switchTab('status')" id="btn-status" class="flex-1 py-4 text-[11px] font-black uppercase tracking-[0.2em] border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-all duration-300 text-center flex items-center justify-center gap-2">Status <span class="w-1.5 h-1.5 bg-wa-accent rounded-full animate-bounce"></span></button>
            </nav>

            <div class="flex-1 overflow-y-auto custom-scrollbar bg-wa-dark relative">
                
                <section id="tab-chats" class="tab-pane block animate-scale-in">
                    <div id="chatList" class="divide-y divide-gray-800/30">
                        <div class="p-20 text-center">
                            <div class="inline-block p-5 bg-wa-panel rounded-full mb-4 opacity-20"><i data-lucide="message-square" class="w-10 h-10"></i></div>
                            <p class="text-xs text-gray-600 font-bold uppercase tracking-widest">Keine aktiven Instanzen</p>
                        </div>
                    </div>
                </section>

                <section id="tab-friends" class="tab-pane hidden p-6 animate-scale-in">
                    <div class="space-y-8">
                        <div class="bg-gradient-to-br from-wa-panel to-gray-900 p-6 rounded-[32px] border border-gray-700/50 shadow-2xl">
                            <h4 class="text-[10px] font-black text-wa-accent uppercase tracking-[0.25em] mb-4">Netzwerk-Erweiterung</h4>
                            <div class="flex gap-3">
                                <input id="friendUidIn" type="text" placeholder="Shadow-UID einf√ºgen..." class="flex-1 bg-wa-dark border border-gray-700 p-4 rounded-2xl text-sm font-mono outline-none focus:border-wa-accent transition">
                                <button onclick="window.sendFriendRequest()" class="bg-wa-accent hover:bg-emerald-600 text-white px-6 rounded-2xl shadow-lg transition active:scale-95"><i data-lucide="user-plus" class="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div id="requestsBox" class="hidden">
                            <h4 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <span class="w-2 h-2 bg-orange-500 rounded-full animate-ping"></span> Ausstehende Anfragen
                            </h4>
                            <div id="requestsList" class="space-y-3"></div>
                        </div>

                        <div>
                            <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Gespeicherte Kontakte</h4>
                            <div id="friendsList" class="space-y-2"></div>
                        </div>
                    </div>
                </section>

                <section id="tab-status" class="tab-pane hidden p-6 animate-scale-in">
                    <div class="flex items-center gap-5 mb-12 p-4 bg-wa-panel rounded-3xl border border-dashed border-gray-600 hover:border-wa-accent transition cursor-pointer group" onclick="document.getElementById('statusUploadIn').click()">
                        <div class="w-16 h-16 rounded-full border-2 border-wa-accent p-1">
                            <div class="w-full h-full rounded-full bg-gray-800 flex items-center justify-center overflow-hidden">
                                <i data-lucide="camera" class="text-gray-500 group-hover:scale-125 transition-transform duration-500"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-black text-gray-100">Mein Status</h3>
                            <p class="text-xs text-gray-500">Teile verschl√ºsselte Momente</p>
                        </div>
                        <input type="file" id="statusUploadIn" class="hidden" accept="image/*" onchange="window.handleStatusUpload()">
                    </div>

                    <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-6">Updates von Kontakten</h4>
                    <div id="globalStatusGrid" class="grid grid-cols-2 gap-4"></div>
                </section>

                <section id="tab-settings" class="tab-pane hidden pb-20 animate-scale-in">
                    <div class="h-44 bg-gradient-to-br from-wa-accent via-emerald-900 to-black relative">
                        <div class="absolute -bottom-14 left-8">
                            <div id="profileAvaLarge" class="w-32 h-32 rounded-[40px] bg-wa-panel border-[8px] border-wa-dark flex items-center justify-center text-5xl font-black text-white shadow-2xl overflow-hidden relative group">
                                <span id="profileAvaChar">?</span>
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition cursor-pointer">
                                    <i data-lucide="refresh-cw" class="w-8 h-8 text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-20 px-8 space-y-8">
                        <div>
                            <h2 id="profileNick" class="text-3xl font-black text-white mb-1">...</h2>
                            <div class="flex items-center gap-2">
                                <span class="bg-wa-accent/20 text-wa-accent px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-tighter">Verified Shadow User</span>
                                <span class="text-[10px] text-gray-600 font-mono" id="profileUidDisplay">---</span>
                            </div>
                        </div>

                        <div class="bg-wa-panel p-6 rounded-[35px] border border-gray-800 space-y-6 shadow-xl">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest ml-2">Profil Name</label>
                                <div class="flex gap-2">
                                    <input id="editNickIn" type="text" class="flex-1 bg-wa-dark border border-gray-700 p-4 rounded-2xl outline-none focus:border-wa-accent transition font-bold text-sm">
                                    <button onclick="window.updateNickname()" class="bg-wa-accent text-white px-6 rounded-2xl font-black text-xs hover:bg-emerald-600 shadow-lg">UPDATE</button>
                                </div>
                            </div>

                            <div class="pt-6 border-t border-gray-800">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-[10px] font-black text-orange-400 uppercase tracking-widest ml-2">Sicherheits-Schl√ºssel</label>
                                    <button onclick="window.rebuildSecretKey()" class="text-[9px] bg-wa-accent/10 text-wa-accent border border-wa-accent/30 px-3 py-1 rounded-full font-black uppercase hover:bg-wa-accent hover:text-white transition">Erneuern</button>
                                </div>
                                <div class="bg-wa-dark p-5 rounded-2xl border border-gray-800 flex items-center justify-between group">
                                    <span id="secretKeyDisplay" class="font-mono text-sm tracking-[0.4em] text-orange-200">********</span>
                                    <button onclick="window.copyToClipboard('secretKeyDisplay')" class="text-gray-600 group-hover:text-wa-accent transition"><i data-lucide="copy" class="w-5 h-5"></i></button>
                                </div>
                                <p class="text-[9px] text-gray-600 mt-4 leading-relaxed px-2">Dieser Schl√ºssel wird ben√∂tigt, um dein Konto auf anderen Ger√§ten mit deiner UID wiederherzustellen. Teile ihn niemals!</p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <button onclick="window.toggleDarkMode()" class="w-full flex items-center justify-between p-5 bg-wa-panel rounded-2xl border border-gray-800 hover:bg-gray-800 transition shadow-md">
                                <div class="flex items-center gap-4">
                                    <div class="w-11 h-11 bg-blue-500/10 text-blue-500 rounded-2xl flex items-center justify-center"><i data-lucide="moon" class="w-6 h-6"></i></div>
                                    <span class="font-black text-sm">Dark Mode</span>
                                </div>
                                <div class="w-12 h-6 bg-wa-accent rounded-full relative"><div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div></div>
                            </button>
                            <button onclick="window.exportIdentity()" class="w-full flex items-center justify-between p-5 bg-wa-panel rounded-2xl border border-gray-800 hover:bg-gray-800 transition shadow-md">
                                <div class="flex items-center gap-4">
                                    <div class="w-11 h-11 bg-purple-500/10 text-purple-500 rounded-2xl flex items-center justify-center"><i data-lucide="hard-drive" class="w-6 h-6"></i></div>
                                    <span class="font-black text-sm">Daten-Export (Backup)</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
                            </button>
                            <button onclick="window.deleteMyAccount()" class="w-full flex items-center justify-between p-5 bg-wa-panel rounded-2xl border border-red-500/20 hover:bg-red-500/5 transition shadow-md group">
                                <div class="flex items-center gap-4">
                                    <div class="w-11 h-11 bg-red-500/10 text-red-500 rounded-2xl flex items-center justify-center group-hover:bg-red-500 group-hover:text-white transition"><i data-lucide="trash-2" class="w-6 h-6"></i></div>
                                    <span class="font-black text-sm text-red-500">Account l√∂schen</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <nav class="md:hidden h-24 bg-wa-panel border-t border-gray-800 flex justify-around items-center px-4 shrink-0 pb-safe">
                <button onclick="window.switchTab('chats')" class="flex flex-col items-center gap-2 text-wa-accent w-20">
                    <i data-lucide="message-circle" class="w-7 h-7"></i>
                    <span class="text-[9px] font-black uppercase tracking-tighter">Chats</span>
                </button>
                <button onclick="window.switchTab('status')" class="flex flex-col items-center gap-2 text-gray-500 w-20">
                    <i data-lucide="aperture" class="w-7 h-7"></i>
                    <span class="text-[9px] font-black uppercase tracking-tighter">Status</span>
                </button>
                <button onclick="window.switchTab('friends')" class="flex flex-col items-center gap-2 text-gray-500 w-20">
                    <i data-lucide="users" class="w-7 h-7"></i>
                    <span class="text-[9px] font-black uppercase tracking-tighter">Netzwerk</span>
                </button>
                <button onclick="window.switchTab('settings')" class="flex flex-col items-center gap-2 text-gray-500 w-20">
                    <i data-lucide="shield" class="w-7 h-7"></i>
                    <span class="text-[9px] font-black uppercase tracking-tighter">Safe</span>
                </button>
            </nav>
        </aside>

        <main id="chatArea" class="hidden md:flex flex-1 flex-col h-full relative overflow-hidden bg-wa-dark z-30">
            <div class="chat-wallpaper"></div>

            <header id="chatHeader" class="hidden h-16 bg-wa-panel flex items-center justify-between px-5 shrink-0 z-40 border-b border-gray-900 pt-safe shadow-xl">
                <div class="flex items-center gap-4">
                    <button onclick="window.closeChatMobile()" class="md:hidden p-2 text-gray-400 hover:text-white transition"><i data-lucide="chevron-left" class="w-7 h-7"></i></button>
                    <div id="activeChatAvatar" class="w-10 h-10 rounded-2xl bg-wa-accent flex items-center justify-center text-white font-black shadow-lg">?</div>
                    <div class="cursor-pointer" onclick="window.showModal('chatInfoModal')">
                        <h2 id="activeChatTitle" class="font-black text-gray-100 leading-none mb-1">...</h2>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 bg-wa-accent rounded-full animate-pulse"></span>
                            <p id="activeChatSub" class="text-[9px] text-wa-accent font-black uppercase tracking-widest">Ende-zu-Ende verschl√ºsselt</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="window.startVoiceCall()" class="p-3 rounded-2xl hover:bg-white/5 text-wa-accent transition" title="Voice Call"><i data-lucide="phone" class="w-5 h-5"></i></button>
                    <button onclick="window.startVideoCall()" class="p-3 rounded-2xl hover:bg-white/5 text-wa-accent transition" title="Video Call"><i data-lucide="video" class="w-5 h-5"></i></button>
                    <button onclick="window.showModal('chatInfoModal')" class="p-3 rounded-2xl hover:bg-white/5 text-gray-500 transition"><i data-lucide="info" class="w-5 h-5"></i></button>
                </div>
            </header>

            <div id="messagesList" class="flex-1 overflow-y-auto p-4 md:px-12 space-y-3 relative z-10 custom-scrollbar flex flex-col">
                <div class="flex-1 flex flex-col items-center justify-center text-gray-700 opacity-40">
                    <div class="w-24 h-24 bg-wa-panel rounded-[40px] flex items-center justify-center mb-6 border border-gray-800 shadow-2xl">
                        <i data-lucide="shield-check" class="w-10 h-10"></i>
                    </div>
                    <p class="text-xs font-black uppercase tracking-[0.4em]">W√§hle eine sichere Pipeline</p>
                </div>
            </div>

            <footer id="chatInputArea" class="hidden p-4 bg-wa-panel flex items-end gap-3 shrink-0 z-40 border-t border-gray-900 pb-safe shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
                <div id="attachmentPreview" class="hidden absolute bottom-24 left-6 right-6 bg-wa-panel p-5 rounded-[35px] border-2 border-wa-accent shadow-[0_0_60px_rgba(0,168,132,0.3)] animate-slide-up">
                    <div class="relative inline-block group">
                        <img id="prevImg" class="max-h-72 rounded-2xl border border-gray-700 shadow-2xl transition-transform group-hover:scale-[1.02]">
                        <button onclick="window.clearAttachment()" class="absolute -top-4 -right-4 bg-red-500 text-white rounded-full p-2.5 shadow-xl hover:bg-red-600 transition-all hover:scale-110 active:scale-90"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <button onclick="document.getElementById('msgFileIn').click()" class="p-3.5 text-gray-500 hover:text-wa-accent transition-all hover:rotate-90">
                    <i data-lucide="paperclip" class="w-6 h-6"></i>
                </button>
                <input type="file" id="msgFileIn" class="hidden" accept="image/*" onchange="window.handleMsgFile()">
                
                <div class="flex-1 bg-wa-dark rounded-[25px] flex items-center px-5 py-3 border border-gray-700 focus-within:border-wa-accent focus-within:ring-2 focus-within:ring-wa-accent/10 transition-all">
                    <textarea id="msgInput" placeholder="Deine verschl√ºsselte Nachricht..." class="w-full bg-transparent outline-none text-[15px] text-gray-200 resize-none py-1 custom-scrollbar max-h-40" rows="1"></textarea>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="sendBtn" onclick="window.sendMessage()" class="bg-wa-accent text-white p-4.5 rounded-[22px] shadow-xl hover:scale-105 active:scale-90 transition-all duration-300">
                        <i data-lucide="send-horizontal" class="w-6 h-6"></i>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <div id="callOverlay" class="hidden fixed inset-0 z-[5000] ios-blur flex flex-col items-center justify-between py-24 px-10 text-white animate-scale-in">
        <div class="text-center w-full relative">
            <div id="callAvatarIcon" class="w-48 h-48 rounded-[60px] bg-wa-panel mx-auto flex items-center justify-center text-7xl font-black border-4 border-wa-accent shadow-[0_0_100px_rgba(0,168,132,0.3)] mb-12 calling-active">?</div>
            <h2 id="callTargetName" class="text-5xl font-black tracking-tight mb-3">...</h2>
            <div class="flex items-center justify-center gap-3">
                <span class="w-2 h-2 bg-wa-accent rounded-full animate-ping"></span>
                <p id="callStatusText" class="text-wa-accent font-black uppercase tracking-[0.4em] text-xs">Aufbau der Pipeline...</p>
            </div>
        </div>
        <div class="flex gap-16 relative z-10">
            <button onclick="window.endCall()" class="w-24 h-24 rounded-full bg-wa-iosRed flex items-center justify-center shadow-2xl hover:scale-110 active:scale-90 transition-all duration-300 ring-8 ring-red-500/10">
                <i data-lucide="phone-off" class="w-10 h-10 fill-current"></i>
            </button>
            <button id="answerCallBtn" onclick="window.acceptCall()" class="hidden w-24 h-24 rounded-full bg-wa-iosGreen flex items-center justify-center shadow-2xl hover:scale-110 active:scale-90 transition-all duration-300 ring-8 ring-emerald-500/10 animate-bounce">
                <i data-lucide="phone" class="w-10 h-10 fill-current"></i>
            </button>
        </div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 z-[4000] glass-modal flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-md rounded-[50px] p-12 border border-gray-700 shadow-[0_40px_100px_rgba(0,0,0,0.8)] animate-scale-in">
            <div class="w-24 h-24 bg-blue-500/10 text-blue-500 rounded-[35px] flex items-center justify-center mb-10 mx-auto">
                <i data-lucide="key-round" class="w-12 h-12"></i>
            </div>
            <h3 class="text-3xl font-black text-center mb-3">Identit√§t laden</h3>
            <p class="text-sm text-gray-500 text-center mb-10 px-4">Gib deine Shadow-UID und deinen 8-stelligen Sicherheitsschl√ºssel ein.</p>
            <div class="space-y-5">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest ml-4">Shadow UID</label>
                    <input id="loginUid" type="text" placeholder="UID einf√ºgen..." class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-blue-500 transition-all font-mono">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest ml-4">Secret Key</label>
                    <input id="loginKey" type="password" placeholder="Passwort eingeben..." class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-blue-500 transition-all font-mono tracking-widest">
                </div>
            </div>
            <button onclick="window.processLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-3xl mt-12 shadow-2xl transition-all active:scale-95 text-lg">LOGIN STARTEN</button>
            <button onclick="window.hideModal('loginModal')" class="w-full mt-6 text-gray-600 font-bold uppercase text-xs tracking-widest">Abbrechen</button>
        </div>
    </div>

    <div id="createGroupModal" class="hidden fixed inset-0 z-[4000] glass-modal flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-md rounded-[50px] p-12 border border-gray-700 shadow-2xl animate-scale-in">
            <div class="w-20 h-20 bg-wa-accent/10 text-wa-accent rounded-[30px] flex items-center justify-center mb-10 mx-auto">
                <i data-lucide="plus-circle" class="w-10 h-10"></i>
            </div>
            <h3 class="text-3xl font-black text-center mb-10 tracking-tight">Neue Pipeline gr√ºnden</h3>
            <div class="space-y-6">
                <input id="newGroupName" type="text" placeholder="Name der Gruppe..." class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-wa-accent font-bold text-lg">
                <input id="newGroupPass" type="password" placeholder="Optionales Passwort..." class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-wa-accent">
            </div>
            <button onclick="window.processCreateGroup()" class="w-full bg-wa-accent hover:bg-emerald-600 text-white font-black py-5 rounded-3xl mt-12 shadow-2xl transition-all active:scale-95 text-lg uppercase tracking-widest">ERSTELLEN</button>
            <button onclick="window.hideModal('createGroupModal')" class="w-full mt-6 text-gray-600 font-bold uppercase text-xs tracking-widest">Schlie√üen</button>
        </div>
    </div>

    <div id="joinGroupModal" class="hidden fixed inset-0 z-[4000] glass-modal flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-md rounded-[50px] p-12 border border-gray-700 animate-scale-in">
            <h3 class="text-2xl font-black mb-10 flex items-center gap-4"><i data-lucide="hash" class="text-wa-accent"></i> Pipeline beitreten</h3>
            <div class="space-y-6">
                <input id="joinGroupId" type="text" placeholder="Gruppen-ID (GRP-XXXX)" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none font-mono text-wa-accent focus:border-wa-accent uppercase">
                <input id="joinGroupPass" type="password" placeholder="Passwort (falls n√∂tig)" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-wa-accent">
            </div>
            <button onclick="window.processJoinGroup()" class="w-full bg-wa-accent hover:bg-emerald-600 text-white font-black py-5 rounded-3xl mt-12 shadow-2xl transition active:scale-95">BEITRETEN</button>
            <button onclick="window.hideModal('joinGroupModal')" class="w-full mt-6 text-gray-500 font-bold uppercase text-xs">Abbrechen</button>
        </div>
    </div>

    <div id="chatInfoModal" class="hidden fixed inset-0 z-[4000] glass-modal flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-lg rounded-[60px] overflow-hidden border border-gray-800 shadow-2xl animate-scale-in">
            <div class="h-56 bg-gradient-to-br from-wa-accent/20 to-wa-dark border-b border-gray-900 flex flex-col items-center justify-center relative">
                <div id="infoAvaBig" class="w-28 h-28 rounded-[40px] bg-wa-accent text-white flex items-center justify-center text-5xl font-black shadow-[0_20px_50px_rgba(0,168,132,0.4)]">?</div>
                <button onclick="window.hideModal('chatInfoModal')" class="absolute top-8 right-8 p-2 bg-black/20 text-white rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-12">
                <h3 id="infoName" class="text-3xl font-black mb-2 tracking-tight">...</h3>
                <div id="infoType" class="text-[10px] font-black text-wa-accent uppercase tracking-[0.3em] mb-10">...</div>
                
                <div class="space-y-8">
                    <div class="bg-wa-dark p-6 rounded-[35px] border border-gray-800 relative">
                        <label class="text-[10px] font-black text-gray-600 uppercase block mb-3 ml-2">Pipeline-Invite-ID</label>
                        <div class="flex items-center gap-4">
                            <input id="infoCopyId" readonly class="bg-transparent text-sm font-mono text-wa-accent outline-none flex-1 truncate" value="---">
                            <button onclick="window.copyToClipboard('infoCopyId')" class="text-gray-500 hover:text-wa-accent transition p-2"><i data-lucide="copy" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-5 px-2">
                            <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Teilnehmer</label>
                            <span id="memberCount" class="text-[10px] bg-wa-accent/10 text-wa-accent px-2 py-0.5 rounded-full font-black">0</span>
                        </div>
                        <div id="infoMemberList" class="max-h-56 overflow-y-auto space-y-3 custom-scrollbar px-1"></div>
                    </div>
                </div>

                <div class="mt-12 flex flex-col gap-3">
                    <button id="leaveActionBtn" onclick="window.processLeaveChat()" class="w-full py-5 rounded-[28px] border-2 border-red-500/30 text-red-500 font-black hover:bg-red-500 hover:text-white transition-all duration-300 uppercase tracking-widest text-sm shadow-lg">Pipeline verlassen</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, writeBatch, limit, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";

        // STATE
        let currentUser = null;
        let activeChatId = null;
        let isPrivateMode = false;
        let myNick = "User";
        let messageUnsub = null;
        let currentCallId = null;
        let notificationPermitted = false;

        // --- AUTH INITIALIZATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const sessionUid = localStorage.getItem("shadow_uid");
                const finalUid = sessionUid || user.uid;
                currentUser = { uid: finalUid };

                const uRef = doc(db, "users", finalUid);
                const uSnap = await getDoc(uRef);

                if (!uSnap.exists()) {
                    myNick = "Shadow-" + Math.floor(1000 + Math.random() * 9000);
                    await setDoc(uRef, {
                        uid: finalUid,
                        nickname: myNick,
                        friends: [],
                        incoming: [],
                        password: null,
                        lastSeen: serverTimestamp(),
                        status: 'online'
                    });
                } else {
                    myNick = uSnap.data().nickname;
                    if (uSnap.data().password) document.getElementById('secretKeyDisplay').innerText = uSnap.data().password;
                }

                bootstrapUI();
                syncChatList();
                syncFriendsList();
                syncStatusStream();
                initializeCallListener();
                checkNotificationSystem();
            } else {
                signInAnonymously(auth);
            }
        });

        // --- UI BOOTSTRAP ---
        function bootstrapUI() {
            document.getElementById('userAvatar').innerText = myNick[0].toUpperCase();
            document.getElementById('userNickHeader').innerText = myNick;
            document.getElementById('profileNick').innerText = myNick;
            document.getElementById('profileAvaChar').innerText = myNick[0].toUpperCase();
            document.getElementById('profileUidDisplay').innerText = currentUser.uid;
            document.getElementById('editNickIn').value = myNick;
            lucide.createIcons();
        }

        // --- NOTIFICATION ENGINE ---
        window.checkNotificationSystem = () => {
            if ("Notification" in window) {
                if (Notification.permission === "default") {
                    setTimeout(() => document.getElementById('notiBanner').classList.remove('hidden'), 5000);
                } else if (Notification.permission === "granted") {
                    notificationPermitted = true;
                }
            }
        };

        window.requestNotificationPerm = async () => {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                notificationPermitted = true;
                new Notification("ShadowChat Enterprise", { body: "Verschl√ºsselte Benachrichtigungen sind jetzt aktiv.", icon: "https://cdn-icons-png.flaticon.com/512/2592/2592317.png" });
            }
            document.getElementById('notiBanner').remove();
        };

        function sendLocalPush(title, message) {
            if (notificationPermitted && document.hidden) {
                new Notification(title, { body: message, icon: "https://cdn-icons-png.flaticon.com/512/2592/2592317.png" });
            }
        }

        // --- MESSAGING SYSTEM ---
        window.sendMessage = async () => {
            const input = document.getElementById('msgInput');
            const file = document.getElementById('msgFileIn').files[0];
            const text = input.value.trim();
            
            if (!activeChatId || (!text && !file)) return;

            let imgUrl = null;
            if (file) {
                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const json = await res.json();
                if (json.success) imgUrl = json.data.url;
            }

            const msgData = {
                text: text,
                img: imgUrl,
                senderId: currentUser.uid,
                senderName: myNick,
                timestamp: serverTimestamp(),
                edited: false,
                type: 'text'
            };

            await addDoc(collection(db, `chats/${activeChatId}/messages`), msgData);
            await updateDoc(doc(db, "chats", activeChatId), { lastActivity: serverTimestamp(), lastMsg: text || "üì∑ Bild" });
            
            input.value = "";
            window.clearAttachment();
            document.getElementById('snd_msg_out').play();
        };

        window.openChatInstance = (id, name, isPriv) => {
            activeChatId = id;
            isPrivateMode = isPriv;

            document.getElementById('chatHeader').classList.replace('hidden', 'flex');
            document.getElementById('chatInputArea').classList.replace('hidden', 'flex');
            document.getElementById('activeChatTitle').innerText = name;
            document.getElementById('activeChatAvatar').innerText = name[0].toUpperCase();

            if (window.innerWidth < 768) {
                document.getElementById('mainSidebar').classList.add('hidden');
                document.getElementById('chatArea').classList.replace('hidden', 'flex');
            }

            if (messageUnsub) messageUnsub();
            
            const q = query(collection(db, `chats/${id}/messages`), orderBy("timestamp", "asc"), limit(100));
            messageUnsub = onSnapshot(q, (snap) => {
                const container = document.getElementById('messagesList');
                const shouldNotify = container.children.length > 0 && snap.docChanges().some(c => c.type === "added");
                
                container.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.senderId === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-2 animate-scale-in`;
                    
                    div.innerHTML = `
                        <div class="relative max-w-[80%] px-5 py-3 shadow-2xl ${isMe ? 'bg-wa-bubbleDarkOut text-white msg-out' : 'bg-wa-panel text-gray-100 msg-in border border-gray-800'}">
                            ${!isMe && !isPriv ? `<p class="text-[9px] font-black text-wa-accent uppercase mb-1.5 tracking-tighter">${m.senderName}</p>` : ''}
                            ${m.img ? `<img src="${m.img}" class="rounded-xl mb-3 max-w-full border border-black/20 shadow-lg cursor-pointer" onclick="window.open('${m.img}')">` : ''}
                            <div class="flex items-end gap-5">
                                <p class="text-[15px] whitespace-pre-wrap leading-relaxed select-text">${m.text || ''}</p>
                                <div class="flex items-center gap-1.5 opacity-30 mb-0.5">
                                    ${m.edited ? '<span class="text-[8px] font-black uppercase">Edited</span>' : ''}
                                    ${isMe ? `<button onclick="window.editChatMessage('${d.id}', '${m.text}')" class="hover:text-white transition"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>` : ''}
                                    <span class="text-[9px] font-bold uppercase">${m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });

                if (shouldNotify) {
                    const last = snap.docs[snap.docs.length-1].data();
                    if (last.senderId !== currentUser.uid) {
                        document.getElementById('snd_msg_in').play();
                        sendLocalPush(name, last.text || "üì∑ Verschl√ºsseltes Bild");
                    }
                }
                container.scrollTop = container.scrollHeight;
                lucide.createIcons();
            });
            updateChatInfoModalData(id, name, isPriv);
        };

        window.editChatMessage = async (msgId, oldContent) => {
            const newContent = prompt("Nachricht korrigieren:", oldContent);
            if (newContent && newContent !== oldContent) {
                await updateDoc(doc(db, `chats/${activeChatId}/messages`, msgId), {
                    text: newContent,
                    edited: true
                });
            }
        };

        // --- ACCOUNT & RECOVERY ---
        window.rebuildSecretKey = async () => {
            const pool = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789!#%@&";
            let key = "";
            for(let i=0; i<8; i++) key += pool.charAt(Math.floor(Math.random() * pool.length));
            await updateDoc(doc(db, "users", currentUser.uid), { password: key });
            document.getElementById('secretKeyDisplay').innerText = key;
            alert("Dein neuer Sicherheitsschl√ºssel wurde generiert!");
        };

        window.processLogin = async () => {
            const uid = document.getElementById('loginUid').value.trim();
            const key = document.getElementById('loginKey').value.trim();
            if (!uid || !key) return alert("Bitte alle Felder ausf√ºllen.");

            const snap = await getDoc(doc(db, "users", uid));
            if (snap.exists() && snap.data().password === key) {
                localStorage.setItem("shadow_uid", uid);
                alert("Identit√§t best√§tigt! System wird neu geladen...");
                location.reload();
            } else {
                alert("Ung√ºltige Zugangsdaten.");
            }
        };

        // --- GROUP ENGINE ---
        window.processCreateGroup = async () => {
            const name = document.getElementById('newGroupName').value.trim();
            const pass = document.getElementById('newGroupPass').value.trim();
            if (!name) return alert("Name wird ben√∂tigt.");

            const gid = "GRP-" + Math.random().toString(36).substring(2,10).toUpperCase();
            await setDoc(doc(db, "chats", gid), {
                type: 'group',
                name: name,
                password: pass || null,
                members: [currentUser.uid],
                creator: currentUser.uid,
                lastActivity: serverTimestamp(),
                lastMsg: "Gruppe wurde erstellt"
            });

            window.hideModal('createGroupModal');
            window.openChatInstance(gid, name, false);
        };

        window.processJoinGroup = async () => {
            const gid = document.getElementById('joinGroupId').value.trim().toUpperCase();
            const pass = document.getElementById('joinGroupPass').value.trim();
            if (!gid) return;

            const snap = await getDoc(doc(db, "chats", gid));
            if (snap.exists()) {
                const data = snap.data();
                if (data.password && data.password !== pass) return alert("Falsches Passwort!");
                
                await updateDoc(doc(db, "chats", gid), {
                    members: arrayUnion(currentUser.uid)
                });
                
                window.hideModal('joinGroupModal');
                window.openChatInstance(gid, data.name, false);
            } else {
                alert("Pipeline nicht gefunden.");
            }
        };

        window.processLeaveChat = async () => {
            if (!activeChatId || !confirm("M√∂chtest du diese Pipeline wirklich trennen?")) return;
            const ref = doc(db, "chats", activeChatId);
            if (isPrivateMode) {
                await updateDoc(ref, { participants: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(ref, { members: arrayRemove(currentUser.uid) });
            }
            window.hideModal('chatInfoModal');
            location.reload();
        };

        // --- CALL SYSTEM ---
        window.startVoiceCall = async () => {
            const cid = "call_" + Date.now() + "_" + currentUser.uid.substring(0,4);
            currentCallId = cid;
            await setDoc(doc(db, "calls", cid), {
                chatId: activeChatId,
                callerId: currentUser.uid,
                callerName: myNick,
                status: 'ringing',
                type: 'voice',
                timestamp: serverTimestamp()
            });
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('callTargetName').innerText = document.getElementById('activeChatTitle').innerText;
            document.getElementById('callStatusText').innerText = "Signal wird gesendet...";
            document.getElementById('answerCallBtn').classList.add('hidden');
        };

        function initializeCallListener() {
            onSnapshot(query(collection(db, "calls"), where("status", "==", "ringing")), (snap) => {
                snap.forEach(async d => {
                    const call = d.data();
                    if (call.callerId === currentUser.uid) return;

                    const chatSnap = await getDoc(doc(db, "chats", call.chatId));
                    if (chatSnap.exists()) {
                        const dat = chatSnap.data();
                        const isMember = dat.type === 'private' ? dat.participants.includes(currentUser.uid) : dat.members.includes(currentUser.uid);
                        
                        if (isMember) {
                            currentCallId = d.id;
                            document.getElementById('callOverlay').classList.remove('hidden');
                            document.getElementById('answerCallBtn').classList.remove('hidden');
                            document.getElementById('callTargetName').innerText = call.callerName;
                            document.getElementById('callStatusText').innerText = "Eingehende Pipeline-Anfrage...";
                            document.getElementById('snd_call_loop').play();
                            sendLocalPush("Anruf", call.callerName + " m√∂chte eine Sprachverbindung aufbauen.");
                        }
                    }
                });
            });
        }

        window.acceptCall = async () => {
            document.getElementById('callStatusText').innerText = "Verschl√ºsselung synchronisiert...";
            document.getElementById('answerCallBtn').classList.add('hidden');
            document.getElementById('snd_call_loop').pause();
            // Implementierung f√ºr WebRTC w√ºrde hier folgen
        };

        window.endCall = async () => {
            if (currentCallId) await deleteDoc(doc(db, "calls", currentCallId));
            document.getElementById('callOverlay').classList.add('hidden');
            document.getElementById('snd_call_loop').pause();
        };

        // --- CORE LISTS & SYNC ---
        async function syncChatList() {
            onSnapshot(query(collection(db, "chats"), orderBy("lastActivity", "desc")), (snap) => {
                const container = document.getElementById('chatList');
                container.innerHTML = "";
                
                if (snap.empty) {
                    container.innerHTML = `<div class="p-20 text-center opacity-20"><i data-lucide="message-square" class="w-12 h-12 mx-auto mb-4"></i><p class="text-xs font-black uppercase">Keine Kan√§le</p></div>`;
                    lucide.createIcons();
                    return;
                }

                snap.forEach(d => {
                    const c = d.data();
                    const isMember = c.type === 'private' ? c.participants?.includes(currentUser.uid) : c.members?.includes(currentUser.uid);
                    
                    if (isMember) {
                        let displayName = c.name;
                        if (c.type === 'private') {
                            const otherId = c.participants.find(p => p !== currentUser.uid);
                            displayName = c.names?.[otherId] || "Privater Kontakt";
                        }
                        
                        const div = document.createElement('div');
                        div.className = "p-5 hover:bg-wa-panel cursor-pointer flex items-center gap-5 transition-all animate-scale-in group border-b border-gray-800/20";
                        div.innerHTML = `
                            <div class="w-14 h-14 rounded-[20px] bg-wa-accent flex items-center justify-center text-white font-black shadow-lg text-xl group-hover:scale-105 transition-transform">${displayName[0]}</div>
                            <div class="flex-1 overflow-hidden">
                                <div class="flex justify-between items-center mb-1">
                                    <h4 class="font-black text-gray-200 truncate tracking-tight text-[15px]">${displayName}</h4>
                                    <span class="text-[8px] font-black text-gray-600 uppercase tracking-widest">${c.type}</span>
                                </div>
                                <p class="text-[13px] text-gray-500 truncate">${c.lastMsg || 'Ende-zu-Ende verschl√ºsselt'}</p>
                            </div>
                        `;
                        div.onclick = () => window.openChatInstance(d.id, displayName, c.type === 'private');
                        container.appendChild(div);
                    }
                });
            });
        }

        async function syncFriendsList() {
            onSnapshot(doc(db, "users", currentUser.uid), async (s) => {
                const d = s.data(); if (!d) return;
                
                const cList = document.getElementById('friendsList');
                cList.innerHTML = "";
                for (const fid of d.friends || []) {
                    const fSnap = await getDoc(doc(db, "users", fid));
                    if (fSnap.exists()) {
                        const fdata = fSnap.data();
                        const div = document.createElement('div');
                        div.className = "p-4 bg-wa-panel rounded-[25px] border border-gray-800 flex justify-between items-center hover:border-wa-accent transition cursor-pointer";
                        div.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-wa-accent rounded-xl flex items-center justify-center font-black text-white text-sm">${fdata.nickname[0]}</div>
                                <b class="text-sm font-black text-gray-200">${fdata.nickname}</b>
                            </div>
                            <i data-lucide="message-square" class="w-5 h-5 text-wa-accent opacity-0 group-hover:opacity-100 transition"></i>
                        `;
                        div.onclick = () => window.startPrivateConversation(fid, fdata.nickname);
                        cList.appendChild(div);
                    }
                }

                const rList = document.getElementById('requestsList');
                rList.innerHTML = "";
                if (d.incoming?.length > 0) {
                    document.getElementById('requestsBox').classList.remove('hidden');
                    for (const rid of d.incoming) {
                        const rSnap = await getDoc(doc(db, "users", rid));
                        const rName = rSnap.exists() ? rSnap.data().nickname : rid.substring(0,8);
                        rList.innerHTML += `
                            <div class="flex justify-between items-center p-4 bg-orange-500/10 border border-orange-500/30 rounded-2xl animate-pulse">
                                <span class="text-xs font-black text-orange-200 uppercase">${rName}</span>
                                <button onclick="window.acceptFriendship('${rid}')" class="text-orange-500 font-black text-[10px] uppercase hover:underline">Best√§tigen</button>
                            </div>`;
                    }
                } else {
                    document.getElementById('requestsBox').classList.add('hidden');
                }
                lucide.createIcons();
            });
        }

        window.startPrivateConversation = async (otherId, otherNick) => {
            const cid = [currentUser.uid, otherId].sort().join("_");
            await setDoc(doc(db, "chats", cid), {
                type: 'private',
                participants: [currentUser.uid, otherId],
                names: { [currentUser.uid]: myNick, [otherId]: otherNick },
                lastActivity: serverTimestamp(),
                lastMsg: "Private Pipeline ge√∂ffnet"
            }, { merge: true });
            window.openChatInstance(cid, otherNick, true);
        };

        window.acceptFriendship = async (rid) => {
            const batch = writeBatch(db);
            batch.update(doc(db, "users", currentUser.uid), { friends: arrayUnion(rid), incoming: arrayRemove(rid) });
            batch.update(doc(db, "users", rid), { friends: arrayUnion(currentUser.uid) });
            await batch.commit();
        };

        window.sendFriendRequest = async () => {
            const targetId = document.getElementById('friendUidIn').value.trim();
            if (!targetId || targetId === currentUser.uid) return alert("Ung√ºltige UID");
            const snap = await getDoc(doc(db, "users", targetId));
            if (snap.exists()) {
                await updateDoc(doc(db, "users", targetId), { incoming: arrayUnion(currentUser.uid) });
                alert("Anfrage gesendet!");
                document.getElementById('friendUidIn').value = "";
            } else {
                alert("Ziel-Nutzer existiert nicht.");
            }
        };

        // --- STATUS ENGINE ---
        function syncStatusStream() {
            onSnapshot(query(collection(db, "status"), orderBy("timestamp", "desc"), limit(12)), (snap) => {
                const grid = document.getElementById('globalStatusGrid');
                grid.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    grid.innerHTML += `
                        <div class="relative rounded-[30px] overflow-hidden aspect-[3/4] cursor-pointer group shadow-xl" onclick="window.open('${s.img}')">
                            <img src="${s.img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                            <div class="absolute bottom-4 left-4">
                                <p class="text-[10px] font-black text-wa-accent uppercase tracking-widest">${s.name}</p>
                                <p class="text-[8px] text-gray-400 uppercase">Vor kurzem</p>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.handleStatusUpload = async () => {
            const file = document.getElementById('statusUploadIn').files[0];
            if (!file) return;
            const fd = new FormData(); fd.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const json = await res.json();
            if (json.success) {
                await addDoc(collection(db, "status"), {
                    uid: currentUser.uid,
                    name: myNick,
                    img: json.data.url,
                    timestamp: serverTimestamp()
                });
                alert("Status erfolgreich geteilt!");
            }
        };

        // --- UTILS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            ['chats', 'friends', 'status', 'settings'].forEach(t => {
                const b = document.getElementById('btn-' + t);
                if (b) { b.classList.remove('border-wa-accent', 'text-wa-accent'); b.classList.add('border-transparent', 'text-gray-500'); }
            });
            const activeB = document.getElementById('btn-' + tab);
            if (activeB) { activeB.classList.add('border-wa-accent', 'text-wa-accent'); activeB.classList.remove('border-transparent', 'text-gray-500'); }
            lucide.createIcons();
        };

        window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.copyToClipboard = (id) => {
            const el = document.getElementById(id);
            const val = el.tagName === "INPUT" ? el.value : el.innerText;
            navigator.clipboard.writeText(val);
            alert("In Zwischenablage kopiert!");
        };

        window.updateNickname = async () => {
            const n = document.getElementById('editNickIn').value.trim();
            if (n) {
                await updateDoc(doc(db, "users", currentUser.uid), { nickname: n });
                location.reload();
            }
        };

        window.handleMsgFile = () => {
            const f = document.getElementById('msgFileIn').files[0];
            if (f) {
                document.getElementById('prevImg').src = URL.createObjectURL(f);
                document.getElementById('attachmentPreview').classList.remove('hidden');
            }
        };

        window.clearAttachment = () => {
            document.getElementById('msgFileIn').value = "";
            document.getElementById('attachmentPreview').classList.add('hidden');
        };

        window.closeChatMobile = () => {
            document.getElementById('chatArea').classList.add('hidden');
            document.getElementById('mainSidebar').classList.remove('hidden');
            activeChatId = null;
        };

        async function updateChatInfoModalData(id, name, isPriv) {
            document.getElementById('infoName').innerText = name;
            document.getElementById('infoAvaBig').innerText = name[0].toUpperCase();
            document.getElementById('infoCopyId').value = id;
            document.getElementById('infoType').innerText = isPriv ? "Private P2P Pipeline" : "Multi-User Group Pipeline";
            
            const list = document.getElementById('infoMemberList');
            list.innerHTML = "";
            
            if (!isPriv) {
                const snap = await getDoc(doc(db, "chats", id));
                const members = snap.data().members;
                document.getElementById('memberCount').innerText = members.length;
                for (const mid of members) {
                    const u = await getDoc(doc(db, "users", mid));
                    list.innerHTML += `
                        <div class="flex items-center gap-4 p-4 bg-wa-dark rounded-3xl border border-gray-800">
                            <div class="w-10 h-10 rounded-xl bg-gray-700 flex items-center justify-center text-xs font-black">${u.exists() ? u.data().nickname[0] : '?'}</div>
                            <span class="text-sm font-bold text-gray-300">${u.exists() ? u.data().nickname : mid}</span>
                        </div>`;
                }
            } else {
                document.getElementById('memberCount').innerText = "2";
                list.innerHTML = `<p class="text-xs text-gray-600 italic p-4 text-center">In einer privaten Pipeline sind nur du und ${name} autorisiert.</p>`;
            }
        }
    </script>
</body>
</html>
