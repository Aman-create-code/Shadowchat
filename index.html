<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShadowChat | Anonym</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .msg-bubble { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-20 md:w-72 glass h-full flex flex-col border-r border-slate-800 transition-all">
        <div class="p-6 flex items-center justify-between border-b border-slate-800">
            <h1 class="hidden md:block font-black text-2xl tracking-tighter bg-gradient-to-br from-indigo-400 to-violet-600 bg-clip-text text-transparent">SHADOW</h1>
            <button onclick="toggleGroupModal()" class="p-2 bg-indigo-600 rounded-xl hover:bg-indigo-500 shadow-lg shadow-indigo-600/20 transition-all">
                <i data-lucide="plus" class="text-white"></i>
            </button>
        </div>
        <div id="groupList" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-3">
            <p class="text-xs text-slate-500 uppercase tracking-widest font-bold px-2">Gruppen</p>
        </div>
        <div class="p-4 border-t border-slate-800 glass">
            <div class="flex items-center gap-3 bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                <div class="w-8 h-8 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-[10px] font-bold">ME</div>
                <div class="hidden md:block truncate">
                    <p class="text-[10px] text-slate-500 font-bold uppercase">Dein Profil</p>
                    <p class="text-xs font-bold truncate" id="myIdText">Anonym...</p>
                </div>
                <button onclick="toggleSettings()" class="ml-auto p-1 hover:bg-slate-800 rounded-lg transition-all">
                    <i data-lucide="settings" class="w-4 h-4 text-slate-400"></i>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black">
        <header class="h-20 glass flex items-center px-8 border-b border-white/5 z-10">
            <div>
                <h2 id="currentGroupName" class="font-bold text-xl text-white">Willkommen</h2>
                <p id="groupStatus" class="text-[10px] text-indigo-400 uppercase tracking-widest font-bold">Wähle eine Gruppe aus</p>
            </div>
        </header>

        <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar flex flex-col">
            <div class="self-center bg-indigo-600/10 border border-indigo-500/20 p-4 rounded-2xl text-center max-w-sm">
                <p class="text-xs text-indigo-300">Wähle links eine Gruppe aus oder erstelle eine neue, um komplett anonym zu chatten. Bilder werden sicher über ImgBB verarbeitet.</p>
            </div>
        </div>

        <footer class="p-6">
            <div class="max-w-5xl mx-auto">
                <div id="previewContainer" class="hidden mb-3 p-2 bg-slate-800 rounded-2xl w-fit relative border border-indigo-500/30">
                    <img id="imagePreview" src="" class="h-24 rounded-lg shadow-xl">
                    <button onclick="cancelImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg hover:scale-110 transition-all"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
                <div class="flex items-center gap-4 bg-slate-900/90 backdrop-blur-xl p-3 rounded-2xl border border-slate-700 shadow-2xl focus-within:border-indigo-500/50 transition-all">
                    <label class="cursor-pointer p-3 hover:bg-indigo-600/10 rounded-xl transition-all group">
                        <i data-lucide="image" class="text-slate-400 group-hover:text-indigo-400 transition-colors"></i>
                        <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="previewFile()">
                    </label>
                    <input type="text" id="msgInput" placeholder="Deine Nachricht..." class="flex-1 bg-transparent border-none outline-none text-white text-sm placeholder:text-slate-600">
                    <button id="sendBtn" class="bg-indigo-600 p-3 rounded-xl hover:bg-indigo-500 shadow-lg shadow-indigo-600/40 hover:scale-105 active:scale-95 transition-all">
                        <i data-lucide="send-horizontal" class="text-white"></i>
                    </button>
                </div>
            </div>
        </footer>
    </main>

    <div id="groupModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] border border-white/10 shadow-2xl">
            <div class="w-12 h-12 bg-indigo-600/20 rounded-2xl flex items-center justify-center mb-4"><i data-lucide="plus" class="text-indigo-400"></i></div>
            <h3 class="text-2xl font-black mb-2">Gruppe starten</h3>
            <p class="text-slate-400 text-xs mb-6 uppercase tracking-widest font-bold">Gib deiner Gruppe einen Namen</p>
            <input type="text" id="newGroupName" placeholder="z.B. Gaming-Talk" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl mb-6 text-white outline-none focus:border-indigo-500 transition-all">
            <div class="flex gap-4">
                <button onclick="toggleGroupModal()" class="flex-1 p-4 text-slate-500 font-bold hover:text-white transition-colors">Abbrechen</button>
                <button id="confirmCreateGroup" class="flex-1 p-4 bg-indigo-600 rounded-2xl font-bold text-white shadow-lg shadow-indigo-600/20">Erstellen</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] border border-white/10 shadow-2xl">
            <h3 class="text-2xl font-black mb-6">Filter Settings</h3>
            <div class="flex items-center justify-between p-5 bg-slate-950 rounded-[1.5rem] border border-slate-800">
                <div>
                    <p class="text-sm font-bold">Schimpfwort-Filter</p>
                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter">Jugendschutz</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="filterToggle" checked class="sr-only peer">
                    <div class="w-11 h-6 bg-slate-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
            </div>
            <button onclick="toggleSettings()" class="w-full mt-8 p-4 bg-white text-black font-black rounded-2xl hover:bg-slate-200 transition-all">Speichern & Schließen</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // DEINE FIREBASE KONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020",
            measurementId: "G-RYEETTDW17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";

        let activeGroupId = null;
        let currentUser = null;
        lucide.createIcons();

        signInAnonymously(auth);
        onAuthStateChanged(auth, u => { if(u) { currentUser = u; document.getElementById('myIdText').innerText = u.uid.substring(0,12); } });

        window.previewFile = () => {
            const file = document.getElementById('imageInput').files[0];
            const reader = new FileReader();
            reader.onload = e => { document.getElementById('imagePreview').src = e.target.result; document.getElementById('previewContainer').classList.remove('hidden'); };
            reader.readAsDataURL(file);
        };
        window.cancelImage = () => { document.getElementById('imageInput').value = ""; document.getElementById('previewContainer').classList.add('hidden'); };

        async function sendMessage() {
            const text = document.getElementById('msgInput').value;
            const file = document.getElementById('imageInput').files[0];
            const btn = document.getElementById('sendBtn');
            if(!activeGroupId || (!text && !file)) return;

            btn.disabled = true;
            let url = null;
            try {
                if(file) {
                    const fd = new FormData(); fd.append("image", file);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                    const d = await res.json(); url = d.data.url;
                }

                let filtered = text;
                if(document.getElementById('filterToggle').checked) {
                    const words = ["scheiße", "idiot", "hurensohn", "wichser", "bastard"]; 
                    words.forEach(w => { filtered = filtered.replace(new RegExp(w, "gi"), "*".repeat(w.length)); });
                }

                await addDoc(collection(db, `groups/${activeGroupId}/messages`), {
                    text: filtered, senderId: currentUser.uid, imageUrl: url, timestamp: serverTimestamp()
                });
                await updateDoc(doc(db, "groups", activeGroupId), { lastActivity: serverTimestamp() });
                document.getElementById('msgInput').value = ""; cancelImage();
            } catch (e) { console.error(e); }
            btn.disabled = false;
        }

        onSnapshot(query(collection(db, "groups"), orderBy("lastActivity", "desc")), snap => {
            const list = document.getElementById('groupList');
            list.innerHTML = '<p class="text-xs text-slate-500 uppercase tracking-widest font-bold px-2">Gruppen</p>';
            snap.forEach(d => {
                const g = d.data();
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl cursor-pointer transition-all border ${activeGroupId === d.id ? 'bg-indigo-600 border-indigo-400 text-white shadow-lg shadow-indigo-600/20' : 'bg-slate-900/50 border-white/5 text-slate-400 hover:border-slate-700'}`;
                div.innerHTML = `<p class="font-bold truncate">${g.name}</p>`;
                div.onclick = () => selectGroup(d.id, g.name);
                list.appendChild(div);
            });
        });

        let unsub = null;
        function selectGroup(id, name) {
            activeGroupId = id; document.getElementById('currentGroupName').innerText = name;
            document.getElementById('groupStatus').innerText = "Verschlüsselter Chat";
            if(unsub) unsub();
            unsub = onSnapshot(query(collection(db, `groups/${id}/messages`), orderBy("timestamp", "asc")), snap => {
                const c = document.getElementById('chatMessages'); c.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data(); const isMe = m.senderId === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `max-w-[85%] p-4 rounded-[1.5rem] msg-bubble shadow-xl ${isMe ? 'self-end bg-indigo-600 rounded-tr-none' : 'self-start bg-slate-800 rounded-tl-none border border-white/5'}`;
                    div.innerHTML = `
                        <p class="text-[9px] ${isMe ? 'text-indigo-200' : 'text-slate-500'} font-black uppercase mb-1 tracking-tighter">${m.senderId.substring(0,10)}</p>
                        ${m.imageUrl ? `<img src="${m.imageUrl}" class="rounded-xl mb-2 border border-white/10 max-h-64 object-cover">` : ''}
                        <p class="text-sm leading-relaxed">${m.text || ''}</p>
                    `;
                    c.appendChild(div);
                });
                c.scrollTop = c.scrollHeight;
            });
        }

        window.toggleGroupModal = () => document.getElementById('groupModal').classList.toggle('hidden');
        window.toggleSettings = () => document.getElementById('settingsModal').classList.toggle('hidden');
        document.getElementById('confirmCreateGroup').onclick = async () => {
            const n = document.getElementById('newGroupName').value;
            if(n) { await addDoc(collection(db, "groups"), { name: n, lastActivity: serverTimestamp() }); toggleGroupModal(); document.getElementById('newGroupName').value = ""; }
        };
        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('msgInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
