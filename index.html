<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShadowChat V12 - God Mode Enterprise</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#f0f2f5', 
                            dark: '#0b141a', 
                            panel: '#202c33',
                            accent: '#00a884', 
                            bubbleOut: '#d9fdd3', 
                            bubbleIn: '#ffffff', 
                            bubbleDarkOut: '#005c4b', 
                            bubbleDarkIn: '#233138',
                            iosRed: '#ff3b30',
                            iosGreen: '#34c759',
                            gold: '#ffb900'
                        }
                    },
                    fontFamily: { sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'SF Pro Display', sans-serif; overflow: hidden; height: 100dvh; background-color: #0b141a; color: #e9edef; margin: 0; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .glass-modal { backdrop-filter: blur(40px) saturate(200%); -webkit-backdrop-filter: blur(40px) saturate(200%); background-color: rgba(10, 10, 10, 0.9); }
        .ios-blur { backdrop-filter: blur(60px) brightness(0.5); -webkit-backdrop-filter: blur(60px) brightness(0.5); }
        
        .msg-in { border-radius: 4px 18px 18px 18px; position: relative; }
        .msg-out { border-radius: 18px 4px 18px 18px; position: relative; }
        
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes ripple { 0% { box-shadow: 0 0 0 0 rgba(0, 168, 132, 0.4); } 100% { box-shadow: 0 0 0 40px rgba(0, 168, 132, 0); } }
        @keyframes scanLine { 0% { top: 0%; } 100% { top: 100%; } }
        
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .calling-active { animation: ripple 1.8s infinite; }
        .scan-line { position: absolute; width: 100%; height: 2px; background: rgba(0, 168, 132, 0.5); animation: scanLine 2s linear infinite; }

        .chat-wallpaper { 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: 500px; opacity: 0.04; position: absolute; inset: 0; pointer-events: none; z-index: 0; 
        }
        .pb-safe { padding-bottom: var(--sab); }
        .pt-safe { padding-top: var(--sat); }

        .shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent); background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    </style>
</head>
<body class="bg-wa-dark select-none">

    <audio id="snd_msg_in" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
    <audio id="snd_msg_out" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" preload="auto"></audio>
    <audio id="snd_call_loop" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop preload="auto"></audio>
    <audio id="snd_call_connect" src="https://assets.mixkit.co/active_storage/sfx/2569/2569-preview.mp3" preload="auto"></audio>

    <div id="notiBanner" class="hidden fixed top-0 left-0 right-0 z-[6000] p-5 bg-wa-panel border-b border-wa-accent text-white flex items-center justify-between shadow-2xl animate-slide-up">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-wa-accent/20 rounded-2xl flex items-center justify-center text-wa-accent"><i data-lucide="shield-alert"></i></div>
            <div>
                <p class="font-black text-sm tracking-tight">Verschl√ºsselte Push-Dienste</p>
                <p class="text-[10px] text-gray-400 uppercase font-bold">Erforderlich f√ºr Echtzeit-Kommunikation</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="window.requestNotificationPerm()" class="bg-wa-accent hover:bg-emerald-600 text-white px-6 py-2 rounded-xl font-black text-xs transition-all uppercase">Aktivieren</button>
            <button onclick="document.getElementById('notiBanner').remove()" class="text-gray-500 font-bold text-xs p-2 uppercase">Ignorieren</button>
        </div>
    </div>

    <div class="flex h-full w-full overflow-hidden relative">
        
        <aside id="mainSidebar" class="flex flex-col w-full md:w-[450px] h-full border-r border-gray-800 bg-wa-dark z-20 shrink-0">
            
            <header class="h-20 bg-wa-panel flex items-center justify-between px-6 shrink-0 border-b border-gray-900 pt-safe">
                <div class="flex items-center gap-4">
                    <div id="userAvatar" onclick="window.switchTab('settings')" class="w-11 h-11 rounded-[16px] bg-gradient-to-br from-wa-accent to-emerald-700 flex items-center justify-center font-black text-white cursor-pointer shadow-xl hover:rotate-3 transition-transform text-xl border border-white/20">?</div>
                    <div class="hidden sm:block">
                        <h1 id="userNickHeader" class="text-[15px] font-black text-gray-100 leading-none mb-1">...</h1>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-wa-accent rounded-full animate-pulse"></span>
                            <span id="globalNetworkStatus" class="text-[10px] font-black text-wa-accent uppercase tracking-[0.15em]">Mainframe Online</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="window.showModal('loginModal')" class="p-3 rounded-2xl hover:bg-white/5 text-blue-400 transition" title="Identit√§t wechseln"><i data-lucide="fingerprint" class="w-5 h-5"></i></button>
                    <button onclick="window.showModal('createGroupModal')" class="p-3 rounded-2xl hover:bg-white/5 text-gray-400 transition"><i data-lucide="users" class="w-5 h-5"></i></button>
                    <button onclick="window.showModal('joinGroupModal')" class="p-3 rounded-2xl hover:bg-white/5 text-wa-accent transition"><i data-lucide="plus-square" class="w-5 h-5"></i></button>
                    <button onclick="window.switchTab('settings')" class="p-3 rounded-2xl hover:bg-white/5 text-gray-400 transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
                </div>
            </header>

            <div class="px-5 py-4 bg-wa-dark border-b border-gray-800/50">
                <div class="bg-wa-panel flex items-center px-5 py-3 rounded-2xl border border-gray-700/50 focus-within:border-wa-accent focus-within:ring-2 focus-within:ring-wa-accent/10 transition-all">
                    <i data-lucide="search" class="w-4 h-4 text-gray-500"></i>
                    <input type="text" id="mainSearch" placeholder="Verschl√ºsselte Suche..." class="bg-transparent text-sm w-full outline-none px-4 text-gray-200 placeholder:text-gray-600">
                </div>
            </div>

            <nav class="flex bg-wa-dark border-b border-gray-800">
                <button onclick="window.switchTab('chats')" id="btn-chats" class="flex-1 py-5 text-[10px] font-black uppercase tracking-[0.25em] border-b-2 border-wa-accent text-wa-accent transition-all duration-300">Nachrichten</button>
                <button onclick="window.switchTab('friends')" id="btn-friends" class="flex-1 py-5 text-[10px] font-black uppercase tracking-[0.25em] border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-all duration-300">Netzwerk</button>
                <button onclick="window.switchTab('status')" id="btn-status" class="flex-1 py-5 text-[10px] font-black uppercase tracking-[0.25em] border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition-all duration-300">Pipeline</button>
            </nav>

            <div class="flex-1 overflow-y-auto custom-scrollbar bg-wa-dark relative">
                <section id="tab-chats" class="tab-pane block animate-scale-in">
                    <div id="chatList" class="divide-y divide-gray-800/30">
                        <div class="p-6 space-y-4">
                            <div class="flex items-center gap-4 shimmer h-16 rounded-2xl"></div>
                            <div class="flex items-center gap-4 shimmer h-16 rounded-2xl"></div>
                        </div>
                    </div>
                </section>

                <section id="tab-friends" class="tab-pane hidden p-8 animate-scale-in">
                    <div class="space-y-10">
                        <div class="bg-wa-panel p-8 rounded-[40px] border border-gray-700/50 shadow-2xl relative overflow-hidden">
                            <div class="scan-line"></div>
                            <h4 class="text-[10px] font-black text-wa-accent uppercase tracking-widest mb-6">UID Handshake anfordern</h4>
                            <div class="flex flex-col gap-4">
                                <input id="friendUidIn" type="text" placeholder="SHADOW-UID-XXXX" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-2xl text-sm font-mono outline-none focus:border-wa-accent">
                                <button onclick="window.sendFriendRequest()" class="w-full bg-wa-accent hover:bg-emerald-600 text-white py-4 rounded-2xl font-black shadow-lg transition active:scale-95 flex items-center justify-center gap-2">
                                    <i data-lucide="user-plus" class="w-5 h-5"></i> PIPELINE STARTEN
                                </button>
                            </div>
                        </div>
                        <div id="requestsBox" class="hidden animate-bounce">
                            <h4 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-4">Eingehende Signale</h4>
                            <div id="requestsList" class="space-y-4"></div>
                        </div>
                        <div>
                            <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-6 px-2">Verifizierte Kontakte</h4>
                            <div id="friendsList" class="space-y-3"></div>
                        </div>
                    </div>
                </section>

                <section id="tab-status" class="tab-pane hidden p-8 animate-scale-in">
                    <div class="mb-12 p-6 bg-gradient-to-br from-wa-panel to-black rounded-[35px] border-2 border-dashed border-gray-700 hover:border-wa-accent transition-all cursor-pointer group" onclick="document.getElementById('statusUploadIn').click()">
                        <div class="flex items-center gap-6">
                            <div class="w-20 h-20 rounded-[25px] border-2 border-wa-accent p-1">
                                <div class="w-full h-full rounded-[20px] bg-gray-800 flex items-center justify-center overflow-hidden">
                                    <i data-lucide="aperture" class="w-8 h-8 text-wa-accent group-hover:rotate-90 transition-transform duration-500"></i>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-black text-white text-lg">Status-Update</h3>
                                <p class="text-xs text-gray-500">Tempor√§re Datenpakete senden</p>
                            </div>
                        </div>
                        <input type="file" id="statusUploadIn" class="hidden" accept="image/*" onchange="window.handleStatusUpload()">
                    </div>
                    <div id="globalStatusGrid" class="grid grid-cols-2 gap-5"></div>
                </section>

                <section id="tab-settings" class="tab-pane hidden animate-scale-in pb-20">
                    <div class="h-48 bg-gradient-to-br from-wa-accent via-emerald-900 to-black relative">
                        <div class="absolute -bottom-16 left-10">
                            <div id="profileAvaLarge" class="w-36 h-36 rounded-[45px] bg-wa-panel border-[10px] border-wa-dark flex items-center justify-center text-6xl font-black text-white shadow-2xl relative group overflow-hidden">
                                <span id="profileAvaChar">?</span>
                                <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition cursor-pointer"><i data-lucide="camera" class="w-10 h-10"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-24 px-10 space-y-10">
                        <div>
                            <h2 id="profileNick" class="text-4xl font-black text-white mb-2">...</h2>
                            <div class="flex items-center gap-3">
                                <span class="bg-wa-accent/10 text-wa-accent px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest border border-wa-accent/20">Identity Verified</span>
                                <span id="profileUidDisplay" class="text-[10px] font-mono text-gray-600 truncate max-w-[150px]">---</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-wa-panel p-6 rounded-[30px] border border-gray-800">
                                <p class="text-[10px] font-black text-gray-600 uppercase mb-2">Uptime</p>
                                <p class="text-xl font-black text-white">99.9%</p>
                            </div>
                            <div class="bg-wa-panel p-6 rounded-[30px] border border-gray-800">
                                <p class="text-[10px] font-black text-gray-600 uppercase mb-2">Messages</p>
                                <p id="statMsgCount" class="text-xl font-black text-white">---</p>
                            </div>
                        </div>
                        <div class="bg-wa-panel p-8 rounded-[40px] border border-gray-800 space-y-8 shadow-2xl">
                            <div class="space-y-3">
                                <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest ml-4">Codename √§ndern</label>
                                <input id="editNickIn" type="text" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-2xl outline-none focus:border-wa-accent transition font-bold text-gray-200">
                                <button onclick="window.updateNickname()" class="w-full bg-wa-accent text-white py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg">Daten synchronisieren</button>
                            </div>
                            <div class="pt-8 border-t border-gray-800">
                                <button onclick="window.copyMyId()" class="w-full flex items-center justify-between p-5 bg-wa-dark rounded-2xl border border-gray-700 hover:bg-gray-800 transition group">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-blue-500/10 text-blue-400 rounded-xl flex items-center justify-center"><i data-lucide="copy" class="w-5 h-5"></i></div>
                                        <span class="font-black text-xs uppercase text-gray-300">Meine UID kopieren</span>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
                                </button>
                            </div>
                        </div>
                        <button onclick="window.deleteMyAccount()" class="w-full py-5 rounded-3xl border border-red-500/30 text-red-500 font-black uppercase text-[10px] tracking-widest hover:bg-red-500 hover:text-white transition-all">Account Terminieren</button>
                    </div>
                </section>
            </div>
        </aside>

        <main id="chatArea" class="hidden md:flex flex-1 flex-col h-full relative overflow-hidden bg-wa-dark z-30">
            <div class="chat-wallpaper"></div>

            <header id="chatHeader" class="hidden h-20 bg-wa-panel flex items-center justify-between px-6 shrink-0 z-40 border-b border-gray-900 pt-safe shadow-2xl">
                <div class="flex items-center gap-4">
                    <button onclick="window.closeChatMobile()" class="md:hidden p-3 text-gray-500"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                    <div id="activeChatAvatar" class="w-12 h-12 rounded-2xl bg-wa-accent flex items-center justify-center text-white font-black shadow-lg text-lg">?</div>
                    <div class="cursor-pointer" onclick="window.showModal('chatInfoModal')">
                        <h2 id="activeChatTitle" class="font-black text-gray-100 leading-none mb-1 text-lg">...</h2>
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-wa-accent rounded-full animate-pulse"></span>
                            <p id="activeChatSub" class="text-[10px] text-wa-accent font-black uppercase tracking-[0.2em]">P2P Pipeline aktiv</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="window.startVoiceCall()" class="w-12 h-12 rounded-2xl hover:bg-white/5 text-wa-accent flex items-center justify-center transition-all"><i data-lucide="phone" class="w-6 h-6"></i></button>
                    <button onclick="window.startVideoCall()" class="w-12 h-12 rounded-2xl hover:bg-white/5 text-wa-accent flex items-center justify-center transition-all"><i data-lucide="video" class="w-6 h-6"></i></button>
                    <button onclick="window.showModal('chatInfoModal')" class="w-12 h-12 rounded-2xl hover:bg-white/5 text-gray-500 flex items-center justify-center transition-all"><i data-lucide="more-vertical" class="w-6 h-6"></i></button>
                </div>
            </header>

            <div id="messagesList" class="flex-1 overflow-y-auto p-6 md:px-16 space-y-4 relative z-10 custom-scrollbar flex flex-col">
                <div class="flex-1 flex flex-col items-center justify-center opacity-20 pointer-events-none">
                    <div class="w-32 h-32 bg-wa-panel rounded-[50px] flex items-center justify-center mb-8 border border-gray-800 shadow-3xl">
                        <i data-lucide="shield-check" class="w-14 h-14"></i>
                    </div>
                    <p class="text-xs font-black uppercase tracking-[0.5em]">Initializing Secure Channel</p>
                </div>
            </div>

            <footer id="chatInputArea" class="hidden p-6 bg-wa-panel flex items-end gap-4 shrink-0 z-40 border-t border-gray-900 pb-safe shadow-[0_-15px_40px_rgba(0,0,0,0.6)]">
                <div id="attachmentPreview" class="hidden absolute bottom-28 left-8 right-8 bg-wa-panel p-6 rounded-[40px] border-2 border-wa-accent shadow-[0_0_80px_rgba(0,168,132,0.4)] animate-slide-up z-50">
                    <div class="relative inline-block">
                        <img id="prevImg" class="max-h-[400px] rounded-3xl border border-gray-700 shadow-2xl">
                        <button onclick="window.clearAttachment()" class="absolute -top-4 -right-4 bg-red-500 text-white rounded-full p-3 shadow-xl hover:scale-110 active:scale-90 transition-all"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                </div>

                <button onclick="document.getElementById('msgFileIn').click()" class="p-4 text-gray-500 hover:text-wa-accent transition-all hover:rotate-45">
                    <i data-lucide="plus-circle" class="w-7 h-7"></i>
                </button>
                <input type="file" id="msgFileIn" class="hidden" accept="image/*" onchange="window.handleMsgFile()">
                
                <div class="flex-1 bg-wa-dark rounded-[28px] flex items-center px-6 py-4 border border-gray-700 focus-within:border-wa-accent transition-all shadow-inner">
                    <textarea id="msgInput" placeholder="Sichere Nachricht senden..." class="w-full bg-transparent outline-none text-[16px] text-gray-200 resize-none py-1 custom-scrollbar max-h-48" rows="1"></textarea>
                </div>
                
                <button id="sendBtn" onclick="window.sendMessage()" class="bg-wa-accent text-white p-5 rounded-[24px] shadow-2xl hover:scale-105 active:scale-90 transition-all duration-300 ring-4 ring-emerald-500/10">
                    <i data-lucide="send-horizontal" class="w-7 h-7"></i>
                </button>
            </footer>
        </main>
    </div>

    <div id="callOverlay" class="hidden fixed inset-0 z-[7000] ios-blur flex flex-col items-center justify-between py-24 px-10 text-white animate-scale-in">
        <div class="text-center w-full">
            <div class="relative inline-block mb-12">
                <div id="callAvatarIcon" class="w-56 h-56 rounded-[70px] bg-wa-panel flex items-center justify-center text-8xl font-black border-4 border-wa-accent shadow-[0_0_120px_rgba(0,168,132,0.4)] calling-active relative z-10 overflow-hidden">?</div>
                <div class="absolute -inset-10 bg-wa-accent/10 rounded-full animate-ping opacity-20"></div>
            </div>
            <h2 id="callTargetName" class="text-5xl font-black tracking-tighter mb-4">Pipeline Root</h2>
            <div class="flex items-center justify-center gap-4">
                <div class="flex gap-1"><span class="w-2 h-2 bg-wa-accent rounded-full animate-bounce"></span><span class="w-2 h-2 bg-wa-accent rounded-full animate-bounce [animation-delay:0.2s]"></span><span class="w-2 h-2 bg-wa-accent rounded-full animate-bounce [animation-delay:0.4s]"></span></div>
                <p id="callStatusText" class="text-wa-accent font-black uppercase tracking-[0.5em] text-xs">Synchronisierung</p>
            </div>
        </div>
        
        <div class="flex gap-20 relative z-20">
            <button onclick="window.endCall()" class="w-24 h-24 rounded-full bg-wa-iosRed flex items-center justify-center shadow-[0_20px_60px_rgba(255,59,48,0.4)] hover:scale-110 active:scale-90 transition-all ring-8 ring-red-500/10">
                <i data-lucide="phone-off" class="w-10 h-10"></i>
            </button>
            <button id="answerCallBtn" onclick="window.acceptCall()" class="hidden w-24 h-24 rounded-full bg-wa-iosGreen flex items-center justify-center shadow-[0_20px_60px_rgba(52,199,89,0.4)] hover:scale-110 active:scale-90 transition-all ring-8 ring-emerald-500/10 animate-bounce">
                <i data-lucide="phone" class="w-10 h-10"></i>
            </button>
        </div>

        <div class="absolute bottom-10 text-[9px] font-black uppercase tracking-[0.8em] text-gray-600">Encrypted Voip Layer V12</div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 z-[8000] glass-modal flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-md rounded-[60px] p-12 border border-gray-700 shadow-3xl animate-scale-in relative overflow-hidden">
            <div class="scan-line"></div>
            <div class="w-24 h-24 bg-blue-600/20 text-blue-500 rounded-[35px] flex items-center justify-center mb-10 mx-auto border border-blue-500/30">
                <i data-lucide="fingerprint" class="w-12 h-12"></i>
            </div>
            <h3 class="text-3xl font-black text-center mb-4 tracking-tight">System Login</h3>
            <p class="text-xs text-gray-500 text-center mb-10 uppercase font-bold tracking-widest">Identit√§t √ºber UID & Key validieren</p>
            <div class="space-y-6">
                <input id="loginUid" type="text" placeholder="SHADOW-UID" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-blue-500 transition-all font-mono text-center">
                <input id="loginKey" type="password" placeholder="SECURITY-KEY" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-blue-500 transition-all font-mono text-center">
            </div>
            <button onclick="window.processLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-3xl mt-12 shadow-2xl transition-all active:scale-95 text-sm uppercase tracking-widest">Initialisierung</button>
            <button onclick="window.hideModal('loginModal')" class="w-full mt-6 text-gray-600 font-black uppercase text-[10px] tracking-widest">Abbrechen</button>
        </div>
    </div>

    <div id="createGroupModal" class="hidden fixed inset-0 z-[8000] glass-modal flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-md rounded-[60px] p-14 border border-gray-700 shadow-3xl animate-scale-in">
            <h3 class="text-3xl font-black mb-12 flex items-center gap-4"><i data-lucide="plus-square" class="text-wa-accent"></i> Neue Pipeline</h3>
            <div class="space-y-8">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest ml-4">Pipeline Name</label>
                    <input id="newGroupName" type="text" placeholder="z.B. OPS-Center" class="w-full bg-wa-dark border border-gray-700 p-5 rounded-3xl outline-none focus:border-wa-accent font-bold text-lg">
                </div>
            </div>
            <button onclick="window.processCreateGroup()" class="w-full bg-wa-accent hover:bg-emerald-600 text-white font-black py-5 rounded-3xl mt-12 shadow-2xl transition active:scale-95 text-xs uppercase tracking-widest">Pipeline Erstellen</button>
            <button onclick="window.hideModal('createGroupModal')" class="w-full mt-6 text-gray-600 font-bold uppercase text-[10px] tracking-widest">Schlie√üen</button>
        </div>
    </div>

    <div id="chatInfoModal" class="hidden fixed inset-0 z-[8000] glass-modal flex items-center justify-center p-6">
        <div class="bg-wa-panel w-full max-w-lg rounded-[60px] overflow-hidden border border-gray-800 shadow-3xl animate-scale-in">
            <div class="h-60 bg-gradient-to-br from-wa-accent/20 to-black border-b border-gray-900 flex flex-col items-center justify-center relative">
                <div id="infoAvaBig" class="w-32 h-32 rounded-[40px] bg-wa-accent text-white flex items-center justify-center text-5xl font-black shadow-2xl">?</div>
                <button onclick="window.hideModal('chatInfoModal')" class="absolute top-10 right-10 p-3 bg-black/40 text-white rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-12">
                <h3 id="infoName" class="text-3xl font-black mb-1">...</h3>
                <div id="infoType" class="text-[10px] font-black text-wa-accent uppercase tracking-[0.4em] mb-10">...</div>
                
                <div class="space-y-10">
                    <div class="bg-wa-dark p-6 rounded-[35px] border border-gray-800">
                        <label class="text-[10px] font-black text-gray-600 uppercase block mb-3 ml-2">Channel-ID (Invite)</label>
                        <div class="flex items-center gap-4">
                            <input id="infoCopyId" readonly class="bg-transparent text-sm font-mono text-wa-accent outline-none flex-1 truncate" value="---">
                            <button onclick="window.copyToClipboard('infoCopyId')" class="text-gray-500 hover:text-wa-accent transition p-2"><i data-lucide="copy" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="flex justify-between items-center px-4">
                            <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Autorisierte Teilnehmer</h4>
                            <span id="memberCount" class="text-[10px] bg-wa-accent/20 text-wa-accent px-3 py-1 rounded-full font-black">0</span>
                        </div>
                        <div id="infoMemberList" class="max-h-60 overflow-y-auto space-y-3 custom-scrollbar pr-2"></div>
                    </div>
                </div>

                <div class="mt-12 flex flex-col gap-4">
                    <button id="leaveActionBtn" onclick="window.processLeaveChat()" class="w-full py-5 rounded-3xl border-2 border-red-500/20 text-red-500 font-black hover:bg-red-500 hover:text-white transition-all uppercase tracking-widest text-[10px]">Verbindung Trennen</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, writeBatch, limit, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CORE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";

        // APP STATE
        let currentUser = null;
        let activeChatId = null;
        let isPrivateMode = false;
        let myNick = "Agent";
        let messageUnsub = null;
        let currentCallId = null;
        let notiPermitted = false;

        // --- AUTH & INITIALIZATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const storedUid = localStorage.getItem("shadow_uid");
                const finalUid = storedUid || user.uid;
                currentUser = { uid: finalUid };

                const uRef = doc(db, "users", finalUid);
                const uSnap = await getDoc(uRef);

                if (!uSnap.exists()) {
                    myNick = "Agent-" + Math.floor(1000 + Math.random() * 8999);
                    await setDoc(uRef, {
                        uid: finalUid,
                        nickname: myNick,
                        friends: [],
                        incoming: [],
                        msgCount: 0,
                        lastSeen: serverTimestamp(),
                        status: 'online'
                    });
                } else {
                    myNick = uSnap.data().nickname;
                    updateStats(uSnap.data().msgCount || 0);
                }

                bootstrap();
                syncMessages();
                syncContacts();
                syncStatusStream();
                initCallSystem();
            } else {
                signInAnonymously(auth);
            }
        });

        function bootstrap() {
            document.getElementById('userAvatar').innerText = myNick[0];
            document.getElementById('userNickHeader').innerText = myNick;
            document.getElementById('profileNick').innerText = myNick;
            document.getElementById('profileAvaChar').innerText = myNick[0];
            document.getElementById('profileUidDisplay').innerText = currentUser.uid;
            document.getElementById('editNickIn').value = myNick;
            
            checkNotiStatus();
            lucide.createIcons();
        }

        function updateStats(count) {
            document.getElementById('statMsgCount').innerText = count;
        }

        // --- CALL SYSTEM (VOIP ENGINE) ---
        window.initCallSystem = () => {
            // Eingehende Anrufe √ºberwachen
            const q = query(collection(db, "calls"), where("status", "in", ["ringing", "connecting"]));
            onSnapshot(q, async (snap) => {
                for (const change of snap.docChanges()) {
                    if (change.type === "added" || change.type === "modified") {
                        const call = change.doc.data();
                        if (call.callerId === currentUser.uid) continue;

                        // Geh√∂rt der User zu diesem Chat?
                        const chatRef = doc(db, "chats", call.chatId);
                        const chatSnap = await getDoc(chatRef);
                        
                        if (chatSnap.exists()) {
                            const chatData = chatSnap.data();
                            const isAuth = chatData.type === 'private' ? 
                                chatData.participants.includes(currentUser.uid) : 
                                chatData.members.includes(currentUser.uid);

                            if (isAuth) {
                                currentCallId = change.doc.id;
                                handleIncomingCall(call);
                            }
                        }
                    }
                    if (change.type === "removed") {
                        if (change.doc.id === currentCallId) {
                            window.endCallUI();
                        }
                    }
                }
            });
        };

        function handleIncomingCall(call) {
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('answerCallBtn').classList.remove('hidden');
            document.getElementById('callTargetName').innerText = call.callerName;
            document.getElementById('callStatusText').innerText = "Signal wird empfangen...";
            document.getElementById('snd_call_loop').play();
            
            if (Notification.permission === "granted") {
                new Notification("Sicherer Anruf", { body: `${call.callerName} ruft dich an...` });
            }
        }

        window.startVoiceCall = async () => {
            if (!activeChatId) return;
            const cid = "call_" + Date.now() + "_" + currentUser.uid.substring(0,4);
            currentCallId = cid;

            await setDoc(doc(db, "calls", cid), {
                chatId: activeChatId,
                callerId: currentUser.uid,
                callerName: myNick,
                status: 'ringing',
                type: 'voice',
                timestamp: serverTimestamp()
            });

            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('callTargetName').innerText = document.getElementById('activeChatTitle').innerText;
            document.getElementById('callStatusText').innerText = "Verschl√ºsselung wird aufgebaut...";
            document.getElementById('answerCallBtn').classList.add('hidden');
            
            // Auf Antwort warten
            onSnapshot(doc(db, "calls", cid), (s) => {
                if (s.exists() && s.data().status === 'connected') {
                    document.getElementById('callStatusText').innerText = "Verbunden (AES-256)";
                    document.getElementById('snd_call_connect').play();
                }
            });
        };

        window.acceptCall = async () => {
            if (!currentCallId) return;
            await updateDoc(doc(db, "calls", currentCallId), { status: 'connected' });
            document.getElementById('answerCallBtn').classList.add('hidden');
            document.getElementById('callStatusText').innerText = "Datenstrom aktiv";
            document.getElementById('snd_call_loop').pause();
            document.getElementById('snd_call_connect').play();
        };

        window.endCall = async () => {
            if (currentCallId) {
                await deleteDoc(doc(db, "calls", currentCallId));
                currentCallId = null;
            }
            window.endCallUI();
        };

        window.endCallUI = () => {
            document.getElementById('callOverlay').classList.add('hidden');
            document.getElementById('snd_call_loop').pause();
            document.getElementById('snd_call_loop').currentTime = 0;
        };

        // --- MESSAGE LOGIC (ADVANCED) ---
        window.sendMessage = async () => {
            const input = document.getElementById('msgInput');
            const file = document.getElementById('msgFileIn').files[0];
            const text = input.value.trim();
            
            if (!activeChatId || (!text && !file)) return;

            let imgUrl = null;
            if (file) {
                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const json = await res.json();
                if (json.success) imgUrl = json.data.url;
            }

            const msgData = {
                text,
                img: imgUrl,
                senderId: currentUser.uid,
                senderName: myNick,
                timestamp: serverTimestamp(),
                readBy: [currentUser.uid],
                type: 'text'
            };

            await addDoc(collection(db, `chats/${activeChatId}/messages`), msgData);
            await updateDoc(doc(db, "chats", activeChatId), { 
                lastActivity: serverTimestamp(), 
                lastMsg: text ? text.substring(0,30) : "üì∑ Datei" 
            });
            await updateDoc(doc(db, "users", currentUser.uid), { msgCount: increment(1) });

            input.value = "";
            window.clearAttachment();
            document.getElementById('snd_msg_out').play();
            input.focus();
        };

        window.openChatInstance = (id, name, isPriv) => {
            activeChatId = id;
            isPrivateMode = isPriv;

            document.getElementById('chatHeader').classList.replace('hidden', 'flex');
            document.getElementById('chatInputArea').classList.replace('hidden', 'flex');
            document.getElementById('activeChatTitle').innerText = name;
            document.getElementById('activeChatAvatar').innerText = name[0];

            if (window.innerWidth < 768) {
                document.getElementById('mainSidebar').classList.add('hidden');
                document.getElementById('chatArea').classList.replace('hidden', 'flex');
            }

            if (messageUnsub) messageUnsub();
            
            const q = query(collection(db, `chats/${id}/messages`), orderBy("timestamp", "asc"), limit(80));
            messageUnsub = onSnapshot(q, (snap) => {
                const container = document.getElementById('messagesList');
                const lastMsgAdded = snap.docChanges().find(c => c.type === "added");
                
                container.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.senderId === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-4 animate-scale-in group`;
                    
                    const time = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                    
                    div.innerHTML = `
                        <div class="max-w-[75%] px-5 py-3 shadow-2xl ${isMe ? 'bg-wa-bubbleDarkOut text-white msg-out' : 'bg-wa-panel text-gray-100 msg-in border border-gray-800'}">
                            ${!isMe && !isPriv ? `<p class="text-[9px] font-black text-wa-accent uppercase mb-2 tracking-widest">${m.senderName}</p>` : ''}
                            ${m.img ? `<img src="${m.img}" class="rounded-2xl mb-3 border border-black/20 shadow-lg cursor-pointer hover:scale-[1.01] transition" onclick="window.open('${m.img}')">` : ''}
                            <div class="flex items-end gap-6">
                                <p class="text-[15px] leading-relaxed select-text">${m.text || ''}</p>
                                <div class="flex items-center gap-1 opacity-40">
                                    <span class="text-[8px] font-black uppercase">${time}</span>
                                    ${isMe ? `<i data-lucide="check-check" class="w-3 h-3 text-wa-accent"></i>` : ''}
                                </div>
                            </div>
                            <button onclick="window.deleteMessage('${d.id}')" class="absolute -top-2 -right-2 bg-wa-dark p-1.5 rounded-full border border-gray-700 opacity-0 group-hover:opacity-100 transition shadow-xl"><i data-lucide="trash-2" class="w-3 h-3 text-red-500"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });

                if (lastMsgAdded && lastMsgAdded.doc.data().senderId !== currentUser.uid) {
                    document.getElementById('snd_msg_in').play();
                }
                container.scrollTop = container.scrollHeight;
                lucide.createIcons();
            });
            updateInfoModal(id, name, isPriv);
        };

        window.deleteMessage = async (mid) => {
            if (confirm("Nachricht f√ºr alle l√∂schen?")) {
                await deleteDoc(doc(db, `chats/${activeChatId}/messages`, mid));
            }
        };

        // --- CONTACTS & GROUP SYNC ---
        function syncMessages() {
            onSnapshot(query(collection(db, "chats"), orderBy("lastActivity", "desc")), (snap) => {
                const list = document.getElementById('chatList');
                list.innerHTML = "";
                
                if (snap.empty) {
                    list.innerHTML = `<div class="p-20 text-center opacity-20"><i data-lucide="shield-off" class="w-16 h-16 mx-auto mb-4"></i><p class="text-[10px] font-black uppercase">Keine aktiven Protokolle</p></div>`;
                    lucide.createIcons();
                    return;
                }

                snap.forEach(d => {
                    const c = d.data();
                    const isM = c.type === 'private' ? c.participants?.includes(currentUser.uid) : c.members?.includes(currentUser.uid);
                    
                    if (isM) {
                        let name = c.name;
                        if (c.type === 'private') {
                            const other = c.participants.find(p => p !== currentUser.uid);
                            name = c.names?.[other] || "Kontakt";
                        }
                        const div = document.createElement('div');
                        div.className = "p-5 hover:bg-wa-panel cursor-pointer flex items-center gap-5 transition-all group border-b border-gray-900/40";
                        div.innerHTML = `
                            <div class="w-14 h-14 rounded-2xl bg-wa-accent flex items-center justify-center text-white font-black shadow-lg text-xl">${name[0]}</div>
                            <div class="flex-1 overflow-hidden">
                                <div class="flex justify-between items-center mb-1">
                                    <h4 class="font-black text-gray-100 truncate text-[15px]">${name}</h4>
                                    <span class="text-[8px] font-black text-gray-600 uppercase tracking-widest">${c.type}</span>
                                </div>
                                <p class="text-xs text-gray-500 truncate font-medium">${c.lastMsg || 'Ende-zu-Ende verschl√ºsselt'}</p>
                            </div>
                        `;
                        div.onclick = () => window.openChatInstance(d.id, name, c.type === 'private');
                        list.appendChild(div);
                    }
                });
            });
        }

        async function syncContacts() {
            onSnapshot(doc(db, "users", currentUser.uid), async (s) => {
                const d = s.data(); if (!d) return;
                
                const cList = document.getElementById('friendsList');
                cList.innerHTML = "";
                for (const fid of d.friends || []) {
                    const fSnap = await getDoc(doc(db, "users", fid));
                    if (fSnap.exists()) {
                        const fdata = fSnap.data();
                        const div = document.createElement('div');
                        div.className = "p-5 bg-wa-panel rounded-[30px] border border-gray-800 flex justify-between items-center hover:border-wa-accent transition cursor-pointer group shadow-lg";
                        div.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-11 h-11 bg-wa-accent rounded-2xl flex items-center justify-center font-black text-white">${fdata.nickname[0]}</div>
                                <div>
                                    <b class="text-sm font-black text-gray-200">${fdata.nickname}</b>
                                    <p class="text-[9px] text-wa-accent uppercase font-black">Trusted Link</p>
                                </div>
                            </div>
                            <i data-lucide="message-square" class="w-5 h-5 text-wa-accent"></i>
                        `;
                        div.onclick = () => window.startPrivateConversation(fid, fdata.nickname);
                        cList.appendChild(div);
                    }
                }

                const rList = document.getElementById('requestsList');
                rList.innerHTML = "";
                if (d.incoming?.length > 0) {
                    document.getElementById('requestsBox').classList.remove('hidden');
                    for (const rid of d.incoming) {
                        rList.innerHTML += `
                            <div class="flex justify-between items-center p-5 bg-orange-500/10 border border-orange-500/30 rounded-3xl animate-pulse">
                                <span class="text-xs font-black text-orange-200 uppercase tracking-widest">${rid.substring(0,12)}...</span>
                                <button onclick="window.acceptFriendship('${rid}')" class="bg-orange-500 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Accept</button>
                            </div>`;
                    }
                } else { document.getElementById('requestsBox').classList.add('hidden'); }
                lucide.createIcons();
            });
        }

        window.startPrivateConversation = async (oid, onick) => {
            const cid = [currentUser.uid, oid].sort().join("_");
            await setDoc(doc(db, "chats", cid), {
                type: 'private',
                participants: [currentUser.uid, oid],
                names: { [currentUser.uid]: myNick, [oid]: onick },
                lastActivity: serverTimestamp(),
                lastMsg: "Private Pipeline ge√∂ffnet"
            }, { merge: true });
            window.openChatInstance(cid, onick, true);
        };

        window.sendFriendRequest = async () => {
            const tid = document.getElementById('friendUidIn').value.trim();
            if (!tid || tid === currentUser.uid) return;
            const snap = await getDoc(doc(db, "users", tid));
            if (snap.exists()) {
                await updateDoc(doc(db, "users", tid), { incoming: arrayUnion(currentUser.uid) });
                alert("Signalanfrage wurde √ºbermittelt.");
                document.getElementById('friendUidIn').value = "";
            } else {
                alert("Ziel-UID nicht im Mainframe gefunden.");
            }
        };

        window.acceptFriendship = async (rid) => {
            const batch = writeBatch(db);
            batch.update(doc(db, "users", currentUser.uid), { friends: arrayUnion(rid), incoming: arrayRemove(rid) });
            batch.update(doc(db, "users", rid), { friends: arrayUnion(currentUser.uid) });
            await batch.commit();
        };

        // --- GROUP ADMIN ---
        window.processCreateGroup = async () => {
            const name = document.getElementById('newGroupName').value.trim();
            if (!name) return;
            const gid = "GRP-" + Math.random().toString(36).substring(2,12).toUpperCase();
            await setDoc(doc(db, "chats", gid), {
                type: 'group',
                name: name,
                members: [currentUser.uid],
                creator: currentUser.uid,
                lastActivity: serverTimestamp(),
                lastMsg: "Zentralrechner verbunden"
            });
            window.hideModal('createGroupModal');
            window.openChatInstance(gid, name, false);
        };

        window.processJoinGroup = async () => {
            const gid = document.getElementById('joinGroupId').value.trim().toUpperCase();
            if (!gid) return;
            const snap = await getDoc(doc(db, "chats", gid));
            if (snap.exists()) {
                await updateDoc(doc(db, "chats", gid), { members: arrayUnion(currentUser.uid) });
                window.hideModal('joinGroupModal');
                window.openChatInstance(gid, snap.data().name, false);
            } else {
                alert("Pipeline-ID ung√ºltig.");
            }
        };

        // --- STATUS SYSTEM ---
        function syncStatusStream() {
            onSnapshot(query(collection(db, "status"), orderBy("timestamp", "desc"), limit(12)), (snap) => {
                const grid = document.getElementById('globalStatusGrid');
                grid.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    grid.innerHTML += `
                        <div class="relative rounded-[35px] overflow-hidden aspect-[3/4] cursor-pointer group shadow-2xl" onclick="window.open('${s.img}')">
                            <img src="${s.img}" class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-125">
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80"></div>
                            <div class="absolute bottom-5 left-5">
                                <p class="text-[10px] font-black text-wa-accent uppercase tracking-widest mb-1">${s.name}</p>
                                <p class="text-[8px] text-gray-500 font-bold uppercase">Encrypted Update</p>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.handleStatusUpload = async () => {
            const file = document.getElementById('statusUploadIn').files[0];
            if (!file) return;
            const fd = new FormData(); fd.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const json = await res.json();
            if (json.success) {
                await addDoc(collection(db, "status"), {
                    uid: currentUser.uid, name: myNick, img: json.data.url, timestamp: serverTimestamp()
                });
                alert("Statuspaket erfolgreich hochgeladen!");
            }
        };

        // --- UTILITIES ---
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + t).classList.remove('hidden');
            ['chats', 'friends', 'status', 'settings'].forEach(b => {
                const btn = document.getElementById('btn-' + b);
                if(btn) {
                    btn.classList.remove('border-wa-accent', 'text-wa-accent');
                    btn.classList.add('border-transparent', 'text-gray-500');
                }
            });
            document.getElementById('btn-' + t).classList.add('border-wa-accent', 'text-wa-accent');
            lucide.createIcons();
        };

        window.updateNickname = async () => {
            const n = document.getElementById('editNickIn').value.trim();
            if (n) {
                await updateDoc(doc(db, "users", currentUser.uid), { nickname: n });
                location.reload();
            }
        };

        window.copyMyId = () => {
            navigator.clipboard.writeText(currentUser.uid);
            alert("Deine UID wurde kopiert.");
        };

        window.handleMsgFile = () => {
            const f = document.getElementById('msgFileIn').files[0];
            if (f) {
                document.getElementById('prevImg').src = URL.createObjectURL(f);
                document.getElementById('attachmentPreview').classList.remove('hidden');
            }
        };

        window.clearAttachment = () => {
            document.getElementById('msgFileIn').value = "";
            document.getElementById('attachmentPreview').classList.add('hidden');
        };

        window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.copyToClipboard = (id) => {
            const el = document.getElementById(id);
            navigator.clipboard.writeText(el.value || el.innerText);
            alert("ID gesichert.");
        };

        window.closeChatMobile = () => {
            document.getElementById('chatArea').classList.add('hidden');
            document.getElementById('mainSidebar').classList.remove('hidden');
            activeChatId = null;
        };

        async function updateInfoModal(id, name, isPriv) {
            document.getElementById('infoName').innerText = name;
            document.getElementById('infoAvaBig').innerText = name[0];
            document.getElementById('infoCopyId').value = id;
            document.getElementById('infoType').innerText = isPriv ? "Sichere P2P Verbindung" : "Gruppen Mainframe";
            
            const list = document.getElementById('infoMemberList');
            list.innerHTML = "";
            
            if (!isPriv) {
                const snap = await getDoc(doc(db, "chats", id));
                const members = snap.data().members;
                const creator = snap.data().creator;
                document.getElementById('memberCount').innerText = members.length;
                
                for (const mid of members) {
                    const u = await getDoc(doc(db, "users", mid));
                    const uData = u.data();
                    list.innerHTML += `
                        <div class="flex items-center justify-between p-4 bg-wa-dark rounded-2xl border border-gray-800">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-gray-700 flex items-center justify-center font-black">${uData ? uData.nickname[0] : '?'}</div>
                                <div>
                                    <p class="text-xs font-bold text-gray-200">${uData ? uData.nickname : mid}</p>
                                    ${mid === creator ? '<p class="text-[8px] text-wa-accent uppercase font-black">Admin</p>' : ''}
                                </div>
                            </div>
                            ${(currentUser.uid === creator && mid !== currentUser.uid) ? 
                                `<button onclick="window.kickMember('${mid}')" class="text-red-500 p-2"><i data-lucide="user-minus" class="w-4 h-4"></i></button>` : ''}
                        </div>`;
                }
            } else {
                document.getElementById('memberCount').innerText = "2";
                list.innerHTML = `<p class="text-[10px] text-gray-600 italic p-6 text-center tracking-widest uppercase">Direktverbindung zwischen zwei Endpunkten.</p>`;
            }
            lucide.createIcons();
        }

        window.kickMember = async (mid) => {
            if(confirm("Teilnehmer aus Pipeline entfernen?")) {
                await updateDoc(doc(db, "chats", activeChatId), { members: arrayRemove(mid) });
                updateInfoModal(activeChatId, document.getElementById('infoName').innerText, false);
            }
        };

        window.processLeaveChat = async () => {
            if (!activeChatId) return;
            const ref = doc(db, "chats", activeChatId);
            await updateDoc(ref, isPrivateMode ? { participants: arrayRemove(currentUser.uid) } : { members: arrayRemove(currentUser.uid) });
            window.closeChatMobile();
            window.hideModal('chatInfoModal');
        };

        window.processLogin = async () => {
            const uid = document.getElementById('loginUid').value.trim();
            if (uid) { localStorage.setItem("shadow_uid", uid); location.reload(); }
        };

        window.requestNotificationPerm = async () => {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                new Notification("ShadowChat", { body: "Verschl√ºsselter Kanal best√§tigt." });
                document.getElementById('notiBanner').remove();
            }
        };

        function checkNotiStatus() {
            if ("Notification" in window && Notification.permission === "default") {
                setTimeout(() => document.getElementById('notiBanner').classList.remove('hidden'), 3000);
            }
        }
    </script>
</body>
</html>
