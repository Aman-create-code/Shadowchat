<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShadowChat Ultimate V5 - Pro Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#f0f2f5', 
                            dark: '#0b141a', 
                            panel: '#202c33',
                            accent: '#00a884', 
                            bubbleOut: '#d9fdd3', 
                            bubbleIn: '#ffffff', 
                            bubbleDarkOut: '#005c4b', 
                            bubbleDarkIn: '#233138' 
                        }
                    },
                    boxShadow: { 'custom': '0 2px 5px 0 rgba(11,20,26,.26),0 2px 10px 0 rgba(11,20,26,.16)' }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; height: 100dvh; background-color: #0b141a; }
        
        /* Smooth Scroll & Animations */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        .msg-anim { animation: msgSlide 0.15s ease-out forwards; }
        @keyframes msgSlide { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .tab-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Backdrop Blur for Modals */
        .glass-modal { backdrop-filter: blur(8px); background-color: rgba(0,0,0,0.7); }
        
        /* Checkmark Style */
        .checks-blue { color: #53bdeb !important; }
        
        /* Reaction Popover */
        .reaction-bar { display: none; position: absolute; top: -40px; left: 0; background: white; border-radius: 20px; padding: 5px 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 50; gap: 8px; }
        .dark .reaction-bar { background: #233138; }
        .msg-container:hover .reaction-bar { display: flex; }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-100 flex flex-col md:flex-row">

    <aside id="mainSidebar" class="flex flex-col w-full md:w-[350px] lg:w-[420px] h-full border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-wa-dark z-20 shrink-0 overflow-hidden transition-all">
        
        <header class="h-[64px] bg-wa-light dark:bg-wa-panel flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <div id="myAvatar" class="w-10 h-10 rounded-full bg-wa-accent flex items-center justify-center font-bold text-white cursor-pointer hover:opacity-80 transition" onclick="window.switchTab('settings')">?</div>
                <div class="hidden sm:block">
                    <p class="font-bold text-sm leading-none" id="myDisplayNick">Loading...</p>
                    <p class="text-[10px] text-wa-accent font-bold mt-1">ShadowChat Pro</p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="window.switchTab('status')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Status"><i data-lucide="circle-dashed" class="w-5 h-5"></i></button>
                <button onclick="window.toggleModal('newGroupModal')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Gruppe erstellen"><i data-lucide="plus" class="w-5 h-5"></i></button>
                <button onclick="window.toggleModal('joinGroupModal')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Beitreten"><i data-lucide="hash" class="w-5 h-5"></i></button>
                <button onclick="window.toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="sun-moon" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="p-2 bg-white dark:bg-wa-dark border-b dark:border-gray-800">
            <div class="bg-gray-100 dark:bg-wa-panel flex items-center px-3 py-1.5 rounded-lg">
                <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                <input type="text" placeholder="Chats suchen oder neu starten" class="bg-transparent text-sm w-full outline-none px-3 py-1">
            </div>
        </div>

        <div class="hidden md:flex justify-around border-b dark:border-gray-800 bg-white dark:bg-wa-dark p-2">
            <button onclick="window.switchTab('chats')" class="tab-btn flex flex-col items-center gap-1 active text-wa-accent" id="tabbtn-chats"><i data-lucide="message-square" class="w-5 h-5"></i><span class="text-[9px] font-bold uppercase">Chats</span></button>
            <button onclick="window.switchTab('friends')" class="tab-btn flex flex-col items-center gap-1 text-gray-500" id="tabbtn-friends"><i data-lucide="users" class="w-5 h-5"></i><span class="text-[9px] font-bold uppercase">Freunde</span></button>
            <button onclick="window.switchTab('settings')" class="tab-btn flex flex-col items-center gap-1 text-gray-500" id="tabbtn-settings"><i data-lucide="settings" class="w-5 h-5"></i><span class="text-[9px] font-bold uppercase">Profil</span></button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative">
            
            <div id="tab-chats" class="tab-transition h-full">
                <div id="chatListContainer" class="divide-y dark:divide-gray-800">
                    </div>
            </div>

            <div id="tab-friends" class="hidden tab-transition p-4 space-y-6">
                <div class="bg-wa-accent/5 p-4 rounded-2xl border border-wa-accent/10">
                    <h4 class="text-xs font-bold text-wa-accent uppercase mb-3">ID Suche</h4>
                    <div class="flex gap-2">
                        <input id="friendSearchInput" type="text" class="flex-1 bg-white dark:bg-wa-panel p-2 rounded-lg text-sm border dark:border-transparent outline-none focus:ring-1 ring-wa-accent" placeholder="Eindeutige ID eingeben">
                        <button onclick="window.sendRequest()" class="bg-wa-accent text-white p-2 rounded-lg"><i data-lucide="user-plus" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div id="pendingContainer" class="hidden">
                    <h4 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-2">Anfragen</h4>
                    <div id="pendingList" class="space-y-2"></div>
                </div>
                <div>
                    <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-2">Meine Kontakte</h4>
                    <div id="contactsList" class="space-y-1"></div>
                </div>
            </div>

            <div id="tab-status" class="hidden tab-transition p-4">
                <div class="flex items-center gap-4 mb-8 cursor-pointer group" onclick="document.getElementById('stIn').click()">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-400"><i data-lucide="camera" class="text-gray-400 group-hover:scale-110 transition"></i></div>
                        <div class="absolute -bottom-1 -right-1 bg-wa-accent rounded-full p-1 border-4 border-white dark:border-wa-dark"><i data-lucide="plus" class="w-3 h-3 text-white"></i></div>
                    </div>
                    <div><h3 class="font-bold">Mein Status</h3><p class="text-xs text-gray-500">Tippe f√ºr neues Update</p></div>
                    <input type="file" id="stIn" class="hidden" accept="image/*" onchange="window.upStatus()">
                </div>
                <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Updates von Freunden</h4>
                <div id="globalStatusList" class="space-y-5"></div>
            </div>

            <div id="tab-settings" class="hidden tab-transition p-6 space-y-8">
                <div class="text-center">
                    <div class="w-24 h-24 rounded-full bg-wa-accent mx-auto flex items-center justify-center text-4xl font-black text-white shadow-xl mb-4" id="setAvatar">?</div>
                    <h2 class="text-xl font-bold" id="setNick">Gast</h2>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 dark:bg-wa-panel p-4 rounded-xl">
                        <label class="text-[10px] font-bold text-wa-accent uppercase tracking-tighter">Dein Name</label>
                        <div class="flex gap-2 mt-1">
                            <input id="nickIn" type="text" class="flex-1 bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-wa-accent outline-none pb-1">
                            <button onclick="window.saveProfile()" class="text-wa-accent font-bold text-xs uppercase">Save</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-wa-panel p-4 rounded-xl cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition" onclick="window.copyMyId()">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Deine Shadow-ID (Klick zum Kopieren)</label>
                        <p id="myFullId" class="text-xs font-mono mt-1 text-wa-accent truncate">---</p>
                    </div>
                </div>
            </div>
        </div>

        <nav class="md:hidden h-[70px] bg-white dark:bg-wa-panel border-t dark:border-gray-800 flex justify-around items-center shrink-0">
            <button onclick="window.switchTab('chats')" class="m-nav-btn flex flex-col items-center text-wa-accent" id="mnav-chats"><i data-lucide="message-square" class="w-6 h-6"></i><span class="text-[10px] font-bold">Chats</span></button>
            <button onclick="window.switchTab('status')" class="m-nav-btn flex flex-col items-center text-gray-500" id="mnav-status"><i data-lucide="circle-dashed" class="w-6 h-6"></i><span class="text-[10px] font-bold">Status</span></button>
            <button onclick="window.switchTab('friends')" class="m-nav-btn flex flex-col items-center text-gray-500" id="mnav-friends"><i data-lucide="users" class="w-6 h-6"></i><span class="text-[10px] font-bold">Freunde</span></button>
            <button onclick="window.switchTab('settings')" class="m-nav-btn flex flex-col items-center text-gray-500" id="mnav-settings"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-[10px] font-bold">Profil</span></button>
        </nav>
    </aside>

    <main id="chatArea" class="hidden md:flex flex-1 flex-col h-full relative overflow-hidden bg-[#efeae2] dark:bg-wa-dark z-30 transition-all duration-300">
        <div class="absolute inset-0 opacity-[0.06] dark:opacity-[0.04] pointer-events-none z-0" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px;"></div>

        <header id="chatHeader" class="hidden h-[64px] bg-wa-light dark:bg-wa-panel flex items-center justify-between px-4 shrink-0 z-10 border-b dark:border-gray-800 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="window.closeChatMobile()" class="md:hidden p-2 -ml-2"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <div id="activeAvatar" class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center text-white font-bold shadow-inner">?</div>
                <div class="cursor-pointer" onclick="window.toggleModal('infoModal')">
                    <h2 id="activeTitle" class="font-bold text-sm md:text-base leading-tight">Chat w√§hlen</h2>
                    <p id="activeSub" class="text-[10px] text-wa-accent font-bold uppercase tracking-wider">Online</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button class="p-2 text-gray-500 hidden sm:block"><i data-lucide="video" class="w-5 h-5"></i></button>
                <button class="p-2 text-gray-500 hidden sm:block"><i data-lucide="phone" class="w-5 h-5"></i></button>
                <button onclick="window.toggleModal('infoModal')" class="p-2 text-gray-500"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div id="messagesList" class="flex-1 overflow-y-auto p-4 md:px-8 lg:px-16 space-y-3 relative z-10 custom-scrollbar flex flex-col">
            <div class="m-auto text-center p-10 bg-white/50 dark:bg-wa-panel/30 rounded-3xl backdrop-blur-sm max-w-xs border border-white/20">
                <i data-lucide="lock" class="w-8 h-8 mx-auto mb-4 text-wa-accent opacity-50"></i>
                <h3 class="font-bold text-sm mb-2">Ende-zu-Ende-Verschl√ºsselung</h3>
                <p class="text-[11px] text-gray-500">Deine Nachrichten und Anrufe sind sicher. Niemand au√üerhalb dieses Chats kann sie lesen.</p>
            </div>
        </div>

        <footer id="chatInputArea" class="hidden p-3 bg-wa-light dark:bg-wa-panel flex items-end gap-3 shrink-0 z-10">
            <div id="attachmentPreview" class="hidden absolute bottom-full left-0 w-full bg-white dark:bg-wa-panel p-4 border-t dark:border-gray-700 shadow-2xl animate-bounce-in">
                <div class="relative inline-block group">
                    <img id="prevImg" class="h-32 w-auto rounded-lg border-2 border-wa-accent shadow-lg">
                    <button onclick="window.clearAttachment()" class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1.5 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>

            <button onclick="document.getElementById('imgIn').click()" class="p-2.5 text-gray-500 hover:text-wa-accent transition"><i data-lucide="paperclip" class="w-6 h-6"></i></button>
            <input type="file" id="imgIn" class="hidden" accept="image/*" onchange="window.handleFile()">
            
            <div class="flex-1 bg-white dark:bg-wa-dark rounded-xl flex items-center px-4 py-2 min-h-[48px] shadow-sm ring-1 ring-gray-200 dark:ring-gray-800">
                <button class="p-1 text-gray-400 hover:text-yellow-500"><i data-lucide="smile" class="w-5 h-5"></i></button>
                <textarea id="msgIn" placeholder="Nachricht schreiben..." class="w-full bg-transparent outline-none text-sm dark:text-white px-3 py-1 resize-none max-h-32 custom-scrollbar" rows="1" oninput="this.style.height='';this.style.height=this.scrollHeight+'px'"></textarea>
            </div>
            
            <button id="sendBtn" onclick="window.sendMsg()" class="bg-wa-accent text-white p-3.5 rounded-xl shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center justify-center">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
            </button>
        </footer>
    </main>

    <div id="newGroupModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white dark:bg-wa-panel w-full max-w-sm rounded-[28px] p-8 shadow-2xl">
            <h3 class="text-2xl font-black mb-6">Neue Gruppe</h3>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-wa-accent uppercase px-1">Gruppenname</label>
                    <input id="ng_name" type="text" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none focus:ring-2 ring-wa-accent transition">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-500 uppercase px-1">Passwort (Optional)</label>
                    <input id="ng_pass" type="password" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-10">
                <button onclick="window.toggleModal('newGroupModal')" class="px-6 py-2 text-gray-500 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition">Abbrechen</button>
                <button onclick="window.createGrp()" class="bg-wa-accent px-8 py-3 rounded-2xl text-white font-black shadow-lg shadow-wa-accent/30 active:scale-95 transition">Erstellen</button>
            </div>
        </div>
    </div>

    <div id="joinGroupModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-wa-panel w-full max-w-sm rounded-[28px] p-8 shadow-2xl">
            <h3 class="text-2xl font-black mb-2">Beitreten</h3>
            <p class="text-xs text-gray-500 mb-6">Gib die 8-stellige Gruppen-ID ein.</p>
            <div class="space-y-4">
                <input id="jg_id" type="text" placeholder="Z.B. X7Y2Z9W1" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none font-mono uppercase text-center text-xl tracking-widest focus:ring-2 ring-wa-accent transition">
                <input id="jg_pass" type="password" placeholder="Passwort (falls n√∂tig)" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none text-center">
            </div>
            <div class="flex justify-end gap-3 mt-10">
                <button onclick="window.toggleModal('joinGroupModal')" class="px-6 py-2 text-gray-500 font-bold rounded-xl transition">Abbrechen</button>
                <button onclick="window.joinGrp()" class="bg-wa-accent px-10 py-3 rounded-2xl text-white font-black shadow-lg shadow-wa-accent/30 active:scale-95 transition">Join</button>
            </div>
        </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-wa-panel w-full max-w-md rounded-[32px] overflow-hidden shadow-2xl relative">
            <button onclick="window.toggleModal('infoModal')" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="h-48 bg-gradient-to-br from-wa-accent to-emerald-700 relative flex items-end p-8">
                <div id="infoAvaLarge" class="w-24 h-24 rounded-3xl bg-white/20 backdrop-blur-md border border-white/30 text-white flex items-center justify-center text-4xl font-black shadow-2xl">?</div>
            </div>
            <div class="p-8">
                <h3 id="infoTit" class="text-2xl font-black mb-1">Name</h3>
                <div id="infoBadge" class="inline-block px-3 py-1 rounded-full bg-wa-accent/10 text-wa-accent text-[10px] font-bold font-mono tracking-widest mb-6">ID: ---</div>
                
                <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Mitglieder im Chat</h4>
                <div id="infoMemberList" class="max-h-48 overflow-y-auto space-y-3 custom-scrollbar">
                    </div>
                
                <button id="leaveBtn" class="w-full mt-8 py-4 rounded-2xl border-2 border-red-500/20 text-red-500 font-bold hover:bg-red-500 hover:text-white transition-all flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Chat verlassen
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // üî• KONFIGURATION (Identisch geblieben)
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";

        // APP STATE
        let currentUser = null;
        let activeChatId = null;
        let isPrivate = false;
        let myNick = "Gast";
        let messageUnsub = null;
        let readUnsub = null;

        lucide.createIcons();

        // UTILS
        const generateID = () => {
            const c = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let r = ""; for(let i=0; i<8; i++) r += c[Math.floor(Math.random()*c.length)];
            return r;
        };

        window.toggleTheme = () => {
            const d = document.documentElement.classList.toggle('dark');
            localStorage.setItem('sc_theme', d ? 'dark' : 'light');
        };
        if(localStorage.getItem('sc_theme') === 'light') document.documentElement.classList.remove('dark');

        window.toggleModal = (id) => document.getElementById(id).classList.toggle('hidden');

        window.switchTab = (tab) => {
            ['chats', 'friends', 'status', 'settings'].forEach(t => {
                document.getElementById('tab-' + t).classList.add('hidden');
                const b = document.getElementById('tabbtn-' + t); if(b) b.classList.remove('text-wa-accent', 'active');
                const mb = document.getElementById('mnav-' + t); if(mb) mb.classList.replace('text-wa-accent', 'text-gray-500');
            });
            document.getElementById('tab-' + tab).classList.remove('hidden');
            const ab = document.getElementById('tabbtn-' + tab); if(ab) ab.classList.add('text-wa-accent', 'active');
            const amb = document.getElementById('mnav-' + tab); if(amb) amb.classList.replace('text-gray-500', 'text-wa-accent');
        };

        window.closeChatMobile = () => {
            document.getElementById('chatArea').classList.add('hidden');
            document.getElementById('mainSidebar').classList.remove('hidden');
            activeChatId = null;
        };

        // AUTH & USER DATA
        signInAnonymously(auth);
        onAuthStateChanged(auth, async (u) => {
            if(u) {
                currentUser = u;
                const uRef = doc(db, "users", u.uid);
                const snap = await getDoc(uRef);
                
                if(!snap.exists()) {
                    myNick = "User-" + Math.floor(Math.random()*9000+1000);
                    await setDoc(uRef, { uid: u.uid, nickname: myNick, friends: [], incoming: [], lastSeen: serverTimestamp() });
                } else {
                    myNick = snap.data().nickname;
                }

                document.getElementById('myAvatar').innerText = myNick.substring(0,2).toUpperCase();
                document.getElementById('setAvatar').innerText = myNick.substring(0,2).toUpperCase();
                document.getElementById('myDisplayNick').innerText = myNick;
                document.getElementById('setNick').innerText = myNick;
                document.getElementById('nickIn').value = myNick;
                document.getElementById('myFullId').innerText = u.uid;

                initRealtimeSync();
            }
        });

        function initRealtimeSync() {
            loadChats();
            loadFriendsTab();
            loadStatusTab();
        }

        // --- FRIENDS & PRIVATE CHATS ---
        window.sendRequest = async () => {
            const id = document.getElementById('friendSearchInput').value.trim();
            if(!id || id === currentUser.uid) return;
            const tRef = doc(db, "users", id);
            const tSnap = await getDoc(tRef);
            if(tSnap.exists()) {
                await updateDoc(tRef, { incoming: arrayUnion(currentUser.uid) });
                alert("Anfrage gesendet!");
                document.getElementById('friendSearchInput').value = "";
            } else alert("ID nicht gefunden.");
        };

        function loadFriendsTab() {
            onSnapshot(doc(db, "users", currentUser.uid), async (s) => {
                const data = s.data(); if(!data) return;
                
                // Pending
                const pL = document.getElementById('pendingList');
                if(data.incoming?.length > 0) {
                    document.getElementById('pendingContainer').classList.remove('hidden');
                    pL.innerHTML = "";
                    for(const rid of data.incoming) {
                        const rU = await getDoc(doc(db, "users", rid));
                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between bg-white dark:bg-wa-panel p-3 rounded-xl shadow-sm border dark:border-gray-800 animate-msgSlide";
                        div.innerHTML = `<span class="font-bold text-sm">${rU.data().nickname}</span><div class="flex gap-2"><button onclick="window.acceptFriend('${rid}')" class="bg-wa-accent text-white p-2 rounded-lg"><i data-lucide="check" class="w-4 h-4"></i></button></div>`;
                        pL.appendChild(div);
                    }
                } else document.getElementById('pendingContainer').classList.add('hidden');

                // Contacts
                const cL = document.getElementById('contactsList');
                cL.innerHTML = "";
                if(data.friends?.length > 0) {
                    for(const fid of data.friends) {
                        const fU = await getDoc(doc(db, "users", fid));
                        const fd = fU.data();
                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between p-3 hover:bg-gray-100 dark:hover:bg-wa-panel rounded-xl transition cursor-pointer";
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold">${fd.nickname[0]}</div>
                                <p class="font-bold text-sm">${fd.nickname}</p>
                            </div>
                            <button onclick="window.startPrivateChat('${fid}', '${fd.nickname}')" class="text-wa-accent p-2 hover:bg-wa-accent/10 rounded-full"><i data-lucide="message-circle" class="w-5 h-5"></i></button>
                        `;
                        cL.appendChild(div);
                    }
                } else cL.innerHTML = `<div class="text-center py-10 text-gray-500 text-xs">Noch keine Kontakte.</div>`;
                lucide.createIcons();
            });
        }

        window.acceptFriend = async (rid) => {
            const mRef = doc(db, "users", currentUser.uid);
            const oRef = doc(db, "users", rid);
            await updateDoc(mRef, { friends: arrayUnion(rid), incoming: arrayRemove(rid) });
            await updateDoc(oRef, { friends: arrayUnion(currentUser.uid) });
        };

        window.startPrivateChat = async (otherId, otherNick) => {
            // Privat-Chat ID ist immer sortierte UIDs kombiniert
            const chatId = [currentUser.uid, otherId].sort().join("_");
            const cRef = doc(db, "chats", chatId);
            const cSnap = await getDoc(cRef);
            
            if(!cSnap.exists()) {
                await setDoc(cRef, { 
                    type: 'private', 
                    participants: [currentUser.uid, otherId], 
                    lastActivity: serverTimestamp(),
                    names: { [currentUser.uid]: myNick, [otherId]: otherNick }
                });
            }
            openChat(chatId, otherNick, true);
        };

        // --- GROUP LOGIC ---
        window.createGrp = async () => {
            const n = document.getElementById('ng_name').value;
            const p = document.getElementById('ng_pass').value;
            if(!n) return;
            const gid = generateID();
            await setDoc(doc(db, "chats", gid), {
                type: 'group', name: n, password: p || null,
                creator: currentUser.uid, members: [currentUser.uid],
                lastActivity: serverTimestamp()
            });
            window.toggleModal('newGroupModal');
            openChat(gid, n, false);
        };

        window.joinGrp = async () => {
            const id = document.getElementById('jg_id').value.toUpperCase();
            const pass = document.getElementById('jg_pass').value;
            const snap = await getDoc(doc(db, "chats", id));
            if(snap.exists()) {
                const d = snap.data();
                if(d.password && d.password !== pass) return alert("Passwort falsch!");
                await updateDoc(doc(db, "chats", id), { members: arrayUnion(currentUser.uid) });
                window.toggleModal('joinGroupModal');
                openChat(id, d.name, false);
            } else alert("Gruppe nicht gefunden.");
        };

        // --- CHAT SYSTEM ---
        function loadChats() {
            // Wir h√∂ren auf Gruppen UND Privat-Chats
            const q = query(collection(db, "chats"), orderBy("lastActivity", "desc"));
            onSnapshot(q, (snap) => {
                const cont = document.getElementById('chatListContainer');
                cont.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    const isMember = c.type === 'private' ? c.participants.includes(currentUser.uid) : c.members.includes(currentUser.uid);
                    
                    if(isMember) {
                        let name = c.name;
                        if(c.type === 'private') {
                            const otherId = c.participants.find(p => p !== currentUser.uid);
                            name = c.names[otherId];
                        }
                        
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-4 p-4 hover:bg-gray-100 dark:hover:bg-wa-panel cursor-pointer transition active:bg-gray-200 dark:active:bg-gray-700";
                        div.innerHTML = `
                            <div class="w-14 h-14 rounded-full flex-shrink-0 bg-gradient-to-br ${c.type==='private'?'from-blue-500 to-indigo-600':'from-wa-accent to-emerald-700'} flex items-center justify-center text-white font-black shadow-md">${name[0]}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-baseline mb-1">
                                    <h4 class="font-bold text-[15px] truncate">${name}</h4>
                                    <span class="text-[10px] text-gray-400 font-mono">${c.type==='group'?'#'+d.id:''}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-gray-500 truncate">Klicke zum Chatten...</p>
                                    <div id="unread-${d.id}" class="hidden w-5 h-5 bg-wa-accent text-white rounded-full flex items-center justify-center text-[10px] font-bold">!</div>
                                </div>
                            </div>
                        `;
                        div.onclick = () => openChat(d.id, name, c.type==='private');
                        cont.appendChild(div);
                    }
                });
            });
        }

        function openChat(id, name, isPriv) {
            activeChatId = id;
            isPrivate = isPriv;

            // UI Adjust
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('chatHeader').classList.add('flex');
            document.getElementById('chatInputArea').classList.remove('hidden');
            document.getElementById('chatInputArea').classList.add('flex');
            document.getElementById('activeTitle').innerText = name;
            document.getElementById('activeAvatar').innerText = name[0];
            document.getElementById('activeSub').innerText = isPriv ? "Privater Chat" : "Gruppe";

            if(window.innerWidth < 768) {
                document.getElementById('mainSidebar').classList.add('hidden');
                document.getElementById('chatArea').classList.remove('hidden');
                document.getElementById('chatArea').classList.add('flex');
            }

            // Messages Sync
            if(messageUnsub) messageUnsub();
            const q = query(collection(db, `chats/${id}/messages`), orderBy("timestamp", "asc"));
            messageUnsub = onSnapshot(q, (snap) => {
                const list = document.getElementById('messagesList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    renderMessage(doc.id, doc.data());
                });
                list.scrollTop = list.scrollHeight;
                
                // Mark as read
                markAllRead(id);
            });

            // Info Modal Sync
            updateInfoModal(id, name, isPriv);
        }

        async function markAllRead(chatId) {
            const q = query(collection(db, `chats/${chatId}/messages`), where("senderId", "!=", currentUser.uid));
            const snap = await getDoc(q); // Normalerweise batch-update, hier simpel:
            // Logik: Wir setzen uns selbst in das 'readBy' Array
            snap.forEach(async d => {
                if(!d.data().readBy?.includes(currentUser.uid)) {
                    await updateDoc(doc(db, `chats/${chatId}/messages`, d.id), { readBy: arrayUnion(currentUser.uid) });
                }
            });
        }

        function renderMessage(msgId, m) {
            const list = document.getElementById('messagesList');
            const isMe = m.senderId === currentUser.uid;
            const time = m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            
            // üî• BLAUE HAKEN LOGIK
            // In Privat-Chats: Gelesen, wenn der Partner im 'readBy' ist
            // In Gruppen: Gelesen, wenn mehr als 1 Person im 'readBy' ist
            const isRead = m.readBy && m.readBy.length > 0;

            const div = document.createElement('div');
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} msg-anim group msg-container relative mb-1`;
            div.innerHTML = `
                <div class="max-w-[85%] md:max-w-[70%] p-2 rounded-xl shadow-sm relative ${isMe ? 'bg-wa-bubbleOut dark:bg-wa-bubbleDarkOut text-gray-800 dark:text-gray-100 rounded-tr-none' : 'bg-white dark:bg-wa-bubbleDarkIn text-gray-800 dark:text-gray-100 rounded-tl-none'}">
                    ${!isMe && !isPrivate ? `<p class="text-[10px] font-black text-wa-accent mb-1">${m.senderName}</p>` : ''}
                    ${m.img ? `<img src="${m.img}" class="rounded-lg mb-2 max-w-full cursor-pointer hover:opacity-90" onclick="window.open('${m.img}')">` : ''}
                    <p class="text-[14.5px] leading-relaxed pr-8 whitespace-pre-wrap">${m.text || ''}</p>
                    
                    <div class="absolute bottom-1 right-2 flex items-center gap-1">
                        <span class="text-[9px] opacity-40 font-bold">${time}</span>
                        ${isMe ? `<i data-lucide="check-check" class="w-3 h-3 ${isRead?'checks-blue':'text-gray-400'}"></i>` : ''}
                    </div>

                    <div class="reaction-bar">
                        <button onclick="window.react('${msgId}', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                        <button onclick="window.react('${msgId}', 'üòÇ')">üòÇ</button>
                        <button onclick="window.react('${msgId}', 'üòÆ')">üòÆ</button>
                        <button onclick="window.react('${msgId}', 'üëç')">üëç</button>
                    </div>
                    ${m.reaction ? `<div class="absolute -bottom-2 -right-1 bg-white dark:bg-gray-800 rounded-full px-1.5 py-0.5 text-[10px] shadow-sm border dark:border-gray-700">${m.reaction}</div>` : ''}
                </div>
            `;
            list.appendChild(div);
            lucide.createIcons();
        }

        window.sendMsg = async () => {
            const inp = document.getElementById('msgIn');
            const file = document.getElementById('imgIn').files[0];
            const txt = inp.value.trim();
            if(!txt && !file) return;

            let url = null;
            if(file) {
                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const d = await res.json(); url = d.data.url;
            }

            await addDoc(collection(db, `chats/${activeChatId}/messages`), {
                text: txt, img: url, senderId: currentUser.uid, senderName: myNick, 
                timestamp: serverTimestamp(), readBy: [], reaction: null
            });

            await updateDoc(doc(db, "chats", activeChatId), { lastActivity: serverTimestamp() });
            
            inp.value = ""; inp.style.height = '48px';
            window.clearAttachment();
        };

        window.handleFile = () => {
            const f = document.getElementById('imgIn').files[0];
            if(f) {
                document.getElementById('prevImg').src = URL.createObjectURL(f);
                document.getElementById('attachmentPreview').classList.remove('hidden');
            }
        };

        window.clearAttachment = () => {
            document.getElementById('imgIn').value = "";
            document.getElementById('attachmentPreview').classList.add('hidden');
        };

        window.react = async (mId, emoji) => {
            await updateDoc(doc(db, `chats/${activeChatId}/messages`, mId), { reaction: emoji });
        };

        // --- INFO & MEMBERS ---
        function updateInfoModal(id, name, isPriv) {
            document.getElementById('infoTit').innerText = name;
            document.getElementById('infoAvaLarge').innerText = name[0];
            document.getElementById('infoBadge').innerText = "ID: " + id;
            
            const ml = document.getElementById('infoMemberList'); ml.innerHTML = "";
            const leave = document.getElementById('leaveBtn');
            
            if(isPriv) {
                leave.classList.add('hidden');
                ml.innerHTML = "<p class='text-xs text-gray-500'>Privater Chat zwischen dir und " + name + ".</p>";
            } else {
                leave.classList.remove('hidden');
                getDoc(doc(db, "chats", id)).then(s => {
                    s.data().members.forEach(async mid => {
                        const u = await getDoc(doc(db, "users", mid));
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3 p-3 bg-gray-50 dark:bg-wa-dark rounded-2xl";
                        div.innerHTML = `<div class="w-8 h-8 rounded-full bg-wa-accent text-white flex items-center justify-center font-black text-[10px]">${u.data().nickname[0]}</div><span class="text-sm font-bold">${u.data().nickname}</span>`;
                        ml.appendChild(div);
                    });
                });
                leave.onclick = async () => {
                    if(confirm("Gruppe verlassen?")) {
                        await updateDoc(doc(db, "chats", id), { members: arrayRemove(currentUser.uid) });
                        window.toggleModal('infoModal');
                        window.closeChatMobile();
                    }
                };
            }
        }

        // --- STATUS SYSTEM ---
        window.upStatus = async () => {
            const f = document.getElementById('stIn').files[0]; if(!f) return;
            const fd = new FormData(); fd.append("image", f);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const d = await res.json();
            await addDoc(collection(db, "status"), {
                uid: currentUser.uid, name: myNick, img: d.data.url, timestamp: serverTimestamp()
            });
            alert("Status gepostet!");
        };

        function loadStatusTab() {
            const dayAgo = new Date(Date.now() - 24*60*60*1000);
            onSnapshot(query(collection(db, "status"), orderBy("timestamp", "desc")), snap => {
                const list = document.getElementById('globalStatusList'); list.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    if(s.timestamp && s.timestamp.toDate() > dayAgo) {
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-wa-panel p-2 rounded-2xl transition";
                        div.innerHTML = `
                            <div class="w-14 h-14 rounded-full border-2 border-wa-accent p-0.5"><img src="${s.img}" class="w-full h-full rounded-full object-cover"></div>
                            <div><h4 class="font-bold text-sm">${s.name}</h4><p class="text-[10px] text-gray-500">${s.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p></div>
                        `;
                        div.onclick = () => window.open(s.img);
                        list.appendChild(div);
                    }
                });
            });
        }

        // --- PROFILE ---
        window.saveProfile = async () => {
            const n = document.getElementById('nickIn').value.trim();
            if(n) {
                await updateDoc(doc(db, "users", currentUser.uid), { nickname: n });
                location.reload();
            }
        };

        window.copyMyId = () => {
            navigator.clipboard.writeText(currentUser.uid);
            alert("Deine ID wurde kopiert. Gib sie deinen Freunden!");
        };

    </script>
</body>
</html>
