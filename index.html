<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShadowChat Ultimate V9 - MultiCall & Edit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#f0f2f5', 
                            dark: '#0b141a', 
                            panel: '#202c33',
                            accent: '#00a884', 
                            bubbleOut: '#d9fdd3', 
                            bubbleIn: '#ffffff', 
                            bubbleDarkOut: '#005c4b', 
                            bubbleDarkIn: '#233138',
                            iosRed: '#ff3b30',
                            iosGreen: '#34c759'
                        }
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.32, 0.72, 0, 1) forwards',
                        'pulse-slow': 'pulse 2s infinite'
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; height: 100dvh; background-color: #0b141a; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .glass-modal { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); background-color: rgba(0,0,0,0.6); }
        .msg-anim { animation: msgSlide 0.15s ease-out forwards; }
        @keyframes msgSlide { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* iOS Call Specifics */
        .ios-blur { backdrop-filter: blur(60px) saturate(180%); -webkit-backdrop-filter: blur(60px) saturate(180%); background: rgba(22, 22, 22, 0.85); }
        .call-btn { transition: transform 0.1s; }
        .call-btn:active { transform: scale(0.92); opacity: 0.8; }
        .ripple {
            position: absolute; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2);
            animation: rippleAnim 2s infinite ease-out; pointer-events: none; z-index: 0;
            width: 100%; height: 100%; top: 0; left: 0;
        }
        @keyframes rippleAnim {
            0% { transform: scale(1); opacity: 0.6; }
            100% { transform: scale(2.2); opacity: 0; }
        }
        .edited-tag { font-size: 10px; color: #8696a0; font-style: italic; margin-left: 4px; }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-100 flex flex-col md:flex-row">

    <div id="audioContainer" class="hidden">
        <audio id="localAudio" muted autoplay playsinline></audio>
        </div>

    <aside id="mainSidebar" class="flex flex-col w-full md:w-[350px] lg:w-[420px] h-full border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-wa-dark z-20 shrink-0 overflow-hidden transition-all">
        <header class="h-[64px] bg-wa-light dark:bg-wa-panel flex items-center justify-between px-4 shrink-0">
            <div class="flex items-center gap-3">
                <div id="myAvatar" class="w-10 h-10 rounded-full bg-wa-accent flex items-center justify-center font-bold text-white cursor-pointer hover:opacity-80 transition" onclick="window.switchTab('settings')">?</div>
                <div class="hidden sm:block">
                    <p class="font-bold text-sm leading-none" id="myDisplayNick">Loading...</p>
                    <p class="text-[10px] text-wa-accent font-bold mt-1">ShadowChat V9</p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="window.switchTab('status')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="circle-dashed" class="w-5 h-5"></i></button>
                <button onclick="window.toggleModal('newGroupModal')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="plus" class="w-5 h-5"></i></button>
                <button onclick="window.toggleModal('joinGroupModal')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="hash" class="w-5 h-5"></i></button>
                <button onclick="window.toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="sun-moon" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="p-2 bg-white dark:bg-wa-dark border-b dark:border-gray-800">
            <div class="bg-gray-100 dark:bg-wa-panel flex items-center px-3 py-1.5 rounded-lg">
                <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                <input type="text" placeholder="Suche..." class="bg-transparent text-sm w-full outline-none px-3 py-1">
            </div>
        </div>

        <div class="hidden md:flex justify-around border-b dark:border-gray-800 bg-white dark:bg-wa-dark p-2">
            <button onclick="window.switchTab('chats')" class="tab-btn flex flex-col items-center gap-1 active text-wa-accent" id="tabbtn-chats"><i data-lucide="message-square" class="w-5 h-5"></i><span class="text-[9px] font-bold uppercase">Chats</span></button>
            <button onclick="window.switchTab('friends')" class="tab-btn flex flex-col items-center gap-1 text-gray-500" id="tabbtn-friends"><i data-lucide="users" class="w-5 h-5"></i><span class="text-[9px] font-bold uppercase">Freunde</span></button>
            <button onclick="window.switchTab('settings')" class="tab-btn flex flex-col items-center gap-1 text-gray-500" id="tabbtn-settings"><i data-lucide="settings" class="w-5 h-5"></i><span class="text-[9px] font-bold uppercase">Profil</span></button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative">
            <div id="tab-chats" class="tab-transition h-full"><div id="chatListContainer" class="divide-y dark:divide-gray-800"></div></div>
            <div id="tab-friends" class="hidden tab-transition p-4 space-y-6">
                <div class="bg-wa-accent/5 p-4 rounded-2xl border border-wa-accent/10">
                    <h4 class="text-xs font-bold text-wa-accent uppercase mb-3">ID Suche</h4>
                    <div class="flex gap-2">
                        <input id="friendSearchInput" type="text" class="flex-1 bg-white dark:bg-wa-panel p-2 rounded-lg text-sm border dark:border-transparent outline-none focus:ring-1 ring-wa-accent" placeholder="ID eingeben">
                        <button onclick="window.sendRequest()" class="bg-wa-accent text-white p-2 rounded-lg"><i data-lucide="user-plus" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div id="pendingContainer" class="hidden"><h4 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-2">Anfragen</h4><div id="pendingList" class="space-y-2"></div></div>
                <div><h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-2">Kontakte</h4><div id="contactsList" class="space-y-1"></div></div>
            </div>
            <div id="tab-status" class="hidden tab-transition p-4">
                <div class="flex items-center gap-4 mb-8 cursor-pointer group" onclick="document.getElementById('stIn').click()">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center overflow-hidden border-2 border-dashed border-gray-400"><i data-lucide="camera" class="text-gray-400 group-hover:scale-110 transition"></i></div>
                        <div class="absolute -bottom-1 -right-1 bg-wa-accent rounded-full p-1 border-4 border-white dark:border-wa-dark"><i data-lucide="plus" class="w-3 h-3 text-white"></i></div>
                    </div>
                    <div><h3 class="font-bold">Mein Status</h3><p class="text-xs text-gray-500">Tippe für neues Update</p></div>
                    <input type="file" id="stIn" class="hidden" accept="image/*" onchange="window.upStatus()">
                </div>
                <div id="globalStatusList" class="space-y-5"></div>
            </div>
            <div id="tab-settings" class="hidden tab-transition p-6 space-y-8">
                <div class="text-center">
                    <div class="w-24 h-24 rounded-full bg-wa-accent mx-auto flex items-center justify-center text-4xl font-black text-white shadow-xl mb-4" id="setAvatar">?</div>
                    <h2 class="text-xl font-bold" id="setNick">Gast</h2>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-50 dark:bg-wa-panel p-4 rounded-xl">
                        <label class="text-[10px] font-bold text-wa-accent uppercase tracking-tighter">Dein Name</label>
                        <div class="flex gap-2 mt-1">
                            <input id="nickIn" type="text" class="flex-1 bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-wa-accent outline-none pb-1">
                            <button onclick="window.saveProfile()" class="text-wa-accent font-bold text-xs uppercase">Save</button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-wa-panel p-4 rounded-xl">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter mb-2 block"><i data-lucide="shield" class="w-3 h-3 inline mr-1"></i>Sicherheit & Recovery</label>
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-1">Deine ID (zum Teilen)</p>
                            <p id="myFullId" class="font-mono text-xs bg-black/5 dark:bg-black/20 p-2 rounded cursor-pointer select-all" onclick="window.copyMyId()">---</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1">Dein Geheim-Passwort (zum Wiederherstellen)</p>
                            <div class="flex gap-2">
                                <p id="mySecretPass" class="font-mono text-xs bg-red-500/10 text-red-500 p-2 rounded flex-1 filter blur-[3px] hover:blur-0 transition cursor-pointer select-all">********</p>
                                <button onclick="document.getElementById('mySecretPass').classList.toggle('blur-[3px]')" class="p-1"><i data-lucide="eye" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>

                    <button onclick="window.toggleModal('loginModal')" class="w-full py-3 rounded-xl bg-gray-200 dark:bg-gray-700 font-bold text-sm hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center justify-center gap-2">
                        <i data-lucide="log-in" class="w-4 h-4"></i> Konto wechseln / Login
                    </button>
                </div>
            </div>
        </div>
        
        <nav class="md:hidden h-[70px] bg-white dark:bg-wa-panel border-t dark:border-gray-800 flex justify-around items-center shrink-0">
            <button onclick="window.switchTab('chats')" class="m-nav-btn flex flex-col items-center text-wa-accent" id="mnav-chats"><i data-lucide="message-square" class="w-6 h-6"></i><span class="text-[10px] font-bold">Chats</span></button>
            <button onclick="window.switchTab('status')" class="m-nav-btn flex flex-col items-center text-gray-500" id="mnav-status"><i data-lucide="circle-dashed" class="w-6 h-6"></i><span class="text-[10px] font-bold">Status</span></button>
            <button onclick="window.switchTab('friends')" class="m-nav-btn flex flex-col items-center text-gray-500" id="mnav-friends"><i data-lucide="users" class="w-6 h-6"></i><span class="text-[10px] font-bold">Freunde</span></button>
            <button onclick="window.switchTab('settings')" class="m-nav-btn flex flex-col items-center text-gray-500" id="mnav-settings"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-[10px] font-bold">Profil</span></button>
        </nav>
    </aside>

    <main id="chatArea" class="hidden md:flex flex-1 flex-col h-full relative overflow-hidden bg-[#efeae2] dark:bg-wa-dark z-30 transition-all duration-300">
        <div class="absolute inset-0 opacity-[0.06] dark:opacity-[0.04] pointer-events-none z-0" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px;"></div>

        <header id="chatHeader" class="hidden h-[64px] bg-wa-light dark:bg-wa-panel flex items-center justify-between px-4 shrink-0 z-10 border-b dark:border-gray-800 shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="window.closeChatMobile()" class="md:hidden p-2 -ml-2"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <div id="activeAvatar" class="w-10 h-10 rounded-full bg-gray-400 flex items-center justify-center text-white font-bold shadow-inner">?</div>
                <div class="cursor-pointer" onclick="window.toggleModal('infoModal')">
                    <h2 id="activeTitle" class="font-bold text-sm md:text-base leading-tight">Chat</h2>
                    <p id="activeSub" class="text-[10px] text-wa-accent font-bold uppercase tracking-wider">Online</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.initiateCall()" class="p-2 text-wa-accent hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition"><i data-lucide="phone" class="w-5 h-5 fill-current"></i></button>
                <button onclick="window.toggleModal('infoModal')" class="p-2 text-gray-500"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div id="messagesList" class="flex-1 overflow-y-auto p-4 md:px-8 lg:px-16 space-y-3 relative z-10 custom-scrollbar flex flex-col"></div>

        <footer id="chatInputArea" class="hidden p-3 bg-wa-light dark:bg-wa-panel flex items-end gap-3 shrink-0 z-10">
            <div id="attachmentPreview" class="hidden absolute bottom-full left-0 w-full bg-white dark:bg-wa-panel p-4 border-t dark:border-gray-700 shadow-2xl">
                <div class="relative inline-block group">
                    <img id="prevImg" class="h-32 w-auto rounded-lg border-2 border-wa-accent shadow-lg">
                    <button onclick="window.clearAttachment()" class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1.5 shadow-md"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
            <button onclick="document.getElementById('imgIn').click()" class="p-2.5 text-gray-500 hover:text-wa-accent transition"><i data-lucide="paperclip" class="w-6 h-6"></i></button>
            <input type="file" id="imgIn" class="hidden" accept="image/*" onchange="window.handleFile()">
            <div class="flex-1 bg-white dark:bg-wa-dark rounded-xl flex items-center px-4 py-2 min-h-[48px] shadow-sm ring-1 ring-gray-200 dark:ring-gray-800">
                <textarea id="msgIn" placeholder="Nachricht schreiben..." class="w-full bg-transparent outline-none text-sm dark:text-white px-3 py-1 resize-none max-h-32 custom-scrollbar" rows="1" oninput="this.style.height='';this.style.height=this.scrollHeight+'px'"></textarea>
            </div>
            <button id="sendBtn" onclick="window.sendMsg()" class="bg-wa-accent text-white p-3.5 rounded-xl shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center justify-center">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
            </button>
        </footer>
    </main>

    <div id="callOverlay" class="hidden fixed inset-0 z-[200] flex flex-col items-center justify-between py-12 px-6 ios-blur text-white animate-slide-up">
        <div class="absolute inset-0 z-0 bg-gradient-to-b from-black/50 via-transparent to-black/80 pointer-events-none"></div>
        
        <div class="relative z-10 text-center w-full flex flex-col items-center mt-8">
            <div class="flex items-center gap-2 text-gray-300 text-sm font-semibold mb-8 opacity-80">
                <i data-lucide="shield-check" class="w-4 h-4 text-green-400"></i> <span>Shadow Multi-Grid Secure</span>
            </div>
            <div class="relative mb-8">
                <div id="callRipple" class="hidden ripple"></div>
                <div id="callAvatar" class="w-36 h-36 rounded-full bg-[#202c33] flex items-center justify-center text-5xl font-bold shadow-2xl border border-white/10 relative z-10">?</div>
            </div>
            <h2 id="callName" class="text-4xl font-bold tracking-tight mb-2">Unbekannt</h2>
            <p id="callStatus"  class="text-lg font-medium text-grey-400 animate-pulse">Verbinden...</p>
            <div id="participantsList" class="mt-4 flex gap-2 justify-center flex-wrap"></div>
        </div>

        <div id="activeCallControls" class="relative z-10 w-full max-w-sm hidden">
            <div class="grid grid-cols-3 gap-6 mb-16 px-4">
                <button class="flex flex-col items-center gap-3 group opacity-60 hover:opacity-100 transition"><div class="w-16 h-16 rounded-full bg-white/10 backdrop-blur flex items-center justify-center"><i data-lucide="mic-off" class="w-7 h-7"></i></div><span class="text-xs font-medium">Stumm</span></button>
                <button class="flex flex-col items-center gap-3 group opacity-60 hover:opacity-100 transition"><div class="w-16 h-16 rounded-full bg-white/10 backdrop-blur flex items-center justify-center"><i data-lucide="volume-2" class="w-7 h-7"></i></div><span class="text-xs font-medium">Laut</span></button>
                <button class="flex flex-col items-center gap-3 group opacity-60 hover:opacity-100 transition"><div class="w-16 h-16 rounded-full bg-white/10 backdrop-blur flex items-center justify-center"><i data-lucide="video-off" class="w-7 h-7"></i></div><span class="text-xs font-medium">Video</span></button>
            </div>
            <div class="flex justify-center mb-8">
                <button onclick="window.hangUpCall()" class="w-20 h-20 rounded-full bg-wa-iosRed flex items-center justify-center shadow-lg hover:scale-105 active:scale-90 transition call-btn">
                    <i data-lucide="phone-off" class="w-9 h-9 fill-current"></i>
                </button>
            </div>
        </div>

        <div id="incomingCallControls" class="relative z-10 w-full max-w-sm flex items-center justify-between px-8 hidden mb-8">
            <div class="flex flex-col items-center gap-3">
                <button onclick="window.hangUpCall()" class="w-20 h-20 rounded-full bg-wa-iosRed flex items-center justify-center shadow-lg hover:scale-105 active:scale-90 transition call-btn">
                    <i data-lucide="phone-off" class="w-8 h-8 fill-current"></i>
                </button>
                <span class="text-sm font-semibold">Ablehnen</span>
            </div>
            <div class="flex flex-col items-center gap-3">
                <button onclick="window.answerIncomingCall()" class="w-20 h-20 rounded-full bg-wa-iosGreen flex items-center justify-center shadow-lg hover:scale-105 active:scale-90 transition call-btn">
                    <i data-lucide="phone" class="w-8 h-8 fill-current"></i>
                </button>
                <span class="text-sm font-semibold">Annehmen</span>
            </div>
        </div>
    </div>

    <div id="newGroupModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-wa-panel w-full max-w-sm rounded-[28px] p-8 shadow-2xl">
            <h3 class="text-2xl font-black mb-6">Neue Gruppe</h3>
            <div class="space-y-4">
                <div class="space-y-1"><label class="text-[10px] font-bold text-wa-accent uppercase px-1">Name</label><input id="ng_name" type="text" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none focus:ring-2 ring-wa-accent"></div>
                <div class="space-y-1"><label class="text-[10px] font-bold text-gray-500 uppercase px-1">Passwort (Optional)</label><input id="ng_pass" type="password" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none"></div>
            </div>
            <div class="flex justify-end gap-3 mt-10">
                <button onclick="window.toggleModal('newGroupModal')" class="px-6 py-2 text-gray-500 font-bold rounded-xl">Abbrechen</button>
                <button onclick="window.createGrp()" class="bg-wa-accent px-8 py-3 rounded-2xl text-white font-black shadow-lg">Erstellen</button>
            </div>
        </div>
    </div>

    <div id="joinGroupModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-wa-panel w-full max-w-sm rounded-[28px] p-8 shadow-2xl">
            <h3 class="text-2xl font-black mb-2">Beitreten</h3>
            <p class="text-xs text-gray-500 mb-6">Gib die Gruppen-ID ein.</p>
            <div class="space-y-4">
                <input id="jg_id" type="text" placeholder="GRP-ID" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none font-mono uppercase text-center text-xl tracking-widest focus:ring-2 ring-wa-accent">
                <input id="jg_pass" type="password" placeholder="Passwort" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none text-center">
            </div>
            <div class="flex justify-end gap-3 mt-10">
                <button onclick="window.toggleModal('joinGroupModal')" class="px-6 py-2 text-gray-500 font-bold rounded-xl">Abbrechen</button>
                <button onclick="window.joinGrp()" class="bg-wa-accent px-10 py-3 rounded-2xl text-white font-black shadow-lg">Join</button>
            </div>
        </div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-wa-panel w-full max-w-sm rounded-[28px] p-8 shadow-2xl relative">
            <button onclick="window.toggleModal('loginModal')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-wa-accent rounded-full mx-auto flex items-center justify-center text-white mb-2"><i data-lucide="user-check" class="w-8 h-8"></i></div>
                <h3 class="text-2xl font-black">Account Login</h3>
                <p class="text-xs text-gray-500 mt-1">Hast du schon ein anderes Konto?</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-wa-accent uppercase px-1">Deine Alte ID</label>
                    <input id="login_id" type="text" placeholder="User ID" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none font-mono text-center">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase px-1">Dein Passwort</label>
                    <input id="login_pass" type="text" placeholder="8-Stelliges Passwort" class="w-full bg-gray-100 dark:bg-wa-dark p-4 rounded-2xl outline-none font-mono text-center">
                </div>
            </div>
            <button onclick="window.recoverAccount()" class="w-full bg-wa-accent mt-8 py-4 rounded-2xl text-white font-black shadow-lg hover:scale-[1.02] transition">Account wiederherstellen</button>
        </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 z-[100] glass-modal flex items-center justify-center p-4">
        <div class="bg-white dark:bg-wa-panel w-full max-w-md rounded-[32px] overflow-hidden shadow-2xl relative">
            <button onclick="window.toggleModal('infoModal')" class="absolute top-6 right-6 text-white hover:opacity-80 transition"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="h-48 bg-gradient-to-br from-wa-accent to-emerald-700 relative flex items-end p-8">
                <div id="infoAvaLarge" class="w-24 h-24 rounded-3xl bg-white/20 backdrop-blur-md border border-white/30 text-white flex items-center justify-center text-4xl font-black shadow-2xl">?</div>
            </div>
            <div class="p-8">
                <h3 id="infoTit" class="text-2xl font-black mb-1">Name</h3>
                <div id="infoBadge" class="inline-block px-3 py-1 rounded-full bg-wa-accent/10 text-wa-accent text-[10px] font-bold font-mono tracking-widest mb-6">ID: ---</div>
                <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Mitglieder</h4>
                <div id="infoMemberList" class="max-h-48 overflow-y-auto space-y-3 custom-scrollbar"></div>
                <button onclick="window.leaveChat()" id="leaveBtn" class="w-full mt-8 py-4 rounded-2xl border-2 border-red-500/20 text-red-500 font-bold hover:bg-red-500 hover:text-white transition-all flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Chat verlassen
                </button>
            </div>
        </div>
    </div> 

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";

        let currentUser = null; // Das Firebase Auth Objekt
        let myRealUid = null;   // Die ID, die wir logisch nutzen (für Account Recovery Switch)
        let activeChatId = null;
        let isPrivate = false;
        let myNick = "Gast";
        let myCustomNames = {}; 
        let messageUnsub = null;
        
        // Multi-User WebRTC Vars
        let localStream = null;
        let peerConnections = {}; // Map: { userId: RTCPeerConnection }
        let callUnsub = null;
        let currentCallId = null;

        const servers = {
            iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }],
            iceCandidatePoolSize: 10,
        };

        lucide.createIcons();

        // --- HELPER FUNCTIONS ---
        function generatePassword() {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!?#@";
            let pass = "";
            for(let i=0; i<8; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
            return pass;
        }

        // --- AUTH & INITIALISIERUNG ---
        // Prüfen ob wir einen "wiederhergestellten" User im LocalStorage haben
        const savedUid = localStorage.getItem('shadow_simulated_uid');

        signInAnonymously(auth);
        
        onAuthStateChanged(auth, async (u) => {
            if(u) {
                currentUser = u;
                // Logik: Wenn wir eine savedUid haben, tun wir so, als wären wir dieser User für DB operationen
                myRealUid = savedUid ? savedUid : u.uid;

                const uRef = doc(db, "users", myRealUid);
                const snap = await getDoc(uRef);
                
                if(!snap.exists()) {
                    // Neuer User
                    if(savedUid) {
                        // Falls die Saved ID nicht existiert (gelöscht?), fallback auf echte ID
                        localStorage.removeItem('shadow_simulated_uid');
                        myRealUid = u.uid;
                        location.reload();
                        return;
                    }
                    myNick = "User-" + Math.floor(Math.random()*9000+1000);
                    const newPass = generatePassword();
                    await setDoc(doc(db, "users", myRealUid), { 
                        uid: myRealUid, 
                        nickname: myNick, 
                        password: newPass, // Hier wird das generierte PW gespeichert
                        friends: [], 
                        incoming: [], 
                        customNames: {}, 
                        lastSeen: serverTimestamp() 
                    });
                    document.getElementById('mySecretPass').innerText = newPass;
                } else {
                    const d = snap.data();
                    myNick = d.nickname;
                    myCustomNames = d.customNames || {};
                    // Check if password exists (for old users), if not create one
                    if(!d.password) {
                        const newPass = generatePassword();
                        await updateDoc(uRef, { password: newPass });
                        document.getElementById('mySecretPass').innerText = newPass;
                    } else {
                        document.getElementById('mySecretPass').innerText = d.password;
                    }
                }
                
                document.getElementById('myAvatar').innerText = myNick.substring(0,2).toUpperCase();
                document.getElementById('setAvatar').innerText = myNick.substring(0,2).toUpperCase();
                document.getElementById('myDisplayNick').innerText = myNick;
                document.getElementById('setNick').innerText = myNick;
                document.getElementById('nickIn').value = myNick;
                document.getElementById('myFullId').innerText = myRealUid;

                loadChats();
                loadFriendsTab();
                loadStatusTab();
                startIncomingCallListener();
                cleanupOldCalls();
            }
        });

        // --- ACCOUNT RECOVERY ---
        window.recoverAccount = async () => {
            const id = document.getElementById('login_id').value.trim();
            const pass = document.getElementById('login_pass').value.trim();
            if(!id || !pass) return alert("Bitte ID und Passwort eingeben.");

            try {
                const targetRef = doc(db, "users", id);
                const snap = await getDoc(targetRef);
                if(snap.exists()) {
                    if(snap.data().password === pass) {
                        localStorage.setItem('shadow_simulated_uid', id);
                        alert("Erfolgreich eingeloggt! Die Seite wird neu geladen.");
                        location.reload();
                    } else {
                        alert("Passwort falsch!");
                    }
                } else {
                    alert("User ID nicht gefunden.");
                }
            } catch(e) {
                console.error(e);
                alert("Fehler beim Login.");
            }
        };

        // --- MESSAGING ---
        window.sendMsg = async () => {
            const inp = document.getElementById('msgIn'); 
            const file = document.getElementById('imgIn').files[0];
            const txt = inp.value.trim();
            if(!txt && !file) return;

            let url = null;
            if(file) {
                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const d = await res.json(); url = d.data.url;
            }

            await addDoc(collection(db, `chats/${activeChatId}/messages`), { 
                text: txt, 
                img: url, 
                senderId: myRealUid, 
                senderName: myNick, 
                timestamp: serverTimestamp() 
            });
            await updateDoc(doc(db, "chats", activeChatId), { lastActivity: serverTimestamp() });
            
            inp.value = ""; 
            window.clearAttachment();
        };

        function openChat(id, name, isPriv) {
            activeChatId = id; isPrivate = isPriv;
            document.getElementById('chatHeader').classList.replace('hidden', 'flex');
            document.getElementById('chatInputArea').classList.replace('hidden', 'flex');
            document.getElementById('activeTitle').innerText = name; 
            document.getElementById('activeAvatar').innerText = name[0];
            
            if(window.innerWidth < 768) { 
                document.getElementById('mainSidebar').classList.add('hidden'); 
                document.getElementById('chatArea').classList.replace('hidden', 'flex'); 
            }
            
            if(messageUnsub) messageUnsub();
            const q = query(collection(db, `chats/${id}/messages`), orderBy("timestamp", "asc"));
            messageUnsub = onSnapshot(q, snap => {
                const list = document.getElementById('messagesList'); 
                list.innerHTML = "";
                snap.forEach(docSnap => {
                    const m = docSnap.data(); 
                    const isMe = m.senderId === myRealUid;
                    const msgId = docSnap.id;
                    const div = document.createElement('div');
                    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-1 relative group/msg`;
                    
                    // Edit & Delete Buttons
                    let controls = "";
                    if(isMe) {
                        controls = `
                        <div class="absolute top-0 right-0 -mt-2 -mr-2 bg-white dark:bg-gray-800 shadow-md rounded-full p-1 hidden group-hover/msg:flex gap-1 z-10">
                            <button onclick="window.editMessage('${msgId}', '${m.text ? m.text.replace(/'/g, "\\'") : ""}')" class="p-1 text-blue-500 hover:bg-blue-100 rounded-full"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                            <button onclick="window.deleteMessage('${msgId}')" class="p-1 text-red-500 hover:bg-red-100 rounded-full"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>`;
                    }

                    div.innerHTML = `
                        <div class="relative max-w-[85%]">
                            ${controls}
                            <div class="p-2 rounded-xl shadow-sm ${isMe ? 'bg-wa-bubbleOut dark:bg-wa-bubbleDarkOut' : 'bg-white dark:bg-wa-bubbleDarkIn'}">
                                ${!isMe && !isPriv ? `<p class="text-[10px] font-black text-wa-accent mb-1">${m.senderName}</p>` : ''}
                                ${m.img ? `<img src="${m.img}" class="rounded-lg mb-1 max-w-full">` : ''}
                                <div class="flex items-end gap-2 flex-wrap">
                                    <p class="text-[14.5px] whitespace-pre-wrap leading-relaxed">${m.text || ''}${m.edited ? '<span class="edited-tag">(bearbeitet)</span>' : ''}</p>
                                </div>
                            </div>
                        </div>`;
                    list.appendChild(div);
                });
                list.scrollTop = list.scrollHeight;
                lucide.createIcons();
            });
            updateInfoModal(id, name, isPriv);
        }

        window.deleteMessage = async (msgId) => {
            if(confirm("Nachricht löschen?")) {
                await deleteDoc(doc(db, `chats/${activeChatId}/messages`, msgId));
            }
        };

        window.editMessage = async (msgId, oldText) => {
            const newText = prompt("Nachricht bearbeiten:", oldText);
            if(newText !== null && newText !== oldText) {
                await updateDoc(doc(db, `chats/${activeChatId}/messages`, msgId), {
                    text: newText,
                    edited: true
                });
            }
        };

        // --- GRUPPEN FUNKTIONEN ---
        window.createGrp = async () => {
            const n = document.getElementById('ng_name').value.trim();
            const p = document.getElementById('ng_pass').value.trim();
            if(!n) return alert("Name fehlt!");
            const gid = "GRP-" + Math.random().toString(36).substring(2,9).toUpperCase();
            
            await setDoc(doc(db, "chats", gid), { 
                type: 'group', 
                name: n, 
                password: p || null, 
                creator: myRealUid, 
                members: [myRealUid], 
                lastActivity: serverTimestamp() 
            });
            alert("Gruppe erstellt! ID: " + gid);
            window.toggleModal('newGroupModal'); 
            openChat(gid, n, false);
        };

        window.joinGrp = async () => {
            const id = document.getElementById('jg_id').value.toUpperCase().trim();
            const pass = document.getElementById('jg_pass').value.trim();
            if(!id) return;
            const snap = await getDoc(doc(db, "chats", id));
            if(snap.exists()) {
                const d = snap.data();
                if(d.password && d.password !== pass) return alert("Passwort falsch!");
                await updateDoc(doc(db, "chats", id), { members: arrayUnion(myRealUid) });
                window.toggleModal('joinGroupModal'); 
                openChat(id, d.name, false);
            } else alert("Gruppe nicht gefunden!");
        };

        window.leaveChat = async () => {
            if(!activeChatId || isPrivate) return;
            if(confirm("Gruppe wirklich verlassen?")) {
                try {
                    await updateDoc(doc(db, "chats", activeChatId), {
                        members: arrayRemove(myRealUid)
                    });
                    document.getElementById('chatArea').classList.add('hidden');
                    if(window.innerWidth < 768) document.getElementById('mainSidebar').classList.remove('hidden');
                    window.toggleModal('infoModal');
                    activeChatId = null;
                } catch(e) {
                    alert("Fehler beim Verlassen: " + e.message);
                }
            }
        };

        function loadChats() {
            const q = query(collection(db, "chats"), orderBy("lastActivity", "desc"));
            onSnapshot(q, snap => {
                const cont = document.getElementById('chatListContainer'); cont.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    const isMem = c.type === 'private' ? c.participants?.includes(myRealUid) : c.members?.includes(myRealUid);
                    if(isMem) {
                        let name = c.name; 
                        if(c.type === 'private') {
                            const otherId = c.participants.find(p => p !== myRealUid);
                            name = myCustomNames[otherId] || c.names[otherId];
                        }
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-4 p-4 hover:bg-gray-100 dark:hover:bg-wa-panel cursor-pointer border-b dark:border-gray-800";
                        div.innerHTML = `<div class="w-12 h-12 rounded-full bg-wa-accent flex items-center justify-center text-white font-bold">${name ? name[0] : '?'}</div><div class="flex-1 truncate"><h4 class="font-bold">${name}</h4><p class="text-xs text-gray-500">${c.type === 'group' ? 'Gruppe' : 'Privat'}</p></div>`;
                        div.onclick = () => openChat(d.id, name, c.type==='private');
                        cont.appendChild(div);
                    }
                });
            });
        }

        // --- KONTAKTE & FREUNDE ---
        function loadFriendsTab() {
            onSnapshot(doc(db, "users", myRealUid), async (s) => {
                const data = s.data(); if(!data) return;
                myCustomNames = data.customNames || {};
                
                const pL = document.getElementById('pendingList');
                if(data.incoming?.length > 0) {
                    document.getElementById('pendingContainer').classList.remove('hidden'); pL.innerHTML = "";
                    for(const rid of data.incoming) {
                        const rU = await getDoc(doc(db, "users", rid));
                        if(rU.exists()) {
                            const div = document.createElement('div');
                            div.className = "flex items-center justify-between bg-white dark:bg-wa-panel p-3 rounded-xl mb-2 shadow-sm";
                            div.innerHTML = `<span>${rU.data().nickname}</span><button onclick="window.acceptFriend('${rid}')" class="bg-wa-accent text-white p-2 rounded-lg"><i data-lucide="check" class="w-4 h-4"></i></button>`;
                            pL.appendChild(div);
                        }
                    }
                } else document.getElementById('pendingContainer').classList.add('hidden');

                const cL = document.getElementById('contactsList'); cL.innerHTML = "";
                if(data.friends?.length > 0) {
                    for(const fid of data.friends) {
                        const fU = await getDoc(doc(db, "users", fid));
                        if(fU.exists()) {
                            const fd = fU.data(); const dispName = myCustomNames[fid] || fd.nickname;
                            const div = document.createElement('div');
                            div.className = "flex items-center justify-between p-3 hover:bg-gray-100 dark:hover:bg-wa-panel rounded-xl border-b dark:border-gray-800";
                            div.innerHTML = `
                                <div class="flex items-center gap-3 cursor-pointer flex-1" onclick="window.startPrivateChat('${fid}', '${dispName}')">
                                    <div class="w-10 h-10 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold">${dispName[0]}</div>
                                    <p class="font-bold text-sm">${dispName}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="window.renameContact('${fid}', '${dispName}')" class="p-2 text-blue-500"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                    <button onclick="window.deleteContact('${fid}')" class="p-2 text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>`;
                            cL.appendChild(div);
                        }
                    }
                } else cL.innerHTML = `<div class="text-center py-10 text-gray-500 text-xs">Keine Kontakte.</div>`;
                lucide.createIcons();
            });
        }

        window.acceptFriend = async (rid) => {
            const batch = writeBatch(db);
            batch.update(doc(db, "users", myRealUid), { friends: arrayUnion(rid), incoming: arrayRemove(rid) });
            batch.update(doc(db, "users", rid), { friends: arrayUnion(myRealUid) });
            await batch.commit();
        };

        window.deleteContact = async (fid) => {
            if(confirm("Kontakt löschen?")) {
                await updateDoc(doc(db, "users", myRealUid), { friends: arrayRemove(fid) });
                await updateDoc(doc(db, "users", fid), { friends: arrayRemove(myRealUid) });
            }
        };

        window.renameContact = async (fid, cur) => {
            const n = prompt("Spitzname:", cur);
            if(n) { const u = {}; u[`customNames.${fid}`] = n; await updateDoc(doc(db, "users", myRealUid), u); }
        };

        window.startPrivateChat = async (oId, oNick) => {
            const id = [myRealUid, oId].sort().join("_");
            await setDoc(doc(db, "chats", id), { 
                type: 'private', 
                participants: [myRealUid, oId], 
                lastActivity: serverTimestamp(), 
                names: { [myRealUid]: myNick, [oId]: oNick } 
            }, { merge: true });
            openChat(id, oNick, true);
        };

        window.copyMyId = () => { navigator.clipboard.writeText(myRealUid); alert("ID kopiert!"); };

        // --- MULTI-USER CALLS (MESH STRUKTUR) ---
        async function setupLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('localAudio').srcObject = localStream;
                return true;
            } catch(e) { alert("Mikrofonfehler!"); return false; }
        }

        // Anruf starten (Geht nun für Privat & Gruppe)
        window.initiateCall = async () => {
            if(!activeChatId) return;
            setupCallUI(true, document.getElementById('activeTitle').innerText);
            if(!(await setupLocalStream())) return;

            // Call Document erstellen
            const callDoc = doc(collection(db, "calls"));
            currentCallId = callDoc.id;
            
            // Call Daten speichern (targetGroupId ist neu für Gruppen)
            const callData = { 
                callerId: myRealUid, 
                callerName: myNick, 
                status: 'ringing',
                isGroup: !isPrivate,
                targetId: isPrivate ? activeChatId.split("_").find(p => p !== myRealUid) : activeChatId, // In Group: Chat ID, In Private: User ID
                participants: [myRealUid]
            };
            await setDoc(callDoc, callData);

            // Listener auf Call Status
            callUnsub = onSnapshot(callDoc, async (s) => {
                const d = s.data();
                if(!d) return;
                
                // Wenn jemand joint (bei Gruppen wichtig)
                if(d.participants && d.participants.length > 1) {
                    updateCallStatusUI("Verbunden (" + d.participants.length + ")");
                    // Hier müsste nun die Logik für Mesh-Verbindungen zu neuen Teilnehmern hin
                    // Vereinfachung: Wir warten auf Angebote im "offers" Subcollection
                }

                if(d.status === 'ended') window.hangUpCall();
            });

            // Wir hören auf "Angebote" von anderen, die beitreten
            onSnapshot(collection(callDoc, "offers"), snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const offerData = change.doc.data();
                        if(offerData.to === myRealUid) {
                            await handleOffer(callDoc, change.doc.id, offerData);
                        }
                    }
                });
            });
        };

        // Hilfsfunktion: Angebot annehmen und antworten
        async function handleOffer(callDocRef, offerId, offerData) {
            const pc = new RTCPeerConnection(servers);
            const peerId = offerData.from;
            peerConnections[peerId] = pc;
            
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            pc.ontrack = e => {
                const aud = document.createElement('audio');
                aud.srcObject = e.streams[0];
                aud.autoplay = true;
                aud.id = `audio-${peerId}`;
                document.getElementById('audioContainer').appendChild(aud);
            };

            pc.onicecandidate = e => {
                if(e.candidate) {
                    addDoc(collection(callDocRef, "candidates"), {
                        candidate: e.candidate.toJSON(),
                        from: myRealUid,
                        to: peerId
                    });
                }
            };

            await pc.setRemoteDescription(new RTCSessionDescription(offerData.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            await addDoc(collection(callDocRef, "answers"), {
                answer: { type: answer.type, sdp: answer.sdp },
                from: myRealUid,
                to: peerId
            });
        }

        // Eingehenden Anruf annehmen
        window.answerIncomingCall = async () => {
            const callDoc = doc(db, "calls", currentCallId);
            const d = (await getDoc(callDoc)).data();
            setupCallUI(false, d.callerName);
            document.getElementById('incomingCallControls').classList.add('hidden');
            document.getElementById('activeCallControls').classList.remove('hidden');
            
            if(!(await setupLocalStream())) return;

            // Mich selbst zur Teilnehmerliste hinzufügen
            await updateDoc(callDoc, { participants: arrayUnion(myRealUid), status: 'connected' });

            // Allen bisherigen Teilnehmern ein Angebot machen
            const participants = d.participants || [];
            participants.forEach(async pId => {
                if(pId === myRealUid) return;
                createOfferForPeer(callDoc, pId);
            });

            // Auf Antworten hören
            onSnapshot(collection(callDoc, "answers"), snapshot => {
                snapshot.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        const ans = change.doc.data();
                        if(ans.to === myRealUid && peerConnections[ans.from]) {
                            peerConnections[ans.from].setRemoteDescription(new RTCSessionDescription(ans.answer));
                        }
                    }
                });
            });

            // Auf neue Kandidaten hören
            onSnapshot(collection(callDoc, "candidates"), snapshot => {
                snapshot.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        const cand = change.doc.data();
                        if(cand.to === myRealUid && peerConnections[cand.from]) {
                            peerConnections[cand.from].addIceCandidate(new RTCIceCandidate(cand.candidate));
                        }
                    }
                });
            });

            // Auf weitere Angebote hören (wenn noch wer joint)
            onSnapshot(collection(callDoc, "offers"), snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const offerData = change.doc.data();
                        if(offerData.to === myRealUid) await handleOffer(callDoc, change.doc.id, offerData);
                    }
                });
            });

            callUnsub = onSnapshot(callDoc, s => { if(s.data()?.status === 'ended') window.hangUpCall(); });
        };

        async function createOfferForPeer(callDocRef, targetPeerId) {
            const pc = new RTCPeerConnection(servers);
            peerConnections[targetPeerId] = pc;

            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.ontrack = e => {
                const aud = document.createElement('audio');
                aud.srcObject = e.streams[0];
                aud.autoplay = true;
                aud.id = `audio-${targetPeerId}`;
                document.getElementById('audioContainer').appendChild(aud);
            };

            pc.onicecandidate = e => {
                if(e.candidate) {
                    addDoc(collection(callDocRef, "candidates"), {
                        candidate: e.candidate.toJSON(),
                        from: myRealUid,
                        to: targetPeerId
                    });
                }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            await addDoc(collection(callDocRef, "offers"), {
                offer: { type: offer.type, sdp: offer.sdp },
                from: myRealUid,
                to: targetPeerId
            });
        }

        window.hangUpCall = async () => {
            if(currentCallId) { 
                try { 
                    // Wenn ich der Caller bin, beende für alle, sonst nur mich entfernen
                    const d = (await getDoc(doc(db, "calls", currentCallId))).data();
                    if(d && d.callerId === myRealUid) {
                        await updateDoc(doc(db, "calls", currentCallId), { status: 'ended' }); 
                    } else {
                        await updateDoc(doc(db, "calls", currentCallId), { participants: arrayRemove(myRealUid) });
                    }
                } catch(e){} 
            }
            
            // Clean up WebRTC
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            document.getElementById('audioContainer').innerHTML = '<audio id="localAudio" muted autoplay playsinline></audio>';

            if(localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            if(callUnsub) callUnsub();
            document.getElementById('callOverlay').classList.add('hidden');
            currentCallId = null;
        };

        function startIncomingCallListener() {
            // Höre auf Anrufe, wo ich das Ziel bin ODER wo meine Gruppe das Ziel ist
            // Firestore Query limitation: OR queries are tricky. We simplify:
            // Wir hören auf ALLE Calls wo status == ringing und checken client side
            const q = query(collection(db, "calls"), where("status", "==", "ringing"));
            onSnapshot(q, s => {
                s.docChanges().forEach(async c => {
                    if(c.type === 'added') {
                        const d = c.doc.data();
                        if(d.callerId === myRealUid) return; // Mein eigener Anruf

                        let shouldRing = false;
                        if(!d.isGroup && d.targetId === myRealUid) shouldRing = true;
                        
                        if(d.isGroup) {
                            // Check ob ich in der Gruppe bin
                            const chatSnap = await getDoc(doc(db, "chats", d.targetId));
                            if(chatSnap.exists() && chatSnap.data().members.includes(myRealUid)) {
                                shouldRing = true;
                            }
                        }

                        if(shouldRing) {
                            currentCallId = c.doc.id;
                            setupCallUI(false, d.callerName + (d.isGroup ? " (Gruppe)" : ""));
                        }
                    }
                });
            });
        }

        function setupCallUI(isCaller, name) {
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('callName').innerText = name;
            document.getElementById('callAvatar').innerText = name[0];
            document.getElementById('callStatus').innerText = isCaller ? "Wählt..." : "Eingehender Anruf...";
            document.getElementById('callRipple').classList.remove('hidden');
            document.getElementById('activeCallControls').classList.toggle('hidden', !isCaller);
            document.getElementById('incomingCallControls').classList.toggle('hidden', isCaller);
        }

        function updateCallStatusUI(txt) {
            const s = document.getElementById('callStatus');
            s.innerText = txt;
            if(txt.includes("Verbunden")) {
                s.classList.add('text-green-400');
                document.getElementById('callRipple').classList.add('hidden');
            }
        }

        // --- STATUS & PROFIL ---
        window.upStatus = async () => {
            const f = document.getElementById('stIn').files[0]; if(!f) return;
            const fd = new FormData(); fd.append("image", f);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const d = await res.json();
            await addDoc(collection(db, "status"), { uid: myRealUid, name: myNick, img: d.data.url, timestamp: serverTimestamp() });
            alert("Status gepostet!");
        };

        function loadStatusTab() {
            const dayAgo = new Date(Date.now() - 24*60*60*1000);
            onSnapshot(query(collection(db, "status"), orderBy("timestamp", "desc")), snap => {
                const list = document.getElementById('globalStatusList'); list.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    if(s.timestamp && s.timestamp.toDate() > dayAgo) {
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-4 p-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-wa-panel rounded-xl mb-2";
                        div.innerHTML = `<img src="${s.img}" class="w-12 h-12 rounded-full border-2 border-wa-accent object-cover"><div><h4 class="font-bold text-sm">${s.name}</h4><p class="text-[10px] text-gray-500">${s.timestamp.toDate().toLocaleTimeString()}</p></div>`;
                        div.onclick = () => window.open(s.img); list.appendChild(div);
                    }
                });
            });
        }

        window.saveProfile = async () => {
            const n = document.getElementById('nickIn').value.trim();
            if(n) { 
                await updateDoc(doc(db, "users", myRealUid), { nickname: n }); 
                alert("Profil gespeichert!");
                location.reload(); 
            }
        };

        // --- HELFER ---
        async function cleanupOldCalls() {
            const q = query(collection(db, "calls"), where("status", "==", "ended"));
            const snap = await getDocs(q); 
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref)); 
            await batch.commit();
        }

        function updateInfoModal(id, name, isPriv) {
            document.getElementById('infoTit').innerText = name;
            document.getElementById('infoAvaLarge').innerText = name[0];
            document.getElementById('infoBadge').innerText = "ID: " + id;
            const ml = document.getElementById('infoMemberList'); ml.innerHTML = "";
            const leaveBtn = document.getElementById('leaveBtn');
            
            if(isPriv) {
                ml.innerHTML = "<p class='text-xs text-gray-500'>Privater Chat.</p>";
                leaveBtn.classList.add('hidden');
            } else {
                leaveBtn.classList.remove('hidden');
                getDoc(doc(db, "chats", id)).then(s => {
                    if(s.exists()){
                        s.data().members.forEach(async mid => {
                            const u = await getDoc(doc(db, "users", mid));
                            if(u.exists()) {
                                const div = document.createElement('div'); 
                                div.className = "p-2 bg-gray-100 dark:bg-wa-dark rounded-lg mb-1 text-sm font-bold flex justify-between";
                                div.innerHTML = `<span>${u.data().nickname}</span>${mid === myRealUid ? '<span class="text-[10px] bg-wa-accent text-white px-1 rounded">ICH</span>' : ''}`;
                                ml.appendChild(div);
                            }
                        });
                    }
                });
            }
        }

        window.toggleModal = (id) => document.getElementById(id).classList.toggle('hidden');
        window.switchTab = (t) => {
            ['chats', 'friends', 'status', 'settings'].forEach(x => document.getElementById('tab-'+x).classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            lucide.createIcons();
        };
        window.toggleTheme = () => document.documentElement.classList.toggle('dark');
        window.handleFile = () => { const f = document.getElementById('imgIn').files[0]; if(f) { document.getElementById('prevImg').src = URL.createObjectURL(f); document.getElementById('attachmentPreview').classList.remove('hidden'); } };
        window.clearAttachment = () => { document.getElementById('imgIn').value = ""; document.getElementById('attachmentPreview').classList.add('hidden'); };
        window.closeChatMobile = () => { document.getElementById('chatArea').classList.add('hidden'); document.getElementById('mainSidebar').classList.remove('hidden'); activeChatId = null; };
        window.sendRequest = async () => {
            const id = document.getElementById('friendSearchInput').value.trim();
            if(!id || id === myRealUid) return alert("ID ungültig");
            const tRef = doc(db, "users", id); const tSnap = await getDoc(tRef);
            if(tSnap.exists()) { await updateDoc(tRef, { incoming: arrayUnion(myRealUid) }); alert("Anfrage gesendet!"); }
            else alert("Nutzer existiert nicht.");
        };
    </script>
</body>
</html>
