<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShadowChat V10 - Ultimate Extended</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: { 
                            light: '#f0f2f5', 
                            dark: '#0b141a', 
                            panel: '#202c33',
                            accent: '#00a884', 
                            bubbleOut: '#d9fdd3', 
                            bubbleIn: '#ffffff', 
                            bubbleDarkOut: '#005c4b', 
                            bubbleDarkIn: '#233138',
                            iosRed: '#ff3b30',
                            iosGreen: '#34c759'
                        }
                    },
                    fontFamily: {
                        sans: ['SF Pro Display', '-apple-system', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'SF Pro Display', sans-serif; overflow: hidden; height: 100dvh; background-color: #0b141a; color: #e9edef; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
        
        .glass-modal { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background-color: rgba(0,0,0,0.75); }
        .ios-blur { backdrop-filter: blur(40px) saturate(150%); -webkit-backdrop-filter: blur(40px); background: rgba(20, 20, 20, 0.8); }
        
        /* Message Bubbles Tail */
        .bubble-shadow { shadow-sm; }
        
        input, textarea { caret-color: #00a884; }

        .call-ripple {
            position: absolute; border: 2px solid #00a884; border-radius: 50%;
            animation: ripple 2s infinite; opacity: 0;
        }
        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(2.5); opacity: 0; }
        }
    </style>
</head>
<body class="bg-wa-dark text-gray-100 flex flex-col md:flex-row">

    <audio id="snd_message" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="snd_call" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>

    <aside id="mainSidebar" class="flex flex-col w-full md:w-[420px] h-full border-r border-gray-800 bg-wa-dark z-20 shrink-0 transition-all duration-300">
        
        <header class="h-[64px] bg-wa-panel flex items-center justify-between px-4 shrink-0 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div id="myAvatar" class="w-10 h-10 rounded-full bg-wa-accent flex items-center justify-center font-bold text-white cursor-pointer hover:scale-105 transition shadow-lg" onclick="window.switchTab('settings')">?</div>
                <div>
                    <p class="font-bold text-sm leading-none" id="myDisplayNick">L√§dt...</p>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="w-2 h-2 bg-wa-accent rounded-full animate-pulse"></span>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">ShadowChat V10</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="window.toggleModal('loginModal')" title="Account wechseln" class="p-2 rounded-full hover:bg-gray-700 text-blue-400 transition">
                    <i data-lucide="user-cog" class="w-5 h-5"></i>
                </button>
                <button onclick="window.toggleModal('newGroupModal')" title="Neue Gruppe" class="p-2 rounded-full hover:bg-gray-700 transition">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </button>
                <button onclick="window.toggleModal('joinGroupModal')" title="Beitreten" class="p-2 rounded-full hover:bg-gray-700 transition text-wa-accent">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                </button>
                <button onclick="window.switchTab('settings')" class="p-2 rounded-full hover:bg-gray-700 transition">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="p-3 bg-wa-dark">
            <div class="bg-wa-panel flex items-center px-4 py-2 rounded-xl border border-gray-700 focus-within:border-wa-accent transition">
                <i data-lucide="search" class="w-4 h-4 text-gray-500"></i>
                <input type="text" id="chatSearch" placeholder="Chats oder Nachrichten suchen..." class="bg-transparent text-sm w-full outline-none px-3 text-gray-200">
            </div>
        </div>

        <div class="flex border-b border-gray-800 bg-wa-dark overflow-x-auto no-scrollbar">
            <button onclick="window.switchTab('chats')" class="flex-1 py-3 text-xs font-bold uppercase tracking-widest border-b-2 border-wa-accent text-wa-accent transition" id="btn-tab-chats">Chats</button>
            <button onclick="window.switchTab('friends')" class="flex-1 py-3 text-xs font-bold uppercase tracking-widest border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition" id="btn-tab-friends">Kontakte</button>
            <button onclick="window.switchTab('status')" class="flex-1 py-3 text-xs font-bold uppercase tracking-widest border-b-2 border-transparent text-gray-500 hover:text-gray-300 transition" id="btn-tab-status">Status</button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar relative bg-wa-dark">
            
            <div id="tab-chats" class="tab-pane active animate-fade">
                <div id="chatListContainer" class="divide-y divide-gray-800/50">
                    <div class="p-8 text-center text-gray-600 text-sm">Keine aktiven Chats vorhanden.</div>
                </div>
            </div>

            <div id="tab-friends" class="tab-pane hidden p-4 animate-fade space-y-6">
                <div class="bg-wa-panel p-5 rounded-2xl border border-gray-700 shadow-xl">
                    <h4 class="text-[10px] font-black text-wa-accent uppercase mb-3 tracking-widest">Nutzer hinzuf√ºgen</h4>
                    <div class="flex gap-2">
                        <input id="friendSearchInput" type="text" class="flex-1 bg-wa-dark border border-gray-700 p-3 rounded-xl text-sm outline-none focus:border-wa-accent transition" placeholder="UID des Nutzers eingeben...">
                        <button onclick="window.sendRequest()" class="bg-wa-accent hover:bg-emerald-600 text-white p-3 rounded-xl transition shadow-lg">
                            <i data-lucide="user-plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="pendingContainer" class="hidden">
                    <h4 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                        <i data-lucide="bell" class="w-3 h-3"></i> Offene Anfragen
                    </h4>
                    <div id="pendingList" class="space-y-2"></div>
                </div>

                <div>
                    <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-3">Meine Kontakte</h4>
                    <div id="contactsList" class="space-y-1"></div>
                </div>
            </div>

            <div id="tab-status" class="tab-pane hidden p-4 animate-fade">
                <div class="flex items-center gap-4 mb-8 cursor-pointer group p-3 rounded-2xl hover:bg-wa-panel transition" onclick="document.getElementById('stIn').click()">
                    <div class="relative">
                        <div class="w-14 h-14 rounded-full border-2 border-wa-accent p-0.5 overflow-hidden">
                            <div class="w-full h-full rounded-full bg-gray-800 flex items-center justify-center overflow-hidden">
                                <i data-lucide="camera" class="text-gray-500 group-hover:scale-110 transition"></i>
                            </div>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-wa-accent rounded-full p-1 border-2 border-wa-dark"><i data-lucide="plus" class="w-3 h-3 text-white"></i></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-200">Mein Status</h3>
                        <p class="text-xs text-gray-500">Tippe, um ein Update zu teilen</p>
                    </div>
                    <input type="file" id="stIn" class="hidden" accept="image/*" onchange="window.upStatus()">
                </div>
                <h4 class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Aktuelle Updates</h4>
                <div id="globalStatusList" class="space-y-4"></div>
            </div>

            <div id="tab-settings" class="tab-pane hidden p-0 animate-fade pb-10">
                <div class="relative h-32 bg-gradient-to-r from-wa-accent to-emerald-900">
                    <div class="absolute -bottom-10 left-6">
                        <div class="w-24 h-24 rounded-full bg-wa-panel border-4 border-wa-dark flex items-center justify-center text-4xl font-black text-white shadow-2xl" id="setAvatarLarge">?</div>
                    </div>
                </div>
                <div class="mt-12 px-6 space-y-6">
                    <div>
                        <h2 class="text-2xl font-black text-gray-100" id="setNick">Gast</h2>
                        <p class="text-xs text-gray-500 flex items-center gap-1">
                            <i data-lucide="shield-check" class="w-3 h-3 text-wa-accent"></i> Verifiziertes Shadow-Konto
                        </p>
                    </div>

                    <div class="space-y-3">
                        <div class="bg-wa-panel p-4 rounded-2xl border border-gray-700">
                            <label class="text-[10px] font-black text-wa-accent uppercase tracking-widest">Anzeigename</label>
                            <div class="flex gap-3 mt-2">
                                <input id="nickIn" type="text" class="flex-1 bg-wa-dark border border-gray-700 p-2 rounded-lg outline-none focus:border-wa-accent transition text-sm">
                                <button onclick="window.saveProfile()" class="bg-wa-accent text-white px-4 py-2 rounded-lg text-xs font-black uppercase hover:bg-emerald-600 transition">Update</button>
                            </div>
                        </div>

                        <div class="bg-wa-panel p-4 rounded-2xl border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Sicherheits-Schl√ºssel</label>
                                <button onclick="window.generateAndSavePass()" class="text-[9px] bg-wa-accent/20 text-wa-accent border border-wa-accent/30 px-2 py-1 rounded-md hover:bg-wa-accent hover:text-white transition">NEU GENERIEREN</button>
                            </div>
                            <div class="flex items-center justify-between bg-wa-dark p-3 rounded-xl border border-gray-800">
                                <span id="myPassDisplay" class="font-mono text-sm text-orange-400 tracking-widest">********</span>
                                <button onclick="window.copyPass()" class="text-gray-500 hover:text-wa-accent"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            </div>
                            <p class="text-[9px] text-gray-500 mt-2 leading-relaxed">Merke dir dieses Passwort! Es wird zusammen mit deiner ID ben√∂tigt, um dein Konto auf anderen Ger√§ten wiederherzustellen.</p>
                        </div>

                        <div class="bg-wa-panel p-4 rounded-2xl border border-gray-700 cursor-pointer group" onclick="window.copyMyId()">
                            <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Meine Shadow-ID</label>
                            <div class="flex items-center justify-between mt-1">
                                <p id="myFullId" class="text-xs font-mono text-wa-accent truncate pr-4">---</p>
                                <i data-lucide="clipboard" class="w-4 h-4 text-gray-600 group-hover:text-wa-accent transition"></i>
                            </div>
                        </div>

                        <div class="pt-4 space-y-2">
                            <button onclick="window.toggleTheme()" class="w-full flex items-center justify-between p-4 bg-wa-panel rounded-2xl border border-gray-700 hover:bg-gray-800 transition">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="moon" class="w-5 h-5"></i></div>
                                    <span class="text-sm font-bold">Dark Mode</span>
                                </div>
                                <div class="w-10 h-5 bg-wa-accent rounded-full relative"><div class="absolute right-1 top-1 w-3 h-3 bg-white rounded-full"></div></div>
                            </button>
                            
                            <button onclick="window.exportLogs()" class="w-full flex items-center justify-between p-4 bg-wa-panel rounded-2xl border border-gray-700 hover:bg-gray-800 transition">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i data-lucide="database" class="w-5 h-5"></i></div>
                                    <span class="text-sm font-bold">Daten exportieren</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <nav class="md:hidden h-[70px] bg-wa-panel border-t border-gray-800 flex justify-around items-center shrink-0">
            <button onclick="window.switchTab('chats')" class="flex flex-col items-center gap-1 text-wa-accent">
                <i data-lucide="message-square" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold uppercase">Chats</span>
            </button>
            <button onclick="window.switchTab('status')" class="flex flex-col items-center gap-1 text-gray-500">
                <i data-lucide="circle-dashed" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold uppercase">Status</span>
            </button>
            <button onclick="window.switchTab('friends')" class="flex flex-col items-center gap-1 text-gray-500">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold uppercase">Freunde</span>
            </button>
            <button onclick="window.switchTab('settings')" class="flex flex-col items-center gap-1 text-gray-500">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold uppercase">Profil</span>
            </button>
        </nav>
    </aside>

    <main id="chatArea" class="hidden md:flex flex-1 flex-col h-full relative overflow-hidden bg-[#0b141a] z-30">
        <div class="absolute inset-0 opacity-[0.05] pointer-events-none" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: 400px;"></div>

        <header id="chatHeader" class="hidden h-[64px] bg-wa-panel flex items-center justify-between px-4 shrink-0 z-40 border-b border-gray-800">
            <div class="flex items-center gap-3">
                <button onclick="window.closeChatMobile()" class="md:hidden p-2 text-gray-400 hover:text-white transition">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div id="activeAvatar" class="w-10 h-10 rounded-full bg-wa-accent flex items-center justify-center text-white font-bold shadow-md">?</div>
                <div class="cursor-pointer group" onclick="window.toggleModal('infoModal')">
                    <h2 id="activeTitle" class="font-bold text-base text-gray-100 group-hover:text-wa-accent transition">Chat</h2>
                    <div class="flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-wa-accent rounded-full"></span>
                        <p id="activeSub" class="text-[9px] text-wa-accent font-black uppercase tracking-tighter">Verschl√ºsselt</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.initiateCall()" class="p-2.5 rounded-full hover:bg-gray-700 text-wa-accent transition" title="Gruppen Call">
                    <i data-lucide="phone" class="w-5 h-5"></i>
                </button>
                <button onclick="window.toggleModal('infoModal')" class="p-2.5 rounded-full hover:bg-gray-700 text-gray-400 transition">
                    <i data-lucide="info" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div id="messagesList" class="flex-1 overflow-y-auto p-4 md:px-12 space-y-2 relative z-10 custom-scrollbar flex flex-col">
            <div class="flex-1 flex flex-col items-center justify-center text-gray-600">
                <i data-lucide="message-square" class="w-12 h-12 mb-4 opacity-20"></i>
                <p class="text-sm italic">W√§hle einen Chat aus, um zu schreiben.</p>
            </div>
        </div>

        <footer id="chatInputArea" class="hidden p-3 bg-wa-panel flex items-end gap-3 shrink-0 z-40 border-t border-gray-800">
            <div id="attachmentPreview" class="hidden absolute bottom-[80px] left-4 right-4 bg-wa-panel p-4 rounded-2xl border-2 border-wa-accent shadow-2xl animate-fade">
                <div class="relative inline-block">
                    <img id="prevImg" class="h-40 w-auto rounded-xl border border-gray-700 shadow-lg">
                    <button onclick="window.clearAttachment()" class="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition shadow-lg">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <button onclick="document.getElementById('imgIn').click()" class="p-2 text-gray-400 hover:text-wa-accent transition">
                <i data-lucide="paperclip" class="w-6 h-6"></i>
            </button>
            <input type="file" id="imgIn" class="hidden" accept="image/*" onchange="window.handleFile()">
            
            <div class="flex-1 bg-wa-dark rounded-2xl flex items-center px-4 py-2 min-h-[48px] border border-gray-700 focus-within:border-wa-accent transition">
                <textarea id="msgIn" placeholder="Deine Nachricht..." class="w-full bg-transparent outline-none text-[15px] text-gray-100 resize-none max-h-32 py-1" rows="1"></textarea>
            </div>
            
            <button id="sendBtn" onclick="window.sendMsg()" class="bg-wa-accent text-white p-3.5 rounded-2xl shadow-xl hover:bg-emerald-600 hover:scale-105 active:scale-95 transition">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
            </button>
        </footer>
    </main>

    <div id="callOverlay" class="hidden fixed inset-0 z-[1000] ios-blur flex flex-col items-center justify-between py-20 px-6 text-white overflow-hidden">
        <div class="call-ripple" style="animation-delay: 0s"></div>
        <div class="call-ripple" style="animation-delay: 0.5s"></div>
        <div class="call-ripple" style="animation-delay: 1s"></div>
        
        <div class="relative z-10 text-center w-full">
            <div class="flex items-center justify-center gap-2 mb-10 opacity-60">
                <i data-lucide="shield-check" class="w-4 h-4 text-wa-accent"></i>
                <span class="text-[10px] font-black uppercase tracking-[0.2em]">ShadowCall Secure Pipeline</span>
            </div>
            
            <div class="w-40 h-40 rounded-full bg-wa-panel mx-auto flex items-center justify-center text-6xl font-black border-4 border-wa-accent/30 shadow-[0_0_50px_rgba(0,168,132,0.3)] mb-8" id="callAvatar">?</div>
            
            <h2 id="callName" class="text-4xl font-black mb-2 tracking-tight">Unbekannt</h2>
            <p id="callStatus" class="text-wa-accent font-bold animate-pulse tracking-widest uppercase text-[11px]">Verbindung wird aufgebaut...</p>
        </div>

        <div id="callActions" class="flex gap-16 relative z-10">
            <div class="flex flex-col items-center gap-3">
                <button id="btnHangup" onclick="window.hangUpCall()" class="w-20 h-20 rounded-full bg-wa-iosRed flex items-center justify-center shadow-2xl hover:bg-red-600 transition hover:scale-110 active:scale-90">
                    <i data-lucide="phone-off" class="w-9 h-9 fill-current"></i>
                </button>
                <span class="text-[10px] font-bold text-gray-400 uppercase">Beenden</span>
            </div>
            
            <div id="answerWrapper" class="hidden flex flex-col items-center gap-3">
                <button id="btnAnswer" onclick="window.answerIncomingCall()" class="w-20 h-20 rounded-full bg-wa-iosGreen flex items-center justify-center shadow-2xl hover:bg-emerald-500 transition hover:scale-110 active:scale-90 animate-bounce">
                    <i data-lucide="phone" class="w-9 h-9 fill-current"></i>
                </button>
                <span class="text-[10px] font-bold text-wa-accent uppercase">Annehmen</span>
            </div>
        </div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 z-[500] glass-modal flex items-center justify-center p-4">
        <div class="bg-wa-panel w-full max-w-sm rounded-[32px] p-8 border border-gray-700 shadow-2xl animate-fade">
            <div class="w-16 h-16 bg-blue-500/10 text-blue-500 rounded-2xl flex items-center justify-center mb-6">
                <i data-lucide="key-round" class="w-8 h-8"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-100 mb-2">Konto wechseln</h3>
            <p class="text-xs text-gray-500 mb-8 leading-relaxed">Gib deine eindeutige Nutzer-ID und dein 8-Zeichen Passwort ein, um deine Daten zu laden.</p>
            
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-2">Nutzer ID</label>
                    <input id="login_id" type="text" placeholder="UID eingeben..." class="w-full bg-wa-dark border border-gray-700 p-4 rounded-2xl outline-none focus:border-blue-500 transition font-mono text-sm">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-gray-500 uppercase ml-2">Passwort</label>
                    <input id="login_pass" type="password" placeholder="Passwort eingeben..." class="w-full bg-wa-dark border border-gray-700 p-4 rounded-2xl outline-none focus:border-blue-500 transition font-mono">
                </div>
            </div>
            
            <button onclick="window.performLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl mt-8 shadow-xl transition-all active:scale-95">LOGIN BEST√ÑTIGEN</button>
            <button onclick="window.toggleModal('loginModal')" class="w-full py-3 text-gray-500 text-xs font-bold uppercase mt-2">Abbrechen</button>
        </div>
    </div>

    <div id="joinGroupModal" class="hidden fixed inset-0 z-[500] glass-modal flex items-center justify-center p-4">
        <div class="bg-wa-panel w-full max-w-sm rounded-[32px] p-8 border border-gray-700 shadow-2xl animate-fade">
            <h3 class="text-2xl font-black text-gray-100 mb-6 flex items-center gap-3">
                <i data-lucide="hash" class="text-wa-accent"></i> Beitritt
            </h3>
            <div class="space-y-4">
                <input id="jg_id" type="text" placeholder="Gruppen-ID (GRP-XXXX)" class="w-full bg-wa-dark border border-gray-700 p-4 rounded-2xl outline-none focus:border-wa-accent transition font-mono uppercase">
                <input id="jg_pass" type="password" placeholder="Passwort (falls ben√∂tigt)" class="w-full bg-wa-dark border border-gray-700 p-4 rounded-2xl outline-none focus:border-wa-accent transition">
            </div>
            <button onclick="window.joinGrp()" class="w-full bg-wa-accent hover:bg-emerald-600 text-white font-black py-4 rounded-2xl mt-8 shadow-xl transition active:scale-95">JETZT BEITRETEN</button>
            <button onclick="window.toggleModal('joinGroupModal')" class="w-full mt-4 text-gray-500 text-sm font-bold uppercase">Schlie√üen</button>
        </div>
    </div>

    <div id="infoModal" class="hidden fixed inset-0 z-[500] glass-modal flex items-center justify-center p-4">
        <div class="bg-wa-panel w-full max-w-md rounded-[40px] overflow-hidden border border-gray-700 shadow-2xl animate-fade">
            <div class="h-32 bg-wa-accent/20 flex items-center justify-center border-b border-gray-800">
                <div id="infoAvaLarge" class="w-20 h-20 rounded-full bg-wa-accent text-white flex items-center justify-center text-3xl font-black shadow-2xl">?</div>
            </div>
            <div class="p-8">
                <h3 id="infoTit" class="text-2xl font-black text-gray-100 mb-1">Chat Name</h3>
                <div class="flex items-center gap-2 mb-6">
                    <span class="w-2 h-2 bg-wa-accent rounded-full"></span>
                    <span id="infoTypeBadge" class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Gruppe</span>
                </div>
                
                <div class="space-y-4 mb-8">
                    <div class="bg-wa-dark p-4 rounded-2xl border border-gray-800">
                        <label class="text-[10px] font-black text-gray-500 uppercase block mb-1">Kopierbare ID</label>
                        <div class="flex items-center gap-3">
                            <input id="infoIdCopy" readonly class="bg-transparent text-sm font-mono text-wa-accent outline-none flex-1" value="GRP-XXXXX">
                            <button onclick="window.copyChatId()" class="text-gray-400 hover:text-wa-accent transition"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-black text-gray-500 uppercase block mb-3 ml-1">Mitglieder</label>
                        <div id="infoMemberList" class="max-h-48 overflow-y-auto space-y-2 custom-scrollbar">
                            </div>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <button id="leaveBtn" onclick="window.leaveCurrentChat()" class="w-full py-4 rounded-2xl border-2 border-red-500/50 text-red-500 font-black hover:bg-red-500 hover:text-white transition-all duration-300">
                        CHAT VERLASSEN
                    </button>
                    <button onclick="window.toggleModal('infoModal')" class="w-full py-3 text-gray-500 text-xs font-bold uppercase tracking-widest">Fenster Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>

    <div id="newGroupModal" class="hidden fixed inset-0 z-[500] glass-modal flex items-center justify-center p-4">
        <div class="bg-wa-panel w-full max-w-sm rounded-[32px] p-8 border border-gray-700 shadow-2xl animate-fade">
            <h3 class="text-2xl font-black text-gray-100 mb-6">Gruppe gr√ºnden</h3>
            <div class="space-y-4">
                <input id="ng_name" type="text" placeholder="Name der Gruppe..." class="w-full bg-wa-dark border border-gray-700 p-4 rounded-2xl outline-none focus:border-wa-accent transition font-bold">
                <input id="ng_pass" type="password" placeholder="Passwort setzen (optional)" class="w-full bg-wa-dark border border-gray-700 p-4 rounded-2xl outline-none focus:border-wa-accent transition">
            </div>
            <button onclick="window.createGrp()" class="w-full bg-wa-accent hover:bg-emerald-600 text-white font-black py-4 rounded-2xl mt-8 shadow-xl transition active:scale-95">GRUPPE ERSTELLEN</button>
            <button onclick="window.toggleModal('newGroupModal')" class="w-full mt-4 text-gray-500 text-sm font-bold uppercase">Abbrechen</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove, where, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // üî• FIREBASE CONFIG (DEINE DATEN)
        const firebaseConfig = {
            apiKey: "AIzaSyBC_O4jysYWBVuSeLJ6-ylx8OXrHBKQjfc",
            authDomain: "shadowchat-e94f0.firebaseapp.com",
            projectId: "shadowchat-e94f0",
            storageBucket: "shadowchat-e94f0.firebasestorage.app",
            messagingSenderId: "555331269217",
            appId: "1:555331269217:web:872ef3fddca93db0957020"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const IMGBB_KEY = "bd8f03312d551a4e7c4973f6af975396";

        let currentUser = null;
        let activeChatId = null;
        let isPrivate = false;
        let myNick = "Gast";
        let messageUnsub = null;
        let currentCallId = null;

        // --- AUTH & LOGIN LOGIK ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                // Check if we force a custom UID (Login System)
                const forcedUid = localStorage.getItem("shadow_uid");
                const finalUid = forcedUid || user.uid;
                
                currentUser = { uid: finalUid };
                const userRef = doc(db, "users", finalUid);
                const userSnap = await getDoc(userRef);
                
                if(!userSnap.exists()) {
                    myNick = "ShadowUser-" + Math.floor(Math.random()*9000+1000);
                    await setDoc(userRef, { 
                        uid: finalUid, 
                        nickname: myNick, 
                        friends: [], 
                        incoming: [], 
                        password: null, 
                        createdAt: serverTimestamp() 
                    });
                } else {
                    myNick = userSnap.data().nickname;
                }
                
                initUI();
                loadChatList();
                loadFriendsList();
                loadStatus();
                listenForCalls();
            } else {
                signInAnonymously(auth);
            }
        });

        // --- UI INITIALISIERUNG ---
        function initUI() {
            document.getElementById('myAvatar').innerText = myNick[0].toUpperCase();
            document.getElementById('setAvatarLarge').innerText = myNick[0].toUpperCase();
            document.getElementById('myDisplayNick').innerText = myNick;
            document.getElementById('setNick').innerText = myNick;
            document.getElementById('nickIn').value = myNick;
            document.getElementById('myFullId').innerText = currentUser.uid;
            
            // Re-render Lucide Icons
            lucide.createIcons();
        }

        // --- ACCOUNT & LOGIN FUNKTIONEN ---
        window.generateAndSavePass = async () => {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!?#$%";
            let pass = "";
            for(let i=0; i<8; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
            
            await updateDoc(doc(db, "users", currentUser.uid), { password: pass });
            document.getElementById('myPassDisplay').innerText = pass;
            alert("Sicherheitsschl√ºssel generiert: " + pass + "\nSpeichere diesen sicher!");
        };

        window.performLogin = async () => {
            const id = document.getElementById('login_id').value.trim();
            const pass = document.getElementById('login_pass').value.trim();
            
            if(!id || !pass) return alert("Fehlende Daten!");
            
            const userSnap = await getDoc(doc(db, "users", id));
            if(userSnap.exists() && userSnap.data().password === pass) {
                localStorage.setItem("shadow_uid", id);
                alert("Login erfolgreich! Das System wird neu geladen...");
                location.reload();
            } else {
                alert("ID oder Passwort inkorrekt.");
            }
        };

        window.copyMyId = () => {
            navigator.clipboard.writeText(currentUser.uid);
            alert("ID in Zwischenablage kopiert!");
        };

        window.copyPass = () => {
            const pass = document.getElementById('myPassDisplay').innerText;
            if(pass !== "********") {
                navigator.clipboard.writeText(pass);
                alert("Passwort kopiert!");
            }
        };

        // --- MESSAGING LOGIK ---
        window.sendMsg = async () => {
            const inp = document.getElementById('msgIn');
            const file = document.getElementById('imgIn').files[0];
            if(!activeChatId || (!inp.value.trim() && !file)) return;

            let imgUrl = null;
            if(file) {
                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
                const d = await res.json(); 
                if(d.success) imgUrl = d.data.url;
            }

            const msgData = {
                text: inp.value.trim(),
                img: imgUrl,
                senderId: currentUser.uid,
                senderName: myNick,
                timestamp: serverTimestamp(),
                edited: false
            };

            await addDoc(collection(db, `chats/${activeChatId}/messages`), msgData);
            await updateDoc(doc(db, "chats", activeChatId), { lastActivity: serverTimestamp() });
            
            inp.value = "";
            window.clearAttachment();
            document.getElementById('snd_message').play();
        };

        window.editMessage = async (msgId, currentText) => {
            const newText = prompt("Nachricht bearbeiten:", currentText);
            if(newText && newText !== currentText) {
                await updateDoc(doc(db, `chats/${activeChatId}/messages`, msgId), {
                    text: newText,
                    edited: true
                });
            }
        };

        window.openChat = (id, name, priv) => {
            activeChatId = id;
            isPrivate = priv;
            
            document.getElementById('chatHeader').classList.replace('hidden', 'flex');
            document.getElementById('chatInputArea').classList.replace('hidden', 'flex');
            document.getElementById('activeTitle').innerText = name;
            document.getElementById('activeAvatar').innerText = name[0].toUpperCase();
            
            if(window.innerWidth < 768) {
                document.getElementById('mainSidebar').classList.add('hidden');
                document.getElementById('chatArea').classList.replace('hidden', 'flex');
            }

            if(messageUnsub) messageUnsub();
            
            const q = query(collection(db, `chats/${id}/messages`), orderBy("timestamp", "asc"));
            messageUnsub = onSnapshot(q, (snap) => {
                const list = document.getElementById('messagesList');
                list.innerHTML = "";
                
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.senderId === currentUser.uid;
                    
                    const div = document.createElement('div');
                    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-1 animate-fade`;
                    
                    div.innerHTML = `
                        <div class="relative max-w-[85%] px-3 py-2 rounded-2xl shadow-md ${isMe ? 'bg-wa-bubbleDarkOut text-white rounded-tr-none' : 'bg-wa-panel text-gray-100 rounded-tl-none border border-gray-700'}">
                            ${!isMe && !priv ? `<p class="text-[9px] font-black text-wa-accent uppercase mb-1">${m.senderName}</p>` : ''}
                            ${m.img ? `<img src="${m.img}" class="rounded-xl mb-2 max-w-full border border-black/20">` : ''}
                            <div class="flex items-end gap-3">
                                <p class="text-[15px] whitespace-pre-wrap leading-relaxed">${m.text || ''}</p>
                                <div class="flex items-center gap-1 opacity-50 mb-0.5">
                                    ${m.edited ? '<span class="text-[8px] font-bold uppercase">Editiert</span>' : ''}
                                    ${isMe ? `<button onclick="window.editMessage('${d.id}', '${m.text}')" class="hover:text-white transition"><i data-lucide="pencil" class="w-3 h-3"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
                list.scrollTop = list.scrollHeight;
                lucide.createIcons();
            });

            updateInfoModal(id, name, priv);
        };

        // --- GRUPPEN LOGIK ---
        window.createGrp = async () => {
            const name = document.getElementById('ng_name').value.trim();
            const pass = document.getElementById('ng_pass').value.trim();
            if(!name) return alert("Name erforderlich");

            const gid = "GRP-" + Math.random().toString(36).substring(2,9).toUpperCase();
            await setDoc(doc(db, "chats", gid), {
                type: 'group',
                name: name,
                password: pass || null,
                members: [currentUser.uid],
                creator: currentUser.uid,
                lastActivity: serverTimestamp()
            });
            
            window.toggleModal('newGroupModal');
            window.openChat(gid, name, false);
        };

        window.joinGrp = async () => {
            const gid = document.getElementById('jg_id').value.trim().toUpperCase();
            const pass = document.getElementById('jg_pass').value.trim();
            if(!gid) return;

            const snap = await getDoc(doc(db, "chats", gid));
            if(snap.exists()) {
                const data = snap.data();
                if(data.password && data.password !== pass) return alert("Falsches Passwort!");
                
                await updateDoc(doc(db, "chats", gid), {
                    members: arrayUnion(currentUser.uid)
                });
                
                window.toggleModal('joinGroupModal');
                window.openChat(gid, data.name, false);
            } else {
                alert("Gruppe nicht gefunden.");
            }
        };

        window.leaveCurrentChat = async () => {
            if(!activeChatId) return;
            if(!confirm("M√∂chtest du diesen Chat wirklich verlassen?")) return;

            const chatRef = doc(db, "chats", activeChatId);
            if(isPrivate) {
                await updateDoc(chatRef, { participants: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(chatRef, { members: arrayRemove(currentUser.uid) });
            }

            window.toggleModal('infoModal');
            window.closeChatMobile();
            location.reload();
        };

        // --- CALL SYSTEM ---
        window.initiateCall = async () => {
            const callId = "call_" + Date.now();
            currentCallId = callId;
            
            await setDoc(doc(db, "calls", callId), {
                chatId: activeChatId,
                callerId: currentUser.uid,
                callerName: myNick,
                status: 'ringing',
                timestamp: serverTimestamp()
            });
            
            document.getElementById('callOverlay').classList.remove('hidden');
            document.getElementById('callName').innerText = document.getElementById('activeTitle').innerText;
            document.getElementById('callAvatar').innerText = document.getElementById('activeTitle').innerText[0].toUpperCase();
        };

        function listenForCalls() {
            onSnapshot(query(collection(db, "calls"), where("status", "==", "ringing")), (snap) => {
                snap.forEach(async d => {
                    const call = d.data();
                    if(call.callerId === currentUser.uid) return;

                    const chatSnap = await getDoc(doc(db, "chats", call.chatId));
                    if(chatSnap.exists()) {
                        const cData = chatSnap.data();
                        const isMem = cData.type === 'private' ? cData.participants.includes(currentUser.uid) : cData.members.includes(currentUser.uid);
                        
                        if(isMem) {
                            currentCallId = d.id;
                            document.getElementById('callOverlay').classList.remove('hidden');
                            document.getElementById('answerWrapper').classList.remove('hidden');
                            document.getElementById('callName').innerText = call.callerName;
                            document.getElementById('callStatus').innerText = "Eingehender ShadowCall...";
                            document.getElementById('snd_call').play();
                        }
                    }
                });
            });
        }

        window.answerIncomingCall = async () => {
            document.getElementById('callStatus').innerText = "Verbunden";
            document.getElementById('answerWrapper').classList.add('hidden');
            document.getElementById('snd_call').pause();
            // Hier w√ºrde WebRTC Logik starten
        };

        window.hangUpCall = async () => {
            if(currentCallId) await deleteDoc(doc(db, "calls", currentCallId));
            document.getElementById('callOverlay').classList.add('hidden');
            document.getElementById('snd_call').pause();
        };

        // --- HILFSFUNKTIONEN ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            
            // UI Button Active State
            ['chats', 'friends', 'status'].forEach(t => {
                const btn = document.getElementById('btn-tab-' + t);
                if(btn) {
                    btn.classList.remove('border-wa-accent', 'text-wa-accent');
                    btn.classList.add('border-transparent', 'text-gray-500');
                }
            });
            const activeBtn = document.getElementById('btn-tab-' + tab);
            if(activeBtn) {
                activeBtn.classList.remove('border-transparent', 'text-gray-500');
                activeBtn.classList.add('border-wa-accent', 'text-wa-accent');
            }
            lucide.createIcons();
        };

        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        };

        window.closeChatMobile = () => {
            document.getElementById('chatArea').classList.add('hidden');
            document.getElementById('mainSidebar').classList.remove('hidden');
        };

        async function loadChatList() {
            onSnapshot(query(collection(db, "chats"), orderBy("lastActivity", "desc")), (snap) => {
                const cont = document.getElementById('chatListContainer');
                cont.innerHTML = "";
                
                snap.forEach(d => {
                    const c = d.data();
                    const isMem = c.type === 'private' ? c.participants?.includes(currentUser.uid) : c.members?.includes(currentUser.uid);
                    
                    if(isMem) {
                        let name = c.name;
                        if(c.type === 'private') {
                            const other = c.participants.find(p => p !== currentUser.uid);
                            name = c.names?.[other] || "Privat Chat";
                        }
                        
                        const div = document.createElement('div');
                        div.className = "p-4 hover:bg-wa-panel cursor-pointer flex items-center gap-3 transition animate-fade";
                        div.innerHTML = `
                            <div class="w-12 h-12 rounded-full bg-wa-accent flex items-center justify-center text-white font-black shadow-lg">${name[0]}</div>
                            <div class="flex-1 overflow-hidden">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-bold text-gray-200 truncate">${name}</h4>
                                    <span class="text-[9px] text-gray-500 uppercase font-black">${c.type}</span>
                                </div>
                                <p class="text-xs text-gray-500 truncate mt-0.5">Verschl√ºsselte Verbindung aktiv</p>
                            </div>
                        `;
                        div.onclick = () => window.openChat(d.id, name, c.type === 'private');
                        cont.appendChild(div);
                    }
                });
            });
        }

        async function updateInfoModal(id, name, priv) {
            document.getElementById('infoTit').innerText = name;
            document.getElementById('infoAvaLarge').innerText = name[0];
            document.getElementById('infoIdCopy').value = id;
            document.getElementById('infoTypeBadge').innerText = priv ? "Privater Chat" : "Gruppe";
            
            const list = document.getElementById('infoMemberList');
            list.innerHTML = `<div class="p-2 text-center text-xs text-gray-600">Mitglieder werden geladen...</div>`;
            
            if(!priv) {
                const s = await getDoc(doc(db, "chats", id));
                list.innerHTML = "";
                for(const mid of s.data().members) {
                    const u = await getDoc(doc(db, "users", mid));
                    list.innerHTML += `
                        <div class="flex items-center gap-3 p-2 bg-wa-dark rounded-xl border border-gray-800">
                            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold">${u.data().nickname[0]}</div>
                            <span class="text-sm font-bold text-gray-300">${u.data().nickname}</span>
                            ${mid === s.data().creator ? '<span class="text-[8px] bg-wa-accent/20 text-wa-accent px-1.5 py-0.5 rounded font-black uppercase ml-auto">Admin</span>' : ''}
                        </div>
                    `;
                }
            } else {
                list.innerHTML = `<p class="text-xs text-gray-500 italic">In privaten Chats sind nur du und dein Kontakt.</p>`;
            }
        }

        window.copyChatId = () => {
            const input = document.getElementById('infoIdCopy');
            input.select();
            document.execCommand('copy');
            alert("Chat-ID kopiert!");
        };

        window.handleFile = () => {
            const f = document.getElementById('imgIn').files[0];
            if(f) {
                document.getElementById('prevImg').src = URL.createObjectURL(f);
                document.getElementById('attachmentPreview').classList.remove('hidden');
            }
        };

        window.clearAttachment = () => {
            document.getElementById('imgIn').value = "";
            document.getElementById('attachmentPreview').classList.add('hidden');
        };

        window.saveProfile = async () => {
            const n = document.getElementById('nickIn').value.trim();
            if(n) {
                await updateDoc(doc(db, "users", currentUser.uid), { nickname: n });
                location.reload();
            }
        };

        window.sendRequest = async () => {
            const id = document.getElementById('friendSearchInput').value.trim();
            if(!id || id === currentUser.uid) return alert("Ung√ºltige ID");
            const snap = await getDoc(doc(db, "users", id));
            if(snap.exists()) {
                await updateDoc(doc(db, "users", id), { incoming: arrayUnion(currentUser.uid) });
                alert("Anfrage gesendet!");
            } else {
                alert("Nutzer nicht gefunden.");
            }
        };

        function loadFriendsList() {
            onSnapshot(doc(db, "users", currentUser.uid), async s => {
                const d = s.data(); if(!d) return;
                
                const cL = document.getElementById('contactsList'); cL.innerHTML = "";
                for(const fid of d.friends || []) {
                    const fU = await getDoc(doc(db, "users", fid));
                    if(fU.exists()) {
                        const div = document.createElement('div');
                        div.className = "p-3 bg-wa-panel rounded-xl border border-gray-700 flex justify-between items-center";
                        div.innerHTML = `<b>${fU.data().nickname}</b><button class="text-wa-accent text-xs font-black uppercase">Chat</button>`;
                        div.onclick = () => window.startPrivateChat(fid, fU.data().nickname);
                        cL.appendChild(div);
                    }
                }
                
                const pL = document.getElementById('pendingList'); pL.innerHTML = "";
                if(d.incoming?.length > 0) {
                    document.getElementById('pendingContainer').classList.remove('hidden');
                    for(const rid of d.incoming) {
                        pL.innerHTML += `<div class="flex justify-between p-3 bg-orange-500/10 border border-orange-500/30 rounded-xl">
                            <span class="text-xs font-mono">${rid.substring(0,8)}...</span>
                            <button onclick="window.acceptFriend('${rid}')" class="text-orange-500 font-black text-xs uppercase">Annehmen</button>
                        </div>`;
                    }
                } else {
                    document.getElementById('pendingContainer').classList.add('hidden');
                }
            });
        }

        window.startPrivateChat = async (oId, oNick) => {
            const cid = [currentUser.uid, oId].sort().join("_");
            await setDoc(doc(db, "chats", cid), {
                type: 'private',
                participants: [currentUser.uid, oId],
                names: { [currentUser.uid]: myNick, [oId]: oNick },
                lastActivity: serverTimestamp()
            }, { merge: true });
            window.openChat(cid, oNick, true);
        };

        window.acceptFriend = async (rid) => {
            const batch = writeBatch(db);
            batch.update(doc(db, "users", currentUser.uid), { friends: arrayUnion(rid), incoming: arrayRemove(rid) });
            batch.update(doc(db, "users", rid), { friends: arrayUnion(currentUser.uid) });
            await batch.commit();
        };

        function loadStatus() {
            onSnapshot(query(collection(db, "status"), orderBy("timestamp", "desc")), snap => {
                const list = document.getElementById('globalStatusList'); list.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    list.innerHTML += `
                        <div class="flex items-center gap-3 p-2 hover:bg-wa-panel rounded-xl cursor-pointer" onclick="window.open('${s.img}')">
                            <img src="${s.img}" class="w-12 h-12 rounded-full border-2 border-wa-accent object-cover">
                            <div><h4 class="font-bold text-sm">${s.name}</h4><p class="text-[10px] text-gray-500">Vor kurzem</p></div>
                        </div>
                    `;
                });
            });
        }

        window.upStatus = async () => {
            const f = document.getElementById('stIn').files[0]; if(!f) return;
            const fd = new FormData(); fd.append("image", f);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const d = await res.json();
            if(d.success) {
                await addDoc(collection(db, "status"), { uid: currentUser.uid, name: myNick, img: d.data.url, timestamp: serverTimestamp() });
                alert("Status geteilt!");
            }
        };

        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
        };

    </script>
</body>
</html>
